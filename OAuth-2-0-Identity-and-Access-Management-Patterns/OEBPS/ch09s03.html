<?xml version="1.0" encoding="utf-8" ?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"><head><title>OAuth 2.0 SAML bearer assertion grant flow</title><link rel="stylesheet" href="epub.css" type="text/css"/><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"/></head><body id="page"><div class="section" title="OAuth 2.0 SAML bearer assertion grant flow"><div class="titlepage"><div><div><h1 class="title"><a id="ch09lvl1sec41"/>OAuth 2.0 SAML bearer assertion grant flow</h1></div></div></div><p>Here we'll explore how<a id="id396" class="indexterm"/> SAML 2.0 bearer assertions can be used as authorization grants.</p><p>Regarding <a id="id397" class="indexterm"/>bearer assertions: a bearer is an entity (for example, a client application) in possession of an assertion, where the entity doesn't have to demonstrate proof of possession of the given assertion with some cryptographic key. Because of this, when the client application is supplying the assertion in the request to the server, the use of secure communication (TLS) is required so that the assertion is not compromised.</p><p>Key characteristic of this new grant type is that the client application is exchanging the SAML assertion for an access token.</p><p>The flow<a id="id398" class="indexterm"/> consists of the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The grant flow is initiated (on behalf of the end user or by some task) by the client application.</li><li class="listitem">The client application either generates a SAML assertion or obtains it from a SAML identity provider.</li><li class="listitem">The client application makes an HTTP POST request to the authorization server in order to exchange the assertion.</li><li class="listitem">The authorization server performs client authorization and validation of the supplied data from the request. If the application is authorized and the assertion is validated the server returns an access token; if any error occurred during the process,<a id="id399" class="indexterm"/> an error response is returned.</li></ol></div><p>If we illustrate the flow we get the following diagram:</p><div class="mediaobject"><img src="graphics/5594OS_09_01.jpg" alt="OAuth 2.0 SAML bearer assertion grant flow"/></div><p>Bear in mind that before the flow is initiated, the application has to be registered. Registration is a process that is described in <a class="link" href="ch03.html" title="Chapter&#xA0;3.&#xA0;First Step for Your Application">Chapter 3</a>, <span class="emphasis"><em>First Step for Your Application</em></span>. In this scenario the user<a id="id400" class="indexterm"/> additionally has to register an X.509 Certificate. If certificate registration is required it should be specified in the registration interface provided by the authorization server.</p><div class="section" title="Preparing assertion"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec53"/>Preparing assertion</h2></div></div></div><p>In order to prepare<a id="id401" class="indexterm"/> the SAML 2.0 assertion XML we need to have the values of the<a id="id402" class="indexterm"/> following XML attributes and elements:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">Issuer</code>: <a id="id403" class="indexterm"/>This is the location of the SAML identity provider (for example, <code class="literal">https://saml-idp.example-service.com</code>), or the OAuth 2.0 client's <code class="literal">client_id</code> field.</li><li class="listitem" style="list-style-type: disc"><code class="literal">NameID</code>: <a id="id404" class="indexterm"/>This is a field inside the parent element named<a id="id405" class="indexterm"/> <code class="literal">Subject</code>. It contains an e-mail address of the user on whose behalf the flow is initiated (for example, <code class="literal">test-user@example.com</code>).</li><li class="listitem" style="list-style-type: disc"><code class="literal">Audience</code>: <a id="id406" class="indexterm"/>This is used for specifying a URI reference for where the assertion is intended for (for example, <code class="literal">https://saml-sp.example-service.net</code>).</li><li class="listitem" style="list-style-type: disc"><code class="literal">Recipient</code>:<a id="id407" class="indexterm"/> This is an attribute for the <code class="literal">SubjectConfirmationData</code> element, specifying the authorization server's token endpoint URI on which the POST request will be executed (for example, <code class="literal">https://example-service.com/oauth/token</code>).</li><li class="listitem" style="list-style-type: disc"><code class="literal">NotOnOrAfter</code>: <a id="id408" class="indexterm"/>This is an attribute for the <code class="literal">Conditions</code> element<a id="id409" class="indexterm"/>, specifying the expiration date until which the assertion can be used. This field can be used for the <code class="literal">SubjectConfirmationData</code> element<a id="id410" class="indexterm"/> as well; it must be specified in at least one of these elements.</li><li class="listitem" style="list-style-type: disc"><code class="literal">NotBefore</code>: <a id="id411" class="indexterm"/>This is an optional attribute that can be used in the same places as the <code class="literal">NotOnOrAfter</code> attribute, specifying from which point in time the assertion can be used.</li></ul></div><p>When these fields are prepared,<a id="id412" class="indexterm"/> additionally the assertion must be digitally signed using the standardized XML Signature W3C specification, and this data goes into the <code class="literal">Signature</code> element<a id="id413" class="indexterm"/> of the<a id="id414" class="indexterm"/> assertion. The signature can<a id="id415" class="indexterm"/> be signed with RSA, SHA-1, or SHA-256, all supported in popular programming languages.</p><p>Following is an example, taken and adjusted from the specification, of a prepared assertion:</p><div class="informalexample"><pre class="programlisting">&lt;Assertion IssueInstant="2010-10-01T20:07:34.619Z"
  ID="ef1xsbZxPV2oqjd7HTLRLIBlBb7"
  Version="2.0"
  xmlns="urn:oasis:names:tc:SAML:2.0:assertion"&gt;
&lt;Issuer&gt;https://saml-idp.example-service.com&lt;/Issuer&gt;
&lt;ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#"&gt;
  [...omitted for brevity...]
&lt;/ds:Signature&gt;
&lt;Subject&gt;
  &lt;NameID
  Format="urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress"&gt;
    test-user@example.com
  &lt;/NameID&gt;
  &lt;SubjectConfirmation
  Method="urn:oasis:names:tc:SAML:2.0:cm:bearer"&gt;
    &lt;SubjectConfirmationData
    NotOnOrAfter="2010-10-01T20:12:34.619Z"
    Recipient="https://example-service.com/oauth/token"/&gt;
    &lt;/SubjectConfirmation&gt;
  &lt;/Subject&gt;
  &lt;Conditions&gt;
  &lt;AudienceRestriction&gt;
    &lt;Audience&gt;https://saml-sp.example-service.net&lt;/Audience&gt;
  &lt;/AudienceRestriction&gt;
  &lt;/Conditions&gt;
  &lt;AuthnStatement AuthnInstant="2010-10-01T20:07:34.371Z"&gt;
  &lt;AuthnContext&gt;
    &lt;AuthnContextClassRef&gt;
    urn:oasis:names:tc:SAML:2.0:ac:classes:X509
    &lt;/AuthnContextClassRef&gt;
  &lt;/AuthnContext&gt;
  &lt;/AuthnStatement&gt;
&lt;/Assertion&gt;</pre></div><p>One last thing to do is to encode <a id="id416" class="indexterm"/>the whole assertion by using base64url encoding before<a id="id417" class="indexterm"/> adding it as part of the POST request.</p></div><div class="section" title="Requesting authorization"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec54"/>Requesting authorization</h2></div></div></div><p>Now that we have the <a id="id418" class="indexterm"/>assertion prepared, it's time to prepare the<a id="id419" class="indexterm"/> POST request in order to<a id="id420" class="indexterm"/> execute it.</p><p>The endpoint with the required parameters may have the following form:</p><p>
<code class="literal">https://example-service.com/oauth/token?grant_type=urn:ietf:params:oauth:grant-type:saml2-bearer&amp;assertion=AssertionToBase64Url</code>
</p><p>The parameters that are used when constructing the request are the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">grant_type</code>:<a id="id421" class="indexterm"/> This is a mandatory parameter, always set to <code class="literal">urn:ietf:params:oauth:grant-type:saml2-bearer</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">assertion</code>: <a id="id422" class="indexterm"/>This is a mandatory parameter, contains a single SAML 2.0 assertion encoded with the base64url method</li><li class="listitem" style="list-style-type: disc"><code class="literal">scope</code>: <a id="id423" class="indexterm"/>This is an optional parameter, used for specifying which parts (or types) of protected resources can be accessed on behalf of the owner</li><li class="listitem" style="list-style-type: disc"><code class="literal">client_id</code>: <a id="id424" class="indexterm"/>This is an optional parameter, used for client identification</li><li class="listitem" style="list-style-type: disc"><code class="literal">client_secret</code>: <a id="id425" class="indexterm"/>This is an optional parameter, used for<a id="id426" class="indexterm"/> client identification</li></ul></div></div><div class="section" title="Successful authorization"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec55"/>Successful authorization</h2></div></div></div><p>If the client is authenticated and the<a id="id427" class="indexterm"/> supplied fields and assertions are<a id="id428" class="indexterm"/> validated, the authorization server will respond with an access token.</p><p>The body of the response may have the following form:</p><div class="informalexample"><pre class="programlisting">{
  "access_token":"exampleAccessTokenValue123",
  "expires_in":3600
}</pre></div><p>Note that refresh tokens<a id="id429" class="indexterm"/> usually are not issued when using this grant type. Client applications can try to refresh the expired access token by requesting a new one with the same assertion. If the assertion has expired then a new access token can be requested by executing the whole grant flow from the start.</p></div><div class="section" title="Authorization error"><div class="titlepage"><div><div><h2 class="title"><a id="ch09lvl2sec56"/>Authorization error</h2></div></div></div><p>If the assertion is not<a id="id430" class="indexterm"/> valid or has<a id="id431" class="indexterm"/> expired, the authorization server returns a response containing information regarding the error.</p><div class="informalexample"><pre class="programlisting">{
  "error":"invalid_grant",
  "error_description":"Audience validation failed",
  "error_uri":https://example-service.com/docs/oauth/saml
}</pre></div><p>The value of the <code class="literal">error</code> parameter will always be <code class="literal">invalid_grant</code>. The value in the <code class="literal">error_description</code> may contain a short message relating to why the assertion failed, and optionally the parameter <code class="literal">error_uri</code> may be included, which contains a link to a web document containing more <a id="id432" class="indexterm"/>detailed explanation.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip25"/>Tip</h3><p>To know in detail which validation steps the authorization server takes when it receives an assertion, check the <span class="emphasis"><em>Assertion Format and Processing Requirements</em></span> section of the<a id="id433" class="indexterm"/> OAuth SAML Assertion Profiles draft specification.</p></div></div></div></div></body></html>
