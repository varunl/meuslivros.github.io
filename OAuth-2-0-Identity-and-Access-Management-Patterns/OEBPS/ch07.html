<?xml version="1.0" encoding="utf-8" ?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter&#xA0;7.&#xA0;OAuth for Trusted Applications</title><link rel="stylesheet" href="epub.css" type="text/css"/><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"/></head><body id="page"><div class="chapter" title="Chapter&#xA0;7.&#xA0;OAuth for Trusted Applications"><div class="titlepage"><div><div><h1 class="title"><a id="ch07"/>Chapter&#xA0;7.&#xA0;OAuth for Trusted Applications</h1></div></div></div><p>In the previous chapter, we learned how to use OAuth 2.0 in mobile applications. We also learned about custom URL schemes, how to define them and how to use them. Up to this point in this book, we have covered the authorization code grant and the implicit grant, two out of the four grants defined in the OAuth 2.0 specification.</p><p>In this chapter, we will cover the remaining two grants defined in the OAuth 2.0 specification&#x2014;the Resource Owner Password Credentials grant (which we can call the password grant for short) and the client credentials grant.</p><p>These two grants are most suitable in environments where trust and information confidentiality are assured. For example, the password grant can be used in internal environments and in scenarios where the authorization server and the client application(s) are by the same creator; and the client credentials grant is mostly used in cases when the client application wants to access some service API on behalf of itself and not on behalf of the user. Because of the fact that these two grants are suitable for less use cases and scenarios compared to the authorization code grant and the client credentials grant, they are supported by fewer service providers.</p><p>Note that the authorization code grant is used in trusted client applications as well, but used for those client applications that want to request a token on behalf of a resource owner (a user), or are able to utilize the web redirection flow instead of explicitly requiring the username and password to be entered.</p><div class="section" title="Resource owner password credentials grant"><div class="titlepage"><div><div><h1 class="title"><a id="ch07lvl1sec31"/>Resource owner password credentials grant</h1></div></div></div><p>The password grant is a grant flow where the client application, together with its client identifier and secret, sends the <a id="id248" class="indexterm"/>user's username and password in exchange for an access token. Instead of the user having to log in and approve the authorization request in some web interface&#x2014;as in the authorization code grant&#x2014;here the user may enter his username and password in the client application UI directly.</p><p>Additionally, this flow is good for client applications that are migrating to OAuth 2.0 and previously used some other form of API authentication, most commonly HTTP Basic or Digest. From the user's perspective, the client application may look and behave the same, but instead of transmitting the username and password to authenticate every request made to the API, it will do that only once<a id="id249" class="indexterm"/> in the beginning in order to obtain the access token.</p><p>Key characteristics of the<a id="id250" class="indexterm"/> password grant type are as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Used in confidential clients</li><li class="listitem" style="list-style-type: disc">Uses the username and password of the resource owner</li><li class="listitem" style="list-style-type: disc">The flow is not redirection-based; it takes only a request from the client application to the authorization server, and the user is not being redirected between interfaces to authorize the request</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip18"/>Tip</h3><p>In the OAuth 2.0 Authorization Framework specifications (RFC 6749), the Resource Owner Password Credentials grant is defined in section <span class="emphasis"><em>4.3</em></span>.</p></div></div><p>Let's take a look at a graphical representation of the flow, shown in the following diagram, taken from the OAuth 2.0 specification:</p><div class="mediaobject"><img src="graphics/5594OS_07_01.jpg" alt="Resource owner password credentials grant"/></div><p>The flow consists of the following steps:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">The resource owner (for example, the user) supplies the Client application with his username and password.</li><li class="listitem">The client application makes a request to the Authorization server, including the user's credentials and also his own identifier and secret.</li><li class="listitem">The Authorization server authenticates the client based on his identifier and secret, checks whether it is authorized for making this request, and checks the resource owner credentials and other parameters supplied. If all checks pass successfully, the <a id="id251" class="indexterm"/>Authorization server returns an access token in response.</li></ol></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip19"/>Tip</h3><p>As a security precaution, it is highly advised that the client application, once it gets the access token, discards and does not store the username and password that the user has entered.</p></div></div><div class="section" title="Requesting authorization"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec31"/>Requesting authorization</h2></div></div></div><p>We'll assume that the client application<a id="id252" class="indexterm"/> is already registered with the authorization server, a step described in <a class="link" href="ch03.html" title="Chapter&#xA0;3.&#xA0;First Step for Your Application">Chapter 3</a>, <span class="emphasis"><em>First Step for Your Application</em></span>.</p><p>The client application constructs the request address using the specified endpoint and the parameters, for example, <code class="literal">https://api.example-service.com/oauth/authorize?grant_type=password&amp;client_id=CLIENT_ID_EXAMPLE&amp;client_secret=CLIENT_SECRET&amp;username=USERNAME&amp;password=PASSWORD</code>.</p><p>When constructed, the address is being executed as an HTTP POST request, and if successful the client application will get an access token in return as part of the response body.</p><p>The parameters that are used when constructing the request are the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">grant_type</code>: <a id="id253" class="indexterm"/>This is a mandatory parameter, always set to <code class="literal">password</code></li><li class="listitem" style="list-style-type: disc"><code class="literal">username</code>: <a id="id254" class="indexterm"/>This is a mandatory parameter supplied by the resource owner (the user)</li><li class="listitem" style="list-style-type: disc"><code class="literal">password</code>: <a id="id255" class="indexterm"/>This is a mandatory parameter supplied by the resource owner (the user)</li><li class="listitem" style="list-style-type: disc"><code class="literal">client_id</code>: <a id="id256" class="indexterm"/>This is an optional parameter used for client identification</li><li class="listitem" style="list-style-type: disc"><code class="literal">client_secret</code>: <a id="id257" class="indexterm"/>This is an optional parameter used for client identification</li><li class="listitem" style="list-style-type: disc"><code class="literal">scope</code>: <a id="id258" class="indexterm"/>This is an optional parameter, as in all previous cases, used for specifying which parts (or types) of protected resources can be accessed on behalf of the owner</li></ul></div><p>Note that the authentication method between the client application and the authorization server may vary, and this is why the client identifier and secret are specified as optional. But in most of the cases they are part of the request URL. Sometimes, some custom additional parameters may have to be included as well, so always refer to the developer documentation supplied for the<a id="id259" class="indexterm"/> given service for which the client application is developed.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip20"/>Tip</h3><p>How the client application asks for the user credentials and obtains them is out of the scope of the OAuth 2.0 specification. A common practice is for the client application to display a dialog box to the user asking him to enter this information.</p></div></div></div><div class="section" title="Successful authorization"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec32"/>Successful authorization</h2></div></div></div><p>When the<a id="id260" class="indexterm"/> authorization server handles the request from the client, several validations are in place, such as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">Validation of the client identification and secret, additionally assuring that the client is authorized to make the request</li><li class="listitem" style="list-style-type: disc">Validation of the credentials of the resource owner</li></ul></div><p>If the validations pass successfully, the authorization server will make a response with an access token and optionally with a refresh token.</p><p>In the body of the response, a JSON (or XML or other) object will be included representing the response. An example is shown as follows:</p><div class="informalexample"><pre class="programlisting">{
  "access_token":"exampleAccessTokenValue123",
  "token_type":"example",
  "expires_in":3600,
  "refresh_token":"exampleRefreshTokenValue123"
}</pre></div><p>The fields that are part of the response are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">access_token</code>: <a id="id261" class="indexterm"/>This is a mandatory parameter and its value is the actual access token the client application may store and use later</li><li class="listitem" style="list-style-type: disc"><code class="literal">token_type</code>: <a id="id262" class="indexterm"/>This is a mandatory parameter, a string representing what kind of a token is the one returned in the response</li><li class="listitem" style="list-style-type: disc"><code class="literal">expires_in</code>: <a id="id263" class="indexterm"/>This is an optional and recommended parameter that specifies the lifetime of the access token in seconds</li><li class="listitem" style="list-style-type: disc"><code class="literal">refresh_token</code>: <a id="id264" class="indexterm"/>This is an optional parameter used by the client to renew an access token whose<a id="id265" class="indexterm"/> lifetime has expired</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip21"/>Tip</h3><p>In some OAuth implementations of the authorization server, some other additional parameters may be included in the response as well. This is usually done to provide some additional business logic.</p></div></div></div><div class="section" title="Authorization error"><div class="titlepage"><div><div><h2 class="title"><a id="ch07lvl2sec33"/>Authorization error</h2></div></div></div><p>If the authorization<a id="id266" class="indexterm"/> request failed for any reason, the authorization server may return a response containing information regarding the error. Again, this may be in JSON format (or XML or other) and may have the following format:</p><div class="informalexample"><pre class="programlisting">{
  "error":"invalid_request",
  "error_description":"Username parameter missing",
  "error_uri": https://example-service.com/docs/oauth/
}</pre></div><p>The <code class="literal">error</code> parameter can contain one of the several values listed as follows, describing the nature of the problem that has occurred:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">invalid_request</code>: <a id="id267" class="indexterm"/>The <code class="literal">error</code> parameter contains this value when there's a problem with the request, either a missing parameter or value, a parameter included multiple times or missing, or a parameter with a malformed name.</li><li class="listitem" style="list-style-type: disc"><code class="literal">invalid_client</code>: <a id="id268" class="indexterm"/>The <code class="literal">error</code> parameter contains this value when the authentication of the client fails. This can happen if authentication parameters are missing (the client identifier and secret) or if the client tries to authenticate with an unsupported method.</li><li class="listitem" style="list-style-type: disc"><code class="literal">invalid_grant</code>: <a id="id269" class="indexterm"/>The <code class="literal">error</code> parameter contains this value when the grant specified is invalid, expired, or revoked, or it was issued to another client. For example, some services don't allow requesting a new access token until the one already issued is not expired.</li><li class="listitem" style="list-style-type: disc"><code class="literal">unauthorized_client</code>: <a id="id270" class="indexterm"/>The <code class="literal">error</code> parameter contains this value when the client was authenticated by the authorization server, but has no authorization to use the grant requested.</li><li class="listitem" style="list-style-type: disc"><code class="literal">unsupported_grant_type</code>:<a id="id271" class="indexterm"/> The <code class="literal">error</code> parameter contains this value when the grant that was requested is not supported by the authorization server.</li><li class="listitem" style="list-style-type: disc"><code class="literal">invalid_scope</code>:<a id="id272" class="indexterm"/> The <code class="literal">error</code> parameter contains this value when the scope specified in the request was not valid, unknown, or malformed. In these situations check the developer documentation by the service provider to see which scopes are available and which ones can be used.</li></ul></div><p>Additionally, the optional parameter <code class="literal">error_description</code> may contain a short message explaining the error,<a id="id273" class="indexterm"/> and the optional parameter <code class="literal">error_uri</code> may contain a link to a web document containing a more detailed explanation. Only the <code class="literal">error parameter</code> is mandatory.</p></div></div></div></body></html>
