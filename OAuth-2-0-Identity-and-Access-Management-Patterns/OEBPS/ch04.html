<?xml version="1.0" encoding="utf-8" ?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Chapter&#xA0;4.&#xA0;OAuth for Web Server Applications</title><link rel="stylesheet" href="epub.css" type="text/css"/><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"/></head><body id="page"><div class="chapter" title="Chapter&#xA0;4.&#xA0;OAuth for Web Server Applications"><div class="titlepage"><div><div><h1 class="title"><a id="ch04"/>Chapter&#xA0;4.&#xA0;OAuth for Web Server Applications</h1></div></div></div><p>Have you ever signed into a website via Facebook, LinkedIn, or Google? For example, you're visiting a news website and you wanted to leave a comment on an article, and instead of creating an account there you just signed in by clicking on a button and choosing "Approve" in Facebook?</p><p>This is just one of the many examples where OAuth 2.0 is successfully and massively used, and this kind of flow&#x2014;the redirecting between the website and Facebook and back&#x2014;is based on the authorization code grant, probably the most frequently used OAuth 2.0 grant.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip07"/>Tip</h3><p>In the OAuth 2.0 authorization framework specification (<span class="emphasis"><em>RFC 6749</em></span>), this grant is defined in <span class="emphasis"><em>Section 4.1</em></span>.</p></div></div><div class="section" title="Authorization code grant"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec19"/>Authorization code grant</h1></div></div></div><p>We can notice the following characteristics<a id="id108" class="indexterm"/> in the authorization code grant:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The authorization code grant is used for confidential clients</li><li class="listitem" style="list-style-type: disc">It uses redirection, so it is a redirection-based flow, between the client and the authorization service</li><li class="listitem" style="list-style-type: disc">It requires the end user's approval for authorization, for example, by displaying a message in a web browser</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip08"/>Tip</h3><p>What is a confidential client? Refer to <a class="link" href="ch02.html" title="Chapter&#xA0;2.&#xA0;Terms You Need To Know">Chapter 2</a>, <span class="emphasis"><em>Terms You Need To Know</em></span>, where we covered the OAuth 2.0 terminology.</p></div></div><p>The authorization code grant<a id="id109" class="indexterm"/> is used to obtain access tokens and optionally refresh tokens. Access tokens are used to perform API requests on behalf of the user; refresh tokens are used to request new access tokens when needed and without the trouble to redo the whole grant flow and end user approval.</p><p>The following diagram shows a graphical representation of this flow, taken from the OAuth 2.0 specification:</p><div class="mediaobject"><img src="graphics/5594OS_04_01.jpg" alt="Authorization code grant"/></div><p>Let's go step-by-step and see how a client gets the authorization<a id="id110" class="indexterm"/> and retrieves an access token on behalf of the user:</p><div class="orderedlist"><ol class="orderedlist arabic"><li class="listitem">First task is the initiation of the flow where the <span class="strong"><strong>Client application</strong></span><a id="id111" class="indexterm"/> is redirecting the <span class="strong"><strong>User agent</strong></span><a id="id112" class="indexterm"/> (for example, the browser) to the authorization endpoint.</li><li class="listitem">Then the <span class="strong"><strong>Authorization server</strong></span><a id="id113" class="indexterm"/> authenticates the <span class="strong"><strong>Resource owner</strong></span><a id="id114" class="indexterm"/> (for example, you have to be logged into Facebook before you approve an authorization) and the owner chooses whether to authorize the request or not. Most commonly this happens in a browser window and this is the only step of the flow that is visible to the end user.</li><li class="listitem">If the user authorizes the request, then he is redirected using the previously supplied redirection endpoint, from which the <span class="strong"><strong>Client application</strong></span> gets the authorization code for that user.</li><li class="listitem">Using this authorization code, the client makes a request for an access token on the specified server endpoint. Additionally, the client authenticates during the request and includes the redirection endpoint.</li><li class="listitem">The <span class="strong"><strong>Authorization server</strong></span> <a id="id115" class="indexterm"/>authenticates the client, validates the authorization code, and ensures that the redirection endpoints supplied in step 4 and 2 match each other. If valid, the <span class="strong"><strong>Authorization server</strong></span> responds back with an access token (and optionally a refresh token). And when the <span class="strong"><strong>Client application</strong></span><a id="id116" class="indexterm"/> gets the access token, it can start making requests with it to some API on behalf of the user.</li></ol></div><p>Basically, this flow can be divided<a id="id117" class="indexterm"/> into two parts, requesting authorization from the user and obtaining an authorization code, and once authorized requesting an access token with the authorization code. Next we'll see the authorization code grant in detail and see which parameters are used and which data is exchanged.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note04"/>Note</h3><p>It is common for the service providers that support OAuth 2.0 (the ones that host the resource servers) to have an internal page, similar to the application registration page that we discussed in the previous chapter, where end users, when logged in, can review which client applications they have given the authorization approval and revoke access if desired.</p></div></div><div class="section" title="Requesting the authorization code"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec22"/>Requesting the authorization code</h2></div></div></div><p>Requesting authorization<a id="id118" class="indexterm"/> is all about getting the user to<a id="id119" class="indexterm"/> authorize the client application and the authorization server to return an authorization code.</p><p>For this, first the client must be registered with the authorization server, and the client application will use the authorization endpoint specified in the registration details. This is covered in detail in <a class="link" href="ch03.html" title="Chapter&#xA0;3.&#xA0;First Step for Your Application">Chapter 3</a>, <span class="emphasis"><em>First Step for Your Application</em></span>.</p><div class="section" title="Making the request"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec01"/>Making the request</h3></div></div></div><p>The client application constructs<a id="id120" class="indexterm"/> the request address (that is, the request URL) from the endpoint and the parameters. For example, it may have the following form:</p><p>
<code class="literal">https://api.example-service.com/oauth/authorize?response_type=code&amp;client_id=CLIENT_ID_EXAMPLE&amp;redirect_uri=REDIRECT_ENDPOINT_EXAMPLE</code>
</p><p>There are several parameters that<a id="id121" class="indexterm"/> are part of the request URL, among which some are mandatory and some are optional. These parameters are explained as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">response_type</code>: <a id="id122" class="indexterm"/>This is a mandatory parameter and its value must be set to <code class="literal">code</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">client_id</code>:<a id="id123" class="indexterm"/> This is a mandatory parameter that is used for identification of the client application to the authorization server. The value is set with the data from the client registration with the authorization server.</li><li class="listitem" style="list-style-type: disc"><code class="literal">redirect_uri</code>: <a id="id124" class="indexterm"/>This is an optional parameter, representing the endpoint to which the authorization server supplies the authorization code, if the authorization was approved by the end user.</li><li class="listitem" style="list-style-type: disc"><code class="literal">scope</code>: <a id="id125" class="indexterm"/>This is an optional parameter that is used for specifying which parts (or types) of the protected resources are to be accessed on behalf of the owner.</li><li class="listitem" style="list-style-type: disc"><code class="literal">state</code>:<a id="id126" class="indexterm"/> This is an optional parameter that can be used by the client for its own purposes, most commonly for security checks. When the authorization server redirects back to the <code class="literal">redirect_uri</code> parameter with the authorization code, it can additionally supply back the <code class="literal">state</code> parameter with the same value that was used in the request. This security precaution is strongly recommended for client developers.</li></ul></div><p>The client redirects the end user<a id="id127" class="indexterm"/> to this endpoint, and the authorization server is validating the request and the user is asked for a decision, whether to allow the authorization request or not.</p><p>As shown in the following illustration, the user decision is displayed and conducted in a dialog message in the browser window, where it is specified which client application wants to be authorized and which privileges it requires (which are defined in the request parameter <code class="literal">scope</code>):</p><div class="mediaobject"><img src="graphics/5594OS_04_02.jpg" alt="Making the request"/></div><p>Lately, even some mobile applications use this flow (due to the fact that mobile operating systems provide mechanisms for secure storage), and display an embedded browser window in which the user logs in to the service provider and approves the authorization request.</p><p>After the user<a id="id128" class="indexterm"/> makes a decision, the authorization server redirects using the <code class="literal">redirect_uri</code> parameter. If this<a id="id129" class="indexterm"/> parameter was not supplied, the default redirect endpoint specified in the registration of the client application is used.</p></div><div class="section" title="Successful authorization"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec02"/>Successful authorization</h3></div></div></div><p>If the user has approved the authorization,<a id="id130" class="indexterm"/> the server will do a redirect to the specified endpoint by the client, for example:</p><p>
<code class="literal">https://client.example.com/oauth/cb?code=AUTHORIZATION_CODE&amp;state=APP_STATE</code>
</p><p>From here the client application retrieves the authorization code from the <code class="literal">code</code> parameter. The second supplied parameter is <code class="literal">state</code> and it contains the same value that was specified in the request.</p><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip09"/>Tip</h3><p>It is a security practice among authorization servers to expire authorization codes and not keep them for more than 10 minutes. So if the client application has retrieved the authorization code, it's advised to continue with the flow immediately and request an access token. If the code is expired the client application will have to go from the start of the flow again. Additionally, an authorization code can be used only once; we cannot get multiple different access tokens with the <a id="id131" class="indexterm"/>same authorization code.</p></div></div></div><div class="section" title="Authorization error"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec03"/>Authorization error</h3></div></div></div><p>If the user has denied the<a id="id132" class="indexterm"/> request or some other error has happened, such as missing parameter, invalid <code class="literal">client_id</code>, or a similar error, the client application will get an error response.</p><p>The client is redirected to the same redirect endpoint (or if this endpoint is invalid, then to the one specified in the client registration), for example:</p><p>
<code class="literal">https://client.example.com/oauth/cb?error=access_denied&amp;state=APP_STATE</code>
</p><p>The <code class="literal">error</code> parameter can contain one of the following values that can be helpful to the client developer to diagnose the problem:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">invalid_request</code>: <a id="id133" class="indexterm"/>This value appears when there's a problem with the request, such as a missing parameter or value, a parameter included more than once, or a parameter with a malformed name.</li><li class="listitem" style="list-style-type: disc"><code class="literal">unauthorized_client</code>: <a id="id134" class="indexterm"/>This value appears when the client application was not authorized.</li><li class="listitem" style="list-style-type: disc"><code class="literal">access_denied</code>:<a id="id135" class="indexterm"/> This value appears when the end user (the resource owner) has denied the request.</li><li class="listitem" style="list-style-type: disc"><code class="literal">unsupported_response_type</code>: <a id="id136" class="indexterm"/>This value appears when the authorization server cannot support the requested response. If in the request the <code class="literal">response_type</code> parameter<a id="id137" class="indexterm"/> is set to <code class="literal">code</code>, this error won't happen.</li><li class="listitem" style="list-style-type: disc"><code class="literal">invalid_scope</code>: <a id="id138" class="indexterm"/>This value appears when the scope specified does not exist or is invalid.</li><li class="listitem" style="list-style-type: disc"><code class="literal">server_error</code>: <a id="id139" class="indexterm"/>This value appears when an unknown error happens and the server cannot process the response. Very similar to HTTP 500 errors in web pages.</li><li class="listitem" style="list-style-type: disc"><code class="literal">temporarily_unavailable</code>: <a id="id140" class="indexterm"/>This value <a id="id141" class="indexterm"/>appears when the authorization server cannot process the request at the given moment.</li></ul></div><p>Besides the <code class="literal">error</code> parameter, few other parameters can be part of the response as well, such as:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">error_description</code>:<a id="id142" class="indexterm"/> This is an optional parameter that may contain a message describing what the cause of the error was</li><li class="listitem" style="list-style-type: disc"><code class="literal">error_uri</code>: <a id="id143" class="indexterm"/>This is an optional parameter containing a URI to a web document that should contain an additional description of the error</li><li class="listitem" style="list-style-type: disc"><code class="literal">state</code>: This is<a id="id144" class="indexterm"/> a mandatory<a id="id145" class="indexterm"/> parameter that returns the exact value that was specified in the request with the<a id="id146" class="indexterm"/> same-named <code class="literal">state</code> parameter</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip10"/>Tip</h3><p>Proper handling of errors by the client application and friendly notifications to the end user are good development. The user will appreciate knowing what precisely is going on.</p></div></div></div></div><div class="section" title="Requesting the access token"><div class="titlepage"><div><div><h2 class="title"><a id="ch04lvl2sec23"/>Requesting the access token</h2></div></div></div><p>Once the client gets the authorization code, <a id="id147" class="indexterm"/>it can go on<a id="id148" class="indexterm"/> and request the access token. This is done between the client application and the server and requires no interaction from the end user.</p><div class="section" title="Making the request"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec04"/>Making the request</h3></div></div></div><p>As with the authorization request, first the client constructs the request address from the specified endpoint and the parameters, resulting in the following example:</p><p>
<code class="literal">https://api.example-service.com/oauth/access_token?grant_type=authorization_code&amp;code=AUTHORIZATION_CODE&amp;redirect_uri=REDIRECT_EXAMPLE&amp;client_id=ID_EXAMPLE</code>
</p><p>The request consists of<a id="id149" class="indexterm"/> the following parameters that are mandatory:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">grant_type</code>: <a id="id150" class="indexterm"/>This parameter's value must be set to <code class="literal">authorization_code</code>.</li><li class="listitem" style="list-style-type: disc"><code class="literal">code</code>: This<a id="id151" class="indexterm"/> is the authorization code previously retrieved from the authorization server.</li><li class="listitem" style="list-style-type: disc"><code class="literal">redirect_uri</code>: This is<a id="id152" class="indexterm"/> the parameter where the authorization server should redirect the client and supply the access token. Additionally, if this parameter was used in the step where the authorization code was requested from the client, the values of <code class="literal">redirect_uri</code> in the authorization code request and this one must be the same.</li><li class="listitem" style="list-style-type: disc"><code class="literal">client_id</code>: <a id="id153" class="indexterm"/>This parameter's value is set as per the data from the client registration with the authorization server, the same as in previous cases.</li></ul></div><p>With the URL address prepared, the client application executes it by making an HTTP POST request, and the authorization server makes the following important checks:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">That the client is valid and already registered</li><li class="listitem" style="list-style-type: disc">That the supplied authorization code is valid and not expired and belongs to the specified <code class="literal">client_id</code> parameter</li><li class="listitem" style="list-style-type: disc">That the <code class="literal">redirect_uri</code> callback is the same as the one specified when the client requested the <a id="id154" class="indexterm"/>authorization code</li></ul></div></div><div class="section" title="Successful response"><div class="titlepage"><div><div><h3 class="title"><a id="ch04lvl3sec05"/>Successful response</h3></div></div></div><p>If all the checks are valid on the<a id="id155" class="indexterm"/> side of the authorization server, an access token and optionally a refresh token are created and sent as a response to the HTTP POST request.</p><p>The response body would contain a JSON (or XML) object and it may have the following form:</p><div class="informalexample"><pre class="programlisting">{
  "access_token":"exampleAccessTokenValue123",
  "expires_in":3600,
  "refresh_token":"exampleRefreshTokenValue123",
  "token_type":"Bearer"
}</pre></div><p>The client application will have to <a id="id156" class="indexterm"/>process this response and store the values of the fields in a secure environment, especially <code class="literal">access_token</code> and <code class="literal">refresh_token</code>. After storing the data, the client can use it, for example by using <code class="literal">access_token</code> to authorize calls to some API methods in the service on behalf of the user.</p></div></div></div></div></body></html>
