<?xml version="1.0" encoding="utf-8" ?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Practical example</title><link rel="stylesheet" href="epub.css" type="text/css"/><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"/></head><body id="page"><div class="section" title="Practical example"><div class="titlepage"><div><div><h1 class="title"><a id="ch05lvl1sec25"/>Practical example</h1></div></div></div><p>Now that we covered <a id="id218" class="indexterm"/>the implicit grant in detail we can create a practical example.</p><p>We will make an example web application that will use Dropbox as its authorization server and will implement the implicit grant.</p><p>The example application consists of an HTML page with JavaScript and jQuery where all the logic is coded. When this page is served from the server to the browser, everything including the <code class="literal">client_id</code> parameter is exposed to the public.</p><p>When we open the root folder of the example application, the important file is the following:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">src\main\webapp\WEB-INF\pages\hello.jsp</code>: This contains the HTML template and the JavaScript logic</li></ul></div><p>Additionally, for added clarity we will check out the cURL statements of the same HTTP requests that are performed in Java. cURL is a popular command line tool that is used for transferring data over various protocols, and it is often used as an HTTP client.</p><p>We will make an authorization request against Dropbox, and once the user has authorized the request with the access token we will make one more request to the Dropbox API and get the name of the user and display it.</p><p>First thing we have to do is to register the client application on Dropbox. These steps are covered in <a class="link" href="ch03.html" title="Chapter&#xA0;3.&#xA0;First Step for Your Application">Chapter 3</a>, <span class="emphasis"><em>First Step for Your Application</em></span>. In the case of Dropbox, that can be done using the following URL:</p><p>
<a class="ulink" href="https://www.dropbox.com/developers/apps">https://www.dropbox.com/developers/apps</a>.</p><p>The body of the HTML page is as follows:</p><div class="informalexample"><pre class="programlisting">&lt;body&gt;
    &lt;p&gt;&lt;a id="init-auth" href=""&gt;Authorize&lt;/a&gt;&lt;/p&gt;
    &lt;p id="auth-token-message"&gt;Client is not authorized!&lt;/p&gt;
    &lt;p id="auth-user-p"&gt;
        Your Dropbox username is: &lt;span id="auth-user-message" &gt;..&lt;/span&gt;.
    &lt;/p&gt;
&lt;/body&gt;</pre></div><p>Here it's simple; we have three paragraph elements, as follows:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc">The first paragraph element has an anchor element with the <code class="literal">init-auth</code> id. This will be the button the end user presses to authorize a request to Dropbox. The <code class="literal">href</code> attribute<a id="id219" class="indexterm"/> will contain the URI with the appropriate parameters to make the request valid and this is assigned from the JavaScript code we'll see next.</li><li class="listitem" style="list-style-type: disc">In the second paragraph <a id="id220" class="indexterm"/>element, a message is shown that the user is not authenticated. When authorized, it will show the value of the access token.</li><li class="listitem" style="list-style-type: disc">And in the third paragraph element, when the user has authorized the request, it will show his name.</li></ul></div><p>Now let's take a look at the JavaScript code, which is embedded as part of the <code class="literal">head</code> tag.</p><p>The whole code is part of a function block:</p><div class="informalexample"><pre class="programlisting">$(function () {
    $("#auth-user-p").hide();</pre></div><p>And the paragraph that will show the authorized user is hidden with the jQuery <code class="literal">hide</code> function.</p><p>Next we define three variables:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><code class="literal">clientId</code>: <a id="id221" class="indexterm"/>This variable will contain the client ID acquired from the Dropbox registration</li><li class="listitem" style="list-style-type: disc"><code class="literal">AuthEndpoint</code>:<a id="id222" class="indexterm"/> This variable will be used as an authorization endpoint</li><li class="listitem" style="list-style-type: disc"><code class="literal">APIEndpoint</code>: <a id="id223" class="indexterm"/>This variable will be used to call methods from the Dropbox API after getting an access token<div class="informalexample"><pre class="programlisting">    var clientId = "CLIENT_ID";
    var AuthEndpoint = "https://www.dropbox.com/1/oauth2/authorize";
    var APIEndpoint = "https://api.dropbox.com";</pre></div></li></ul></div><p>Next in the <code class="literal">AuthenticationURL</code> variable<a id="id224" class="indexterm"/> the parameters are added to the authorization endpoint with the appropriate values, and with this we have constructed the URL for the request and added the jQuery's <code class="literal">attr</code> function<a id="id225" class="indexterm"/> to the <code class="literal">init-auth</code> link.</p><p>With this, when the user clicks on the <span class="strong"><strong>Authorize</strong></span> button<a id="id226" class="indexterm"/>, the flow will start.</p><div class="informalexample"><pre class="programlisting">    var AuthenticationURL = AuthEndpoint +
            "?response_type=token" +
            "&amp;client_id=" + clientId +
            "&amp;redirect_uri=" + window.location +
            "&amp;state=XXXYYYY";
    $("#init-auth").attr("href", AuthenticationURL);</pre></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="tip14"/>Tip</h3><p>The assigned <code class="literal">state</code> parameter in the request is set to "XXXYYYY". This serves just as an example; in real world scenarios a securely random value should be generated and used.</p></div></div><p>This URL endpoint that<a id="id227" class="indexterm"/> is requested when the user clicks on <span class="strong"><strong>Authorize</strong></span> has the following form, when represented as a CURL statement:</p><div class="informalexample"><pre class="programlisting">curl -d response_type=token \
  -d client_id=insertValue \
  -d redirect_uri=http://localhost:8090/ \
  -d state=XXXYYYY \
  https://www.dropbox.com/1/oauth2/authorize</pre></div><p>The next of the code checks whether the user has chosen whether to authorize the request or not (after Dropbox has redirected back to our client application), and uses the information from the response.</p><p>If the value in <code class="literal">document.location.hash</code> is not empty, that means that there is a response in the fragment section (the data after the hash character in the URL) and by making this check we know whether the page is loaded by a redirection.</p><div class="informalexample"><pre class="programlisting">    if (document.location.hash !== "") {</pre></div><p>If the check returns a true value, then this is a redirection with some data in the URL fragment. This means that we can proceed. We can extract the access token with a regular expression using the following code:</p><div class="informalexample"><pre class="programlisting">        var token = decodeURI(
            (RegExp('access_token=' + '(.+?)(&amp;|$)').exec(document.location.hash)||[,null])[1]
        );</pre></div><p>For the sake of not going off-topic, we will not dwell into the details of how the regular expression works.</p><p>Next we change the text in the paragraphs, letting the user know that the client application has returned from the authorization request.</p><div class="informalexample"><pre class="programlisting">        $('#init-auth').text("Authorize again");
        $('#auth-token-message').text("Your token is: " + token);</pre></div><p>And finally, with the use of the access token, we make an AJAX request with the help of jQuery and ask Dropbox's API to give us the user information on behalf of the user, whose access token we have obtained.</p><p>Notice how we use <code class="literal">xhr.setRequestHeader</code> to put in an authorization header and use the token as its value.<a id="id228" class="indexterm"/> Without this, the Dropbox server will not know who is making the request and we will not be able to get the data from the API.</p><p>When the request is finished, we get a response showing who the user is on the page.</p><div class="informalexample"><pre class="programlisting">        $.ajax({
            url: APIEndpoint + '/1/account/info',
            beforeSend: function (xhr) {
                xhr.setRequestHeader('Authorization',"Bearer " + token);
                xhr.setRequestHeader('Accept', "application/json");
            },
            success: function (response) {
                $('#auth-user-p').show();
                if (response) {
                    $("#auth-user-message").text(response.display_name);
                } else {
                    $('#auth-user-p').text("An error occurred!");
                }
            }
        });
    }
});</pre></div><p>In the end, after a successful authorization and redirection back to the client application, the client application may look <a id="id229" class="indexterm"/>like the following screenshot:</p><div class="mediaobject"><img src="graphics/5594_01.jpg" alt="Practical example"/></div></div></body></html>
