<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>Starting the Books API</title><link href="springer_epub.css" type="text/css" rel="styleSheet"/></head><body><div class="ChapterContextInformation"><div class="ContextInformation" id="b978-1-4842-2187-7_4"><div class="ChapterCopyright">© Paul Redmond 2016</div><span class="ContextInformationAuthorEditorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span></span></span><span class="ContextInformationBookTitles"><span class="BookTitle" xml:lang="en">Lumen Programming Guide</span></span><span class="ChapterDOI">10.1007/978-1-4842-2187-7_4</span></div></div><!--Begin Abstract--><div class="MainTitleSection"><h1 class="ChapterTitle" xml:lang="en">4. Starting the Books API</h1></div><div class="AuthorGroup"><div class="AuthorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span><sup>1 <span class="ContactIcon"/></sup></span></div><div class="Affiliations"><div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">Phoenix, Arizona, USA</div></div><div class="ClearBoth"> </div></div></div><!--End Abstract--><div class="Fulltext"><div id="Par1" class="Para">In this chapter, we will focus on writing our first API resource: <span class="EmphasisFontCategoryNonProportional">/books</span>. We will take this in small chunks and test it as we go. At the end of the next few chapters we will have a fully-tested <span class="EmphasisFontCategoryNonProportional">/books</span> resource doing basic CRUD operations. The <span class="EmphasisFontCategoryNonProportional">/books</span> resource will look like this:</div><div id="Par2" class="Para ParaOneEmphasisChild">
          <span class="EmphasisTypeItalic">Basic REST /books Resource</span>
        </div><div id="Par3" class="Para">
          <div class="ProgramCode" id="PC1"><div class="FixedLine">GET /books Get all the books</div><div class="FixedLine">POST /books Create a new book</div><div class="FixedLine">GET /books/{id} Get a book</div><div class="FixedLine">PUT /books/{id} Update a book</div><div class="FixedLine">DELETE /books/{id} Delete a book</div></div>
        </div><div id="Sec1" class="Section1 RenderAsSection1"><h2 class="Heading">Creating the First Endpoint</h2><div id="Par4" class="Para ParaOneEmphasisChild">The first order of business to create a <span class="EmphasisFontCategoryNonProportional">BooksControllerTest</span> class and write your first failing test. You will then write the minimum amount of code required to get the test to pass. When you get back to green, you are free to refactor or add another feature.</div><div id="Par5" class="Para">I prefer my test’s namespace to be organized under the same namespace as the application namespace. In our case, the controller namespace will be <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">App\Http\Controllers</span></span> and the tests for controllers will go under <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Tests\App\Http\Controllers</span></span>. So let’s write some code! See Listing <span class="InternalRef"><a href="#Par6">4-1</a></span>.</div><div id="Par6" class="Para">
            <div class="ProgramCode" id="PC2"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ mkdir -p tests/app/Http/Controllers</div><div class="FixedLine">$ git mv tests/ExampleTest.php tests/app/Http/Controllers/BooksControllerTest.php</div><div class="FixedLine">$ touch app/Http/Controllers/BooksController.php</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-1.</span><div class="SimplePara">Creating Your Test and Controller</div></div></div></div>
          </div><div id="Par7" class="Para">In Listing <span class="InternalRef"><a href="#Par6">4-1</a></span>, you rename the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">ExampleTest.php</span></span> file as the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">BooksControllerTest.php</span></span> with git since you don’t want a fake example test. Feel free to create files however you want, but I will do it from the command line throughout the book for maximum portability.</div><div id="Par8" class="Para">Now you’ll write and execute your first failing test for the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">GET /books</span></span> route. Note the “use TestCase” import because you are namespacing your tests (Listing <span class="InternalRef"><a href="#Par9">4-2</a></span>). You could also reference it with <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">extends \TestCase</span></span> and skip the <span class="EmphasisFontCategoryNonProportional">use</span> statement.</div><div id="Par9" class="Para">
            <div class="ProgramCode" id="PC3"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine"> 6  </div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">class BooksControllerTest extends</span> TestCase</div><div class="FixedLine"> 8  {</div><div class="FixedLine"> 9      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">10      <span class="EmphasisTypeBold">public function</span> index_status_code_should_be_200()</div><div class="FixedLine">11      {</div><div class="FixedLine">12          $this-&gt;get('/books')-&gt;seeStatusCode(200);</div><div class="FixedLine">13      }</div><div class="FixedLine">14  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-2.</span><div class="SimplePara">The BooksControllerTest.php File</div></div></div></div>
          </div><div id="Par10" class="Para">Your test makes a request to the <span class="EmphasisFontCategoryNonProportional">/books</span> route and then expects to see a <span class="EmphasisFontCategoryNonProportional">200</span> status code. The <span class="EmphasisFontCategoryNonProportional">visit</span> and <span class="EmphasisFontCategoryNonProportional">seeStatusCode</span> methods are provided by the <span class="EmphasisFontCategoryNonProportional">Laravel\Lumen\Testing\CrawlerTrait</span> trait. You will become more familiar with the methods the <span class="EmphasisFontCategoryNonProportional">CrawlerTrait</span> provides as we work through the book.</div><div id="Par11" class="Para">Now run the test you just created and see what happens (Listing <span class="InternalRef"><a href="#Par12">4-3</a></span>).</div><div id="Par12" class="Para">
            <div class="ProgramCode" id="PC4"><div class="FixedLine">vagrant@homestead:∼/Code/bookr$ phpunit</div><div class="FixedLine">F</div><div class="FixedLine">...</div><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 1, Assertions: 1, Failures: 1.</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-3.</span><div class="SimplePara">Failing the Test</div></div></div></div>
          </div><div id="Par13" class="Para">I have omitted a stack trace, but basically your failing test received a <span class="EmphasisFontCategoryNonProportional">404</span> status code. Now, it’s time to make our test pass, but you only write the least amount of code to get your test to passing and nothing more. You created the <span class="EmphasisFontCategoryNonProportional">BooksController</span> file earlier in the chapter, so now add the code in Listing <span class="InternalRef"><a href="#Par14">4-4</a></span>.</div><div id="Par14" class="Para">
            <div class="ProgramCode" id="PC5"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 6   <span class="EmphasisTypeItalic">* Class BooksController</span>
          </div><div class="FixedLine"> 7   <span class="EmphasisTypeItalic">* @package App\Http\Controllers</span>
          </div><div class="FixedLine"> 8   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine"> 9  <span class="EmphasisTypeBold">class BooksController</span>
          </div><div class="FixedLine">10  {</div><div class="FixedLine">11      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">12       <span class="EmphasisTypeItalic">* GET /books</span>
          </div><div class="FixedLine">13       <span class="EmphasisTypeItalic">* @return array</span>
          </div><div class="FixedLine">14       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">15      <span class="EmphasisTypeBold">public function</span> index()</div><div class="FixedLine">16      {</div><div class="FixedLine">17          <span class="EmphasisTypeBold">return</span> [];</div><div class="FixedLine">18      }</div><div class="FixedLine">19  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-4.</span><div class="SimplePara">The BooksController.php Class</div></div></div></div>
          </div><div id="Par15" class="Para">You define an <span class="EmphasisFontCategoryNonProportional">index</span> method and return an empty array. You still haven’t defined a route for your <span class="EmphasisFontCategoryNonProportional">GET /books</span> endpoint, which you’ll add below the default route in <span class="EmphasisFontCategoryNonProportional">app/Http/routes.php</span>, as shown in Listing <span class="InternalRef"><a href="#Par16">4-5</a></span>.</div><div id="Par16" class="Para">
            <div class="ProgramCode" id="PC6"><div class="FixedLine">14  $app-&gt;get('/', <span class="EmphasisTypeBold">function</span> () <span class="EmphasisTypeBold">use</span> ($app) {</div><div class="FixedLine">15      <span class="EmphasisTypeBold">return</span> $app-&gt;version();</div><div class="FixedLine">16  });</div><div class="FixedLine">17</div><div class="FixedLine">18  $app-&gt;get('/books', 'BooksController@index');</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-5.</span><div class="SimplePara">Adding the BooksController@index Route</div></div></div></div>
          </div><div id="Par17" class="Para">This is the first time using a controller for the second argument of a route definition. Lumen assumes the namespace of a controller to be <span class="EmphasisFontCategoryNonProportional">App\Http\Controllers</span>, and the second argument is in this format: <span class="EmphasisFontCategoryNonProportional">&lt;controller_name&gt;@&lt;method&gt;</span>. The <span class="EmphasisFontCategoryNonProportional">BooksController@index</span> string passed to your route references the public index method of the <span class="EmphasisFontCategoryNonProportional">BooksController</span>. With the controller and route in place, your test should pass now (Listing <span class="InternalRef"><a href="#Par18">4-6</a></span>).</div><div id="Par18" class="Para">
            <div class="ProgramCode" id="PC7"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 1 assertion)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-6.</span><div class="SimplePara">Passing the Test</div></div></div></div>
          </div><div id="Par19" class="Para">Now that your tests are back to green you are ready to add more features. We know this endpoint will return a collection of books, so you will write a test for that (Listing <span class="InternalRef"><a href="#Par20">4-7</a></span>).</div><div id="Par20" class="Para">
            <div class="ProgramCode" id="PC8"><div class="FixedLine">15  /** @test **/</div><div class="FixedLine">16  <span class="EmphasisTypeBold">public function</span> index_should_return_a_collection_of_records()</div><div class="FixedLine">17  {</div><div class="FixedLine">18      $this</div><div class="FixedLine">19          -&gt;get('/books')</div><div class="FixedLine">20          -&gt;seeJson([</div><div class="FixedLine">21              'title' =&gt; 'War of the Worlds'</div><div class="FixedLine">22          ])</div><div class="FixedLine">23          -&gt;seeJson([</div><div class="FixedLine">24              'title' =&gt; 'A Wrinkle in Time'</div><div class="FixedLine">25          ]);</div><div class="FixedLine">26  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-7.</span><div class="SimplePara">Testing the JSON Response</div></div></div></div>
          </div><div id="Par21" class="Para">The test introduces the <span class="EmphasisFontCategoryNonProportional">seeJson()</span> method, which converts the passed array into JSON and assures that the JSON occurs somewhere within the response. I encourage you to read the official Lumen documentation on <span class="ExternalRef"><a href="http://lumen.laravel.com/docs/testing"><span class="RefSource">testing</span></a></span> (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/testing"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/testing</span>
              </span></a></span>). The “<span class="ExternalRef"><a href="http://lumen.laravel.com/docs/testing#testing-json-apis"><span class="RefSource">Testing JSON APIs</span></a></span>” (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/testing#testing-json-apis"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/testing#testing-json-apis</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> section has information on testing JSON responses.</div><div id="Par22" class="Para">As you would expect, if you run the tests, you will see failures. A failed test means you are ready to write implementation code. To reiterate, you will write the smallest amount of code to get tests passing again (Listing <span class="InternalRef"><a href="#Par23">4-8</a></span>).</div><div id="Par23" class="Para">
            <div class="ProgramCode" id="PC9"><div class="FixedLine">11  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">12   <span class="EmphasisTypeItalic">* GET /books</span>
          </div><div class="FixedLine">13   <span class="EmphasisTypeItalic">* @return array</span>
          </div><div class="FixedLine">14   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">15  <span class="EmphasisTypeBold">public function</span> index()</div><div class="FixedLine">16  {</div><div class="FixedLine">17      <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">18          ['title' =&gt; 'War of the Worlds'],</div><div class="FixedLine">19          ['title' =&gt; 'A Wrinkle in Time']</div><div class="FixedLine">20      ];</div><div class="FixedLine">21  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-8.</span><div class="SimplePara">Returning a Collection of Books</div></div></div></div>
          </div><div id="Par24" class="Para">After adding the controller code, tests should be back to green (Listing <span class="InternalRef"><a href="#Par25">4-9</a></span>)!</div><div id="Par25" class="Para">
            <div class="ProgramCode" id="PC10"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (2 tests, 3 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-9.</span><div class="SimplePara">Passing Test for a Collection of Books</div></div></div></div>
          </div><div id="Par26" class="Para ParaTypeImportant">
        <img src="A395120_1_En_4_Figa_HTML.jpg" alt="A395120_1_En_4_Figa_HTML.jpg"/> Git commit: Add /books Index Route</div><div id="Par27" class="Para ParaTypeImportant">e21bf99 (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/e21bf99"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/e21bf99</span>
              </span></a></span>)</div><div id="Par28" class="Para">Now that you have passing tests, you are free to refactor the code and continue to ensure the tests still pass. With that in mind, it seems like a good time to introduce some real data from the database.</div></div><div id="Sec2" class="Section1 RenderAsSection1"><h2 class="Heading">Setting Up Models and Seed Data</h2><div id="Par29" class="Para">Our book API is not very useful right now without dynamic data, but we have a good testing foundation to make sure we can iterate and verify that our tests still pass. You can lean on your tests while you convert your controller to use a database. Lumen has some great features that make working with databases very pleasant!</div><div id="Par30" class="Para ParaOneEmphasisChild">Your first order of business is to define a <span class="EmphasisFontCategoryNonProportional">Book</span> model. What should that look like? What columns should you include? You could flesh out the entire data structure up front, but database migrations make it really easy to iterate on the database schema. For now, your schema will be very simple.</div><div id="Par31" class="Para ParaTypeImportant">
        <img src="A395120_1_En_4_Figb_HTML.jpg" alt="A395120_1_En_4_Figb_HTML.jpg"/> I encourage you to spend some time thinking about your database structure in the beginning. Aim for a mix of defining good structure up front without it paralyzing you from getting started on writing code.</div><div id="Par32" class="Para ParaTypeImportant">Migrations allow you to iterate on the schema, but making good data decisions early can save you some headaches.</div><div id="Par33" class="Para">You will start by creating a database migration with the artisan console (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/artisan"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/artisan</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> for the books resource (Listing <span class="InternalRef"><a href="#Par34">4-10</a></span>).</div><div id="Par34" class="Para">
            <div class="ProgramCode" id="PC11"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan make:migration create_books_table --create=books</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-10.</span><div class="SimplePara">The Books Database Migration</div></div></div></div>
          </div><div id="Par35" class="Para">The <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">make:migration</span></span> command knows you intend to create a new database table from the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">--create</span></span> flag. Your filename date will differ from my example, but will end with the same <span class="EmphasisFontCategoryNonProportional">create_books_table.php</span> file suffix.</div><div id="FPar1" class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant"><div class="Heading">
          <img src="A395120_1_En_4_Figc_HTML.jpg" alt="A395120_1_En_4_Figc_HTML.jpg"/> Migrations</div><div id="Par36" class="Para">Database migrations (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/migrations"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/migrations</span>
                </span></a></span>) are covered in great detail in the Laravel documentation. The Laravel migration documentation applies to Lumen.</div></div><div id="Par37" class="Para">In the generated migration you will see two methods: <span class="EmphasisFontCategoryNonProportional">up()</span> and <span class="EmphasisFontCategoryNonProportional">down()</span>. The <span class="EmphasisFontCategoryNonProportional">up()</span> method will be used to apply the migration and the <span class="EmphasisFontCategoryNonProportional">down()</span> method will roll back the migration. The <span class="EmphasisFontCategoryNonProportional">artisan</span> command takes care of <span class="EmphasisFontCategoryNonProportional">down</span> for you automatically because of the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">--create</span></span> flag, so let’s finish writing the <span class="EmphasisFontCategoryNonProportional">up</span> method (Listing <span class="InternalRef"><a href="#Par38">4-11</a></span>).</div><div id="Par38" class="Para">
            <div class="ProgramCode" id="PC12"><div class="FixedLine"> 8  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 9   <span class="EmphasisTypeItalic">* Run the migrations.</span>
          </div><div class="FixedLine">10   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">11   <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">12   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">13  <span class="EmphasisTypeBold">public function</span> up()</div><div class="FixedLine">14  {</div><div class="FixedLine">15      Schema::create('books', <span class="EmphasisTypeBold">function</span> (Blueprint $table) {</div><div class="FixedLine">16          $table-&gt;increments('id');</div><div class="FixedLine">17          $table-&gt;string('title');</div><div class="FixedLine">18          $table-&gt;text('description');</div><div class="FixedLine">19          $table-&gt;string('author');</div><div class="FixedLine">20          $table-&gt;timestamps();</div><div class="FixedLine">21      });</div><div class="FixedLine">22  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-11.</span><div class="SimplePara">The Books Table Migration</div></div></div></div>
          </div><div id="Par39" class="Para">The migration is very readable and simple. Take note of <span class="EmphasisFontCategoryNonProportional">$table-&gt;timestamps()</span>, which will create two datetime columns: <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">created_at</span></span> and <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">updated_at</span></span>. Eloquent will also populate the timestamp columns for you automatically when you create and update records.</div><div id="Par40" class="Para">Now that you have the migration ready, let’s run it (Listing <span class="InternalRef"><a href="#Par41">4-12</a></span>).</div><div id="Par41" class="Para">
            <div class="ProgramCode" id="PC13"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan migrate</div><div class="FixedLine">Migrated: 2016_07_28_232137_create_books_table</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-12.</span><div class="SimplePara">Running Your First Database Migration</div></div></div></div>
          </div><div id="Par42" class="Para">It seems to have worked! Check the database to be sure (Table <span class="InternalRef"><a href="#Tab1">4-1</a></span>).<div id="Tab1" class="Table"><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Table 4-1.</span><div class="SimplePara">The Books Table Structure</div></div></div><table border="1"><colgroup><col/><col/><col/><col/></colgroup><thead><tr class="header"><th><div class="SimplePara">Field</div></th><th><div class="SimplePara">Type</div></th><th><div class="SimplePara">Key</div></th><th><div class="SimplePara">Default</div></th></tr></thead><tbody><tr class="noclass"><td><div class="SimplePara">id</div></td><td><div class="SimplePara">int(10) unsigned</div></td><td><div class="SimplePara">PRI</div></td><td><div class="SimplePara">NULL</div></td></tr><tr class="noclass"><td><div class="SimplePara">title</div></td><td><div class="SimplePara">varchar(255)</div></td><td> </td><td><div class="SimplePara">NULL</div></td></tr><tr class="noclass"><td><div class="SimplePara">description</div></td><td><div class="SimplePara">Text</div></td><td> </td><td><div class="SimplePara">NULL</div></td></tr><tr class="noclass"><td><div class="SimplePara">author</div></td><td><div class="SimplePara">varchar(255)</div></td><td> </td><td><div class="SimplePara">NULL</div></td></tr><tr class="noclass"><td><div class="SimplePara">created_at</div></td><td><div class="SimplePara">Timestamp</div></td><td> </td><td><div class="SimplePara">0000-00-00 00:00:00</div></td></tr><tr class="noclass"><td><div class="SimplePara">updated_at</div></td><td><div class="SimplePara">Timestamp</div></td><td> </td><td><div class="SimplePara">0000-00-00 00:00:00</div></td></tr></tbody></table></div>
      </div><div id="Par43" class="Para">
            <div class="ProgramCode" id="PC14"><div class="FixedLine">mysql&gt; use bookr;</div><div class="FixedLine">mysql&gt; show columns from books;</div></div>
          </div><div id="Par44" class="Para ParaOneEmphasisChild">Success! Now that you have a working database migration, you are going to need some data. How should we get data into the development database? We could version a SQL script that we execute when setting up an environment; we could connect to the database and add some rows by hand. At this point, either would be fine, but it will get clunky fast. Real fast. Fortunately (and not surprisingly) Lumen provides a better way with <span class="EmphasisTypeBold">database seeding</span>.</div><div id="Par45" class="Para">The database seeding files are located in the <span class="EmphasisFontCategoryNonProportional">database/seeds</span> folder—specifically the <span class="EmphasisFontCategoryNonProportional">DatabaseSeeder.php</span> file. Listing <span class="InternalRef"><a href="#Par46">4-13</a></span> shows what the stock <span class="EmphasisFontCategoryNonProportional">DatabaseSeeder</span> class looks like.</div><div id="Par46" class="Para">
            <div class="ProgramCode" id="PC15"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2  </div><div class="FixedLine"> 3  use Illuminate\Database\Seeder;</div><div class="FixedLine"> 4  </div><div class="FixedLine"> 5  class DatabaseSeeder extends Seeder</div><div class="FixedLine"> 6  {</div><div class="FixedLine"> 7      /**</div><div class="FixedLine"> 8       * Run the database seeds.</div><div class="FixedLine"> 9       *</div><div class="FixedLine">10       * @return void</div><div class="FixedLine">11       */</div><div class="FixedLine">12      public function run()</div><div class="FixedLine">13      {</div><div class="FixedLine">14          // $this-&gt;call('UserTableSeeder');</div><div class="FixedLine">15      }</div><div class="FixedLine">16  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-13.</span><div class="SimplePara">The Default Seeder Class</div></div></div></div>
          </div><div id="Par47" class="Para">Line #14 is an example of how the <span class="EmphasisFontCategoryNonProportional">DatabaseSeeder</span> can call other seeder classes to keep things tidy. Based on the <span class="EmphasisFontCategoryNonProportional">DatabaseSeeder</span> example, it makes sense to make a seeder class for the <span class="EmphasisFontCategoryNonProportional">books</span> table. Create the file <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">database/seeds/BooksTableSeeder.php</span></span> and call it from the <span class="EmphasisFontCategoryNonProportional">DatabaseSeeder</span> class. Once you create the seeder, you can use it to populate your development database with the <span class="EmphasisFontCategoryNonProportional">artisan db:seed</span> command (Listing <span class="InternalRef"><a href="#Par48">4-14</a></span>).</div><div id="Par48" class="Para">
            <div class="ProgramCode" id="PC16"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">use</span> Carbon\Carbon;</div><div class="FixedLine"> 4  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Seeder;</div><div class="FixedLine"> 5</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">class BooksTableSeeder extends</span> Seeder</div><div class="FixedLine"> 7  {</div><div class="FixedLine"> 8      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 9       <span class="EmphasisTypeItalic">* Run the database seeds.</span>
          </div><div class="FixedLine">10       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">11       <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">12       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">13      <span class="EmphasisTypeBold">public function</span> run()</div><div class="FixedLine">14      {</div><div class="FixedLine">15          DB::table('books')-&gt;insert([</div><div class="FixedLine">16              'title' =&gt; 'War of the Worlds',</div><div class="FixedLine">17              'description' =&gt; 'A science fiction masterpiece about Martians invading London',</div><div class="FixedLine">18              'author' =&gt; 'H. G. Wells',</div><div class="FixedLine">19              'created_at' =&gt; Carbon::now(),</div><div class="FixedLine">20              'updated_at' =&gt; Carbon::now(),</div><div class="FixedLine">21          ]);</div><div class="FixedLine">22</div><div class="FixedLine">23          DB::table('books')-&gt;insert([</div><div class="FixedLine">24              'title' =&gt; 'A Wrinkle in Time',</div><div class="FixedLine">25              'description' =&gt; 'A young girl goes on a mission to save her father who has gone missing after working on a mysterious project called a tesseract.',</div><div class="FixedLine">26              'author' =&gt; 'Madeleine L\'Engle',</div><div class="FixedLine">27              'created_at' =&gt; Carbon::now(),</div><div class="FixedLine">28              'updated_at' =&gt; Carbon::now()</div><div class="FixedLine">29          ]);</div><div class="FixedLine">30      }</div><div class="FixedLine">31  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-14.</span><div class="SimplePara">The BooksTableSeeder</div></div></div></div>
          </div><div id="Par49" class="Para">The <span class="EmphasisFontCategoryNonProportional">DB::table()</span> method returns an instance of the <span class="EmphasisFontCategoryNonProportional">\Illuminate\Database\Query\Builder</span> class, which has an <span class="EmphasisFontCategoryNonProportional">insert</span> method to insert a record to the database. The <span class="EmphasisFontCategoryNonProportional">Builder::insert()</span> method accepts an associative array of data. The code also introduces the Carbon (<span class="ExternalRef"><a href="http://carbon.nesbot.com/"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">http://carbon.nesbot.com/</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> library, a standalone library for working with PHP’s <span class="EmphasisFontCategoryNonProportional">DateTime</span>.</div><div id="Par50" class="Para">To use the book seeder, you need to call the <span class="EmphasisFontCategoryNonProportional">BooksTableSeeder</span> within the <span class="EmphasisFontCategoryNonProportional">database/seeds/DatabaseSeeder.php</span> class (Listing <span class="InternalRef"><a href="#Par51">4-15</a></span>).</div><div id="Par51" class="Para">
            <div class="ProgramCode" id="PC17"><div class="FixedLine">12  <span class="EmphasisTypeBold">public function</span> run()</div><div class="FixedLine">13  {</div><div class="FixedLine">14      <span class="EmphasisTypeItalic">// $this-&gt;call('UserTableSeeder');</span>
          </div><div class="FixedLine">15      $this-&gt;call(BooksTableSeeder::class);</div><div class="FixedLine">16  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-15.</span><div class="SimplePara">Calling the BooksTableSeeder in the DatabaseSeeder Class</div></div></div></div>
          </div><div id="Par52" class="Para">You are now ready to seed the database with artisan. Since you created a new seeder class, you need to dump the composer autoloader. The database classes are autoloaded through composer’s class <span class="ExternalRef"><a href="https://getcomposer.org/doc/04-schema.md#classmap"><span class="RefSource">map</span></a></span> (<span class="ExternalRef"><a href="https://getcomposer.org/doc/04-schema.md#classmap"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://getcomposer.org/doc/04-schema.md#classmap</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> setting, so each new seeder requires running the <span class="EmphasisFontCategoryNonProportional">dump-autoload</span> command (Listing <span class="InternalRef"><a href="#Par53">4-16</a></span>).</div><div id="Par53" class="Para">
            <div class="ProgramCode" id="PC18"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ composer dump-autoload</div><div class="FixedLine">Generating autoload files</div></div><div class="LineGroup"><div class="FixedLine">$ php artisan migrate:refresh</div><div class="FixedLine">Rolled back: 2015_10_17_075310_create_books_table</div><div class="FixedLine">Migrated: 2015_10_17_075310_create_books_table</div></div><div class="LineGroup"><div class="FixedLine">$ php artisan db:seed</div><div class="FixedLine">Seeded: BooksTableSeeder</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-16.</span><div class="SimplePara">Refreshing the Schema and Seeding the Database</div></div></div></div>
          </div><div id="Par54" class="Para">I introduced a new <span class="EmphasisFontCategoryNonProportional">artisan</span> command called <span class="EmphasisFontCategoryNonProportional">migrate:refresh,</span> which will reset and rerun all migrations. The <span class="EmphasisFontCategoryNonProportional">db:seed</span> command populates the <span class="EmphasisFontCategoryNonProportional">bookr</span> database with the seed data you just defined.</div><div id="FPar2" class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant"><div class="Heading">
          <img src="A395120_1_En_4_Figd_HTML.jpg" alt="A395120_1_En_4_Figd_HTML.jpg"/> Artisan</div><div id="Par55" class="Para">To get an overview of what each <span class="EmphasisFontCategoryNonProportional">artisan</span> command does, run <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">php artisan</span></span> to get a list of commands and a short description. You can even write your own commands.</div></div><div id="Par56" class="Para">Database migrations, database seeding, and Eloquent are the great features that set Lumen apart from other PHP micro-frameworks, in my opinion. Lumen is lightweight, but it offers features to help developer productivity that are not out of reach or difficult to enable.</div></div><div id="Sec3" class="Section1 RenderAsSection1"><h2 class="Heading">Eloquent Books</h2><div id="Par57" class="Para">Now that the <span class="EmphasisFontCategoryNonProportional">books</span> table has data, let’s define a model representing the <span class="EmphasisFontCategoryNonProportional">books</span> table that you can use to query the database. Lumen (like Laravel) has access to Eloquent ORM, which is a fantastic ActiveRecord implementation for querying data and inserting/updating data.</div><div id="Par58" class="Para ParaOneEmphasisChild">Lumen does not ship with an <span class="EmphasisFontCategoryNonProportional">artisan</span> command for creating models, but creating one is not hard:</div><div id="Par59" class="Para">
            <div class="ProgramCode" id="PC19"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ touch app/Book.php</div></div>
          </div><div id="Par60" class="Para">The model is really simple at the moment (Listing <span class="InternalRef"><a href="#Par61">4-17</a></span>).</div><div id="Par61" class="Para">
            <div class="ProgramCode" id="PC20"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Eloquent\Model;</div><div class="FixedLine"> 6</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">class Book extends</span> Model</div><div class="FixedLine"> 8  {</div><div class="FixedLine"> 9</div><div class="FixedLine">10  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-17.</span><div class="SimplePara">The Book Eloquent Model</div></div></div></div>
          </div><div id="Par62" class="Para">With the seeded data and <span class="EmphasisFontCategoryNonProportional">Book</span> model in hand, you are ready to wrap up the refactored <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">BooksController@index</span></span> route (Listing <span class="InternalRef"><a href="#Par63">4-18</a></span>).</div><div id="Par63" class="Para">
            <div class="ProgramCode" id="PC21"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> App\Book;</div><div class="FixedLine"> 6</div><div class="FixedLine"> 7  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 8   <span class="EmphasisTypeItalic">* Class BooksController</span>
          </div><div class="FixedLine"> 9   <span class="EmphasisTypeItalic">* @package App\Http\Controllers</span>
          </div><div class="FixedLine">10   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">11  <span class="EmphasisTypeBold">class BooksController</span>
          </div><div class="FixedLine">12  {</div><div class="FixedLine">13      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">14       <span class="EmphasisTypeItalic">* GET /books</span>
          </div><div class="FixedLine">15       <span class="EmphasisTypeItalic">* @return array</span>
          </div><div class="FixedLine">16       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">17      <span class="EmphasisTypeBold">public function</span> index()</div><div class="FixedLine">18      {</div><div class="FixedLine">19          <span class="EmphasisTypeBold">return</span> Book::all();</div><div class="FixedLine">20      }</div><div class="FixedLine">21  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-18.</span><div class="SimplePara">Putting the Book Model to Work</div></div></div></div>
          </div><div id="Par64" class="Para">Now it’s time to run the test suite to see if your refactor broke anything:</div><div id="Par65" class="Para">
            <div class="ProgramCode" id="PC22"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (2 tests, 3 assertions)</div></div></div>
          </div><div id="Par66" class="Para">The refactor was simple and passed the first time. Sometimes refactors will lead to broken tests, which we will see later in this book. The goal of refactoring is that we start refactoring while tests are green, and then when we are done refactoring we should still be at green.</div><div id="Par67" class="Para">If you make a request to <span class="ExternalRef"><a href="http://bookr.app/books"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">http://bookr.app/books</span>
              </span></a></span>, you should something resembling the response in Listing <span class="InternalRef"><a href="#Par68">4-19</a></span>.</div><div id="Par68" class="Para">
            <div class="ProgramCode" id="PC23"><div class="FixedLine">[</div><div class="FixedLine">    {</div><div class="FixedLine">        <span class="EmphasisTypeBold">"id"</span>:1,</div><div class="FixedLine">        <span class="EmphasisTypeBold">"title"</span>:"War of the Worlds",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"description"</span>:"A science fiction masterpiece about Martians invading London",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"author"</span>:"H. G. Wells",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"created_at"</span>:"2015-12-30 03:11:40",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"updated_at"</span>:"2015-12-30 03:11:40"</div><div class="FixedLine">    },</div><div class="FixedLine">    {</div><div class="FixedLine">        <span class="EmphasisTypeBold">"id"</span>:2,</div><div class="FixedLine">        <span class="EmphasisTypeBold">"title"</span>:"A Wrinkle in Time",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"description"</span>:"A young girl goes on a mission to save her father who has gone missing after working on a mysterious project called a tesseract.",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"author"</span>:"Madeleine L'Engle",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"created_at"</span>:"2015-12-30 03:11:40",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"updated_at"</span>:"2015-12-30 03:11:40"</div><div class="FixedLine">    }</div><div class="FixedLine">]</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 4-19.</span><div class="SimplePara">Example Response from /books</div></div></div></div>
          </div></div><div id="Sec4" class="Section1 RenderAsSection1"><h2 class="Heading">Success</h2><div id="Par69" class="Para ParaOneEmphasisChild">Boom! We’ve successfully refactored the BooksController to use a database and an Eloquent model. We will see plenty more examples of models throughout the book. Now we can move on to the rest of the <span class="EmphasisFontCategoryNonProportional">/books</span> endpoints. See you in the next chapter.</div><div id="Par70" class="Para ParaTypeImportant">
        <img src="A395120_1_En_4_Fige_HTML.jpg" alt="A395120_1_En_4_Fige_HTML.jpg"/> Git commit: Create books Table and BooksController</div><div id="Par71" class="Para ParaTypeImportant">729dff4 (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/729dff4"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/729dff4</span>
              </span></a></span>)</div></div></div></body></html>
