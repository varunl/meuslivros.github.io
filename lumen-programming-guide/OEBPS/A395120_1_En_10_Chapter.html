<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>The /authors API Resource</title><link href="springer_epub.css" type="text/css" rel="styleSheet"/></head><body><div class="ChapterContextInformation"><div class="ContextInformation" id="b978-1-4842-2187-7_10"><div class="ChapterCopyright">© Paul Redmond 2016</div><span class="ContextInformationAuthorEditorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span></span></span><span class="ContextInformationBookTitles"><span class="BookTitle" xml:lang="en">Lumen Programming Guide</span></span><span class="ChapterDOI">10.1007/978-1-4842-2187-7_10</span></div></div><!--Begin Abstract--><div class="MainTitleSection"><h1 class="ChapterTitle" xml:lang="en">10. The /authors API Resource</h1></div><div class="AuthorGroup"><div class="AuthorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span><sup>1 <span class="ContactIcon"/></sup></span></div><div class="Affiliations"><div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">Phoenix, Arizona, USA</div></div><div class="ClearBoth"> </div></div></div><!--End Abstract--><div class="Fulltext"><div id="Par1" class="Para">In this chapter, you are going to build on the last chapter’s introduction to the <span class="EmphasisFontCategoryNonProportional">authors</span> table. You will start working on API endpoints for your dedicated <span class="EmphasisFontCategoryNonProportional">Author</span> resource! At this point, you should be familiar with the basics of defining routes and working with controllers. Reference Chapter <span class="ExternalRef"><a href="A395120_1_En_4_Chapter.html"><span class="RefSource">4</span></a></span> and Chapter <span class="ExternalRef"><a href="A395120_1_En_5_Chapter.html"><span class="RefSource">5</span></a></span> to get a refresher as needed.</div><div id="Par2" class="Para">The author endpoint will provide API endpoints for getting author details and the books they’ve authored. Along the way I will show you a really cool feature of Fractal that allows you to include associated transformer data in a response; this means you can easily include book data in author responses if desired.</div><div id="Par3" class="Para">Your basic API endpoints will look like Listing <span class="InternalRef"><a href="#Par4">10-1</a></span>.</div><div id="Par4" class="Para">
          <div class="ProgramCode" id="PC1"><div class="FixedLine">GET    /authors       Get all the authors</div><div class="FixedLine">POST   /authors       Create a <span class="EmphasisTypeBold">new</span> author</div><div class="FixedLine">GET    /authors/{id}  Get an author’s details</div><div class="FixedLine">PUT    /authors/{id}  Update an author</div><div class="FixedLine">DELETE /authors/{id}  Delete an author</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-1.</span><div class="SimplePara">Basic REST /authors Resource</div></div></div></div>
        </div><div id="Par5" class="Para">Before you work on the individual endpoints, let’s define all your routes in <span class="EmphasisFontCategoryNonProportional">app/Http/routes.php</span> (Listing <span class="InternalRef"><a href="#Par6">10-2</a></span>).</div><div id="Par6" class="Para">
          <div class="ProgramCode" id="PC2"><div class="FixedLine">27  $app-&gt;group([</div><div class="FixedLine">28      'prefix' =&gt; '/authors',</div><div class="FixedLine">29      'namespace' =&gt; 'App\Http\Controllers'</div><div class="FixedLine">30  ], <span class="EmphasisTypeBold">function</span> (\Laravel\Lumen\Application $app) {</div><div class="FixedLine">31      $app-&gt;get('/', 'AuthorsController@index');</div><div class="FixedLine">32      $app-&gt;post('/', 'AuthorsController@store');</div><div class="FixedLine">33      $app-&gt;get('/{id:[\d]+}', 'AuthorsController@show');</div><div class="FixedLine">34      $app-&gt;put('/{id:[\d]+}', 'AuthorsController@update');</div><div class="FixedLine">35      $app-&gt;delete('/{id:[\d]+}', 'AuthorsController@destroy');</div><div class="FixedLine">36  });</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-2.</span><div class="SimplePara">Defining the Author Routes</div></div></div></div>
        </div><div id="Par7" class="Para">The code snippet introduces the <span class="EmphasisFontCategoryNonProportional">$app-&gt;group()</span> method, which accepts the following keys: <span class="EmphasisFontCategoryNonProportional">prefix</span>, <span class="EmphasisFontCategoryNonProportional">namespace</span>, and <span class="EmphasisFontCategoryNonProportional">middleware</span>. You need to define the <span class="EmphasisFontCategoryNonProportional">namespace</span> key so the group knows how to locate the <span class="EmphasisFontCategoryNonProportional">AuthorsController</span> and you define a prefix of <span class="EmphasisFontCategoryNonProportional">/authors</span> that all routes in the group will use.</div><div id="Sec1" class="Section1 RenderAsSection1"><h2 class="Heading">The GET /authors Endpoint</h2><div id="Par8" class="Para">Your first endpoint will get all authors. You will create an <span class="EmphasisFontCategoryNonProportional">AuthorTransformer</span> class that you can use on all author responses. If you recall, in the last chapter you created a factory and database seeder for authors that you can use to write your tests for the <span class="EmphasisFontCategoryNonProportional">/authors</span> endpoints. Time to code.</div><div id="Par9" class="Para">First up, let’s create the files necessary for this whole section (Listing <span class="InternalRef"><a href="#Par10">10-3</a></span>).</div><div id="Par10" class="Para">
            <div class="ProgramCode" id="PC3"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ touch app/Transformer/AuthorTransformer.php</div><div class="FixedLine">$ touch tests/app/Transformer/AuthorTransformerTest.php</div><div class="FixedLine">$ touch app/Http/Controllers/AuthorsController.php</div><div class="FixedLine">$ touch tests/app/Http/Controllers/AuthorsControllerTest.php</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-3.</span><div class="SimplePara">Creating the AuthorTransformer Class</div></div></div></div>
          </div><div id="Sec2" class="Section2 RenderAsSection2"><h3 class="Heading">The AuthorsTransformer</h3><div id="Par11" class="Para">Let’s start with the <span class="EmphasisFontCategoryNonProportional">AuthorTransformerTest</span> class (Listing <span class="InternalRef"><a href="#Par12">10-4</a></span>).</div><div id="Par12" class="Para">
              <div class="ProgramCode" id="PC4"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Transformer;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> App\Transformer\AuthorTransformer;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use Laravel\Lumen\Testing\DatabaseMigrations</span>;</div><div class="FixedLine"> 8</div><div class="FixedLine"> 9  <span class="EmphasisTypeBold">class AuthorTransformerTest extends</span> TestCase</div><div class="FixedLine">10  {</div><div class="FixedLine">11      <span class="EmphasisTypeBold">use</span> DatabaseMigrations;</div><div class="FixedLine">12</div><div class="FixedLine">13      <span class="EmphasisTypeBold">public function</span> setUp()</div><div class="FixedLine">14      {</div><div class="FixedLine">15          <span class="EmphasisTypeBold">parent</span>::setUp();</div><div class="FixedLine">16</div><div class="FixedLine">17          $this-&gt;subject = <span class="EmphasisTypeBold">new</span> AuthorTransformer();</div><div class="FixedLine">18      }</div><div class="FixedLine">19      <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">20      <span class="EmphasisTypeBold">public function</span> it_can_be_initialized()</div><div class="FixedLine">21      {</div><div class="FixedLine">22          $this-&gt;assertInstanceOf(AuthorTransformer::class, $this-&gt;subject);</div><div class="FixedLine">23      }</div><div class="FixedLine">24  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-4.</span><div class="SimplePara">The AuthorTransformerTest Skeleton Class</div></div></div></div>
            </div><div id="Par13" class="Para">Your test file is fairly familiar. As a convenience I’ve opted to construct the transformer before each test in the <span class="EmphasisFontCategoryNonProportional">setUp()</span> method and assign it to <span class="EmphasisFontCategoryNonProportional">$this-&gt;subject</span>.</div><div id="Par14" class="Para">Next, you create the <span class="EmphasisFontCategoryNonProportional">AuthorTransformer</span> class to get the test passing (Listing <span class="InternalRef"><a href="#Par15">10-5</a></span>).</div><div id="Par15" class="Para">
              <div class="ProgramCode" id="PC5"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Transformer;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> App\Author;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> League\Fractal\TransformerAbstract;</div><div class="FixedLine"> 7</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">class AuthorTransformer extends</span> TransformerAbstract</div><div class="FixedLine"> 9  {</div><div class="FixedLine">10  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-5.</span><div class="SimplePara">Creating the AuthorTransformer Class</div></div></div></div>
            </div><div id="Par16" class="Para">Now that you have the boilerplate code, you need to write tests for your specification. First, the <span class="EmphasisFontCategoryNonProportional">AuthorTransformer</span> should simply need to be able to transform an <span class="EmphasisFontCategoryNonProportional">Author</span> model in a consistent way that you expect (Listing <span class="InternalRef"><a href="#Par17">10-6</a></span>).</div><div id="Par17" class="Para">
              <div class="ProgramCode" id="PC6"><div class="FixedLine">25  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">26  <span class="EmphasisTypeBold">public function</span> it_can_transform_an_author()</div><div class="FixedLine">27  {</div><div class="FixedLine">28      $author = factory(\App\Author::class)-&gt;create();</div><div class="FixedLine">29</div><div class="FixedLine">30      $actual = $this-&gt;subject-&gt;transform($author);</div><div class="FixedLine">31</div><div class="FixedLine">32      $this-&gt;assertEquals($author-&gt;id, $actual['id']);</div><div class="FixedLine">33      $this-&gt;assertEquals($author-&gt;name, $actual['name']);</div><div class="FixedLine">34      $this-&gt;assertEquals($author-&gt;gender, $actual['gender']);</div><div class="FixedLine">35      $this-&gt;assertEquals($author-&gt;biography, $actual['biography']);</div><div class="FixedLine">36      $this-&gt;assertEquals(</div><div class="FixedLine">37          $author-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">38          $actual['created']</div><div class="FixedLine">39      );</div><div class="FixedLine">40      $this-&gt;assertEquals(</div><div class="FixedLine">41          $author-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">42          $actual['created']</div><div class="FixedLine">43      );</div><div class="FixedLine">44  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-6.</span><div class="SimplePara">The Test Specification for the transform() Method</div></div></div></div>
            </div><div id="Par18" class="Para">Your assertions are straightforward and make sure that the transformer includes all the expected author properties. Now write the <span class="EmphasisFontCategoryNonProportional">AuthorTransformer::transform()</span> implementation to get the newly written test to pass (Listing <span class="InternalRef"><a href="#Par19">10-7</a></span>).</div><div id="Par19" class="Para">
              <div class="ProgramCode" id="PC7"><div class="FixedLine">10  <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">11   <span class="EmphasisTypeItalic">* Transform an author model</span>
            </div><div class="FixedLine">12   <span class="EmphasisTypeItalic">*</span>
            </div><div class="FixedLine">13   <span class="EmphasisTypeItalic">* @param Author $author</span>
            </div><div class="FixedLine">14   <span class="EmphasisTypeItalic">* @return array</span>
            </div><div class="FixedLine">15   <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">16  <span class="EmphasisTypeBold">public function</span> transform(Author $author)</div><div class="FixedLine">17  {</div><div class="FixedLine">18      <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">19          'id' =&gt; $author-&gt;id,</div><div class="FixedLine">20          'name' =&gt; $author-&gt;name,</div><div class="FixedLine">21          'gender' =&gt; $author-&gt;gender,</div><div class="FixedLine">22          'biography' =&gt; $author-&gt;biography,</div><div class="FixedLine">23          'created' =&gt; $author-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">24          'updated' =&gt; $author-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">25      ];</div><div class="FixedLine">26  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-7.</span><div class="SimplePara">Implementing the AuthorTransformer::transform() Method</div></div></div></div>
            </div><div id="Par20" class="Para">You should have been running tests after writing each test and then after implementing it. Let’s make sure you are passing now (Listing <span class="InternalRef"><a href="#Par21">10-8</a></span>).</div><div id="Par21" class="Para">
              <div class="ProgramCode" id="PC8"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (29 tests, 132 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-8.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
            </div></div><div id="Sec3" class="Section2 RenderAsSection2"><h3 class="Heading">The Author Controller</h3><div id="Par22" class="Para">Now that you have a basic <span class="EmphasisFontCategoryNonProportional">AuthorTransformer</span> you will change focus to the <span class="EmphasisFontCategoryNonProportional">AuthorsController@index</span> route. Let’s write your first test in the <span class="EmphasisFontCategoryNonProportional">tests/app/Http/Controllers/AuthorsControllerTest.php</span> file (Listing <span class="InternalRef"><a href="#Par23">10-9</a></span>).</div><div id="Par23" class="Para">
              <div class="ProgramCode" id="PC9"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> Illuminate\Http\Response;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> Laravel\Lumen\Testing\DatabaseMigrations;</div><div class="FixedLine"> 8</div><div class="FixedLine"> 9  <span class="EmphasisTypeBold">class AuthorsControllerTest extends</span> TestCase</div><div class="FixedLine">10  {</div><div class="FixedLine">11      <span class="EmphasisTypeBold">use</span> DatabaseMigrations;</div><div class="FixedLine">12</div><div class="FixedLine">13      <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">14      <span class="EmphasisTypeBold">public function</span> index_responds_with_200_status_code()</div><div class="FixedLine">15      {</div><div class="FixedLine">16          $this-&gt;get('/authors')-&gt;seeStatusCode(Response::HTTP_OK);</div><div class="FixedLine">17      }</div><div class="FixedLine">18  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-9.</span><div class="SimplePara">Testing the AuthorsController@index for a 200 Status Code</div></div></div></div>
            </div><div id="Par24" class="Para">Running the test at this point results in a failing test with a <span class="EmphasisFontCategoryNonProportional">500</span> status code because you haven’t defined the controller. Add the following controller code in Listing <span class="InternalRef"><a href="#Par25">10-10</a></span> to get the test back to green.</div><div id="Par25" class="Para">
              <div class="ProgramCode" id="PC10"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> App\Author;</div><div class="FixedLine"> 6</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">class AuthorsController extends</span> Controller</div><div class="FixedLine"> 8  {</div><div class="FixedLine"> 9      <span class="EmphasisTypeBold">public function</span> index()</div><div class="FixedLine">10      {</div><div class="FixedLine">11      }</div><div class="FixedLine">12  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-10.</span><div class="SimplePara">Defining the AuthorsController</div></div></div></div>
            </div><div id="Par26" class="Para">Just defining the route and controller method results in a <span class="EmphasisFontCategoryNonProportional">200</span> status code. Next, you will write assertions to test that the <span class="EmphasisFontCategoryNonProportional">AuthorsController@index</span> returns a collection of records in the <span class="EmphasisFontCategoryNonProportional">AuthorsControllerTest</span> file (Listing <span class="InternalRef"><a href="#Par27">10-11</a></span>).</div><div id="Par27" class="Para">
              <div class="ProgramCode" id="PC11"><div class="FixedLine">19  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">20  <span class="EmphasisTypeBold">public function</span> index_should_return_a_collection_of_records()</div><div class="FixedLine">21  {</div><div class="FixedLine">22      $authors = factory(\App\Author::class, 2)-&gt;create();</div><div class="FixedLine">23</div><div class="FixedLine">24      $this-&gt;get('/authors', ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">25</div><div class="FixedLine">26      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">27      $this-&gt;assertArrayHasKey('data', $body);</div><div class="FixedLine">28      $this-&gt;assertCount(2, $body['data']);</div><div class="FixedLine">29</div><div class="FixedLine">30      <span class="EmphasisTypeBold">foreach</span> ($authors <span class="EmphasisTypeBold">as</span> $author) {</div><div class="FixedLine">31          $this-&gt;seeJson([</div><div class="FixedLine">32              'id' =&gt; $author-&gt;id,</div><div class="FixedLine">33              'name' =&gt; $author-&gt;name,</div><div class="FixedLine">34              'gender' =&gt; $author-&gt;gender,</div><div class="FixedLine">35              'biography' =&gt; $author-&gt;biography,</div><div class="FixedLine">36              'created' =&gt; $author-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">37              'updated' =&gt; $author-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">38          ]);</div><div class="FixedLine">39      }</div><div class="FixedLine">40  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-11.</span><div class="SimplePara">Testing That the AuthorsController@index Returns Multiple Records</div></div></div></div>
            </div><div id="Par28" class="Para">The test is nearly identical to the same test for the <span class="EmphasisFontCategoryNonProportional">/books</span> route. Next, write the integration and get the test to pass (Listing <span class="InternalRef"><a href="#Par29">10-12</a></span>).</div><div id="Par29" class="Para">
              <div class="ProgramCode" id="PC12"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> App\Author;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> App\Transformer\AuthorTransformer;</div><div class="FixedLine"> 7</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">class AuthorsController extends</span> Controller</div><div class="FixedLine"> 9  {</div><div class="FixedLine">10      <span class="EmphasisTypeBold">public function</span> index()</div><div class="FixedLine">11      {</div><div class="FixedLine">12          <span class="EmphasisTypeBold">return</span> $this-&gt;collection(</div><div class="FixedLine">13              Author::all(),</div><div class="FixedLine">14              <span class="EmphasisTypeBold">new</span> AuthorTransformer()</div><div class="FixedLine">15          );</div><div class="FixedLine">16      }</div><div class="FixedLine">17  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-12.</span><div class="SimplePara">Returning a Collection of Author Records</div></div></div></div>
            </div><div id="Par30" class="Para">You are starting to reap the benefits of your Fractal integration and returning a consistent response takes no effort!</div><div id="Par31" class="Para">Let’s verify your tests now (Listing <span class="InternalRef"><a href="#Par32">10-13</a></span>).</div><div id="Par32" class="Para">
              <div class="ProgramCode" id="PC13"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (31 tests, 147 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-13.</span><div class="SimplePara">Running Tests for the AuthorsController</div></div></div></div>
            </div></div></div><div id="Sec4" class="Section1 RenderAsSection1"><h2 class="Heading">The GET /authors/{id} Endpoint</h2><div id="Par33" class="Para ParaOneEmphasisChild">You will continue with your quick pace and knock out the first version of the <span class="EmphasisFontCategoryNonProportional">GET /authors/{id}</span> route. In this route, you want to allow including an author’s books, so I will show you a way to easily accomplish this with Fractal.</div><div id="Sec5" class="Section2 RenderAsSection2"><h3 class="Heading">A Basic Response</h3><div id="Par34" class="Para">Let’s start by testing for a basic response you are familiar with from the <span class="EmphasisFontCategoryNonProportional">/books/{id}</span> route (Listing <span class="InternalRef"><a href="#Par35">10-14</a></span>).</div><div id="Par35" class="Para">
              <div class="ProgramCode" id="PC14"><div class="FixedLine">42  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">43  <span class="EmphasisTypeBold">public function</span> show_should_return_a_valid_author()</div><div class="FixedLine">44  {</div><div class="FixedLine">45      $book = $this-&gt;bookFactory();</div><div class="FixedLine">46      $author = $book-&gt;author;</div><div class="FixedLine">47</div><div class="FixedLine">48      $this-&gt;get("/authors/<span class="EmphasisTypeBold">{</span>$author-&gt;id<span class="EmphasisTypeBold">}</span>", ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">49      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">50      $this-&gt;assertArrayHasKey('data', $body);</div><div class="FixedLine">51</div><div class="FixedLine">52      $this-&gt;seeJson([</div><div class="FixedLine">53          'id' =&gt; $author-&gt;id,</div><div class="FixedLine">54          'name' =&gt; $author-&gt;name,</div><div class="FixedLine">55          'gender' =&gt; $author-&gt;gender,</div><div class="FixedLine">56          'biography' =&gt; $author-&gt;biography,</div><div class="FixedLine">57          'created' =&gt; $author-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">58          'updated' =&gt; $author-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">59      ]);</div><div class="FixedLine">60  }</div><div class="FixedLine">61</div><div class="FixedLine">62  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">63  <span class="EmphasisTypeBold">public function</span> show_should_fail_on_an_invalid_author()</div><div class="FixedLine">64  {</div><div class="FixedLine">65      $this-&gt;get('/authors/1234', ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">66      $this-&gt;seeStatusCode(Response::HTTP_NOT_FOUND);</div><div class="FixedLine">67</div><div class="FixedLine">68      $this-&gt;seeJson([</div><div class="FixedLine">69          'message' =&gt; 'Not Found',</div><div class="FixedLine">70          'status' =&gt; Response::HTTP_NOT_FOUND</div><div class="FixedLine">71      ]);</div><div class="FixedLine">72</div><div class="FixedLine">73      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">74      $this-&gt;assertArrayHasKey('error', $body);</div><div class="FixedLine">75      $error = $body['error'];</div><div class="FixedLine">76</div><div class="FixedLine">77      $this-&gt;assertEquals('Not Found', $error['message']);</div><div class="FixedLine">78      $this-&gt;assertEquals(Response::HTTP_NOT_FOUND, $error['status']);</div><div class="FixedLine">79  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-14.</span><div class="SimplePara">Testing the AuthorsController@show Method</div></div></div></div>
            </div><div id="Par36" class="Para">I cheated a little and added two tests, but everything in these tests should be familiar to you already. The implementation for the <span class="EmphasisFontCategoryNonProportional">AuthorsController@show</span> method should cover both tests and get back to green (Listing <span class="InternalRef"><a href="#Par37">10-15</a></span>).</div><div id="Par37" class="Para">
              <div class="ProgramCode" id="PC15"><div class="FixedLine">18  <span class="EmphasisTypeBold">public function</span> show($id)</div><div class="FixedLine">19  {</div><div class="FixedLine">20      <span class="EmphasisTypeBold">return</span> $this-&gt;item(</div><div class="FixedLine">21          Author::findorFail($id),</div><div class="FixedLine">22          <span class="EmphasisTypeBold">new</span> AuthorTransformer()</div><div class="FixedLine">23      );</div><div class="FixedLine">24  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-15.</span><div class="SimplePara">Implementing a Passing AuthorsController@show Method</div></div></div></div>
            </div></div><div id="Sec6" class="Section2 RenderAsSection2"><h3 class="Heading">Including Other Models in the Response</h3><div id="Par38" class="Para ParaOneEmphasisChild">Fractal provides a way to build responses for relationships between transformers. This will allow you to load the <span class="EmphasisFontCategoryNonProportional">Book</span> data for an author without much effort on your part, and provide consistent behavior across your API. You can provide these associations by default, or optionally include them.</div><div id="Par39" class="Para">How should you go about implementing the inclusion of optional data in your API? A common strategy that you are going to use is to include a query string parameter to instruct the API to provide optional extra data (Listing <span class="InternalRef"><a href="#Par40">10-16</a></span>).</div><div id="Par40" class="Para">
              <div class="ProgramCode" id="PC16"><div class="FixedLine">http://bookr.app/authors/1?include=books</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-16.</span><div class="SimplePara">Your Query String Used to Include Extra Data</div></div></div></div>
            </div><div id="Par41" class="Para">In order for Fractal to include <span class="EmphasisFontCategoryNonProportional">Book</span> data, you need to add a few things to <span class="EmphasisFontCategoryNonProportional">app/Http/Response/FractalResponse.php</span>. You need a way to get the request query string param <span class="EmphasisFontCategoryNonProportional">include</span> and pass its value to fractal. One way to accomplish this is to pass an instance of <span class="EmphasisFontCategoryNonProportional">Illuminate\Http\Request</span> as a dependency of <span class="EmphasisFontCategoryNonProportional">FractalResponse</span>.</div><div id="Par42" class="Para">First, let’s write your tests for updating the <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> to include the <span class="EmphasisFontCategoryNonProportional">Request</span> dependency. You will start by adding the <span class="EmphasisFontCategoryNonProportional">Illuminate\Http\Request</span> dependency throughout the <span class="EmphasisFontCategoryNonProportional">tests/app/Http/Response/FractalResponseTest.php</span> file. The <span class="EmphasisFontCategoryNonProportional">FractalResponseTest</span> class should look Listing <span class="InternalRef"><a href="#Par43">10-17</a></span> when you are done.</div><div id="Par43" class="Para">
              <div class="ProgramCode" id="PC17"><div class="FixedLine">  1  &lt;?php</div><div class="FixedLine">  2</div><div class="FixedLine">  3  namespace Tests\App\Http\Response;</div><div class="FixedLine">  4</div><div class="FixedLine">  5  use TestCase;</div><div class="FixedLine">  6  use Mockery as m;</div><div class="FixedLine">  7  use League\Fractal\Manager;</div><div class="FixedLine">  8  <span class="EmphasisTypeBold">use Illuminate\Http\Request;</span>
            </div><div class="FixedLine">  9  use App\Http\Response\FractalResponse;</div><div class="FixedLine"> 10  use League\Fractal\Serializer\SerializerAbstract;</div><div class="FixedLine"> 11</div><div class="FixedLine"> 12  class FractalResponseTest extends TestCase</div><div class="FixedLine"> 13  {</div><div class="FixedLine"> 14      /** @test **/</div><div class="FixedLine"> 15      public function it_can_be_initialized()</div><div class="FixedLine"> 16      {</div><div class="FixedLine"> 17          $manager = m::mock(Manager::class);</div><div class="FixedLine"> 18          $serializer = m::mock(SerializerAbstract::class);</div><div class="FixedLine"> 19          <span class="EmphasisTypeBold">$request = m::mock(Request::class);</span>
            </div><div class="FixedLine"> 20</div><div class="FixedLine"> 21          $manager</div><div class="FixedLine"> 22              -&gt;shouldReceive('setSerializer')</div><div class="FixedLine"> 23              -&gt;with($serializer)</div><div class="FixedLine"> 24              -&gt;once()</div><div class="FixedLine"> 25              -&gt;andReturn($manager);</div><div class="FixedLine"> 26          <span class="EmphasisTypeBold">$fractal = new FractalResponse($manager, $serializer, $request);</span>
            </div><div class="FixedLine"> 27          $this-&gt;assertInstanceOf(FractalResponse::class, $fractal);</div><div class="FixedLine"> 28      }</div><div class="FixedLine"> 29</div><div class="FixedLine"> 30      /** @test **/</div><div class="FixedLine"> 31      public function it_can_transform_an_item()</div><div class="FixedLine"> 32      {</div><div class="FixedLine"> 33          <span class="EmphasisTypeBold">// Request</span>
            </div><div class="FixedLine"> 34          <span class="EmphasisTypeBold">$request = m::mock(Request::class);</span>
            </div><div class="FixedLine"> 35</div><div class="FixedLine"> 36          // Transformer</div><div class="FixedLine"> 37          $transformer = m::mock('League\Fractal\TransformerAbstract');</div><div class="FixedLine"> 38</div><div class="FixedLine"> 39          // Scope</div><div class="FixedLine"> 40          $scope = m::mock('League\Fractal\Scope');</div><div class="FixedLine"> 41          $scope</div><div class="FixedLine"> 42              -&gt;shouldReceive('toArray')</div><div class="FixedLine"> 43              -&gt;once()</div><div class="FixedLine"> 44              -&gt;andReturn(['foo' =&gt; 'bar']);</div><div class="FixedLine"> 45</div><div class="FixedLine"> 46          // Serializer</div><div class="FixedLine"> 47          $serializer = m::mock('League\Fractal\Serializer\SerializerAbstract');</div><div class="FixedLine"> 48</div><div class="FixedLine"> 49          $manager = m::mock('League\Fractal\Manager');</div><div class="FixedLine"> 50          $manager</div><div class="FixedLine"> 51              -&gt;shouldReceive('setSerializer')</div><div class="FixedLine"> 52              -&gt;with($serializer)</div><div class="FixedLine"> 53              -&gt;once();</div><div class="FixedLine"> 54</div><div class="FixedLine"> 55          $manager</div><div class="FixedLine"> 56              -&gt;shouldReceive('createData')</div><div class="FixedLine"> 57              -&gt;once()</div><div class="FixedLine"> 58             -&gt;andReturn($scope);</div><div class="FixedLine"> 59</div><div class="FixedLine"> 60          <span class="EmphasisTypeBold">$subject = new FractalResponse($manager, $serializer, $request);</span>
            </div><div class="FixedLine"> 61          $this-&gt;assertInternalType(</div><div class="FixedLine"> 62              'array',</div><div class="FixedLine"> 63              $subject-&gt;item(['foo' =&gt; 'bar'], $transformer)</div><div class="FixedLine"> 64          );</div><div class="FixedLine"> 65      }</div><div class="FixedLine"> 66</div><div class="FixedLine"> 67      /** @test **/</div><div class="FixedLine"> 68      public function it_can_transform_a_collection()</div><div class="FixedLine"> 69      {</div><div class="FixedLine"> 70          $data = [</div><div class="FixedLine"> 71              ['foo' =&gt; 'bar'],</div><div class="FixedLine"> 72              ['fizz' =&gt; 'buzz'],</div><div class="FixedLine"> 73          ];</div><div class="FixedLine"> 74</div><div class="FixedLine"> 75          <span class="EmphasisTypeBold">// Request</span>
            </div><div class="FixedLine"> 76          <span class="EmphasisTypeBold">$request = m::mock(Request::class);</span>
            </div><div class="FixedLine"> 77</div><div class="FixedLine"> 78          // Transformer</div><div class="FixedLine"> 79          $transformer = m::mock('League\Fractal\TransformerAbstract');</div><div class="FixedLine"> 80</div><div class="FixedLine"> 81          // Scope</div><div class="FixedLine"> 82          $scope = m::mock('League\Fractal\Scope');</div><div class="FixedLine"> 83          $scope</div><div class="FixedLine"> 84              -&gt;shouldReceive('toArray')</div><div class="FixedLine"> 85              -&gt;once()</div><div class="FixedLine"> 86              -&gt;andReturn($data);</div><div class="FixedLine"> 87</div><div class="FixedLine"> 88          // Serializer</div><div class="FixedLine"> 89          $serializer = m::mock('League\Fractal\Serializer\SerializerAbstract');</div><div class="FixedLine"> 90</div><div class="FixedLine"> 91          $manager = m::mock('League\Fractal\Manager');</div><div class="FixedLine"> 92          $manager</div><div class="FixedLine"> 93              -&gt;shouldReceive('setSerializer')</div><div class="FixedLine"> 94              -&gt;with($serializer)</div><div class="FixedLine"> 95              -&gt;once();</div><div class="FixedLine"> 96</div><div class="FixedLine"> 97          $manager</div><div class="FixedLine"> 98              -&gt;shouldReceive('createData')</div><div class="FixedLine"> 99              -&gt;once()</div><div class="FixedLine">100              -&gt;andReturn($scope);</div><div class="FixedLine">101</div><div class="FixedLine">102          <span class="EmphasisTypeBold">$subject = new FractalResponse($manager, $serializer, $request);</span>
            </div><div class="FixedLine">103          $this-&gt;assertInternalType(</div><div class="FixedLine">104              'array',</div><div class="FixedLine">105              $subject-&gt;collection($data, $transformer)</div><div class="FixedLine">106          );</div><div class="FixedLine">107     }</div><div class="FixedLine">108  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-17.</span><div class="SimplePara">Full FractalResponseTest Source</div></div></div></div>
            </div><div id="Par44" class="Para">You’ve imported the <span class="EmphasisFontCategoryNonProportional">Illuminate\Http\Response</span> class and included it throughout the file in order to initialize an instance with the response. Now you need to update your <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> class to accept the Illuminate <span class="EmphasisFontCategoryNonProportional">Request</span> instance in the constructor (Listing <span class="InternalRef"><a href="#Par45">10-18</a></span>).</div><div id="Par45" class="Para">
              <div class="ProgramCode" id="PC18"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  namespace App\Http\Response;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  use League\Fractal\Manager;</div><div class="FixedLine"> 6  use League\Fractal\Resource\Item;</div><div class="FixedLine"> 7  use League\Fractal\TransformerAbstract;</div><div class="FixedLine"> 8  use League\Fractal\Resource\Collection;</div><div class="FixedLine"> 9  use League\Fractal\Resource\ResourceInterface;</div><div class="FixedLine">10  use League\Fractal\Serializer\SerializerAbstract;</div><div class="FixedLine">11  <span class="EmphasisTypeBold">use Illuminate\Http\Request;</span>
            </div><div class="FixedLine">12</div><div class="FixedLine">13  class FractalResponse</div><div class="FixedLine">14  {</div><div class="FixedLine">15      /**</div><div class="FixedLine">16       * @var Manager</div><div class="FixedLine">17       */</div><div class="FixedLine">18      private $manager;</div><div class="FixedLine">19</div><div class="FixedLine">20      /**</div><div class="FixedLine">21       * @var SerializerAbstract</div><div class="FixedLine">22       */</div><div class="FixedLine">23      private $serializer;</div><div class="FixedLine">24</div><div class="FixedLine">25      <span class="EmphasisTypeBold">/**</span>
            </div><div class="FixedLine">26       <span class="EmphasisTypeBold">* @var Request</span>
            </div><div class="FixedLine">27       <span class="EmphasisTypeBold">*/</span>
            </div><div class="FixedLine">28      <span class="EmphasisTypeBold">private $request;</span>
            </div><div class="FixedLine">29</div><div class="FixedLine">30      <span class="EmphasisTypeBold">public function __construct(</span>
            </div><div class="FixedLine">31          <span class="EmphasisTypeBold">Manager $manager,</span>
            </div><div class="FixedLine">32          <span class="EmphasisTypeBold">SerializerAbstract $serializer,</span>
            </div><div class="FixedLine">33          <span class="EmphasisTypeBold">Request $request</span>
            </div><div class="FixedLine">34      <span class="EmphasisTypeBold">) {</span>
            </div><div class="FixedLine">35          $this-&gt;manager = $manager;</div><div class="FixedLine">36          $this-&gt;serializer = $serializer;</div><div class="FixedLine">37          $this-&gt;manager-&gt;setSerializer($serializer);</div><div class="FixedLine">38          <span class="EmphasisTypeBold">$this-&gt;request = $request;</span>
            </div><div class="FixedLine">39      }</div><div class="FixedLine">40      // ...</div><div class="FixedLine">41  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-18.</span><div class="SimplePara">Updating FractalResponse to Accept a Request Instance (Partial Source)</div></div></div></div>
            </div><div id="Par46" class="Para">The code snippet looks like a lot of code; all that is happening here is that you are importing the <span class="EmphasisFontCategoryNonProportional">Illuminate\Http\Response</span> class, type-hinting the constructor argument, and assigning the request. The <span class="EmphasisFontCategoryNonProportional">$request</span> parameter will come from the Service Container.</div><div id="Par47" class="Para">If you run the test suite now, you will get lots of failures because you’ve updated your <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> constructor with the <span class="EmphasisFontCategoryNonProportional">Response</span> instance. In order to get back to green, you need to update the <span class="EmphasisFontCategoryNonProportional">app/Providers/FractalServiceProvider.php</span> file to pass the response instance from the container into your <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> instance (Listing <span class="InternalRef"><a href="#Par48">10-19</a></span>).</div><div id="Par48" class="Para">
              <div class="ProgramCode" id="PC19"><div class="FixedLine">12  <span class="EmphasisTypeBold">public function</span> register()</div><div class="FixedLine">13  {</div><div class="FixedLine">14      <span class="EmphasisTypeItalic">// Bind the DataArraySerializer to an interface contract</span>
            </div><div class="FixedLine">15      $this-&gt;app-&gt;bind(</div><div class="FixedLine">16          'League\Fractal\Serializer\SerializerAbstract',</div><div class="FixedLine">17          'League\Fractal\Serializer\DataArraySerializer'</div><div class="FixedLine">18      );</div><div class="FixedLine">19</div><div class="FixedLine">20      $this-&gt;app-&gt;bind(FractalResponse::class, <span class="EmphasisTypeBold">function</span> ($app) {</div><div class="FixedLine">21          $manager = <span class="EmphasisTypeBold">new</span> Manager();</div><div class="FixedLine">22          $serializer = $app['League\Fractal\Serializer\SerializerAbstract'];</div><div class="FixedLine">23</div><div class="FixedLine">24          <span class="EmphasisTypeBold">return new</span> FractalResponse($manager, $serializer, $app['request']);</div><div class="FixedLine">25      });</div><div class="FixedLine">26</div><div class="FixedLine">27      $this-&gt;app-&gt;alias(FractalResponse::class, 'fractal');</div><div class="FixedLine">28  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-19.</span><div class="SimplePara">Adding the Request Dependency to the FractalResponse Service</div></div></div></div>
            </div><div id="Par49" class="Para">The service container has the service <span class="EmphasisFontCategoryNonProportional">$app['request']</span>, which is a service that represents the current request. You simply pass the service into the <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> constructor and now your tests should pass again.</div><div id="Par50" class="Para">Let’s verify if your tests are passing now (Listing <span class="InternalRef"><a href="#Par51">10-20</a></span>).</div><div id="Par51" class="Para">
              <div class="ProgramCode" id="PC20"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (33 tests, 160 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-20.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
            </div><div id="Par52" class="Para">Now that you have the <span class="EmphasisFontCategoryNonProportional">$app['request']</span> instance in your <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> service you are ready to write a method in the <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> class that parses <span class="EmphasisFontCategoryNonProportional">request includes</span> with the following requirements:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par53" class="Para">If an <span class="EmphasisFontCategoryNonProportional">include</span> string is passed, use it to parse <span class="EmphasisFontCategoryNonProportional">includes</span>.</div></li><li><div id="Par54" class="Para">If a parameter is <span class="EmphasisTypeItalic">not</span> passed, use the URL <span class="EmphasisFontCategoryNonProportional">?include=</span> query param.</div></li></ul></div>
        </div><div id="Par55" class="Para">The requirements allow you to manually pass the <span class="EmphasisFontCategoryNonProportional">includes</span>, but you will commonly rely on the <span class="EmphasisFontCategoryNonProportional">?include=</span> query string parameter.</div><div id="Par56" class="Para">The tests should look something like Listing <span class="InternalRef"><a href="#Par57">10-21</a></span>.</div><div id="Par57" class="Para">
              <div class="ProgramCode" id="PC21"><div class="FixedLine">110  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">111  <span class="EmphasisTypeBold">public function</span> it_should_parse_passed_includes_when_passed()</div><div class="FixedLine">112  {</div><div class="FixedLine">113      $serializer = m::mock(SerializerAbstract::class);</div><div class="FixedLine">114</div><div class="FixedLine">115      $manager = m::mock(Manager::class);</div><div class="FixedLine">116      $manager-&gt;shouldReceive('setSerializer')-&gt;with($serializer);</div><div class="FixedLine">117      $manager</div><div class="FixedLine">118          -&gt;shouldReceive('parseIncludes')</div><div class="FixedLine">119          -&gt;with('books');</div><div class="FixedLine">120</div><div class="FixedLine">121      $request = m::mock(Request::class);</div><div class="FixedLine">122      $request-&gt;shouldNotReceive('query');</div><div class="FixedLine">123</div><div class="FixedLine">124      $subject = <span class="EmphasisTypeBold">new</span> FractalResponse($manager, $serializer, $request);</div><div class="FixedLine">125      $subject-&gt;parseIncludes('books');</div><div class="FixedLine">126  }</div><div class="FixedLine">127</div><div class="FixedLine">128  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">129  <span class="EmphasisTypeBold">public function</span> it_should_parse_request_query_includes_with_no_arguments()</div><div class="FixedLine">130  {</div><div class="FixedLine">131      $serializer = m::mock(SerializerAbstract::class);</div><div class="FixedLine">132      $manager = m::mock(Manager::class);</div><div class="FixedLine">133      $manager-&gt;shouldReceive('setSerializer')-&gt;with($serializer);</div><div class="FixedLine">134      $manager</div><div class="FixedLine">135          -&gt;shouldReceive('parseIncludes')</div><div class="FixedLine">136          -&gt;with('books');</div><div class="FixedLine">137</div><div class="FixedLine">138      $request = m::mock(Request::class);</div><div class="FixedLine">139      $request</div><div class="FixedLine">140          -&gt;shouldReceive('query')</div><div class="FixedLine">141          -&gt;with('include', '')</div><div class="FixedLine">142          -&gt;andReturn('books');</div><div class="FixedLine">143</div><div class="FixedLine">144      (<span class="EmphasisTypeBold">new</span> FractalResponse($manager, $serializer, $request))-&gt;parseIncludes();</div><div class="FixedLine">145  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-21.</span><div class="SimplePara">Tests for the FractalResponse::parseIncludes() Method</div></div></div></div>
            </div><div id="Par58" class="Para">You have tested both outlined scenarios with mockery. The first test ensures that the passed parameter is used and that the request instance <span class="EmphasisFontCategoryNonProportional">query()</span> method is not called. In the second example, you call <span class="EmphasisFontCategoryNonProportional">parseIncludes()</span> with no arguments and assert that the request object’s <span class="EmphasisFontCategoryNonProportional">query</span> method is called and returns a value.</div><div id="Par59" class="Para">The <span class="EmphasisFontCategoryNonProportional">AuthorsTransformer</span> will now optionally include the books associated with an author when the request query string contains <span class="EmphasisFontCategoryNonProportional">/authors/{id}?include=books</span>. This is where your eager-loading call in the controller is a good idea: instead of each individual book requiring an extra query, all the author’s books are retrieved in a single query.</div><div id="Par60" class="Para">You are now ready to write the implementation in your <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> service (Listing <span class="InternalRef"><a href="#Par61">10-22</a></span>).</div><div id="Par61" class="Para">
              <div class="ProgramCode" id="PC22"><div class="FixedLine">41  <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">42   <span class="EmphasisTypeItalic">* Get the includes from the request if none are passed.</span>
            </div><div class="FixedLine">43   <span class="EmphasisTypeItalic">*</span>
            </div><div class="FixedLine">44   <span class="EmphasisTypeItalic">* @param null $includes</span>
            </div><div class="FixedLine">45   <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">46  <span class="EmphasisTypeBold">public function</span> parseIncludes($includes = <span class="EmphasisTypeBold">null</span>)</div><div class="FixedLine">47  {</div><div class="FixedLine">48      <span class="EmphasisTypeBold">if</span> (<span class="EmphasisTypeBold">empty</span>($includes)) {</div><div class="FixedLine">49          $includes = $this-&gt;request-&gt;query('include', '');</div><div class="FixedLine">50      }</div><div class="FixedLine">51</div><div class="FixedLine">52      $this-&gt;manager-&gt;parseIncludes($includes);</div><div class="FixedLine">53  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-22.</span><div class="SimplePara">Implementing the FractalResponse::parseIncludes( ) Method</div></div></div></div>
            </div><div id="Par62" class="Para">You’ve defined the <span class="EmphasisFontCategoryNonProportional">parseIncludes()</span> method right below the <span class="EmphasisFontCategoryNonProportional">constructor</span>. The method checks to see if the <span class="EmphasisFontCategoryNonProportional">$includes</span> parameter has a non-empty value. If it <span class="EmphasisTypeItalic">is</span> empty, you assign <span class="EmphasisFontCategoryNonProportional">$includes</span> to the request query param <span class="EmphasisFontCategoryNonProportional">?include</span>. The second parameter in <span class="EmphasisFontCategoryNonProportional">$this-&gt;request-&gt;query('include', '')</span> is the default if <span class="EmphasisFontCategoryNonProportional">include</span> doesn’t exist.</div><div id="Par63" class="Para">Let’s run the <span class="EmphasisFontCategoryNonProportional">FractalResponseTest</span> after adding tests and the implementation and see where things are at (Listing <span class="InternalRef"><a href="#Par64">10-23</a></span>).</div><div id="Par64" class="Para">
              <div class="ProgramCode" id="PC23"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (35 tests, 166 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-23.</span><div class="SimplePara">Running the FractalResponse Tests</div></div></div></div>
            </div><div id="Par65" class="Para">The <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> class can now accept the <span class="EmphasisFontCategoryNonProportional">?include=</span> query parameter and allows the Fractal manager class to parse the passed <span class="EmphasisFontCategoryNonProportional">includes</span>.</div><div id="Par66" class="Para">The other side of the <span class="EmphasisFontCategoryNonProportional">includes</span> functionality is the <span class="EmphasisFontCategoryNonProportional">AuthorTransformer</span> class and making sure it can transform the books associated with the author.</div><div id="Par67" class="Para">If you look at the <span class="ExternalRef"><a href="http://fractal.thephpleague.com/transformers/"><span class="RefSource">transformers</span></a></span> documentation (<span class="ExternalRef"><a href="http://fractal.thephpleague.com/transformers/"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">http://fractal.thephpleague.com/transformers/</span>
                </span></a></span>) (see the “Including Data” section) you will see two class properties that transformers can define: <span class="EmphasisFontCategoryNonProportional">$availableIncludes</span> and <span class="EmphasisFontCategoryNonProportional">$defaultIncludes</span>. The <span class="EmphasisFontCategoryNonProportional">$availableIncludes</span> is used to <span class="EmphasisTypeItalic">optionally</span> include other transformers, and the <span class="EmphasisFontCategoryNonProportional">$defaultIncludes</span> array automatically includes other transformers. You will opt to use <span class="EmphasisFontCategoryNonProportional">$availableIncludes</span> to include related <span class="EmphasisFontCategoryNonProportional">Book</span> records on demand. Append the test in Listing <span class="InternalRef"><a href="#Par68">10-24</a></span> to the <span class="EmphasisFontCategoryNonProportional">tests/app/Transformer/AuthorTransformerTest.php</span> file.</div><div id="Par68" class="Para">
              <div class="ProgramCode" id="PC24"><div class="FixedLine">46  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">47  <span class="EmphasisTypeBold">public function</span> it_can_transform_related_books()</div><div class="FixedLine">48  {</div><div class="FixedLine">49      $book = $this-&gt;bookFactory();</div><div class="FixedLine">50      $author = $book-&gt;author;</div><div class="FixedLine">51</div><div class="FixedLine">52      $data = $this-&gt;subject-&gt;includeBooks($author);</div><div class="FixedLine">53      $this-&gt;assertInstanceOf(\League\Fractal\Resource\Collection::class, $data);</div><div class="FixedLine">54  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-24.</span><div class="SimplePara">Test for Transforming an Author’s Books</div></div></div></div>
            </div><div id="Par69" class="Para">In order to get your new failing author transformer test passing you need to define the <span class="EmphasisFontCategoryNonProportional">AuthorTransformer::includeBooks()</span> method in the file <span class="EmphasisFontCategoryNonProportional">app/Transformers/AuthorTransformer.php</span>. Define the following at the top of the <span class="EmphasisFontCategoryNonProportional">AuthorTransformer</span> class (Listing <span class="InternalRef"><a href="#Par70">10-25</a></span>).</div><div id="Par70" class="Para">
              <div class="ProgramCode" id="PC25"><div class="FixedLine">10  <span class="EmphasisTypeBold">protected</span> $availableIncludes = [</div><div class="FixedLine">11      'books'</div><div class="FixedLine">12  ];</div><div class="FixedLine">13</div><div class="FixedLine">14  <span class="EmphasisTypeBold">public function</span> includeBooks(Author $author)</div><div class="FixedLine">15  {</div><div class="FixedLine">16      <span class="EmphasisTypeBold">return</span> $this-&gt;collection($author-&gt;books, <span class="EmphasisTypeBold">new</span> BookTransformer());</div><div class="FixedLine">17  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-25.</span><div class="SimplePara">The AuthorsTransformer::includeBooks( ) Method</div></div></div></div>
            </div><div id="Par71" class="Para">Your transformer should pass now (Listing <span class="InternalRef"><a href="#Par72">10-26</a></span>).</div><div id="Par72" class="Para">
              <div class="ProgramCode" id="PC26"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (36 tests, 167 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-26.</span><div class="SimplePara">Running All Tests for AuthorTransformer</div></div></div></div>
            </div><div id="Par73" class="Para">You have one task remaining for this feature—you need to wire it all up in the controller. First, let’s create a test to optionally include books in the <span class="EmphasisFontCategoryNonProportional">/author/{id}</span> response in your <span class="EmphasisFontCategoryNonProportional">tests/app/Http/Controllers/AuthorsController.php</span> file (Listing <span class="InternalRef"><a href="#Par74">10-27</a></span>).</div><div id="Par74" class="Para">
              <div class="ProgramCode" id="PC27"><div class="FixedLine"> 81  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine"> 82  <span class="EmphasisTypeBold">public function</span> show_optionally_includes_books()</div><div class="FixedLine"> 83  {</div><div class="FixedLine"> 84      $book = $this-&gt;bookFactory();</div><div class="FixedLine"> 85      $author = $book-&gt;author;</div><div class="FixedLine"> 86</div><div class="FixedLine"> 87      $this-&gt;get(</div><div class="FixedLine"> 88          "/authors/<span class="EmphasisTypeBold">{</span>$author-&gt;id<span class="EmphasisTypeBold">}</span>?include=books",</div><div class="FixedLine"> 89          ['Accept' =&gt; 'application/json']</div><div class="FixedLine"> 90      );</div><div class="FixedLine"> 91</div><div class="FixedLine"> 92      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine"> 93</div><div class="FixedLine"> 94      $this-&gt;assertArrayHasKey('data', $body);</div><div class="FixedLine"> 95      $data = $body['data'];</div><div class="FixedLine"> 96      $this-&gt;assertArrayHasKey('books', $data);</div><div class="FixedLine"> 97      $this-&gt;assertArrayHasKey('data', $data['books']);</div><div class="FixedLine"> 98      $this-&gt;assertCount(1, $data['books']['data']);</div><div class="FixedLine"> 99</div><div class="FixedLine">100      <span class="EmphasisTypeItalic">// See Author Data</span>
            </div><div class="FixedLine">101      $this-&gt;seeJson([</div><div class="FixedLine">102          'id' =&gt; $author-&gt;id,</div><div class="FixedLine">103          'name' =&gt; $author-&gt;name,</div><div class="FixedLine">104      ]);</div><div class="FixedLine">105</div><div class="FixedLine">106      <span class="EmphasisTypeItalic">// Test included book Data (the first record)</span>
            </div><div class="FixedLine">107      $actual = $data['books']['data'][0];</div><div class="FixedLine">108      $this-&gt;assertEquals($book-&gt;id, $actual['id']);</div><div class="FixedLine">109      $this-&gt;assertEquals($book-&gt;title, $actual['title']);</div><div class="FixedLine">110      $this-&gt;assertEquals($book-&gt;description, $actual['description']);</div><div class="FixedLine">111      $this-&gt;assertEquals(</div><div class="FixedLine">112          $book-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">113          $actual['created']</div><div class="FixedLine">114      );</div><div class="FixedLine">115      $this-&gt;assertEquals(</div><div class="FixedLine">116          $book-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">117          $actual['updated']</div><div class="FixedLine">118      );</div><div class="FixedLine">119  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-27.</span><div class="SimplePara">Test to Optionally Include Books</div></div></div></div>
            </div><div id="Par75" class="Para ParaOneEmphasisChild">This test is long but easy to understand. The test looks similar to the <span class="EmphasisFontCategoryNonProportional">show_should_return_a_valid_author</span> test, but you don’t need to assert as many author keys in the response because it’s already covered. You only do enough to know the author is represented in the response and focus on testing that the books associated with the author are included.</div><div id="Par76" class="Para">The test will fail if you run it because you haven’t told fractal about the <span class="EmphasisFontCategoryNonProportional">?include=books</span> part of your test yet, so fractal doesn’t know you want to include books (Listing <span class="InternalRef"><a href="#Par77">10-28</a></span>).</div><div id="Par77" class="Para">
              <div class="ProgramCode" id="PC28"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\AuthorsControllerTest::show_optionally_includes_bo\</div><div class="FixedLine">oks</div><div class="FixedLine">Failed asserting that an array has the key 'books'.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/AuthorsControllerTest.php:96</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 37, Assertions: 169, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-28.</span><div class="SimplePara">Optionally Including Books Test Failure</div></div></div></div>
            </div><div id="Par78" class="Para">It would be nice if your controllers just automatically called the <span class="EmphasisFontCategoryNonProportional">parseIncludes()</span> method you built earlier to include related entities. To do this, you can call <span class="EmphasisFontCategoryNonProportional">parseIncludes()</span> in the base controller <span class="EmphasisFontCategoryNonProportional">App\Http\Controllers\Controller.php</span> where you assign <span class="EmphasisFontCategoryNonProportional">$this-&gt;fractal</span> in the constructor (Listing <span class="InternalRef"><a href="#Par79">10-29</a></span>).</div><div id="Par79" class="Para">
              <div class="ProgramCode" id="PC29"><div class="FixedLine">16  <span class="EmphasisTypeBold">public function</span> __construct(FractalResponse $fractal)</div><div class="FixedLine">17  {</div><div class="FixedLine">18      $this-&gt;fractal = $fractal;</div><div class="FixedLine">19      $this-&gt;fractal-&gt;parseIncludes();</div><div class="FixedLine">20  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-29.</span><div class="SimplePara">Calling parseIncludes( ) in the Base Controller</div></div></div></div>
            </div><div id="Par80" class="Para">The base controller is calling <span class="EmphasisFontCategoryNonProportional">FractalManager::parseIncludes()</span> without passing any arguments and will assign any values in the <span class="EmphasisFontCategoryNonProportional">?include=</span> query params. You can include multiple with <span class="EmphasisFontCategoryNonProportional">?include=books,another</span>. Your feature should pass at this point (Listing <span class="InternalRef"><a href="#Par81">10-30</a></span>).</div><div id="Par81" class="Para">
              <div class="ProgramCode" id="PC30"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (37 tests, 178 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-30.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
            </div><div id="Par82" class="Para">After you put in some hard work, your feature works! An example response might look like Listing <span class="InternalRef"><a href="#Par83">10-31</a></span>.</div><div id="Par83" class="Para">
              <div class="ProgramCode" id="PC31"><div class="FixedLine">{</div><div class="FixedLine">    <span class="EmphasisTypeBold">"data"</span>:{</div><div class="FixedLine">        <span class="EmphasisTypeBold">"id"</span>:1,</div><div class="FixedLine">        <span class="EmphasisTypeBold">"name"</span>:"Jane Doe",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"gender"</span>:"female",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"biography"</span>:"Hello World",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"created"</span>:"2015-11-25T00:13:00+0000",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"updated"</span>:"2015-11-25T00:13:00+0000",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"books"</span>:{</div><div class="FixedLine">            <span class="EmphasisTypeBold">"data"</span>:[</div><div class="FixedLine">                {</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"id"</span>:1,</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"title"</span>:"Ab beatae dignissimos laudantium aut quod beatae",</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"description"</span>:"Non reprehenderit ut pariatur. Voluptate magni nam ea modi dolores rerum. Molestiae eaque et sunt et.",</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"author"</span>:"Jane Doe",</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"created"</span>:"2015-11-25T00:13:00+0000",</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"updated"</span>:"2015-11-25T00:13:00+0000"</div><div class="FixedLine">                }</div><div class="FixedLine">            ]</div><div class="FixedLine">        }</div><div class="FixedLine">    }</div><div class="FixedLine">}</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-31.</span><div class="SimplePara">Sample Response for AuthorsController@show With Books</div></div></div></div>
            </div><div id="Par84" class="Para">With minimal effort you were able to load related model data into your response in a consistent fashion. Any time you include related entities, consumers can expect the same data patterns and keys.</div></div></div><div id="Sec7" class="Section1 RenderAsSection1"><h2 class="Heading">The POST /authors Endpoint</h2><div id="Par85" class="Para">The last section had many moving parts, but now it’s time to slow it down and work on a more focused <span class="EmphasisFontCategoryNonProportional">POST /authors</span> endpoint. You’ve covered creating a new resource in the <span class="EmphasisFontCategoryNonProportional">POST /books</span> endpoint so most of this will be good review and practice. If you recall the steps taken in the <span class="EmphasisFontCategoryNonProportional">BooksController::store()</span> method, they were as follows:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par86" class="Para">Validate the POST data.</div></li><li><div id="Par87" class="Para">Create a new resource; in this case, a new Author.</div></li><li><div id="Par88" class="Para ParaOneEmphasisChild">Respond with the new resource and a <span class="EmphasisFontCategoryNonProportional">201</span> created status code.</div></li><li><div id="Par89" class="Para ParaOneEmphasisChild">Provide a <span class="EmphasisFontCategoryNonProportional">Location</span> header with the new location of the resource.</div></li></ul></div>
      </div><div id="Par90" class="Para">You will start by creating a new resource and responding with a <span class="EmphasisFontCategoryNonProportional">201</span>, followed by adding on validation and the <span class="EmphasisFontCategoryNonProportional">Location</span> header.</div><div id="Par91" class="Para">First, you define a successful POST request test in <span class="EmphasisFontCategoryNonProportional">tests/app/Http/Controllers/AuhorsControllerTest.php</span> (Listing <span class="InternalRef"><a href="#Par92">10-32</a></span>).</div><div id="Par92" class="Para">
            <div class="ProgramCode" id="PC32"><div class="FixedLine">121  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">122  <span class="EmphasisTypeBold">public function</span> store_can_create_a_new_author()</div><div class="FixedLine">123  {</div><div class="FixedLine">124      $postData = [</div><div class="FixedLine">125          'name' =&gt; 'H. G. Wells',</div><div class="FixedLine">126          'gender' =&gt; 'male',</div><div class="FixedLine">127          'biography' =&gt; 'Prolific Science-Fiction Writer',</div><div class="FixedLine">128      ];</div><div class="FixedLine">129</div><div class="FixedLine">130      $this-&gt;post('/authors', $postData, ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">131</div><div class="FixedLine">132      $this-&gt;seeStatusCode(201);</div><div class="FixedLine">133      $data = $this-&gt;response-&gt;getData(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">134      $this-&gt;assertArrayHasKey('data', $data);</div><div class="FixedLine">135      $this-&gt;seeJson($postData);</div><div class="FixedLine">136</div><div class="FixedLine">137      $this-&gt;seeInDatabase('authors', $postData);</div><div class="FixedLine">138  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-32.</span><div class="SimplePara">Test for Creating a New Author</div></div></div></div>
          </div><div id="Par93" class="Para">Here is the initial version of the <span class="EmphasisFontCategoryNonProportional">AuthorsController@store</span> (Listing <span class="InternalRef"><a href="#Par94">10-33</a></span>).</div><div id="Par94" class="Para">
            <div class="ProgramCode" id="PC33"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  namespace App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  use App\Author;</div><div class="FixedLine"> 6  use App\Transformer\AuthorTransformer;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use Illuminate\Http\Request;</span>
          </div><div class="FixedLine"> 8</div><div class="FixedLine"> 9  class AuthorsController extends Controller</div><div class="FixedLine">10  {</div><div class="FixedLine">11      public function index()</div><div class="FixedLine">12      {</div><div class="FixedLine">13          return $this-&gt;collection(</div><div class="FixedLine">14              Author::all(),</div><div class="FixedLine">15              new AuthorTransformer()</div><div class="FixedLine">16          );</div><div class="FixedLine">17      }</div><div class="FixedLine">18</div><div class="FixedLine">19      public function show($id)</div><div class="FixedLine">20      {</div><div class="FixedLine">21          return $this-&gt;item(</div><div class="FixedLine">22              Author::findorFail($id),</div><div class="FixedLine">23              new AuthorTransformer()</div><div class="FixedLine">24          );</div><div class="FixedLine">25      }</div><div class="FixedLine">26</div><div class="FixedLine">27      <span class="EmphasisTypeBold">public function store(Request $request)</span>
          </div><div class="FixedLine">28      <span class="EmphasisTypeBold">{</span>
          </div><div class="FixedLine">29          <span class="EmphasisTypeBold">$author = Author::create($request-&gt;all());</span>
          </div><div class="FixedLine">30          <span class="EmphasisTypeBold">$data = $this-&gt;item($author, new AuthorTransformer());</span>
          </div><div class="FixedLine">31</div><div class="FixedLine">32          <span class="EmphasisTypeBold">return response()-&gt;json($data, 201);</span>
          </div><div class="FixedLine">33      <span class="EmphasisTypeBold">}</span>
          </div><div class="FixedLine">34  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-33.</span><div class="SimplePara">AuthorsController with @store Method Added</div></div></div></div>
          </div><div id="Par95" class="Para">The code should pass the tests after your change (Listing <span class="InternalRef"><a href="#Par96">10-34</a></span>).</div><div id="Par96" class="Para">
            <div class="ProgramCode" id="PC34"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (38 tests, 184 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-34.</span><div class="SimplePara">Running Tests After Defining the @store Method</div></div></div></div>
          </div><div id="Par97" class="Para">The next feature you are going to add is validation. For the <span class="EmphasisFontCategoryNonProportional">BooksController</span> you separated your controller validation tests into a separate file. Feel free to do that for the <span class="EmphasisFontCategoryNonProportional">AuthorsController</span> validation tests. The code will still work, but you are going to add these tests in the <span class="EmphasisFontCategoryNonProportional">tests/app/Http/Controllers/AuthorsControllerTest.php</span> file (Listing <span class="InternalRef"><a href="#Par98">10-35</a></span>).</div><div id="Par98" class="Para">
            <div class="ProgramCode" id="PC35"><div class="FixedLine">140  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">141  <span class="EmphasisTypeBold">public function</span> store_method_validates_required_fields()</div><div class="FixedLine">142  {</div><div class="FixedLine">143      $this-&gt;post('/authors', [],</div><div class="FixedLine">144          ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">145</div><div class="FixedLine">146      $data = $this-&gt;response-&gt;getData(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">147</div><div class="FixedLine">148      $fields = ['name', 'gender', 'biography'];</div><div class="FixedLine">149</div><div class="FixedLine">150      <span class="EmphasisTypeBold">foreach</span> ($fields <span class="EmphasisTypeBold">as</span> $field) {</div><div class="FixedLine">151          $this-&gt;assertArrayHasKey($field, $data);</div><div class="FixedLine">152          $this-&gt;assertEquals(["The <span class="EmphasisTypeBold">{</span>$field<span class="EmphasisTypeBold">}</span> field is required."], $data[$field]);</div><div class="FixedLine">153      }</div><div class="FixedLine">154  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-35.</span><div class="SimplePara">Validation Test for the AuthorsController@store Method</div></div></div></div>
          </div><div id="Par99" class="Para">Implement the code in Listing <span class="InternalRef"><a href="#Par100">10-36</a></span> to get the test passing (Listing <span class="InternalRef"><a href="#Par101">10-37</a></span>).</div><div id="Par100" class="Para">
            <div class="ProgramCode" id="PC36"><div class="FixedLine">27  <span class="EmphasisTypeBold">public function</span> store(Request $request)</div><div class="FixedLine">28  {</div><div class="FixedLine">29      $this-&gt;validate($request, [</div><div class="FixedLine">30          'name' =&gt; 'required',</div><div class="FixedLine">31          'gender' =&gt; 'required',</div><div class="FixedLine">32          'biography' =&gt; 'required'</div><div class="FixedLine">33      ]);</div><div class="FixedLine">34</div><div class="FixedLine">35      $author = Author::create($request-&gt;all());</div><div class="FixedLine">36      $data = $this-&gt;item($author, <span class="EmphasisTypeBold">new</span> AuthorTransformer());</div><div class="FixedLine">37</div><div class="FixedLine">38      <span class="EmphasisTypeBold">return</span> response()-&gt;json($data, 201);</div><div class="FixedLine">39  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-36.</span><div class="SimplePara">Adding Validation to AuthorsController@store</div></div></div></div>
          </div><div id="Par101" class="Para">
            <div class="ProgramCode" id="PC37"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (39 tests, 190 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-37.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par102" class="Para">Next, let’s experiment and see what happens if you try to post a value for gender that does not match your enum field of <span class="EmphasisFontCategoryNonProportional">male</span> or <span class="EmphasisFontCategoryNonProportional">female</span> (Listing <span class="InternalRef"><a href="#Par103">10-38</a></span>).</div><div id="Par103" class="Para">
            <div class="ProgramCode" id="PC38"><div class="FixedLine">156  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">157  <span class="EmphasisTypeBold">public function</span> store_invalidates_incorrect_gender_data()</div><div class="FixedLine">158  {</div><div class="FixedLine">159      $postData = [</div><div class="FixedLine">160          'name' =&gt; 'John Doe',</div><div class="FixedLine">161          'gender' =&gt; 'unknown',</div><div class="FixedLine">162          'biography' =&gt; 'An anonymous author'</div><div class="FixedLine">163      ];</div><div class="FixedLine">164</div><div class="FixedLine">165      $this-&gt;post('/authors', $postData, ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">166</div><div class="FixedLine">167      $this-&gt;seeStatusCode(422);</div><div class="FixedLine">168</div><div class="FixedLine">169      $data = $this-&gt;response-&gt;getData(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">170      $this-&gt;assertCount(1, $data);</div><div class="FixedLine">171      $this-&gt;assertArrayHasKey('gender', $data);</div><div class="FixedLine">172      $this-&gt;assertEquals(</div><div class="FixedLine">173          ["Gender format is invalid: must equal 'male' or 'female'"],</div><div class="FixedLine">174          $data['gender']</div><div class="FixedLine">175      );</div><div class="FixedLine">176  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-38.</span><div class="SimplePara">Test for Invalid Gender Data</div></div></div></div>
          </div><div id="Par104" class="Para">In this test, you’ve specified a gender value not allowed in your enum field. You assert that you should only have one validation failure by counting the <span class="EmphasisFontCategoryNonProportional">$data</span> array and then assert the validation message for failed gender validation. Even though you are using an enum field, you get a <span class="EmphasisFontCategoryNonProportional">201</span> when you shouldn’t (Listing <span class="InternalRef"><a href="#Par105">10-39</a></span>).</div><div id="Par105" class="Para">
            <div class="ProgramCode" id="PC39"><div class="LineGroup"><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\AuthorsControllerTest::store_invalidates_incorrect\</div><div class="FixedLine">_gender_data</div><div class="FixedLine">Failed asserting that 201 matches expected 422.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/vendor/laravel/lumen-framework/src/Testing/CrawlerTrait.php:412</div><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/AuthorsControllerTest.php:167</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 40, Assertions: 191, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-39.</span><div class="SimplePara">Running the Gender Validation Test</div></div></div></div>
          </div><div id="Par106" class="Para">You will use a <span class="EmphasisFontCategoryNonProportional">regex</span> rule to guarantee a valid gender to get the requirement passing (Listing <span class="InternalRef"><a href="#Par107">10-40</a></span>).</div><div id="Par107" class="Para">
            <div class="ProgramCode" id="PC40"><div class="FixedLine">27  <span class="EmphasisTypeBold">public function</span> store(Request $request)</div><div class="FixedLine">28  {</div><div class="FixedLine">29      $this-&gt;validate($request, [</div><div class="FixedLine">30          'name' =&gt; 'required',</div><div class="FixedLine">31          'gender' =&gt; [</div><div class="FixedLine">32              'required',</div><div class="FixedLine">33              'regex:/^(male|female)$/i',</div><div class="FixedLine">34          ],</div><div class="FixedLine">35          'biography' =&gt; 'required'</div><div class="FixedLine">36      ], [</div><div class="FixedLine">37          'gender.regex' =&gt; "Gender format is invalid: must equal 'male' or 'female'"</div><div class="FixedLine">38      ]);</div><div class="FixedLine">39</div><div class="FixedLine">40      $author = Author::create($request-&gt;all());</div><div class="FixedLine">41      $data = $this-&gt;item($author, <span class="EmphasisTypeBold">new</span> AuthorTransformer());</div><div class="FixedLine">42</div><div class="FixedLine">43      <span class="EmphasisTypeBold">return</span> response()-&gt;json($data, 201);</div><div class="FixedLine">44  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-40.</span><div class="SimplePara">Validating Gender in the AuthorsController@store Method</div></div></div></div>
          </div><div id="Par108" class="Para">You’ve added a regular expression validation rule for <span class="EmphasisFontCategoryNonProportional">gender</span> and changed the <span class="EmphasisFontCategoryNonProportional">gender</span> rules to use an array. This is because your regex contains a pipe character, (|), which is what the validator uses to separate rules. Lastly, you add a custom validation message so users of the API will know what values are allowed.</div><div id="Par109" class="Para">Let’s check back in with your test suite and make sure it’s green (Listing <span class="InternalRef"><a href="#Par110">10-41</a></span>).</div><div id="Par110" class="Para">
            <div class="ProgramCode" id="PC41"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (40 tests, 194 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-41.</span><div class="SimplePara">Testing Gender Validation Again</div></div></div></div>
          </div><div id="Par111" class="Para">The last validation rule you will add before you complete the <span class="EmphasisFontCategoryNonProportional">POST /authors</span> endpoint is length validation for the <span class="EmphasisFontCategoryNonProportional">name</span> field (Listing <span class="InternalRef"><a href="#Par112">10-42</a></span>).</div><div id="Par112" class="Para">
            <div class="ProgramCode" id="PC42"><div class="FixedLine">178  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">179  <span class="EmphasisTypeBold">public function</span> store_invalidates_name_when_name_is_just_too_long()</div><div class="FixedLine">180  {</div><div class="FixedLine">181      $postData = [</div><div class="FixedLine">182          'name' =&gt; str_repeat('a', 256),</div><div class="FixedLine">183          'gender' =&gt; 'male',</div><div class="FixedLine">184          'biography' =&gt; 'A Valid Biography'</div><div class="FixedLine">185      ];</div><div class="FixedLine">186</div><div class="FixedLine">187      $this-&gt;post('/authors', $postData, ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">188</div><div class="FixedLine">189      $this-&gt;seeStatusCode(422);</div><div class="FixedLine">190</div><div class="FixedLine">191      $data = $this-&gt;response-&gt;getData(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">192      $this-&gt;assertCount(1, $data);</div><div class="FixedLine">193      $this-&gt;assertArrayHasKey('name', $data);</div><div class="FixedLine">194      $this-&gt;assertEquals(</div><div class="FixedLine">195          ["The name may not be greater than 255 characters."],</div><div class="FixedLine">196          $data['name']</div><div class="FixedLine">197      );</div><div class="FixedLine">198  }</div><div class="FixedLine">199</div><div class="FixedLine">200  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">201  <span class="EmphasisTypeBold">public function</span> store_is_valid_when_name_is_just_long_enough()</div><div class="FixedLine">202  {</div><div class="FixedLine">203      $postData = [</div><div class="FixedLine">204          'name' =&gt; str_repeat('a', 255),</div><div class="FixedLine">205          'gender' =&gt; 'male',</div><div class="FixedLine">206          'biography' =&gt; 'A Valid Biography'</div><div class="FixedLine">207      ];</div><div class="FixedLine">208</div><div class="FixedLine">209      $this-&gt;post('/authors', $postData,</div><div class="FixedLine">210          ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">211</div><div class="FixedLine">212      $this-&gt;seeStatusCode(201);</div><div class="FixedLine">213      $this-&gt;seeInDatabase('authors', $postData);</div><div class="FixedLine">214  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-42.</span><div class="SimplePara">Adding Length Validation Tests for AuthorsController@store</div></div></div></div>
          </div><div id="Par113" class="Para">The two tests check the same max validation you added for the Book’s <span class="EmphasisFontCategoryNonProportional">title</span> column. To get these tests passing you need one-line change (Listing <span class="InternalRef"><a href="#Par114">10-43</a></span>). Run the tests again (Listing <span class="InternalRef"><a href="#Par115">10-44</a></span>).</div><div id="Par114" class="Para">
            <div class="ProgramCode" id="PC43"><div class="FixedLine">27  <span class="EmphasisTypeBold">public function</span> store(Request $request)</div><div class="FixedLine">28  {</div><div class="FixedLine">29      $this-&gt;validate($request, [</div><div class="FixedLine">30          <span class="EmphasisTypeBold">'name' =&gt; 'required|max:255',</span>
          </div><div class="FixedLine">31          'gender' =&gt; [</div><div class="FixedLine">32              'required',</div><div class="FixedLine">33              'regex:/^(male|female)$/i',</div><div class="FixedLine">34          ],</div><div class="FixedLine">35          'biography' =&gt; 'required'</div><div class="FixedLine">36      ], [</div><div class="FixedLine">37          'gender.regex' =&gt; "Gender format is invalid: must equal 'male' or 'female'"</div><div class="FixedLine">38      ]);</div><div class="FixedLine">39</div><div class="FixedLine">40      $author = Author::create($request-&gt;all());</div><div class="FixedLine">41      $data = $this-&gt;item($author, <span class="EmphasisTypeBold">new</span> AuthorTransformer());</div><div class="FixedLine">42</div><div class="FixedLine">43      <span class="EmphasisTypeBold">return</span> response()-&gt;json($data, 201);</div><div class="FixedLine">44  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-43.</span><div class="SimplePara">Adding Max Name Validation Rule</div></div></div></div>
          </div><div id="Par115" class="Para">
            <div class="ProgramCode" id="PC44"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (42 tests, 200 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-44.</span><div class="SimplePara">Running the Test Suite After Adding Max Validation</div></div></div></div>
          </div><div id="Par116" class="Para">You now have a solid endpoint for creating authors with valid data. Now you need to make sure that creating the author adds a <span class="EmphasisFontCategoryNonProportional">Location</span> header (Listing <span class="InternalRef"><a href="#Par117">10-45</a></span>).</div><div id="Par117" class="Para">
            <div class="ProgramCode" id="PC45"><div class="FixedLine">216  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">217  <span class="EmphasisTypeBold">public function</span> store_returns_a_valid_location_header()</div><div class="FixedLine">218  {</div><div class="FixedLine">219      $postData = [</div><div class="FixedLine">220          'name' =&gt; 'H. G. Wells',</div><div class="FixedLine">221          'gender' =&gt; 'male',</div><div class="FixedLine">222          'biography' =&gt; 'Prolific Science-Fiction Writer'</div><div class="FixedLine">223      ];</div><div class="FixedLine">224</div><div class="FixedLine">225      $this</div><div class="FixedLine">226          -&gt;post('/authors', $postData,</div><div class="FixedLine">227              ['Accept' =&gt; 'application/json'])</div><div class="FixedLine">228          -&gt;seeStatusCode(201);</div><div class="FixedLine">229</div><div class="FixedLine">230      $data = $this-&gt;response-&gt;getData(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">231      $this-&gt;assertArrayHasKey('data', $data);</div><div class="FixedLine">232      $this-&gt;assertArrayHasKey('id', $data['data']);</div><div class="FixedLine">233</div><div class="FixedLine">234      <span class="EmphasisTypeItalic">// Check the Location header</span>
          </div><div class="FixedLine">235      $id = $data['data']['id'];</div><div class="FixedLine">236     $this-&gt;seeHeaderWithRegExp('Location', "#/authors/<span class="EmphasisTypeBold">{</span>$id<span class="EmphasisTypeBold">}</span>$#");</div><div class="FixedLine">237  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-45.</span><div class="SimplePara">Test for the Location Header When an Author Is Created</div></div></div></div>
          </div><div id="Par118" class="Para">This test doesn’t need to check every detail since another test already covers checking the response data. The test focuses on asserting the value of the <span class="EmphasisFontCategoryNonProportional">Location</span> header and checks for a valid id. You use your custom <span class="EmphasisFontCategoryNonProportional">seeHeaderWithRegExp</span> assertion to make sure the location header is correct (Listing <span class="InternalRef"><a href="#Par119">10-46</a></span>).</div><div id="Par119" class="Para">
            <div class="ProgramCode" id="PC46"><div class="LineGroup"><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\AuthorsControllerTest::store_returns_a_valid_locat\</div><div class="FixedLine">ion_header</div><div class="FixedLine">Response should have the header 'Location' but does not.</div><div class="FixedLine">Failed asserting that false is true.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/tests/TestCase.php:29</div><div class="FixedLine">/home/vagrant/Code/bookr/tests/TestCase.php:45</div><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/AuthorsControllerTest.php:235</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 43, Assertions: 204, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-46.</span><div class="SimplePara">Running the Test Suite After Adding the Location Header Test</div></div></div></div>
          </div><div id="Par120" class="Para">The first code update you will make is defining the <span class="EmphasisFontCategoryNonProportional">GET /authors/id</span> route as a named route so you can more easily generate a route URL. Modify the route in <span class="EmphasisFontCategoryNonProportional">app/Http/routes.php</span> (Listing <span class="InternalRef"><a href="#Par121">10-47</a></span>).</div><div id="Par121" class="Para">
            <div class="ProgramCode" id="PC47"><div class="FixedLine">$app-&gt;group([</div><div class="FixedLine">    'prefix' =&gt; '/authors',</div><div class="FixedLine">    'namespace' =&gt; 'App\Http\Controllers'</div><div class="FixedLine">], <span class="EmphasisTypeBold">function</span> (\Laravel\Lumen\Application $app) {</div><div class="FixedLine">    <span class="EmphasisTypeItalic">// …</span>
          </div><div class="FixedLine">    $app-&gt;get('/{id:[\d]+}', [</div><div class="FixedLine">        'as' =&gt; 'authors.show',</div><div class="FixedLine">        'uses' =&gt; 'AuthorsController@show'</div><div class="FixedLine">    ]);</div><div class="FixedLine">    <span class="EmphasisTypeItalic">// ...</span>
          </div><div class="FixedLine">});</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-47.</span><div class="SimplePara">Making the Authors Route a Named Route</div></div></div></div>
          </div><div id="Par122" class="Para">Now you can add the <span class="EmphasisFontCategoryNonProportional">Location</span> header in the <span class="EmphasisFontCategoryNonProportional">AuthorsController@store</span> route (Listing <span class="InternalRef"><a href="#Par123">10-48</a></span>).</div><div id="Par123" class="Para">
            <div class="ProgramCode" id="PC48"><div class="FixedLine">27  <span class="EmphasisTypeBold">public function</span> store(Request $request)</div><div class="FixedLine">28  {</div><div class="FixedLine">29      $this-&gt;validate($request, [</div><div class="FixedLine">30          'name' =&gt; 'required|max:255',</div><div class="FixedLine">31          'gender' =&gt; [</div><div class="FixedLine">32              'required',</div><div class="FixedLine">33              'regex:/^(male|female)$/i',</div><div class="FixedLine">34          ],</div><div class="FixedLine">35          'biography' =&gt; 'required'</div><div class="FixedLine">36      ], [</div><div class="FixedLine">37          'gender.regex' =&gt; "Gender format is invalid: must equal 'male' or 'female'"</div><div class="FixedLine">38      ]);</div><div class="FixedLine">39</div><div class="FixedLine">40      $author = Author::create($request-&gt;all());</div><div class="FixedLine">41      $data = $this-&gt;item($author, <span class="EmphasisTypeBold">new</span> AuthorTransformer());</div><div class="FixedLine">42</div><div class="FixedLine">43      <span class="EmphasisTypeBold">return</span> response()-&gt;json($data, 201, [</div><div class="FixedLine">44          'Location' =&gt; route('authors.show', ['id' =&gt; $author-&gt;id])</div><div class="FixedLine">45      ]);</div><div class="FixedLine">46  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-48.</span><div class="SimplePara">Adding the Location Header in the AuthorsController</div></div></div></div>
          </div><div id="Par124" class="Para">Let’s see if your suite passes now (Listing <span class="InternalRef"><a href="#Par125">10-49</a></span>).</div><div id="Par125" class="Para">
            <div class="ProgramCode" id="PC49"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (43 tests, 205 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-49.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par126" class="Para ParaOneEmphasisChild">All features pass for the <span class="EmphasisFontCategoryNonProportional">POST /authors</span> endpoint!</div></div><div id="Sec8" class="Section1 RenderAsSection1"><h2 class="Heading">The PUT /authors/{id} Endpoint</h2><div id="Par127" class="Para">Next up is the ability to update an author. You will add the following features:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par128" class="Para">It will have the ability to change author name, gender, and biography.</div></li><li><div id="Par129" class="Para">It will have the ability to validate name, gender, and biography.</div></li><li><div id="Par130" class="Para ParaOneEmphasisChild">It should not match an invalid route, such as <span class="EmphasisFontCategoryNonProportional">/authors/foobar.</span>
            </div></li><li><div id="Par131" class="Para">It should 404 an invalid author.</div></li></ul></div>
      </div><div id="Par132" class="Para">You will start out by writing a test to update an author (Listing <span class="InternalRef"><a href="#Par133">10-50</a></span>).</div><div id="Par133" class="Para">
            <div class="ProgramCode" id="PC50"><div class="FixedLine">239  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">240  <span class="EmphasisTypeBold">public function</span> update_can_update_an_existing_author()</div><div class="FixedLine">241  {</div><div class="FixedLine">242      $author = factory(\App\Author::class)-&gt;create();</div><div class="FixedLine">243</div><div class="FixedLine">244      $requestData = [</div><div class="FixedLine">245          'name' =&gt; 'New Author Name',</div><div class="FixedLine">246          'gender' =&gt; $author-&gt;gender === 'male' ? 'female' : 'male',</div><div class="FixedLine">247          'biography' =&gt; 'An updated biography',</div><div class="FixedLine">248      ];</div><div class="FixedLine">249</div><div class="FixedLine">250      $this</div><div class="FixedLine">251          -&gt;put(</div><div class="FixedLine">252              "/authors/<span class="EmphasisTypeBold">{</span>$author-&gt;id<span class="EmphasisTypeBold">}</span>",</div><div class="FixedLine">253              $requestData,</div><div class="FixedLine">254              ['Accept' =&gt; 'application/json']</div><div class="FixedLine">255          )</div><div class="FixedLine">256          -&gt;seeStatusCode(200)</div><div class="FixedLine">257          -&gt;seeJson($requestData)</div><div class="FixedLine">258          -&gt;seeInDatabase('authors', [</div><div class="FixedLine">259              'name' =&gt; 'New Author Name'</div><div class="FixedLine">260          ])</div><div class="FixedLine">261          -&gt;notSeeInDatabase('authors', [</div><div class="FixedLine">262              'name' =&gt; $author-&gt;name</div><div class="FixedLine">263          ]);</div><div class="FixedLine">264</div><div class="FixedLine">265      $this-&gt;assertArrayHasKey('data', $this-&gt;response-&gt;getData(<span class="EmphasisTypeBold">true</span>));</div><div class="FixedLine">266  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-50.</span><div class="SimplePara">Test to Successfully Update an Author</div></div></div></div>
          </div><div id="Par134" class="Para ParaOneEmphasisChild">Your test updates all the author fields and then chains assertions together to ensure the proper status code and that the response has correct author data. Next, the test asserts that the updated record is found in the database and that the old author data is not found. Lastly, you continue to ensure your API contains a <span class="EmphasisFontCategoryNonProportional">data</span> key.</div><div id="Par135" class="Para">The minimum code needed to get the controller passing is in Listing <span class="InternalRef"><a href="#Par136">10-51</a></span>.</div><div id="Par136" class="Para">
            <div class="ProgramCode" id="PC51"><div class="FixedLine">48  <span class="EmphasisTypeBold">public function</span> update(Request $request, $id)</div><div class="FixedLine">49  {</div><div class="FixedLine">50      $author = Author::findOrFail($id);</div><div class="FixedLine">51</div><div class="FixedLine">52      $author-&gt;fill($request-&gt;all());</div><div class="FixedLine">53      $author-&gt;save();</div><div class="FixedLine">54</div><div class="FixedLine">55      $data = $this-&gt;item($author, <span class="EmphasisTypeBold">new</span> AuthorTransformer());</div><div class="FixedLine">56</div><div class="FixedLine">57      <span class="EmphasisTypeBold">return</span> response()-&gt;json($data, 200);</div><div class="FixedLine">58  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-51.</span><div class="SimplePara">Writing the AuthorsController@update Code</div></div></div></div>
          </div><div id="Par137" class="Para">The code in <span class="EmphasisFontCategoryNonProportional">AuthorsController@update</span> should be familiar. Let’s see if it passes (Listing <span class="InternalRef"><a href="#Par138">10-52</a></span>).</div><div id="Par138" class="Para">
            <div class="ProgramCode" id="PC52"><div class="LineGroup"><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (44 tests, 212 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-52.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par139" class="Para">Next up is validation testing. The validation rules will be the same as the <span class="EmphasisFontCategoryNonProportional">AuthorsController@store</span> method, so let’s refactor both methods to use the same rules. With your tests passing, let’s refactor the validation out of the <span class="EmphasisFontCategoryNonProportional">@store</span> method. You will write a <span class="EmphasisFontCategoryNonProportional">private</span> method at the end of the <span class="EmphasisFontCategoryNonProportional">AuthorsController</span> to deal with validation (Listing <span class="InternalRef"><a href="#Par140">10-53</a></span>).</div><div id="Par140" class="Para">
            <div class="ProgramCode" id="PC53"><div class="FixedLine">60  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">61   <span class="EmphasisTypeItalic">* Validate author updates from the request.</span>
          </div><div class="FixedLine">62   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">63   <span class="EmphasisTypeItalic">* @param Request $request</span>
          </div><div class="FixedLine">64   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">65  <span class="EmphasisTypeBold">private function</span> validateAuthor(Request $request)</div><div class="FixedLine">66  {</div><div class="FixedLine">67      $this-&gt;validate($request, [</div><div class="FixedLine">68          'name' =&gt; 'required|max:255',</div><div class="FixedLine">69          'gender' =&gt; [</div><div class="FixedLine">70              'required',</div><div class="FixedLine">71              'regex:/^(male|female)$/i',</div><div class="FixedLine">72          ],</div><div class="FixedLine">73          'biography' =&gt; 'required'</div><div class="FixedLine">74      ], [</div><div class="FixedLine">75          'gender.regex' =&gt; "Gender format is invalid: must equal 'male' or 'female'"</div><div class="FixedLine">76      ]);</div><div class="FixedLine">77  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-53.</span><div class="SimplePara">Custom Method for Author Validation</div></div></div></div>
          </div><div id="Par141" class="Para">Nothing new in this method; you just copied the original <span class="EmphasisFontCategoryNonProportional">AuthorsController@store</span> validation code into a <span class="EmphasisFontCategoryNonProportional">private</span> method. Let’s use the <span class="EmphasisFontCategoryNonProportional">validateAuthor()</span> method in the <span class="EmphasisFontCategoryNonProportional">@store</span> controller method (Listing <span class="InternalRef"><a href="#Par142">10-54</a></span>).</div><div id="Par142" class="Para">
            <div class="ProgramCode" id="PC54"><div class="FixedLine">27  <span class="EmphasisTypeBold">public function</span> store(Request $request)</div><div class="FixedLine">28  {</div><div class="FixedLine">29      <span class="EmphasisTypeBold">$this-&gt;validateAuthor($request);</span>
          </div><div class="FixedLine">30</div><div class="FixedLine">31      $author = Author::create($request-&gt;all());</div><div class="FixedLine">32      $data = $this-&gt;item($author, <span class="EmphasisTypeBold">new</span> AuthorTransformer());</div><div class="FixedLine">33</div><div class="FixedLine">34      <span class="EmphasisTypeBold">return</span> response()-&gt;json($data, 201, [</div><div class="FixedLine">35          'Location' =&gt; route('authors.show', ['id' =&gt; $author-&gt;id])</div><div class="FixedLine">36      ]);</div><div class="FixedLine">37  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-54.</span><div class="SimplePara">Refactoring the AuthorsController@store Method</div></div></div></div>
          </div><div id="Par143" class="Para">Let’s see if the code passes the tests (Listing <span class="InternalRef"><a href="#Par144">10-55</a></span>).</div><div id="Par144" class="Para">
            <div class="ProgramCode" id="PC55"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (44 tests, 212 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-55.</span><div class="SimplePara">See If Tests Pass After the Refactor</div></div></div></div>
          </div><div id="Par145" class="Para">Your code passes the tests, so you can write the next validation tests for the <span class="EmphasisFontCategoryNonProportional">AuthorsController@update</span> method (Listing <span class="InternalRef"><a href="#Par146">10-56</a></span>).</div><div id="Par146" class="Para">
            <div class="ProgramCode" id="PC56"><div class="FixedLine">268  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">269  <span class="EmphasisTypeBold">public function</span> update_method_validates_required_fields()</div><div class="FixedLine">270  {</div><div class="FixedLine">271      $author = factory(\App\Author::class)-&gt;create();</div><div class="FixedLine">272      $this-&gt;put("/authors/<span class="EmphasisTypeBold">{</span>$author-&gt;id<span class="EmphasisTypeBold">}</span>", [], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">273      $this-&gt;seeStatusCode(422);</div><div class="FixedLine">274      $data = $this-&gt;response-&gt;getData(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">275</div><div class="FixedLine">276      $fields = ['name', 'gender', 'biography'];</div><div class="FixedLine">277</div><div class="FixedLine">278      <span class="EmphasisTypeBold">foreach</span> ($fields <span class="EmphasisTypeBold">as</span> $field) {</div><div class="FixedLine">279          $this-&gt;assertArrayHasKey($field, $data);</div><div class="FixedLine">280          $this-&gt;assertEquals(["The <span class="EmphasisTypeBold">{</span>$field<span class="EmphasisTypeBold">}</span> field is required."], $data[$field]);</div><div class="FixedLine">281      }</div><div class="FixedLine">282  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-56.</span><div class="SimplePara">Writing a Test for AuthorsController@update Validation</div></div></div></div>
          </div><div id="Par147" class="Para">Now, run the test suite to verify that your new validation test fails (Listing <span class="InternalRef"><a href="#Par148">10-57</a></span>).</div><div id="Par148" class="Para">
            <div class="ProgramCode" id="PC57"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\AuthorsControllerTest::update_method_validates_req\</div><div class="FixedLine">uired_fields</div><div class="FixedLine">Failed asserting that 200 matches expected 422.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/vendor/laravel/lumen-framework/src/Testing/CrawlerTrait\</div><div class="FixedLine">.php:412</div><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/AuthorsControllerTest.php:273</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 45, Assertions: 213, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-57.</span><div class="SimplePara">Testing the Update Validation Method</div></div></div></div>
          </div><div id="Par149" class="Para">You can now use your refactored validation to make the new test pass (Listing <span class="InternalRef"><a href="#Par150">10-58</a></span>).</div><div id="Par150" class="Para">
            <div class="ProgramCode" id="PC58"><div class="FixedLine">39  <span class="EmphasisTypeBold">public function</span> update(Request $request, $id)</div><div class="FixedLine">40  {</div><div class="FixedLine">41      $this-&gt;validateAuthor($request);</div><div class="FixedLine">42      $author = Author::findOrFail($id);</div><div class="FixedLine">43</div><div class="FixedLine">44      $author-&gt;fill($request-&gt;all());</div><div class="FixedLine">45      $author-&gt;save();</div><div class="FixedLine">46</div><div class="FixedLine">47      $data = $this-&gt;item($author, <span class="EmphasisTypeBold">new</span> AuthorTransformer());</div><div class="FixedLine">48</div><div class="FixedLine">49      <span class="EmphasisTypeBold">return</span> response()-&gt;json($data, 200);</div><div class="FixedLine">50  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-58.</span><div class="SimplePara">Using the New validateAuthor() Method</div></div></div></div>
          </div><div id="Par151" class="Para">Your test suite should be back to green (Listing <span class="InternalRef"><a href="#Par152">10-59</a></span>).</div><div id="Par152" class="Para">
            <div class="ProgramCode" id="PC59"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (45 tests, 219 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-59.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par153" class="Para">Another thing you can clean up is the duplicated test code for validating an author. Let’s refactor your tests to test both the <span class="EmphasisFontCategoryNonProportional">@update</span> and <span class="EmphasisFontCategoryNonProportional">@store</span> methods at the same time. You can start by refactoring the <span class="EmphasisFontCategoryNonProportional">store_method_validates_required_fields</span> test in the <span class="EmphasisFontCategoryNonProportional">AuthorsControllerTest</span> (Listing <span class="InternalRef"><a href="#Par154">10-60</a></span>).</div><div id="Par154" class="Para">
            <div class="ProgramCode" id="PC60"><div class="FixedLine">140  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">141  <span class="EmphasisTypeBold">public function</span> validation_validates_required_fields()</div><div class="FixedLine">142  {</div><div class="FixedLine">143      $author = factory(\App\Author::class)-&gt;create();</div><div class="FixedLine">144      $tests = [</div><div class="FixedLine">145          ['method' =&gt; 'post', 'url' =&gt; '/authors'],</div><div class="FixedLine">146          ['method' =&gt; 'put', 'url' =&gt; "/authors/<span class="EmphasisTypeBold">{</span>$author-&gt;id<span class="EmphasisTypeBold">}</span>"],</div><div class="FixedLine">147      ];</div><div class="FixedLine">148</div><div class="FixedLine">149      <span class="EmphasisTypeBold">foreach</span> ($tests <span class="EmphasisTypeBold">as</span> $test) {</div><div class="FixedLine">150          $method = $test['method'];</div><div class="FixedLine">151          $this-&gt;{$method}($test['url'], [], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">152          $this-&gt;seeStatusCode(422);</div><div class="FixedLine">153          $data = $this-&gt;response-&gt;getData(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">154</div><div class="FixedLine">155          $fields = ['name', 'gender', 'biography'];</div><div class="FixedLine">156</div><div class="FixedLine">157          <span class="EmphasisTypeBold">foreach</span> ($fields <span class="EmphasisTypeBold">as</span> $field) {</div><div class="FixedLine">158              $this-&gt;assertArrayHasKey($field, $data);</div><div class="FixedLine">159              $this-&gt;assertEquals(["The <span class="EmphasisTypeBold">{</span>$field<span class="EmphasisTypeBold">}</span> field is required."], $data[$field]);</div><div class="FixedLine">160          }</div><div class="FixedLine">161      }</div><div class="FixedLine">162 }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-60.</span><div class="SimplePara">Testing the Create and Update Validation Fields</div></div></div></div>
          </div><div id="Par155" class="Para">Note that the method name has been updated to reflect the scope of the test after refactoring. The <span class="EmphasisFontCategoryNonProportional">$tests</span> array defines the outline for testing both <span class="EmphasisFontCategoryNonProportional">@create</span> and <span class="EmphasisFontCategoryNonProportional">@update</span> validation. The <span class="EmphasisFontCategoryNonProportional">foreach</span> is basically the same as the original test except that now the tests use the dynamic values from the <span class="EmphasisFontCategoryNonProportional">$tests</span> array.</div><div id="Par156" class="Para">All of your tests should still be passing at this point if you want to run the test suite before you start refactoring the next test. The next test you will refactor is the <span class="EmphasisFontCategoryNonProportional">store_invalidates_incorrect_gender_data</span> test in the same file (Listing <span class="InternalRef"><a href="#Par157">10-61</a></span>).</div><div id="Par157" class="Para">
            <div class="ProgramCode" id="PC61"><div class="FixedLine">164  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">165  <span class="EmphasisTypeBold">public function</span> validation_invalidates_incorrect_gender_data()</div><div class="FixedLine">166  {</div><div class="FixedLine">167      $author = factory(\App\Author::class)-&gt;create();</div><div class="FixedLine">168      $tests = [</div><div class="FixedLine">169          <span class="EmphasisTypeItalic">// Create</span>
          </div><div class="FixedLine">170          [</div><div class="FixedLine">171              'method' =&gt; 'post',</div><div class="FixedLine">172              'url' =&gt; '/authors',</div><div class="FixedLine">173              'data' =&gt; [</div><div class="FixedLine">174                  'name' =&gt; 'John Doe',</div><div class="FixedLine">175                  'biography' =&gt; 'An anonymous author'</div><div class="FixedLine">176              ]</div><div class="FixedLine">177          ],</div><div class="FixedLine">178</div><div class="FixedLine">179          <span class="EmphasisTypeItalic">// Update</span>
          </div><div class="FixedLine">180          [</div><div class="FixedLine">181              'method' =&gt; 'put',</div><div class="FixedLine">182              'url' =&gt; "/authors/<span class="EmphasisTypeBold">{</span>$author-&gt;id<span class="EmphasisTypeBold">}</span>",</div><div class="FixedLine">183              'data' =&gt; [</div><div class="FixedLine">184                  'name' =&gt; $author-&gt;name,</div><div class="FixedLine">185                  'biography' =&gt; $author-&gt;biography</div><div class="FixedLine">186              ]</div><div class="FixedLine">187          ]</div><div class="FixedLine">188      ];</div><div class="FixedLine">189</div><div class="FixedLine">190      <span class="EmphasisTypeBold">foreach</span> ($tests <span class="EmphasisTypeBold">as</span> $test) {</div><div class="FixedLine">191          $method = $test['method'];</div><div class="FixedLine">192          $test['data']['gender'] = 'unknown';</div><div class="FixedLine">193          $this-&gt;{$method}($test['url'], $test['data'], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">194</div><div class="FixedLine">195          $this-&gt;seeStatusCode(422);</div><div class="FixedLine">196</div><div class="FixedLine">197          $data = $this-&gt;response-&gt;getData(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">198          $this-&gt;assertCount(1, $data);</div><div class="FixedLine">299          $this-&gt;assertArrayHasKey('gender', $data);</div><div class="FixedLine">200          $this-&gt;assertEquals(</div><div class="FixedLine">201              ["Gender format is invalid: must equal 'male' or 'female'"],</div><div class="FixedLine">202              $data['gender']</div><div class="FixedLine">203          );</div><div class="FixedLine">204      }</div><div class="FixedLine">205  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-61.</span><div class="SimplePara">Refactoring Invalid Gender Test</div></div></div></div>
          </div><div id="Par158" class="Para">Let’s run your test suite to see if your code still passes the tests (Listing <span class="InternalRef"><a href="#Par159">10-62</a></span>).</div><div id="Par159" class="Para">
            <div class="ProgramCode" id="PC62"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (45 tests, 231 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-62.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par160" class="Para">Onto refactoring the next test: the <span class="EmphasisFontCategoryNonProportional">store_invalidates_name_when_name_is_just_too_long</span> test, which you will rename since it’s testing create and update (Listing <span class="InternalRef"><a href="#Par161">10-63</a></span>).</div><div id="Par161" class="Para">
            <div class="ProgramCode" id="PC63"><div class="FixedLine">207  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">208  <span class="EmphasisTypeBold">public function</span> validation_invalidates_name_when_name_is_just_too_long()</div><div class="FixedLine">209  {</div><div class="FixedLine">210      $author = factory(\App\Author::class)-&gt;create();</div><div class="FixedLine">211      $tests = [</div><div class="FixedLine">212          <span class="EmphasisTypeItalic">// Create</span>
          </div><div class="FixedLine">213          [</div><div class="FixedLine">214              'method' =&gt; 'post',</div><div class="FixedLine">215              'url' =&gt; '/authors',</div><div class="FixedLine">216              'data' =&gt; [</div><div class="FixedLine">217                  'name' =&gt; 'John Doe',</div><div class="FixedLine">218                  'gender' =&gt; 'male',</div><div class="FixedLine">219                  'biography' =&gt; 'An anonymous author'</div><div class="FixedLine">220              ]</div><div class="FixedLine">221          ],</div><div class="FixedLine">222</div><div class="FixedLine">223          <span class="EmphasisTypeItalic">// Update</span>
          </div><div class="FixedLine">224          [</div><div class="FixedLine">225              'method' =&gt; 'put',</div><div class="FixedLine">226              'url' =&gt; "/authors/<span class="EmphasisTypeBold">{</span>$author-&gt;id<span class="EmphasisTypeBold">}</span>",</div><div class="FixedLine">227              'data' =&gt; [</div><div class="FixedLine">228                  'name' =&gt; $author-&gt;name,</div><div class="FixedLine">229                  'gender' =&gt; $author-&gt;gender,</div><div class="FixedLine">230                  'biography' =&gt; $author-&gt;biography</div><div class="FixedLine">231              ]</div><div class="FixedLine">232          ]</div><div class="FixedLine">233      ];</div><div class="FixedLine">234</div><div class="FixedLine">235      <span class="EmphasisTypeBold">foreach</span> ($tests <span class="EmphasisTypeBold">as</span> $test) {</div><div class="FixedLine">236          $method = $test['method'];</div><div class="FixedLine">237          $test['data']['name'] = str_repeat('a', 256);</div><div class="FixedLine">238</div><div class="FixedLine">239          $this-&gt;{$method}($test['url'], $test['data'], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">240</div><div class="FixedLine">241          $this-&gt;seeStatusCode(422);</div><div class="FixedLine">242</div><div class="FixedLine">243          $data = $this-&gt;response-&gt;getData(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">244          $this-&gt;assertCount(1, $data);</div><div class="FixedLine">245          $this-&gt;assertArrayHasKey('name', $data);</div><div class="FixedLine">246          $this-&gt;assertEquals(["The name may not be greater than 255 characters."], $data['name']);</div><div class="FixedLine">247      }</div><div class="FixedLine">248  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-63.</span><div class="SimplePara">Refactoring Test When the Name is Just Too Long</div></div></div></div>
          </div><div id="Par162" class="Para">Your tests are still passing at this point and you have one more validation-related test to refactor. Before you finish the final test, it’s noticeable how much your refactor data is exactly the same in each validation test. Let’s extract a method for the data at the end of the <span class="EmphasisFontCategoryNonProportional">AuthorsControllerTest</span> (Listing <span class="InternalRef"><a href="#Par163">10-64</a></span>).</div><div id="Par163" class="Para">
            <div class="ProgramCode" id="PC64"><div class="FixedLine">334  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">335   <span class="EmphasisTypeItalic">* Provides boilerplate test instructions for validation.</span>
          </div><div class="FixedLine">336   <span class="EmphasisTypeItalic">* @return array</span>
          </div><div class="FixedLine">337   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">338  <span class="EmphasisTypeBold">private function</span> getValidationTestData()</div><div class="FixedLine">339  {</div><div class="FixedLine">340      $author = factory(\App\Author::class)-&gt;create();</div><div class="FixedLine">341      <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">342          <span class="EmphasisTypeItalic">// Create</span>
          </div><div class="FixedLine">343          [</div><div class="FixedLine">344              'method' =&gt; 'post',</div><div class="FixedLine">345              'url' =&gt; '/authors',</div><div class="FixedLine">346              'status' =&gt; 201,</div><div class="FixedLine">347              'data' =&gt; [</div><div class="FixedLine">348                  'name' =&gt; 'John Doe',</div><div class="FixedLine">349                  'gender' =&gt; 'male',</div><div class="FixedLine">350                  'biography' =&gt; 'An anonymous author'</div><div class="FixedLine">351              ]</div><div class="FixedLine">352          ],</div><div class="FixedLine">353</div><div class="FixedLine">354          <span class="EmphasisTypeItalic">// Update</span>
          </div><div class="FixedLine">355          [</div><div class="FixedLine">356              'method' =&gt; 'put',</div><div class="FixedLine">357              'url' =&gt; "/authors/<span class="EmphasisTypeBold">{</span>$author-&gt;id<span class="EmphasisTypeBold">}</span>",</div><div class="FixedLine">358              'status' =&gt; 200,</div><div class="FixedLine">359              'data' =&gt; [</div><div class="FixedLine">360                  'name' =&gt; $author-&gt;name,</div><div class="FixedLine">361                  'gender' =&gt; $author-&gt;gender,</div><div class="FixedLine">362                  'biography' =&gt; $author-&gt;biography</div><div class="FixedLine">363              ]</div><div class="FixedLine">364          ]</div><div class="FixedLine">365      ];</div><div class="FixedLine">366  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-64.</span><div class="SimplePara">Extract Boilerplate Validation Data</div></div></div></div>
          </div><div id="Par164" class="Para ParaOneEmphasisChild">The only thing to note in the new method is the <span class="EmphasisFontCategoryNonProportional">status</span> key, which allows a validation test that succeeds to test the status code for each type of operation.</div><div id="Par165" class="Para">Now that you have the new <span class="EmphasisFontCategoryNonProportional">getValidationTestData()</span> method, let’s drop it in to your tests (Listing <span class="InternalRef"><a href="#Par166">10-65</a></span>).</div><div id="Par166" class="Para">
            <div class="ProgramCode" id="PC65"><div class="FixedLine">164  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">165  <span class="EmphasisTypeBold">public function</span> validation_invalidates_incorrect_gender_data()</div><div class="FixedLine">166  {</div><div class="FixedLine">167      <span class="EmphasisTypeBold">foreach</span> ($this-&gt;getValidationTestData() <span class="EmphasisTypeBold">as</span> $test) {</div><div class="FixedLine">168          $method = $test['method'];</div><div class="FixedLine">169          $test['data']['gender'] = 'unknown';</div><div class="FixedLine">170          $this-&gt;{$method}($test['url'], $test['data'], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">172</div><div class="FixedLine">173          $this-&gt;seeStatusCode(422);</div><div class="FixedLine">174</div><div class="FixedLine">175          $data = $this-&gt;response-&gt;getData(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">176          $this-&gt;assertCount(1, $data);</div><div class="FixedLine">177          $this-&gt;assertArrayHasKey('gender', $data);</div><div class="FixedLine">178          $this-&gt;assertEquals(</div><div class="FixedLine">179              ["Gender format is invalid: must equal 'male' or 'female'"],</div><div class="FixedLine">180              $data['gender']</div><div class="FixedLine">181          );</div><div class="FixedLine">182      }</div><div class="FixedLine">183  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-65.</span><div class="SimplePara">Updated Gender Validation Test</div></div></div></div>
          </div><div id="Par167" class="Para">Now let’s try using your new method in the <span class="EmphasisFontCategoryNonProportional">store_is_valid_when_name_is_just_long_enough</span> test and rename it to match its new purpose (Listing <span class="InternalRef"><a href="#Par168">10-66</a></span>).</div><div id="Par168" class="Para">
            <div class="ProgramCode" id="PC66"><div class="FixedLine">227  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">228  <span class="EmphasisTypeBold">public function</span> validation_is_valid_when_name_is_just_long_enough()</div><div class="FixedLine">229  {</div><div class="FixedLine">230      <span class="EmphasisTypeBold">foreach</span> ($this-&gt;getValidationTestData() <span class="EmphasisTypeBold">as</span> $test) {</div><div class="FixedLine">231          $method = $test['method'];</div><div class="FixedLine">232          $test['data']['name'] = str_repeat('a', 255);</div><div class="FixedLine">233</div><div class="FixedLine">234          $this-&gt;{$method}($test['url'], $test['data'], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">235</div><div class="FixedLine">236          $this-&gt;seeStatusCode($test['status']);</div><div class="FixedLine">237          $this-&gt;seeInDatabase('authors', $test['data']);</div><div class="FixedLine">238      }</div><div class="FixedLine">239  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-66.</span><div class="SimplePara">Refactored Test When the Name is Just Long Enough</div></div></div></div>
          </div><div id="Par169" class="Para">With your refactored test using the new <span class="EmphasisFontCategoryNonProportional">getValidationTestData()</span> your test is straightforward. Now let’s update the <span class="EmphasisFontCategoryNonProportional">validation_invalidates_name_when_name_is_just_too_long</span> to use your new method (Listing <span class="InternalRef"><a href="#Par170">10-67</a></span>).</div><div id="Par170" class="Para">
            <div class="ProgramCode" id="PC67"><div class="FixedLine">184  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">185  <span class="EmphasisTypeBold">public function</span> validation_invalidates_name_when_name_is_just_too_long()</div><div class="FixedLine">186  {</div><div class="FixedLine">187      <span class="EmphasisTypeBold">foreach</span> ($this-&gt;getValidationTestData() <span class="EmphasisTypeBold">as</span> $test) {</div><div class="FixedLine">188          $method = $test['method'];</div><div class="FixedLine">189          $test['data']['name'] = str_repeat('a', 256);</div><div class="FixedLine">190</div><div class="FixedLine">191          $this-&gt;{$method}($test['url'], $test['data'], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">192</div><div class="FixedLine">193          $this-&gt;seeStatusCode(422);</div><div class="FixedLine">194</div><div class="FixedLine">195          $data = $this-&gt;response-&gt;getData(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">196          $this-&gt;assertCount(1, $data);</div><div class="FixedLine">197          $this-&gt;assertArrayHasKey('name', $data);</div><div class="FixedLine">198          $this-&gt;assertEquals(["The name may not be greater than 255 characters."], $data['name']);</div><div class="FixedLine">299      }</div><div class="FixedLine">200  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-67.</span><div class="SimplePara">Updated Test When Name is Just Too Long</div></div></div></div>
          </div><div id="Par171" class="Para">Now that validation covers both creating and updating, you can remove the <span class="EmphasisFontCategoryNonProportional">update_method_validates_required_fields</span> test you originally started writing and then ensure the code passes the full test suite (Listing <span class="InternalRef"><a href="#Par172">10-68</a></span>).</div><div id="Par172" class="Para">
            <div class="ProgramCode" id="PC68"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (45 tests, 237 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-68.</span><div class="SimplePara">Running the Test Suite After Refactoring</div></div></div></div>
          </div><div id="Par173" class="Para">The refactoring of the <span class="EmphasisFontCategoryNonProportional">AuthorsController</span> and <span class="EmphasisFontCategoryNonProportional">AuthorsControllerTest</span> has the code looking really clean. Your test coverage allowed you to rip out duplicate code and have confidence that things are still working.</div></div><div id="Sec9" class="Section1 RenderAsSection1"><h2 class="Heading">The DELETE /authors/{id} Endpoint</h2><div id="Par174" class="Para">The last author endpoint you will work on in this chapter is the <span class="EmphasisFontCategoryNonProportional">DELETE /authors/{id}</span> route. If you recall the schema design of the <span class="EmphasisFontCategoryNonProportional">books</span> table, you added a foreign key constraint to the <span class="EmphasisFontCategoryNonProportional">author_id</span> field that will <span class="EmphasisFontCategoryNonProportional">CASCADE</span> when an author is deleted. This means that when your author is deleted, all the books associated with that author will be deleted.</div><div id="Par175" class="Para">You have simple criteria for your first test:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par176" class="Para ParaOneEmphasisChild">The author should not exist in the <span class="EmphasisFontCategoryNonProportional">authors</span> table after delete.</div></li><li><div id="Par177" class="Para ParaOneEmphasisChild">No books with the author’s id should exist in the <span class="EmphasisFontCategoryNonProportional">books</span> table.</div></li><li><div id="Par178" class="Para">A 204 status code should be returned with no content when the delete succeeds.</div></li></ul></div>
      </div><div id="Par179" class="Para">You will add your remaining tests above the <span class="EmphasisFontCategoryNonProportional">private</span> function <span class="EmphasisFontCategoryNonProportional">getValidationTestdata()</span> method to keep the test organized (Listing <span class="InternalRef"><a href="#Par180">10-69</a></span>).</div><div id="Par180" class="Para">
            <div class="ProgramCode" id="PC69"><div class="FixedLine">284  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">285  <span class="EmphasisTypeBold">public function</span> delete_can_remove_an_author_and_his_or_her_books()</div><div class="FixedLine">286  {</div><div class="FixedLine">287      $author = factory(\App\Author::class)-&gt;create();</div><div class="FixedLine">288</div><div class="FixedLine">289      $this</div><div class="FixedLine">290          -&gt;delete("/authors/<span class="EmphasisTypeBold">{</span>$author-&gt;id<span class="EmphasisTypeBold">}</span>")</div><div class="FixedLine">291          -&gt;seeStatusCode(204)</div><div class="FixedLine">292          -&gt;notSeeInDatabase('authors', ['id' =&gt; $author-&gt;id])</div><div class="FixedLine">293          -&gt;notSeeInDatabase('books', ['author_id' =&gt; $author-&gt;id]);</div><div class="FixedLine">294  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-69.</span><div class="SimplePara">Successful Delete Test</div></div></div></div>
          </div><div id="Par181" class="Para">And the <span class="EmphasisFontCategoryNonProportional">@destroy</span> implementation above the <span class="EmphasisFontCategoryNonProportional">private validateAuthor()</span> method (Listing <span class="InternalRef"><a href="#Par182">10-70</a></span>).</div><div id="Par182" class="Para">
            <div class="ProgramCode" id="PC70"><div class="FixedLine">52  <span class="EmphasisTypeBold">public function</span> destroy($id)</div><div class="FixedLine">53  {</div><div class="FixedLine">54      Author::findOrFail($id)-&gt;delete();</div><div class="FixedLine">55</div><div class="FixedLine">56      <span class="EmphasisTypeBold">return</span> response(<span class="EmphasisTypeBold">null</span>, 204);</div><div class="FixedLine">57  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-70.</span><div class="SimplePara">Implementing the AuthorsController@destroy Method</div></div></div></div>
          </div><div id="Par183" class="Para">The final test ensures that a 404 response is returned when an invalid author id is passed (Listing <span class="InternalRef"><a href="#Par184">10-71</a></span>).</div><div id="Par184" class="Para">
            <div class="ProgramCode" id="PC71"><div class="FixedLine">296  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">297  <span class="EmphasisTypeBold">public function</span> deleting_an_invalid_author_should_return_a_404()</div><div class="FixedLine">298  {</div><div class="FixedLine">299      $this</div><div class="FixedLine">300          -&gt;delete('/authors/99999', [], ['Accept' =&gt; 'application/json'])</div><div class="FixedLine">301          -&gt;seeStatusCode(404);</div><div class="FixedLine">302  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-71.</span><div class="SimplePara">Test Trying to Delete an Invalid ID</div></div></div></div>
          </div><div id="Par185" class="Para">This test already passes because you used <span class="EmphasisFontCategoryNonProportional">findOurFail($id)</span> but you will keep it anyway just in case things change in the future. You could replace the <span class="EmphasisFontCategoryNonProportional">findOrFail()</span> with <span class="EmphasisFontCategoryNonProportional">find()</span> to see the failure if you want to experiment before replacing it with <span class="EmphasisFontCategoryNonProportional">findOrFail()</span>.</div><div id="Par186" class="Para">Let’s run the test suite before concluding the chapter (Listing <span class="InternalRef"><a href="#Par187">10-72</a></span>).</div><div id="Par187" class="Para">
            <div class="ProgramCode" id="PC72"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (47 tests, 241 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 10-72.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div class="Para ParaTypeImportant">
        <img src="A395120_1_En_10_Figa_HTML.jpg" alt="A395120_1_En_10_Figa_HTML.jpg"/> Git Commit: Add the Authors Resource API</div><div class="Para ParaTypeImportant">b06c563 (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/b06c563"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/b06c563</span>
              </span></a></span>)</div></div><div id="Sec10" class="Section1 RenderAsSection1"><h2 class="Heading">Conclusion</h2><div id="Par190" class="Para ParaOneEmphasisChild">You are done with the basics of the <span class="EmphasisFontCategoryNonProportional">/authors</span> routes and this chapter! The biggest thing introduced in this chapter was how to include associated entity data in responses with Fractal. You also got lots of practice refactoring methods and tests, and making sure things still pass afterwards.</div><div id="Par191" class="Para">Now that you have two working entities, in the next chapter you will use existing entities to build out a book bundles feature. The chapter will also introduce how to add multiple entity associations in a many-to-many relationship through the API. You will also cover embedded relationships.</div></div></div></body></html>
