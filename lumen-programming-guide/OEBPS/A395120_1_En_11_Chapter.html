<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>Book Bundles</title><link href="springer_epub.css" type="text/css" rel="styleSheet"/></head><body><div class="ChapterContextInformation"><div class="ContextInformation" id="b978-1-4842-2187-7_11"><div class="ChapterCopyright">© Paul Redmond 2016</div><span class="ContextInformationAuthorEditorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span></span></span><span class="ContextInformationBookTitles"><span class="BookTitle" xml:lang="en">Lumen Programming Guide</span></span><span class="ChapterDOI">10.1007/978-1-4842-2187-7_11</span></div></div><!--Begin Abstract--><div class="MainTitleSection"><h1 class="ChapterTitle" xml:lang="en">11. Book Bundles</h1></div><div class="AuthorGroup"><div class="AuthorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span><sup>1 <span class="ContactIcon"/></sup></span></div><div class="Affiliations"><div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">Phoenix, Arizona, USA</div></div><div class="ClearBoth"> </div></div></div><!--End Abstract--><div class="Fulltext"><div id="Par1" class="Para">In this chapter, you will be building a simple book bundle implementation. A book bundle is basically a collection of books bundled together under a common theme. For example, a “Database Primer” book bundle might include books about database design, database theory, and database administration.</div><div id="Par2" class="Para">The outline for the API endpoints you will cover this chapter will be as shown in Listing <span class="InternalRef"><a href="#Par3">11-1</a></span>.</div><div id="Par3" class="Para">
          <div class="ProgramCode" id="PC1"><div class="FixedLine">GET    /bundles/{id} Get individual bundle details</div><div class="FixedLine">PUT    /bundles/{id}/books/{bookId} Add a Book to a Bundle</div><div class="FixedLine">DELETE /bundles/{id}/books/{bookId} Remove a Book from a Bundle</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-1.</span><div class="SimplePara">Basic REST /Bundles Endpoints</div></div></div></div>
        </div><div id="Par4" class="Para">Your book routes in Listing <span class="InternalRef"><a href="#Par3">11-1</a></span> are <span class="EmphasisTypeItalic">nested REST resources</span>, meaning they represent books in the context of the <span class="EmphasisFontCategoryNonProportional">/bundles</span> functionality. You will use these nested resources to manage adding and removing books from bundles.</div><div id="Par5" class="Para">You won’t code basic CRUD endpoints for <span class="EmphasisFontCategoryNonProportional">/bundles</span> in this chapter—you should be equipped with enough knowledge to complete CRUD endpoints for <span class="EmphasisFontCategoryNonProportional">/bundles</span> on your own. The focus of this chapter will be on new functionality you haven’t learned yet.</div><div id="Sec1" class="Section1 RenderAsSection1"><h2 class="Heading">Defining the Relationship Between Books and Bundles</h2><div id="Par6" class="Para">The <span class="EmphasisFontCategoryNonProportional">Bundle</span> and <span class="EmphasisFontCategoryNonProportional">Book</span> model relationship will be a many-to-many (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/eloquent-relationships#many-to-many"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/eloquent-relationships#many-to-many</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> relationship—you may also know this relationship as “has and belongs to many” (HABTM). It is reasonable that one book could be included in multiple bundles, and that a bundle will have many books (as the name implies).</div><div id="Par7" class="Para">In this section, you will define the tables, relationships, and data needed for your tests and seed data. Once you have your schema and seed data, you can start coding features.</div><div id="Par8" class="Para">Let’s start defining the data and the relationships needed. First, you need a <span class="EmphasisFontCategoryNonProportional">bundles</span> table that contains data such as the bundle name (Listing <span class="InternalRef"><a href="#Par9">11-2</a></span>).</div><div id="Par9" class="Para">
            <div class="ProgramCode" id="PC2"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan make:migration \</div><div class="FixedLine">create_bundles_table --create=bundles</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-2.</span><div class="SimplePara">Creating the bundles Table</div></div></div></div>
          </div><div id="Par10" class="Para">If you recall, the <span class="EmphasisFontCategoryNonProportional">--create</span> flag will generate the migration with <span class="EmphasisFontCategoryNonProportional">Schema::create()</span> in the <span class="EmphasisFontCategoryNonProportional">CreateBundlesTable::up()</span> method and <span class="EmphasisFontCategoryNonProportional">Schema::drop()</span> in the <span class="EmphasisFontCategoryNonProportional">CreateBundlesTable::down()</span> method.</div><div id="Par11" class="Para">The bundle will simply have <span class="EmphasisFontCategoryNonProportional">title</span> and <span class="EmphasisFontCategoryNonProportional">description</span> fields with the usual timestamps (Listing <span class="InternalRef"><a href="#Par12">11-3</a></span>).</div><div id="Par12" class="Para">
            <div class="ProgramCode" id="PC3"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Schema\Blueprint;</div><div class="FixedLine"> 4  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Migrations\Migration;</div><div class="FixedLine"> 5</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">class CreateBundlesTable extends</span> Migration</div><div class="FixedLine"> 7  {</div><div class="FixedLine"> 8      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 9       <span class="EmphasisTypeItalic">* Run the migrations.</span>
          </div><div class="FixedLine">10       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">11       <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">12       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">13      <span class="EmphasisTypeBold">public function</span> up()</div><div class="FixedLine">14      {</div><div class="FixedLine">15          Schema::create('bundles', <span class="EmphasisTypeBold">function</span> (Blueprint $table) {</div><div class="FixedLine">16              $table-&gt;increments('id');</div><div class="FixedLine">17              $table-&gt;string('title');</div><div class="FixedLine">18              $table-&gt;text('description');</div><div class="FixedLine">19              $table-&gt;timestamps();</div><div class="FixedLine">20          });</div><div class="FixedLine">21      }</div><div class="FixedLine">22</div><div class="FixedLine">23      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">24       <span class="EmphasisTypeItalic">* Reverse the migrations.</span>
          </div><div class="FixedLine">25       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">26       <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">27       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">28      <span class="EmphasisTypeBold">public function</span> down()</div><div class="FixedLine">29      {</div><div class="FixedLine">30          Schema::drop('bundles');</div><div class="FixedLine">31      }</div><div class="FixedLine">32  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-3.</span><div class="SimplePara">The CreateBundlesTable Migration</div></div></div></div>
          </div><div id="Par13" class="Para">Next, your <span class="EmphasisTypeItalic">many-to-many</span> relationship needs a pivot table. The convention for a many-to-many relationship pivot table will be derived from the alphabetical order of the related model names. In your case, the convention for “Books” and “Bundles” will be a “book_bundle” table. You will use the convention, but you can also customize things, as you might now expect, in Eloquent if needed. The next migration will look like Listing <span class="InternalRef"><a href="#Par14">11-4</a></span>.</div><div id="Par14" class="Para">
            <div class="ProgramCode" id="PC4"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan make:migration \</div><div class="FixedLine">create_book_bundle_table --create=book_bundle</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-4.</span><div class="SimplePara">Creating the Migration for the book_bundle Table</div></div></div></div>
          </div><div id="Par15" class="Para">And the migration will look like Listing <span class="InternalRef"><a href="#Par16">11-5</a></span>.</div><div id="Par16" class="Para">
            <div class="ProgramCode" id="PC5"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Schema\Blueprint;</div><div class="FixedLine"> 4  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Migrations\Migration;</div><div class="FixedLine"> 5</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">class CreateBookBundleTable extends</span> Migration</div><div class="FixedLine"> 7  {</div><div class="FixedLine"> 8      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 9       <span class="EmphasisTypeItalic">* Run the migrations.</span>
          </div><div class="FixedLine">10       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">11       <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">12       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">13      <span class="EmphasisTypeBold">public function</span> up()</div><div class="FixedLine">14      {</div><div class="FixedLine">15          Schema::create('book_bundle', <span class="EmphasisTypeBold">function</span> (Blueprint $table) {</div><div class="FixedLine">16              $table-&gt;increments('id');</div><div class="FixedLine">17              $table-&gt;integer('book_id')-&gt;unsigned();</div><div class="FixedLine">18              $table-&gt;integer('bundle_id')-&gt;unsigned();</div><div class="FixedLine">19              $table-&gt;timestamps();</div><div class="FixedLine">20          });</div><div class="FixedLine">21      }</div><div class="FixedLine">22</div><div class="FixedLine">23      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">24       <span class="EmphasisTypeItalic">* Reverse the migrations.</span>
          </div><div class="FixedLine">25       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">26       <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">27       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">28      <span class="EmphasisTypeBold">public function</span> down()</div><div class="FixedLine">29      {</div><div class="FixedLine">30          Schema::drop('book_bundle');</div><div class="FixedLine">31      }</div><div class="FixedLine">32 }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-5.</span><div class="SimplePara">The CreateBookBundleTable Migration Class</div></div></div></div>
          </div><div id="Par17" class="Para">The <span class="EmphasisFontCategoryNonProportional">book_id</span> and <span class="EmphasisFontCategoryNonProportional">bundle_id</span> fields correlate with the <span class="EmphasisFontCategoryNonProportional">id</span> column on the <span class="EmphasisFontCategoryNonProportional">books</span> and <span class="EmphasisFontCategoryNonProportional">bundles</span> tables, including being an <span class="EmphasisFontCategoryNonProportional">unsigned</span> integer. Other than that, there’s nothing new here.</div><div id="Par18" class="Para">Now you can run your migrations and make sure they work as expected (Listing <span class="InternalRef"><a href="#Par19">11-6</a></span>).</div><div id="Par19" class="Para">
            <div class="ProgramCode" id="PC6"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan migrate:refresh</div><div class="FixedLine">Rolled back: 2016_01_20_052512_remove_books_authors_column</div><div class="FixedLine">Rolled back: 2016_01_20_051118_associate_books_with_authors</div><div class="FixedLine">Rolled back: 2016_01_20_050526_create_authors_table</div><div class="FixedLine">Rolled back: 2015_12_29_234835_create_books_table</div><div class="FixedLine">Migrated: 2015_12_29_234835_create_books_table</div><div class="FixedLine">Migrated: 2016_01_20_050526_create_authors_table</div><div class="FixedLine">Migrated: 2016_01_20_051118_associate_books_with_authors</div><div class="FixedLine">Migrated: 2016_01_20_052512_remove_books_authors_column</div><div class="FixedLine">Migrated: 2016_01_24_041900_create_bundles_table</div><div class="FixedLine">Migrated: 2016_01_30_165357_create_book_bundle_table</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-6.</span><div class="SimplePara">Running the Database Migrations</div></div></div></div>
          </div><div id="Par20" class="Para">Now that you have your migrations working, the next step is creating a <span class="EmphasisFontCategoryNonProportional">Bundle</span> model so that you can define the associations (Listing <span class="InternalRef"><a href="#Par21">11-7</a></span>).</div><div id="Par21" class="Para">
            <div class="ProgramCode" id="PC7"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ touch app/Bundle.php</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-7.</span><div class="SimplePara">Creating the app/Bundle.php File</div></div></div></div>
          </div><div id="Par22" class="Para">Open the <span class="EmphasisFontCategoryNonProportional">app/Bundle.php</span> and define the Bundle model with the code in Listing <span class="InternalRef"><a href="#Par23">11-8</a></span>.</div><div id="Par23" class="Para">
            <div class="ProgramCode" id="PC8"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Eloquent\Model;</div><div class="FixedLine"> 6</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">class Bundle extends</span> Model</div><div class="FixedLine"> 8  {</div><div class="FixedLine"> 9      <span class="EmphasisTypeBold">protected</span> $fillable = ['title', 'description'];</div><div class="FixedLine">10</div><div class="FixedLine">11      <span class="EmphasisTypeBold">public function</span> books()</div><div class="FixedLine">12      {</div><div class="FixedLine">13          <span class="EmphasisTypeBold">return</span> $this-&gt;belongsToMany(\App\Book::class);</div><div class="FixedLine">14      }</div><div class="FixedLine">15  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-8.</span><div class="SimplePara">The Bundle Eloquent Model</div></div></div></div>
          </div><div id="Par24" class="Para">The <span class="EmphasisFontCategoryNonProportional">Bundle::books()</span> method defines the <span class="EmphasisFontCategoryNonProportional">Book</span> model as a belongs-to-many relationship. You have seen the <span class="EmphasisFontCategoryNonProportional">belongsTo()</span> and <span class="EmphasisFontCategoryNonProportional">hasMany</span> associations when you associated <span class="EmphasisFontCategoryNonProportional">Book</span> and <span class="EmphasisFontCategoryNonProportional">Author</span>, so this should already look familiar. For more information on Eloquent relationships, see the Eloquent relationships (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/eloquent-relationships"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/eloquent-relationships</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> documentation.</div><div id="Par25" class="Para">You need to update the <span class="EmphasisFontCategoryNonProportional">Book</span> model in <span class="EmphasisFontCategoryNonProportional">app/Book.php</span> to define the inverse of this relationship, which is identical (Listing <span class="InternalRef"><a href="#Par26">11-9</a></span>).</div><div id="Par26" class="Para">
            <div class="ProgramCode" id="PC9"><div class="FixedLine">21  <span class="EmphasisTypeBold">public function</span> bundles()</div><div class="FixedLine">22  {</div><div class="FixedLine">23      <span class="EmphasisTypeBold">return</span> $this-&gt;belongsToMany(\App\Bundle::class);</div><div class="FixedLine">24  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-9.</span><div class="SimplePara">Defining the Bundle Relationship in the Book Model</div></div></div></div>
          </div><div id="Par27" class="Para">The last thing you will do is define the factory so that you can create model seed data. Add the code in Listing <span class="InternalRef"><a href="#Par28">11-10</a></span> to the end of the <span class="EmphasisFontCategoryNonProportional">database/factories/ModelFactory.php</span> file.</div><div id="Par28" class="Para">
            <div class="ProgramCode" id="PC10"><div class="FixedLine">38  $factory-&gt;define(\App\Bundle::class, <span class="EmphasisTypeBold">function</span> ($faker) {</div><div class="FixedLine">39</div><div class="FixedLine">40      $title = $faker-&gt;sentence(rand(3, 10));</div><div class="FixedLine">41</div><div class="FixedLine">42      <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">43          'title' =&gt; substr($title, 0, strlen($title) - 1),</div><div class="FixedLine">44          'description' =&gt; $faker-&gt;text</div><div class="FixedLine">45      ];</div><div class="FixedLine">46  });</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-10.</span><div class="SimplePara">Model Factory for the Bundle Model</div></div></div></div>
          </div><div id="Par29" class="Para">Next, create a new database seeder file (Listing <span class="InternalRef"><a href="#Par30">11-11</a></span>) and seed code (Listing <span class="InternalRef"><a href="#Par31">11-12</a></span>):</div><div id="Par30" class="Para">
            <div class="ProgramCode" id="PC11"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ touch database/seeds/BundlesTableSeeder.php</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-11.</span><div class="SimplePara">Creating the BundlesTableSeeder Class</div></div></div></div>
          </div><div id="Par31" class="Para">
            <div class="ProgramCode" id="PC12"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Seeder;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">class BundlesTableSeeder extends</span> Seeder</div><div class="FixedLine"> 6  {</div><div class="FixedLine"> 7      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 8       <span class="EmphasisTypeItalic">* Run the database seeds.</span>
          </div><div class="FixedLine"> 9       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">10       <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">11       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">12      <span class="EmphasisTypeBold">public function</span> run()</div><div class="FixedLine">13      {</div><div class="FixedLine">14          factory(\App\Bundle::class, 5)-&gt;create()-&gt;each(<span class="EmphasisTypeBold">function</span> ($bundle) {</div><div class="FixedLine">15              $booksCount = rand(2, 5);</div><div class="FixedLine">16              $bookIds = [];</div><div class="FixedLine">17</div><div class="FixedLine">18              <span class="EmphasisTypeBold">while</span> ($booksCount &gt; 0) {</div><div class="FixedLine">19                  $book = \App\Book::whereNotIn('id', $bookIds)</div><div class="FixedLine">20                      -&gt;orderByRaw("RAND()")</div><div class="FixedLine">21                      -&gt;first();</div><div class="FixedLine">22</div><div class="FixedLine">23                  $bundle-&gt;books()-&gt;attach($book);</div><div class="FixedLine">24                  $bookIds[] = $book-&gt;id;</div><div class="FixedLine">25                  $booksCount--;</div><div class="FixedLine">26              }</div><div class="FixedLine">27          });</div><div class="FixedLine">28      }</div><div class="FixedLine">29  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-12.</span><div class="SimplePara">The BundlesTableSeeder Class</div></div></div></div>
          </div><div id="Par32" class="Para">The <span class="EmphasisFontCategoryNonProportional">Bundles</span> seeder class creates five bundles and then loops through each one. In the callback, a random amount of books (between 2 and 5) will be defined with <span class="EmphasisFontCategoryNonProportional">rand(2, 5)</span>. The <span class="EmphasisFontCategoryNonProportional">while</span> loop finds a random book in the database that has not been used yet with the <span class="EmphasisFontCategoryNonProportional">whereNotIn('id', $bookIds)</span> call and returns the first result. Next, the book is attached to the current bundle, and added to the ignore array so the book will not be in the same bundle twice.</div><div id="Par33" class="Para">You need to add the new <span class="EmphasisFontCategoryNonProportional">BundlesTableSeeder</span> class to the <span class="EmphasisFontCategoryNonProportional">database/seeds/DatabaseSeeder.php</span> file (Listing <span class="InternalRef"><a href="#Par34">11-13</a></span>).</div><div id="Par34" class="Para">
            <div class="ProgramCode" id="PC13"><div class="FixedLine"> 7  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 8   <span class="EmphasisTypeItalic">* Run the database seeds.</span>
          </div><div class="FixedLine"> 9   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">10   <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">11   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">12  <span class="EmphasisTypeBold">public function</span> run()</div><div class="FixedLine">13  {</div><div class="FixedLine">14      // $this-&gt;call('UserTableSeeder');</div><div class="FixedLine">15      $this-&gt;call(BooksTableSeeder::class);</div><div class="FixedLine">16      $this-&gt;call(BundlesTableSeeder::class);</div><div class="FixedLine">17  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-13.</span><div class="SimplePara">Adding the BundlesTableSeeder to the DatabaseSeeder</div></div></div></div>
          </div><div id="Par35" class="Para">You are ready to run the migrations again and seed the new bundle data (Listing <span class="InternalRef"><a href="#Par36">11-14</a></span>).</div><div id="Par36" class="Para">
            <div class="ProgramCode" id="PC14"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ composer dump-autoload</div><div class="FixedLine">$ php artisan migrate:refresh</div><div class="FixedLine">...</div><div class="FixedLine">$ php artisan db:seed</div><div class="FixedLine">Seeded: BooksTableSeeder</div><div class="FixedLine">Seeded: BundlesTableSeeder</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-14.</span><div class="SimplePara">Migrating and Seeding Application Data</div></div></div></div>
          </div><div id="Par37" class="Para">Remember that when you add new seeder classes you need to update the Composer autoloader with the <span class="EmphasisTypeItalic">composer dump-autoload command</span> so artisan can find the seeder class. If all went well, you should have some seed data in the <span class="EmphasisFontCategoryNonProportional">bundles</span> table and <span class="EmphasisFontCategoryNonProportional">book_bundle</span> table.</div><div id="Par38" class="Para">You now have the correct data model and associations to move onto your next endpoint, which is returning an individual bundle with related books.</div></div><div id="Sec2" class="Section1 RenderAsSection1"><h2 class="Heading">The GET /bundles/{id} Endpoint</h2><div id="Par39" class="Para">With your data and model relationships in place, you are ready to start working on the individual bundle response. Your API endpoint (<span class="EmphasisFontCategoryNonProportional">/bundles/{id}</span>) response resembles the JSON in Listing <span class="InternalRef"><a href="#Par40">11-15</a></span>.</div><div id="Par40" class="Para">
            <div class="ProgramCode" id="PC15"><div class="FixedLine">{</div><div class="FixedLine">    <span class="EmphasisTypeBold">"data"</span>:{</div><div class="FixedLine">        <span class="EmphasisTypeBold">"id"</span>:1,</div><div class="FixedLine">        <span class="EmphasisTypeBold">"title"</span>:"Eveniet numquam quos doloribus nemo dolore culpa voluptatem nobis in omnis aut",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"description"</span>:"Perferendis minus omnis accusantium reiciendis totam. Quoautem ratione amet facere quam. Iure sunt qui odio sint.",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"created"</span>:"2015-12-06T03:14:58+0000",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"updated"</span>:"2015-12-06T03:14:58+0000",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"books"</span>:{</div><div class="FixedLine">            <span class="EmphasisTypeBold">"data"</span>:[</div><div class="FixedLine">                {</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"id"</span>:6,</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"title"</span>:"Et ipsam facilis rerum expedita doloribus quasi aliquam numquam provident rerum mollitia",</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"description"</span>:"Itaque cumque est et vitae voluptatibus ad. Rerum repellendus consequatur labore eum nostrum. Ut et ut voluptate maiores.",</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"author"</span>:"Angelina Doyle",</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"created"</span>:"2015-12-06T03:14:58+0000",</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"updated"</span>:"2015-12-06T03:14:58+0000"</div><div class="FixedLine">                },</div><div class="FixedLine">                {</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"id"</span>:33,</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"title"</span>:"Dolorem at cum esse",</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"description"</span>:"Commodi et consequuntur quia culpa. Totam earum ad tempore cumque dolor. In ratione voluptas quisquam et est quaerat rem.",</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"author"</span>:"Rylan Lind II",</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"created"</span>:"2015-12-06T03:14:58+0000",</div><div class="FixedLine">                    <span class="EmphasisTypeBold">"updated"</span>:"2015-12-06T03:14:58+0000"</div><div class="FixedLine">                }</div><div class="FixedLine">            ]</div><div class="FixedLine">        }</div><div class="FixedLine">    }</div><div class="FixedLine">}</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-15.</span><div class="SimplePara">Example Bundle Response</div></div></div></div>
          </div><div id="Par41" class="Para">You are ready to create your <span class="EmphasisFontCategoryNonProportional">BundleTransformer</span> file (Listing <span class="InternalRef"><a href="#Par42">11-16</a></span>).</div><div id="Par42" class="Para">
            <div class="ProgramCode" id="PC16"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ touch tests/app/Transformer/BundleTransformerTest.php</div><div class="FixedLine">$ touch app/Transformer/BundleTransformer.php</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-16.</span><div class="SimplePara">Creating the BundleTransformer Class and Test</div></div></div></div>
          </div><div id="Par43" class="Para">Next, you are going to cheat a little and write all the bundle transformer tests beforehand (Listing <span class="InternalRef"><a href="#Par44">11-17</a></span>).</div><div id="Par44" class="Para">
            <div class="ProgramCode" id="PC17"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Transformer;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> App\Transformer\BundleTransformer;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> Laravel\Lumen\Testing\DatabaseMigrations;</div><div class="FixedLine"> 8</div><div class="FixedLine"> 9  <span class="EmphasisTypeBold">class BundleTransformerTest extends</span> TestCase</div><div class="FixedLine">10  {</div><div class="FixedLine">11      <span class="EmphasisTypeBold">use</span> DatabaseMigrations;</div><div class="FixedLine">12</div><div class="FixedLine">13      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">14       <span class="EmphasisTypeItalic">* @var BundleTransformer</span>
          </div><div class="FixedLine">15       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">16      <span class="EmphasisTypeBold">private</span> $subject;</div><div class="FixedLine">17</div><div class="FixedLine">18      <span class="EmphasisTypeBold">public function</span> setUp()</div><div class="FixedLine">19      {</div><div class="FixedLine">20          <span class="EmphasisTypeBold">parent</span>::setUp();</div><div class="FixedLine">21</div><div class="FixedLine">22          $this-&gt;subject = <span class="EmphasisTypeBold">new</span> BundleTransformer();</div><div class="FixedLine">23      }</div><div class="FixedLine">24</div><div class="FixedLine">25      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">26      <span class="EmphasisTypeBold">public function</span> it_can_be_initialized()</div><div class="FixedLine">27      {</div><div class="FixedLine">28          $this-&gt;assertInstanceOf(</div><div class="FixedLine">29              BundleTransformer::class,</div><div class="FixedLine">30              $this-&gt;subject</div><div class="FixedLine">31          );</div><div class="FixedLine">32      }</div><div class="FixedLine">33</div><div class="FixedLine">34      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">35      <span class="EmphasisTypeBold">public function</span> it_can_transform_a_bundle()</div><div class="FixedLine">36      {</div><div class="FixedLine">37          $bundle = factory(\App\Bundle::class)-&gt;create();</div><div class="FixedLine">38</div><div class="FixedLine">39          $actual = $this-&gt;subject-&gt;transform($bundle);</div><div class="FixedLine">40</div><div class="FixedLine">41          $this-&gt;assertEquals($bundle-&gt;id, $actual['id']);</div><div class="FixedLine">42          $this-&gt;assertEquals($bundle-&gt;title, $actual['title']);</div><div class="FixedLine">43          $this-&gt;assertEquals(</div><div class="FixedLine">44              $bundle-&gt;description,</div><div class="FixedLine">45              $actual['description']</div><div class="FixedLine">46          );</div><div class="FixedLine">47          $this-&gt;assertEquals(</div><div class="FixedLine">48              $bundle-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">49              $actual['created']</div><div class="FixedLine">50          );</div><div class="FixedLine">51          $this-&gt;assertEquals(</div><div class="FixedLine">52              $bundle-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">53              $actual['updated']</div><div class="FixedLine">54          );</div><div class="FixedLine">55      }</div><div class="FixedLine">56</div><div class="FixedLine">57      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">58      <span class="EmphasisTypeBold">public function</span> it_can_transform_related_books()</div><div class="FixedLine">59      {</div><div class="FixedLine">60          $bundle = $this-&gt;bundleFactory();</div><div class="FixedLine">61</div><div class="FixedLine">62          $data = $this-&gt;subject-&gt;includeBooks($bundle);</div><div class="FixedLine">63          $this-&gt;assertInstanceOf(</div><div class="FixedLine">64              \League\Fractal\Resource\Collection::class,</div><div class="FixedLine">65              $data</div><div class="FixedLine">66          );</div><div class="FixedLine">67          $this-&gt;assertInstanceOf(</div><div class="FixedLine">68              \App\Book::class,</div><div class="FixedLine">69              $data-&gt;getData()[0]</div><div class="FixedLine">70          );</div><div class="FixedLine">71          $this-&gt;assertCount(2, $data-&gt;getData());</div><div class="FixedLine">72      }</div><div class="FixedLine">73 }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-17.</span><div class="SimplePara">Testing the Bundle Transformer</div></div></div></div>
          </div><div id="Par45" class="Para">I have included all the tests needed to cover the <span class="EmphasisFontCategoryNonProportional">BundleTransformer</span>; this test is just like the other transformer tests you’ve already covered. You might have noticed the call to <span class="EmphasisFontCategoryNonProportional">$this-&gt;bundleFactory()</span> in the <span class="EmphasisFontCategoryNonProportional">it_can_transform_related_books</span> test, which you haven’t written yet. You might have also noticed the <span class="EmphasisFontCategoryNonProportional">setUp()</span> method used to initialize the subject of your tests as <span class="EmphasisFontCategoryNonProportional">$this-&gt;subject,</span> which is a convenient way to set up the test subject before of each test.</div><div id="Par46" class="Para">You are ready to write the actual transformer class, write the <span class="EmphasisFontCategoryNonProportional">bundleFactory()</span> method, and get tests back to green. Next, you will write the <span class="EmphasisFontCategoryNonProportional">BundleTransformer</span> implementation in <span class="EmphasisFontCategoryNonProportional">app/Transformer/BundleTransformer.php</span> (Listing <span class="InternalRef"><a href="#Par47">11-18</a></span>).</div><div id="Par47" class="Para">
            <div class="ProgramCode" id="PC18"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Transformer;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> App\Bundle;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> League\Fractal\TransformerAbstract;</div><div class="FixedLine"> 7</div><div class="FixedLine"> 8  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 9   <span class="EmphasisTypeItalic">* Class BundleTransformer</span>
          </div><div class="FixedLine">10   <span class="EmphasisTypeItalic">* @package App\Transformer</span>
          </div><div class="FixedLine">11   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">12  <span class="EmphasisTypeBold">class BundleTransformer extends</span> TransformerAbstract</div><div class="FixedLine">13  {</div><div class="FixedLine">14      <span class="EmphasisTypeBold">protected</span> $defaultIncludes = ['books'];</div><div class="FixedLine">15</div><div class="FixedLine">16      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">17       <span class="EmphasisTypeItalic">* Include a bundle's books</span>
          </div><div class="FixedLine">18       <span class="EmphasisTypeItalic">* @param Bundle $bundle</span>
          </div><div class="FixedLine">19       <span class="EmphasisTypeItalic">* @return \League\Fractal\Resource\Collection</span>
          </div><div class="FixedLine">20       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">21      <span class="EmphasisTypeBold">public function</span> includeBooks(Bundle $bundle)</div><div class="FixedLine">22      {</div><div class="FixedLine">23          <span class="EmphasisTypeBold">return</span> $this-&gt;collection($bundle-&gt;books, <span class="EmphasisTypeBold">new</span> BookTransformer());</div><div class="FixedLine">24      }</div><div class="FixedLine">25</div><div class="FixedLine">26      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">27       <span class="EmphasisTypeItalic">* Transform a bundle</span>
          </div><div class="FixedLine">28       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">29       <span class="EmphasisTypeItalic">* @param Bundle $bundle</span>
          </div><div class="FixedLine">30       <span class="EmphasisTypeItalic">* @return array</span>
          </div><div class="FixedLine">31       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">32      <span class="EmphasisTypeBold">public function</span> transform(Bundle $bundle)</div><div class="FixedLine">33      {</div><div class="FixedLine">34          <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">35              'id' =&gt; $bundle-&gt;id,</div><div class="FixedLine">36              'title' =&gt; $bundle-&gt;title,</div><div class="FixedLine">37              'description' =&gt; $bundle-&gt;description,</div><div class="FixedLine">38              'created' =&gt; $bundle-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">39              'updated' =&gt; $bundle-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">40          ];</div><div class="FixedLine">41      }</div><div class="FixedLine">42  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-18.</span><div class="SimplePara">Implementing the BundleTransformer Class</div></div></div></div>
          </div><div id="Par48" class="Para">The <span class="EmphasisFontCategoryNonProportional">BundleTransformer</span> will always include books; therefore this transformer has <span class="EmphasisFontCategoryNonProportional">books</span> in the <span class="EmphasisFontCategoryNonProportional">$defaultIncludes</span> array.</div><div id="Par49" class="Para">Next, let’s define the <span class="EmphasisFontCategoryNonProportional">bundleFactory()</span> method in the base <span class="EmphasisFontCategoryNonProportional">tests/TestCase.php</span> file right after the <span class="EmphasisFontCategoryNonProportional">bookFactory()</span> method in order to easily create bundle records in the database for testing purposes (Listing <span class="InternalRef"><a href="#Par50">11-19</a></span>).</div><div id="Par50" class="Para">
            <div class="ProgramCode" id="PC19"><div class="FixedLine">78  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">79   <span class="EmphasisTypeItalic">* Convenience method for creating a book bundle</span>
          </div><div class="FixedLine">80   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">81   <span class="EmphasisTypeItalic">* @param int $count</span>
          </div><div class="FixedLine">82   <span class="EmphasisTypeItalic">* @return mixed</span>
          </div><div class="FixedLine">83   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">84  <span class="EmphasisTypeBold">protected function</span> bundleFactory($bookCount = 2)</div><div class="FixedLine">85  {</div><div class="FixedLine">86      <span class="EmphasisTypeBold">if</span> ($bookCount &lt;= 1) {</div><div class="FixedLine">87          <span class="EmphasisTypeBold">throw new</span> \RuntimeException('A bundle must have two or more books!');</div><div class="FixedLine">88      }</div><div class="FixedLine">89</div><div class="FixedLine">90      $bundle = factory(\App\Bundle::class)-&gt;create();</div><div class="FixedLine">91      $books = $this-&gt;bookFactory($bookCount);</div><div class="FixedLine">92</div><div class="FixedLine">93      $books-&gt;each(<span class="EmphasisTypeBold">function</span> ($book) <span class="EmphasisTypeBold">use</span> ($bundle) {</div><div class="FixedLine">94          $bundle-&gt;books()-&gt;attach($book);</div><div class="FixedLine">95      });</div><div class="FixedLine">96</div><div class="FixedLine">97      <span class="EmphasisTypeBold">return</span> $bundle;</div><div class="FixedLine">98  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-19.</span><div class="SimplePara">Defining the bundleFactory() Method in the TestCase Class</div></div></div></div>
          </div><div id="Par51" class="Para">The <span class="EmphasisFontCategoryNonProportional">bundleFactory()</span> method first makes sure that a <span class="EmphasisFontCategoryNonProportional">$bookCount</span> of at least 2 is passed; otherwise it will throw a <span class="EmphasisFontCategoryNonProportional">\RuntimeException</span>. Next, a bundle is created in the test database. You use the <span class="EmphasisFontCategoryNonProportional">TestCase::bookFactory()</span> method to create multiple books, and then you loop through each book and attach it to your bundle. Finally, you return the bundle.</div><div id="Par52" class="Para">Before moving on, verify that all tests pass (Listing <span class="InternalRef"><a href="#Par53">11-20</a></span>).</div><div id="Par53" class="Para">
            <div class="ProgramCode" id="PC20"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (50 tests, 250 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-20.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par54" class="Para">With the <span class="EmphasisFontCategoryNonProportional">BundleTransformer</span> class in place you can create test file for the Bundle controller at <span class="EmphasisFontCategoryNonProportional">tests/app/Http/Controllers/BundlesControllerTest.php</span> with the first failing test for the <span class="EmphasisFontCategoryNonProportional">BundlesController@show</span> method (Listing <span class="InternalRef"><a href="#Par55">11-21</a></span> and Listing <span class="InternalRef"><a href="#Par56">11-22</a></span>).</div><div id="Par55" class="Para">
            <div class="ProgramCode" id="PC21"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ touch app/Http/Controllers/BundlesController.php</div><div class="FixedLine">$ touch tests/app/Http/Controllers/BundlesControllerTest.php</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-21.</span><div class="SimplePara">Creating the BundlesController and Test File</div></div></div></div>
          </div><div id="Par56" class="Para">
            <div class="ProgramCode" id="PC22"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> Laravel\Lumen\Testing\DatabaseMigrations;</div><div class="FixedLine"> 7</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">class BundlesControllerTest extends</span> TestCase</div><div class="FixedLine"> 9  {</div><div class="FixedLine">10      <span class="EmphasisTypeBold">use</span> DatabaseMigrations;</div><div class="FixedLine">11</div><div class="FixedLine">12      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">13      <span class="EmphasisTypeBold">public function</span> show_should_return_a_valid_bundle()</div><div class="FixedLine">14      {</div><div class="FixedLine">15          $bundle = $this-&gt;bundleFactory();</div><div class="FixedLine">16</div><div class="FixedLine">17          $this-&gt;get("/bundles/<span class="EmphasisTypeBold">{</span>$bundle-&gt;id<span class="EmphasisTypeBold">}</span>", ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">18          $this-&gt;seeStatusCode(200);</div><div class="FixedLine">19          $body = $this-&gt;response-&gt;getData(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">20</div><div class="FixedLine">21          $this-&gt;assertArrayHasKey('data', $body);</div><div class="FixedLine">22          $data = $body['data'];</div><div class="FixedLine">23</div><div class="FixedLine">24          <span class="EmphasisTypeItalic">// Check bundle properties exist in the response</span>
          </div><div class="FixedLine">25          $this-&gt;assertEquals($bundle-&gt;id, $data['id']);</div><div class="FixedLine">26          $this-&gt;assertEquals($bundle-&gt;title, $data['title']);</div><div class="FixedLine">27          $this-&gt;assertEquals($bundle-&gt;title, $data['title']);</div><div class="FixedLine">28          $this-&gt;assertEquals(</div><div class="FixedLine">29              $bundle-&gt;description,</div><div class="FixedLine">30              $data['description']</div><div class="FixedLine">31          );</div><div class="FixedLine">32          $this-&gt;assertEquals(</div><div class="FixedLine">33              $bundle-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">34              $data['created']</div><div class="FixedLine">35          );</div><div class="FixedLine">36          $this-&gt;assertEquals(</div><div class="FixedLine">37              $bundle-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">38              $data['updated']</div><div class="FixedLine">39          );</div><div class="FixedLine">40</div><div class="FixedLine">41          <span class="EmphasisTypeItalic">// Check that book data is in the response</span>
          </div><div class="FixedLine">42          $this-&gt;assertArrayHasKey('books', $data);</div><div class="FixedLine">43          $books = $data['books'];</div><div class="FixedLine">44</div><div class="FixedLine">45          <span class="EmphasisTypeItalic">// Check that two books exist in the response</span>
          </div><div class="FixedLine">46          $this-&gt;assertArrayHasKey('data', $books);</div><div class="FixedLine">47          $this-&gt;assertCount(2, $books['data']);</div><div class="FixedLine">48</div><div class="FixedLine">49          <span class="EmphasisTypeItalic">// Verify keys for one book...</span>
          </div><div class="FixedLine">50          $this-&gt;assertEquals(</div><div class="FixedLine">51              $bundle-&gt;books[0]-&gt;title,</div><div class="FixedLine">52              $books['data'][0]['title']</div><div class="FixedLine">53          );</div><div class="FixedLine">54          $this-&gt;assertEquals(</div><div class="FixedLine">55              $bundle-&gt;books[0]-&gt;description,</div><div class="FixedLine">56              $books['data'][0]['description']</div><div class="FixedLine">57          );</div><div class="FixedLine">58          $this-&gt;assertEquals(</div><div class="FixedLine">59              $bundle-&gt;books[0]-&gt;author-&gt;name,</div><div class="FixedLine">60              $books['data'][0]['author']</div><div class="FixedLine">61          );</div><div class="FixedLine">62          $this-&gt;assertEquals(</div><div class="FixedLine">63              $bundle-&gt;books[0]-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">64              $books['data'][0]['created']</div><div class="FixedLine">65          );</div><div class="FixedLine">66          $this-&gt;assertEquals(</div><div class="FixedLine">67              $bundle-&gt;books[0]-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">68              $books['data'][0]['updated']</div><div class="FixedLine">69          );</div><div class="FixedLine">70      }</div><div class="FixedLine">71  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-22.</span><div class="SimplePara">Writing the Test for the BundlesController@show Method</div></div></div></div>
          </div><div id="Par57" class="Para">The test is long but simple. You get the bundle response and go through all the data to make sure your bundle endpoint contains all the response data. The controller isn’t complicated but you want to make sure you test all the expected data. In fact, the implementation is only a few lines (Listing <span class="InternalRef"><a href="#Par58">11-23</a></span>).</div><div id="Par58" class="Para">
            <div class="ProgramCode" id="PC23"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> App\Bundle;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> App\Transformer\BundleTransformer;</div><div class="FixedLine"> 7</div><div class="FixedLine"> 8  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 9   <span class="EmphasisTypeItalic">* Class BundlesController</span>
          </div><div class="FixedLine">10   <span class="EmphasisTypeItalic">* @package App\Http\Controllers</span>
          </div><div class="FixedLine">11   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">12  <span class="EmphasisTypeBold">class BundlesController extends</span> Controller</div><div class="FixedLine">13  {</div><div class="FixedLine">14      <span class="EmphasisTypeBold">public function</span> show($id)</div><div class="FixedLine">15      {</div><div class="FixedLine">16          $bundle = Bundle::findOrFail($id);</div><div class="FixedLine">17          $data = $this-&gt;item($bundle, <span class="EmphasisTypeBold">new</span> BundleTransformer());</div><div class="FixedLine">18</div><div class="FixedLine">19          <span class="EmphasisTypeBold">return</span> response()-&gt;json($data);</div><div class="FixedLine">20      }</div><div class="FixedLine">21  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-23.</span><div class="SimplePara">The Initial Version of the BundlesController</div></div></div></div>
          </div><div id="Par59" class="Para">You’ve seen the <span class="EmphasisFontCategoryNonProportional">@show</span> method a few times. All you need to do at the moment is find the bundle and run the response through Fractal. The <span class="EmphasisFontCategoryNonProportional">BundleTransformer</span> automatically includes the bundle’s books in the response. You still need to define a <span class="EmphasisFontCategoryNonProportional">BundlesController@show</span> route in the <span class="EmphasisFontCategoryNonProportional">app/Http/routes.php</span> file before your tests will pass again. You might as well take this opportunity to write all the routes for this chapter at once (Listing <span class="InternalRef"><a href="#Par60">11-24</a></span>).</div><div id="Par60" class="Para">
            <div class="ProgramCode" id="PC24"><div class="FixedLine">41  $app-&gt;group([</div><div class="FixedLine">42      'prefix' =&gt; '/bundles',</div><div class="FixedLine">43      'namespace' =&gt; 'App\Http\Controllers'</div><div class="FixedLine">44  ], <span class="EmphasisTypeBold">function</span> (\Laravel\Lumen\Application $app) {</div><div class="FixedLine">45</div><div class="FixedLine">46      $app-&gt;get('/{id:[\d]+}', [</div><div class="FixedLine">47          'as' =&gt; 'bundles.show',</div><div class="FixedLine">48          'uses' =&gt; 'BundlesController@show'</div><div class="FixedLine">49      ]);</div><div class="FixedLine">50</div><div class="FixedLine">51      $app-&gt;put(</div><div class="FixedLine">52          '/{bundleId:[\d]+}/books/{bookId:[\d]+}',</div><div class="FixedLine">53          'BundlesController@addBook'</div><div class="FixedLine">54      );</div><div class="FixedLine">55</div><div class="FixedLine">56      $app-&gt;delete(</div><div class="FixedLine">57          '/{bundleId:[\d]+}/books/{bookId:[\d]+}',</div><div class="FixedLine">58          'BundlesController@removeBook'</div><div class="FixedLine">59      );</div><div class="FixedLine">60  });</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-24.</span><div class="SimplePara">Adding the /bundles Routes</div></div></div></div>
          </div><div id="Par61" class="Para">With the routes defined you are ready to see if your test suite is fully passing again (Listing <span class="InternalRef"><a href="#Par62">11-25</a></span>).</div><div id="Par62" class="Para">
            <div class="ProgramCode" id="PC25"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div><div class="FixedLine">OK (51 tests, 266 assertions)</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-25.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div></div><div id="Sec3" class="Section1 RenderAsSection1"><h2 class="Heading">Adding a Book to a Bundle</h2><div id="Par63" class="Para ParaOneEmphasisChild">Up to this point, you have relied on seed data and factories to associate bundles and books. You need an API endpoint to define the relationship for books contained within a bundle. You will write the API to allow adding and removing a single book per request. Adding a book will use the <span class="EmphasisFontCategoryNonProportional">PUT/bundles/{bundleId:[\d]+}/books/{bookId:[\d]+}</span> nested route.</div><div id="Par64" class="Para">Let’s start by writing the failing test for adding a book to an existing bundle in the <span class="EmphasisFontCategoryNonProportional">tests/app/Http/Controllers/BundlesControllerTest.php</span> file (Listing <span class="InternalRef"><a href="#Par65">11-26</a></span>).</div><div id="Par65" class="Para">
            <div class="ProgramCode" id="PC26"><div class="FixedLine"> 72  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine"> 73  <span class="EmphasisTypeBold">public function</span> addBook_should_add_a_book_to_a_bundle()</div><div class="FixedLine"> 74  {</div><div class="FixedLine"> 75      $bundle = factory(\App\Bundle::class)-&gt;create();</div><div class="FixedLine"> 76      $book = $this-&gt;bookFactory();</div><div class="FixedLine"> 77</div><div class="FixedLine"> 78      <span class="EmphasisTypeItalic">// Bundle should not have any associated books yet</span>
          </div><div class="FixedLine"> 79      $this-&gt;notSeeInDatabase('book_bundle', ['bundle_id' =&gt; $bundle-&gt;id]);</div><div class="FixedLine"> 80</div><div class="FixedLine"> 81      $this-&gt;put("/bundles/<span class="EmphasisTypeBold">{</span>$bundle-&gt;id<span class="EmphasisTypeBold">}</span>/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>", [],</div><div class="FixedLine"> 82          ['Accept' =&gt; 'application/json']);</div><div class="FixedLine"> 83</div><div class="FixedLine"> 84      $this-&gt;seeStatusCode(200);</div><div class="FixedLine"> 85</div><div class="FixedLine"> 86      $dbBundle = \App\Bundle::with('books')-&gt;find($bundle-&gt;id);</div><div class="FixedLine"> 87      $this-&gt;assertCount(1, $dbBundle-&gt;books,</div><div class="FixedLine"> 88          'The bundle should have 1 associated book');</div><div class="FixedLine"> 89</div><div class="FixedLine"> 90      $this-&gt;assertEquals(</div><div class="FixedLine"> 91          $dbBundle-&gt;books()-&gt;first()-&gt;id,</div><div class="FixedLine"> 92          $book-&gt;id</div><div class="FixedLine"> 93      );</div><div class="FixedLine"> 94</div><div class="FixedLine"> 95      $body = $this-&gt;response-&gt;getData(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine"> 96</div><div class="FixedLine"> 97      $this-&gt;assertArrayHasKey('data', $body);</div><div class="FixedLine"> 98      <span class="EmphasisTypeItalic">// Ensure the book id is in the response.</span>
          </div><div class="FixedLine"> 99      $this-&gt;assertArrayHasKey('books', $body['data']);</div><div class="FixedLine">100      $this-&gt;assertArrayHasKey('data', $body['data']['books']);</div><div class="FixedLine">101</div><div class="FixedLine">102      <span class="EmphasisTypeItalic">// Make sure the book is in the response</span>
          </div><div class="FixedLine">103      $books = $body['data']['books'];</div><div class="FixedLine">104      $this-&gt;assertEquals($book-&gt;id, $books['data'][0]['id']);</div><div class="FixedLine">105  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-26.</span><div class="SimplePara">Testing the Addition of a Book to a Bundle</div></div></div></div>
          </div><div id="Par66" class="Para ParaOneEmphasisChild">Your test creates a bundle and a book separately because you don’t want them associated, and you assert that the new bundle does not have any books. You associate a book with the bundle with a <span class="EmphasisFontCategoryNonProportional">PUT</span> request and then get the bundle from the database to ensure the book is now associated with the bundle. Lastly, the test ensures the response contains the newly associated book and has the expected response.</div><div id="Par67" class="Para">Next, you will write the <span class="EmphasisFontCategoryNonProportional">BundlesController::addBook()</span> method which adds a book to the bundle (Listing <span class="InternalRef"><a href="#Par68">11-27</a></span>).</div><div id="Par68" class="Para">
            <div class="ProgramCode" id="PC27"><div class="FixedLine">22  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">23   <span class="EmphasisTypeItalic">* @param int $bundleId</span>
          </div><div class="FixedLine">24   <span class="EmphasisTypeItalic">* @param int $bookId</span>
          </div><div class="FixedLine">25   <span class="EmphasisTypeItalic">* @return \Illuminate\Http\JsonResponse</span>
          </div><div class="FixedLine">26   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">27  <span class="EmphasisTypeBold">public function</span> addBook($bundleId, $bookId)</div><div class="FixedLine">28  {</div><div class="FixedLine">29      $bundle = \App\Bundle::findOrFail($bundleId);</div><div class="FixedLine">30      $book = \App\Book::findOrFail($bookId);</div><div class="FixedLine">31</div><div class="FixedLine">32      $bundle-&gt;books()-&gt;attach($book);</div><div class="FixedLine">33      $data = $this-&gt;item($bundle, <span class="EmphasisTypeBold">new</span> BundleTransformer());</div><div class="FixedLine">34</div><div class="FixedLine">35      <span class="EmphasisTypeBold">return</span> response()-&gt;json($data);</div><div class="FixedLine">36  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-27.</span><div class="SimplePara">The Initial Method for Adding a Book</div></div></div></div>
          </div><div id="Par69" class="Para">The implementation is really simple: the controller makes sure that both the bundle and book are valid records and attaches the book to the bundle with the <span class="EmphasisFontCategoryNonProportional">attach()</span> method. Let’s make sure your new controller method satisfies your tests (Listing <span class="InternalRef"><a href="#Par70">11-28</a></span>).</div><div id="Par70" class="Para">
            <div class="ProgramCode" id="PC28"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (52 tests, 274 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-28.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div></div><div id="Sec4" class="Section1 RenderAsSection1"><h2 class="Heading">Remove a Book from a Bundle</h2><div id="Par71" class="Para">Now that you have a way to add a book to a bundle, you need a way to remove a book too. Removing a book from a bundle resembles adding a book and will not take much effort to test and implement. First, write the test for removing a book (Listing <span class="InternalRef"><a href="#Par72">11-29</a></span>).</div><div id="Par72" class="Para">
            <div class="ProgramCode" id="PC29"><div class="FixedLine">107  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">108  <span class="EmphasisTypeBold">public function</span> removeBook_should_remove_a_book_from_a_bundle()</div><div class="FixedLine">109  {</div><div class="FixedLine">110      $bundle = $this-&gt;bundleFactory(3);</div><div class="FixedLine">111      $book = $bundle-&gt;books()-&gt;first();</div><div class="FixedLine">112</div><div class="FixedLine">113      $this-&gt;seeInDatabase('book_bundle', [</div><div class="FixedLine">114          'book_id' =&gt; $book-&gt;id,</div><div class="FixedLine">115          'bundle_id' =&gt; $bundle-&gt;id</div><div class="FixedLine">116      ]);</div><div class="FixedLine">117</div><div class="FixedLine">118      $this-&gt;assertCount(3, $bundle-&gt;books);</div><div class="FixedLine">119</div><div class="FixedLine">120      $this</div><div class="FixedLine">121          -&gt;delete("/bundles/<span class="EmphasisTypeBold">{</span>$bundle-&gt;id<span class="EmphasisTypeBold">}</span>/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>")</div><div class="FixedLine">122          -&gt;seeStatusCode(204)</div><div class="FixedLine">123          -&gt;notSeeInDatabase('book_bundle', [</div><div class="FixedLine">124              'book_id' =&gt; $book-&gt;id,</div><div class="FixedLine">125              'bundle_id' =&gt; $bundle-&gt;id</div><div class="FixedLine">126          ]);</div><div class="FixedLine">127</div><div class="FixedLine">128      $dbBundle = \App\Bundle::find($bundle-&gt;id);</div><div class="FixedLine">129      $this-&gt;assertCount(2, $dbBundle-&gt;books);</div><div class="FixedLine">130  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-29.</span><div class="SimplePara">Test for Removing a Book from a Bundle</div></div></div></div>
          </div><div id="Par73" class="Para">Let’s break down the code in this test:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par74" class="Para">Create a bundle with three associated books.</div></li><li><div id="Par75" class="Para">Get the first associated book and ensures the database association.</div></li><li><div id="Par76" class="Para">Assert that the bundle has three associated books.</div></li><li><div id="Par77" class="Para">Make a <span class="EmphasisFontCategoryNonProportional">DELETE</span> request and check for a <span class="EmphasisFontCategoryNonProportional">204</span> response.</div></li><li><div id="Par78" class="Para">Verify that the removed book is not associated with the bundle anymore.</div></li><li><div id="Par79" class="Para">Verify that the bundle only has two associated books in the database after deleting the association.</div></li></ul></div>
      </div><div id="Par80" class="Para">The controller method is just like the <span class="EmphasisFontCategoryNonProportional">addBook()</span> method, except that you call <span class="EmphasisFontCategoryNonProportional">detach()</span> instead of <span class="EmphasisFontCategoryNonProportional">attach()</span> to remove the book from the bundle.</div><div id="Par81" class="Para">Up next is the controller method for removing a book from a book bundle (Listing <span class="InternalRef"><a href="#Par82">11-30</a></span>).</div><div id="Par82" class="Para">
            <div class="ProgramCode" id="PC30"><div class="FixedLine">38  <span class="EmphasisTypeBold">public function</span> removeBook($bundleId, $bookId)</div><div class="FixedLine">39  {</div><div class="FixedLine">40      $bundle = \App\Bundle::findOrFail($bundleId);</div><div class="FixedLine">41      $book = \App\Book::findOrFail($bookId);</div><div class="FixedLine">42</div><div class="FixedLine">43      $bundle-&gt;books()-&gt;detach($book);</div><div class="FixedLine">44</div><div class="FixedLine">45      <span class="EmphasisTypeBold">return</span> response(<span class="EmphasisTypeBold">null</span>, 204);</div><div class="FixedLine">46  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-30.</span><div class="SimplePara">Removing a Book in the BundlesController</div></div></div></div>
          </div><div id="Par83" class="Para">The <span class="EmphasisFontCategoryNonProportional">removeBook</span> method finds the bundle and book records, and then detaches the association between the bundle and book. The response sends back a null response body with a <span class="EmphasisFontCategoryNonProportional">204 No Content</span> on success.</div><div id="Par84" class="Para">Next, finalize your bundle features by running the full test suite (Listing <span class="InternalRef"><a href="#Par85">11-31</a></span>).</div><div id="Par85" class="Para">
            <div class="ProgramCode" id="PC31"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (53 tests, 279 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 11-31.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par86" class="Para ParaTypeImportant">
        <img src="A395120_1_En_11_Figa_HTML.jpg" alt="A395120_1_En_11_Figa_HTML.jpg"/> Git Commit: Add the Bundles API Resource</div><div id="Par87" class="Para ParaTypeImportant">
        <span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/bookr/commits/e720e5c"><span class="RefSource">e720e5c</span></a></span> (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/492e78b"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/492e78b</span>
              </span></a></span>)</div></div><div id="Sec5" class="Section1 RenderAsSection1"><h2 class="Heading">Conclusion</h2><div id="Par88" class="Para">You learned how to deal with adding and removing many-to-many associations through API requests, in addition to basic <span class="EmphasisFontCategoryNonProportional">GET</span> responses for all bundles and individual bundles. You now have enough experience in this book to write tests for the remaining <span class="EmphasisFontCategoryNonProportional">/bundle</span> CRUD operations and then implement each one. I demonstrated one way to represent many-to-many associations through an AP; you can now expand upon it with things like bulk adding and removing of books from a bundle.</div><div id="Par89" class="Para">In the next and final chapter of this book, you will explore polymorphic relationships, as well as some performance optimizations to your queries for associated records.</div></div></div></body></html>
