<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>Hello Lumen</title><link href="springer_epub.css" type="text/css" rel="styleSheet"/></head><body><div class="ChapterContextInformation"><div class="ContextInformation" id="b978-1-4842-2187-7_2"><div class="ChapterCopyright">© Paul Redmond 2016</div><span class="ContextInformationAuthorEditorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span></span></span><span class="ContextInformationBookTitles"><span class="BookTitle" xml:lang="en">Lumen Programming Guide</span></span><span class="ChapterDOI">10.1007/978-1-4842-2187-7_2</span></div></div><!--Begin Abstract--><div class="MainTitleSection"><h1 class="ChapterTitle" xml:lang="en">2. Hello Lumen</h1></div><div class="AuthorGroup"><div class="AuthorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span><sup>1 <span class="ContactIcon"/></sup></span></div><div class="Affiliations"><div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">Phoenix, Arizona, USA</div></div><div class="ClearBoth"> </div></div></div><!--End Abstract--><div class="Fulltext"><div id="Par1" class="Para">Let’s dive right into Lumen. In this chapter, you’ll learn how to set up a new Lumen project and you’ll explore some of Lumen’s basic features:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par2" class="Para">Routing</div></li><li><div id="Par3" class="Para">Middleware</div></li><li><div id="Par4" class="Para">Requests</div></li><li><div id="Par5" class="Para">Responses</div></li></ul></div>
    </div><div id="Par6" class="Para">To follow along, you should have the recommended Homestead environment from Chapter <span class="ExternalRef"><a href="A395120_1_En_1_Chapter.html"><span class="RefSource">1</span></a></span> installed.</div><div id="Sec1" class="Section1 RenderAsSection1"><h2 class="Heading">Setting Up a New Project</h2><div id="Par7" class="Para">Before you can get started, you need to create a new Lumen project in Homestead. To create a new project, ssh into Homestead virtual machine and use Composer to create a new Lumen project (Listing <span class="InternalRef"><a href="#Par8">2-1</a></span>).</div><div id="Par8" class="Para">
            <div class="ProgramCode" id="PC1"><div class="LineGroup"><div class="FixedLine"># On your local machine</div><div class="FixedLine">$ cd ∼/Code/Homestead</div><div class="FixedLine">$ vagrant ssh</div></div><div class="LineGroup"><div class="FixedLine"># In the virtual machine</div><div class="FixedLine">vagrant@homestead:∼$ cd ∼/Code</div><div class="FixedLine">vagrant@homestead:∼/Code$ composer create-project \</div><div class="FixedLine">  laravel/lumen=∼5.2.0 --prefer-dist hello-lumen</div><div class="FixedLine">vagrant@homestead:∼/Code$ cd hello-lumen</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-1.</span><div class="SimplePara">Creating a New Lumen Application in Homestead</div></div></div></div>
          </div><div id="Par9" class="Para ParaTypeImportant ParaOneEmphasisChild">The book examples assume Homestead was cloned to the suggested path <span class="EmphasisFontCategoryNonProportional">∼/Code/Homestead</span>. Adjust the commands if you cloned Homestead elsewhere.</div><div id="Par10" class="Para">In the Homestead virtual machine, you change the directory to <span class="EmphasisFontCategoryNonProportional">∼/Code,</span> where your application files will live. Next, you use Composer’s <span class="EmphasisFontCategoryNonProportional">create-project</span> command to create a new Lumen project. The last argument in the <span class="EmphasisFontCategoryNonProportional">create-project</span> command tells Composer to create the project in the path <span class="EmphasisFontCategoryNonProportional">∼/Code/hello-lumen</span>. Now that you’ve created a new project on the virtual machine, you should also see a shared local path at <span class="EmphasisFontCategoryNonProportional">∼/Code/hello-lumen</span> on your own machine.</div><div id="Par11" class="Para">The next step is telling Homestead about the <span class="EmphasisFontCategoryNonProportional">hello-lumen</span> application. On your local machine, open <span class="EmphasisFontCategoryNonProportional">∼/.homestead/Homestead.yaml</span> and find the default project under the <span class="EmphasisFontCategoryNonProportional">sites</span> key (Listing <span class="InternalRef"><a href="#Par12">2-2</a></span>).</div><div id="Par12" class="Para">
            <div class="ProgramCode" id="PC2"><div class="FixedLine">sites:</div><div class="FixedLine">    - map: homestead.app</div><div class="FixedLine">      to: /home/vagrant/Code/Laravel/public</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-2.</span><div class="SimplePara">Default Sites Configuration in Homestead.yaml</div></div></div></div>
          </div><div id="Par13" class="Para">Replace it with the code in Listing <span class="InternalRef"><a href="#Par14">2-3</a></span> and save the file.</div><div id="Par14" class="Para">
            <div class="ProgramCode" id="PC3"><div class="FixedLine">sites:</div><div class="FixedLine">    - map: hello-lumen.app</div><div class="FixedLine">      to: /home/vagrant/Code/hello-lumen/public</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-3.</span><div class="SimplePara">Default Sites Configuration in Homestead.yaml</div></div></div></div>
          </div><div id="Par15" class="Para">Configure the project’s hostname and the path to the <span class="EmphasisFontCategoryNonProportional">public</span> folder on the virtual machine. Save the file and run <span class="EmphasisFontCategoryNonProportional">vagrant provision</span> on your local machine to update Homestead with the new configuration changes (Listing <span class="InternalRef"><a href="#Par16">2-4</a></span>).</div><div id="Par16" class="Para">
            <div class="ProgramCode" id="PC4"><div class="FixedLine">&gt; cd ∼/Code/Homestead</div><div class="FixedLine">&gt; vagrant provision</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-4.</span><div class="SimplePara">Provision Vagrant Locally</div></div></div></div>
          </div><div id="Par17" class="Para ParaTypeImportant">Every time you update <span class="EmphasisFontCategoryNonProportional">Homestead.yaml</span> you will need to run the <span class="EmphasisFontCategoryNonProportional">vagrant provision</span> command.</div><div id="Par18" class="Para">Once Vagrant is finished provisioning the machine, the last step is adding an entry to the <span class="EmphasisFontCategoryNonProportional">hosts</span> file on your local machine. The <span class="EmphasisFontCategoryNonProportional">hosts</span> file will map the hostname <span class="EmphasisFontCategoryNonProportional">hello-lumen.app</span> to your virtual machine’s IP address. You can find Homestead’s IP address by finding the <span class="EmphasisFontCategoryNonProportional">ip</span> key in the ∼<span class="EmphasisFontCategoryNonProportional">/.homestead/Homestead.yaml</span> file—you should see something like <span class="EmphasisFontCategoryNonProportional">ip: "192.168.10.10"</span>.</div><div id="Par19" class="Para">Take note of the IP address so you can add it to the local <span class="EmphasisFontCategoryNonProportional">hosts</span> file. To update the <span class="EmphasisFontCategoryNonProportional">hosts</span> file on Mac or Linux, the file path is <span class="EmphasisFontCategoryNonProportional">/etc/hosts</span>; if you are on Windows, the file path is <span class="EmphasisFontCategoryNonProportional">C:\Windows\System32\drivers\etc\hosts</span>. Add the line from Listing <span class="InternalRef"><a href="#Par20">2-5</a></span> to your <span class="EmphasisFontCategoryNonProportional">hosts</span> file.</div><div id="Par20" class="Para">
            <div class="ProgramCode" id="PC5"><div class="FixedLine">192.168.10.10 hello-lumen.app</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-5.</span><div class="SimplePara">Adding Hostname to Hosts File</div></div></div></div>
          </div><div id="Par21" class="Para ParaTypeImportant ParaOneEmphasisChild">Be sure to use the IP address found in your <span class="EmphasisFontCategoryNonProportional">∼/.homestead/Homestead.yaml</span> file, not the IP shown in this book. It might be the same, but make sure.</div><div id="Par22" class="Para">After updating the <span class="EmphasisFontCategoryNonProportional">hosts</span> file, visit <span class="ExternalRef"><a href="http://hello-lumen.app/"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">http://hello-lumen.app/</span>
              </span></a></span> in your browser and you should see something similar to Figure <span class="InternalRef"><a href="#Fig1">2-1</a></span>.<div class="Figure" id="Fig1"><div class="MediaObject" id="MO1"><img src="A395120_1_En_2_Fig1_HTML.jpg" alt="A395120_1_En_2_Fig1_HTML.jpg"/></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Figure 2-1.</span><div class="SimplePara">Lumen default route</div></div></div></div>
      </div><div id="Par23" class="Para">You should now have a working hello-lumen project. Let’s get to work!</div></div><div id="Sec2" class="Section1 RenderAsSection1"><h2 class="Heading">Routes</h2><div id="Par24" class="Para">Routing (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/routing"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/routing</span>
              </span></a></span>) is the first feature we will cover. Application routes in Lumen are defined in the <span class="EmphasisFontCategoryNonProportional">app/Http/routes.php</span> file. In the most basic form, routing configuration includes an HTTP verb (GET, POST, etc.) which accepts a URI and a <span class="EmphasisFontCategoryNonProportional">Closure</span>. We will use the Closure style routes in this chapter, but we will use controllers throughout the book.</div><div id="Par25" class="Para">The first routes will be two simple “Hello World” examples to introduce you to routing:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par26" class="Para ParaOneEmphasisChild">
              <span class="EmphasisFontCategoryNonProportional">/hello/world</span> which responds with the text “Hello World”</div></li><li><div id="Par27" class="Para ParaOneEmphasisChild">
              <span class="EmphasisFontCategoryNonProportional">/hello/{name}</span> which responds with a customized greeting</div></li></ul></div>
      </div><div id="Par28" class="Para">Before you define your own routes, if you open the file <span class="EmphasisFontCategoryNonProportional">app/Http/routes.php,</span> the default contents looks like Listing <span class="InternalRef"><a href="#Par29">2-6</a></span>.</div><div id="Par29" class="Para">
            <div class="ProgramCode" id="PC6"><div class="LineGroup"><div class="FixedLine">&lt;?php</div></div><div class="LineGroup"><div class="FixedLine">$app-&gt;get('/', <span class="EmphasisTypeBold">function</span> () <span class="EmphasisTypeBold">use</span> ($app) {</div><div class="FixedLine">    <span class="EmphasisTypeBold">return</span> $app-&gt;version();</div><div class="FixedLine">});</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-6.</span><div class="SimplePara">The Default Lumen Route in app/Http/routes.php</div></div></div></div>
          </div><div id="Par30" class="Para">The <span class="EmphasisFontCategoryNonProportional">$app</span> variable in the routes file is an instance of <span class="EmphasisFontCategoryNonProportional">\Laravel\Lumen\Application</span> which is defined in the <span class="EmphasisFontCategoryNonProportional">bootstrap/app.php</span> file. The application routes file is imported near the end of <span class="EmphasisFontCategoryNonProportional">bootstrap/app.php</span> (Listing <span class="InternalRef"><a href="#Par31">2-7</a></span>).</div><div id="Par31" class="Para">
            <div class="ProgramCode" id="PC7"><div class="FixedLine">$app-&gt;group(['namespace' =&gt; 'App\Http\Controllers'], <span class="EmphasisTypeBold">function</span> ($app) {</div><div class="FixedLine">    <span class="EmphasisTypeBold">require</span> __DIR__.'/../app/Http/routes.php';</div><div class="FixedLine">});</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-7.</span><div class="SimplePara">The Bootstrap File Importing Routes</div></div></div></div>
          </div><div id="Sec3" class="Section2 RenderAsSection2"><h3 class="Heading">The Hello World Route</h3><div id="Par32" class="Para">Your first route is a simple <span class="EmphasisFontCategoryNonProportional">/hello/world</span> route that responds with the text “Hello World”. Open up the <span class="EmphasisFontCategoryNonProportional">app/Http/routes.php</span> file and add the route shown in Listing <span class="InternalRef"><a href="#Par33">2-8</a></span>.</div><div id="Par33" class="Para">
              <div class="ProgramCode" id="PC8"><div class="FixedLine">18  $app-&gt;get('/hello/world', <span class="EmphasisTypeBold">function</span> () <span class="EmphasisTypeBold">use</span> ($app) {</div><div class="FixedLine">19      <span class="EmphasisTypeBold">return</span> "Hello world!";</div><div class="FixedLine">20  });</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-8.</span><div class="SimplePara">The /hello/world Route in app/Http/routes.php</div></div></div></div>
            </div><div id="Par34" class="Para">The <span class="EmphasisFontCategoryNonProportional">$app-&gt;get()</span> method accepts a URI and a <span class="EmphasisFontCategoryNonProportional">\Closure</span> that gets executed to create the response. The route returns a string response. If you visit <span class="ExternalRef"><a href="http://hello-lumen.app/hello/world"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">http://hello-lumen.app/hello/world</span>
                </span></a></span> in your browser, you will see the response “Hello world!”</div><div id="Par35" class="Para">The <span class="EmphasisFontCategoryNonProportional">$app</span> instance has HTTP methods like <span class="EmphasisFontCategoryNonProportional">get</span>, <span class="EmphasisFontCategoryNonProportional">put</span>, <span class="EmphasisFontCategoryNonProportional">post</span>, and <span class="EmphasisFontCategoryNonProportional">delete</span> which are used to define routes. In this example, the defined route will respond to <span class="EmphasisFontCategoryNonProportional">GET</span> requests. If you try to send a <span class="EmphasisFontCategoryNonProportional">POST</span> request, you will get a <span class="EmphasisFontCategoryNonProportional">405</span> response (Listing <span class="InternalRef"><a href="#Par36">2-9</a></span>).</div><div id="Par36" class="Para">
              <div class="ProgramCode" id="PC9"><div class="FixedLine">$ curl -I -XPOST http://hello-lumen.app/hello/world</div><div class="FixedLine">HTTP/1.1 405 Method <span class="EmphasisTypeBold">Not</span> Allowed</div><div class="FixedLine">Server: nginx/1.9.7</div><div class="FixedLine">Content-Type: text/html; charset=UTF-8</div><div class="FixedLine">Transfer-Encoding: chunked</div><div class="FixedLine">Connection: keep-alive</div><div class="FixedLine">allow: GET</div><div class="FixedLine">Cache-Control: no-cache, <span class="EmphasisTypeBold">private</span>
            </div><div class="FixedLine">date: Tue, 29 Dec 2015 06:28:46 GMT</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-9.</span><div class="SimplePara">Trying to POST to the Hello World Route</div></div></div></div>
            </div></div><div id="Sec4" class="Section2 RenderAsSection2"><h3 class="Heading">Route Parameters</h3><div id="Par37" class="Para">The second route you are going to add has a dynamic route parameter (Listing <span class="InternalRef"><a href="#Par38">2-10</a></span>).</div><div id="Par38" class="Para">
              <div class="ProgramCode" id="PC10"><div class="FixedLine">22  $app-&gt;get('/hello/{name}', <span class="EmphasisTypeBold">function</span> ($name) <span class="EmphasisTypeBold">use</span> ($app) {</div><div class="FixedLine">23      <span class="EmphasisTypeBold">return</span> "Hello <span class="EmphasisTypeBold">{</span>$name<span class="EmphasisTypeBold">}</span>";</div><div class="FixedLine">24  });</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-10.</span><div class="SimplePara">Your Second Route</div></div></div></div>
            </div><div id="Par39" class="Para">The route URI has a required route parameter <span class="EmphasisFontCategoryNonProportional">{name}</span> which is then passed to the <span class="EmphasisFontCategoryNonProportional">\Closure</span>. You then <span class="EmphasisFontCategoryNonProportional">return y</span>our concatenated <span class="EmphasisFontCategoryNonProportional">$name</span> variable, which creates the HTTP response shown in Listing <span class="InternalRef"><a href="#Par40">2-11</a></span>.</div><div id="Par40" class="Para">
              <div class="ProgramCode" id="PC11"><div class="LineGroup"><div class="FixedLine">$ curl -i http://hello-lumen.app/hello/paul</div><div class="FixedLine">HTTP/1.1 200 OK</div><div class="FixedLine">Server: nginx/1.9.7</div><div class="FixedLine">Content-Type: text/html; charset=UTF-8</div><div class="FixedLine">Transfer-Encoding: chunked</div><div class="FixedLine">Connection: keep-alive</div><div class="FixedLine">Cache-Control: no-cache</div><div class="FixedLine">Date: Sat, 26 Dec 2015 21:27:19 GMT</div></div><div class="LineGroup"><div class="FixedLine">Hello paul</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-11.</span><div class="SimplePara">Example Response from the Router</div></div></div></div>
            </div><div id="Par41" class="Para">You can define multiple route parameters in one route and add constraints to them (only digits). I will go over plenty of route examples as you work through this book.</div></div></div><div id="Sec5" class="Section1 RenderAsSection1"><h2 class="Heading">Middleware and Responses</h2><div id="Par42" class="Para">Similar to express.js (<span class="ExternalRef"><a href="http://expressjs.com/"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">http://expressjs.com/</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> and many other web frameworks, Lumen has HTTP middleware (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/middleware"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/middleware</span>
              </span></a></span>). Middleware provides a way to filter incoming HTTP requests before a defined route handles the request. You can use middleware to do any number of things, like authentication, validating a signed request, and CORS support, to name a few. Middleware classes are typically created in the <span class="EmphasisFontCategoryNonProportional">app/Http/Middleware</span> path by convention; I suggest sticking to the convention unless you plan on writing a standalone package that includes middleware.</div><div id="Par43" class="Para">Lumen has two types of middleware configuration: global middleware and route middleware. What is the difference between the two types? Global middleware runs on every HTTP request and route middleware runs on specific routes (or groups of routes) configured to run the middleware. We will go over an example of each.</div><div id="Par44" class="Para">We will also cover an example of creating a response object in middleware. We will work with response objects throughout this book, but we will only touch on them lightly in this chapter.</div><div id="Sec6" class="Section2 RenderAsSection2"><h3 class="Heading">Global Middleware</h3><div id="Par45" class="Para">The first middleware example you will write is a simple request logger that logs every incoming request to the <span class="EmphasisFontCategoryNonProportional">storage/logs/lumen.log</span> application log file. Configuring the logging middleware to be a <span class="EmphasisTypeItalic">global middleware</span> makes sense because we want to log all HTTP requests.</div><div id="Par46" class="Para">Start by creating the file <span class="EmphasisFontCategoryNonProportional">app/Http/Middleware/RequestLogMiddleware.php</span> with the contents shown in Listing <span class="InternalRef"><a href="#Par47">2-12</a></span>.</div><div id="Par47" class="Para">
              <div class="ProgramCode" id="PC12"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2  </div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Middleware;</div><div class="FixedLine"> 4  </div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> Log;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> Closure;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> Illuminate\Http\Request;</div><div class="FixedLine"> 8  </div><div class="FixedLine"> 9  <span class="EmphasisTypeBold">class RequestLogMiddleware</span>
            </div><div class="FixedLine">10  {</div><div class="FixedLine">11      <span class="EmphasisTypeBold">public function</span> handle(Request $request, Closure $next)</div><div class="FixedLine">12      {</div><div class="FixedLine">13          Log::info("Request Logged<span class="EmphasisTypeBold">\n</span>" .</div><div class="FixedLine">14              sprintf("∼∼∼∼<span class="EmphasisTypeBold">\n</span>%s∼∼∼∼", (string) $request));</div><div class="FixedLine">15  </div><div class="FixedLine">16          <span class="EmphasisTypeBold">return</span> $next($request);</div><div class="FixedLine">17      }</div><div class="FixedLine">18  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-12.</span><div class="SimplePara">Creating the RequestLogMiddleware</div></div></div></div>
            </div><div id="Par48" class="Para">Middleware needs to define a <span class="EmphasisFontCategoryNonProportional">handle</span> method that accepts two parameters: the request object and a <span class="EmphasisFontCategoryNonProportional">Closure</span> instance. The request object is an instance of <span class="EmphasisFontCategoryNonProportional">Illuminate\Http\Request</span> and represents the current request.</div><div id="Par49" class="Para ParaTypeImportant ParaOneEmphasisChild">Each middleware must call return <span class="EmphasisFontCategoryNonProportional">$next($request)</span> at some point in order to continue processing the request.</div><div id="Par50" class="Para">Now you need to register your new middleware in <span class="EmphasisFontCategoryNonProportional">bootstrap/app.php</span> (Listing <span class="InternalRef"><a href="#Par51">2-13</a></span>).</div><div id="Par51" class="Para">
              <div class="ProgramCode" id="PC13"><div class="FixedLine">62  <span class="EmphasisTypeItalic">// $app-&gt;middleware([</span>
            </div><div class="FixedLine">63  <span class="EmphasisTypeItalic">//    App\Http\Middleware\ExampleMiddleware::class</span>
            </div><div class="FixedLine">64  <span class="EmphasisTypeItalic">// ]);</span>
            </div><div class="FixedLine">65  </div><div class="FixedLine">66  $app-&gt;middleware([</div><div class="FixedLine">67      App\Http\Middleware\RequestLogMiddleware::class</div><div class="FixedLine">68  ]);</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-13.</span><div class="SimplePara">Registering a Global Middleware</div></div></div></div>
            </div><div id="Par52" class="Para ParaOneEmphasisChild">The <span class="EmphasisFontCategoryNonProportional">Application::middleware()</span> method accepts an array of middleware class names. I have included the commented out middleware so you can see other types of middleware that ship with Lumen.</div><div id="Par53" class="Para">There is one more step to get the middleware working: you need to enable facades (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/facades"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/facades</span>
                </span></a></span>) so the <span class="EmphasisFontCategoryNonProportional">Log</span> class will work as expected.</div><div id="Par54" class="Para">In <span class="EmphasisFontCategoryNonProportional">bootstrap/app.php,</span> uncomment the code in Listing <span class="InternalRef"><a href="#Par55">2-14</a></span>.</div><div id="Par55" class="Para">
              <div class="ProgramCode" id="PC14"><div class="FixedLine">26  <span class="EmphasisTypeItalic">// $app-&gt;withFacades();</span>
            </div><div class="FixedLine">27  $app-&gt;withFacades();</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-14.</span><div class="SimplePara">Enabling Facades in the Application</div></div></div></div>
            </div><div id="Par56" class="Para">With facades enabled, the new middleware will add a log entry to <span class="EmphasisFontCategoryNonProportional">storage/logs/lumen.log</span> for every request (Listing <span class="InternalRef"><a href="#Par57">2-15</a></span>).</div><div id="Par57" class="Para">
              <div class="ProgramCode" id="PC15"><div class="FixedLine">[2015-12-26 21:47:53] lumen.INFO: Request Logged</div><div class="FixedLine">GET /hello/paul HTTP/1.1</div><div class="FixedLine">...</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-15.</span><div class="SimplePara">Partial Log Output from RequestLogMiddleware in lumen.log</div></div></div></div>
            </div><div id="FPar1" class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant"><div class="Heading">Facades</div><div id="Par58" class="Para">The facade pattern provides a static interface to classes available in the service container (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/container"><span class="RefSource">
                    <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/container</span>
                  </span></a></span>).</div><div id="Par59" class="Para">It offers a clean style that I personally like, but you are not required to use it.</div><div id="Par60" class="Para">Lumen offers various ways of resolving dependencies out of the container, which you will see in this book. Also be sure to read the “Resolving” section of the documentation (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/container"><span class="RefSource">
                    <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/container</span>
                  </span></a></span>).</div></div><div id="Par61" class="Para">The middleware should be working. What happens if we forget to call <span class="EmphasisFontCategoryNonProportional">$next($request)</span>? To experiment, you would get the following response (Listing <span class="InternalRef"><a href="#Par62">2-16</a></span>) by removing <span class="EmphasisFontCategoryNonProportional">return $next($request)</span> from the middleware (be sure to put it back).</div><div id="Par62" class="Para">
              <div class="ProgramCode" id="PC16"><div class="FixedLine">$ curl -i http://hello-lumen.app/hello/paul</div><div class="FixedLine">HTTP/1.1 200 OK</div><div class="FixedLine">Server: nginx/1.9.7</div><div class="FixedLine">Date: Sat, 26 Dec 2015 21:54:00 GMT</div><div class="FixedLine">Content-Type: text/html; charset=UTF-8</div><div class="FixedLine">Transfer-Encoding: chunked</div><div class="FixedLine">Connection: keep-alive</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-16.</span><div class="SimplePara">What Happens When $next($request) Is Not Returned?</div></div></div></div>
            </div><div id="Par63" class="Para">Middleware can also control <span class="EmphasisTypeBold">whether or not</span> the HTTP request should continue being processed. For example, an authentication middleware would deny access to guests trying to access secured parts of the application by sending a <span class="EmphasisFontCategoryNonProportional">403 Forbidden</span> response instead of proceeding with the request. Middleware should either allow the request to continue or send a response back.</div></div><div id="Sec7" class="Section2 RenderAsSection2"><h3 class="Heading">Route Middleware</h3><div id="Par64" class="Para">Our next middleware will be <span class="EmphasisTypeItalic">route middleware</span> for the <span class="EmphasisFontCategoryNonProportional">/hello/{name}</span> route. Create a new middleware class in <span class="EmphasisFontCategoryNonProportional">app/Http/Middleware/HelloMiddleware.php</span> with the code from Listing <span class="InternalRef"><a href="#Par65">2-17</a></span>.</div><div id="Par65" class="Para">
              <div class="ProgramCode" id="PC17"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Middleware;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> Closure;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> Illuminate\Http\Request;</div><div class="FixedLine"> 7</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">class HelloMiddleware</span>
            </div><div class="FixedLine"> 9  {</div><div class="FixedLine">10      <span class="EmphasisTypeBold">public function</span> handle(Request $request, Closure $next)</div><div class="FixedLine">11      {</div><div class="FixedLine">12          <span class="EmphasisTypeBold">if</span> (preg_match('/balrog$/i', $request-&gt;getRequestUri())) {</div><div class="FixedLine">13              <span class="EmphasisTypeBold">return</span> response('YOU SHALL NOT PASS!', 403);</div><div class="FixedLine">14          }</div><div class="FixedLine">15</div><div class="FixedLine">16          <span class="EmphasisTypeBold">return</span> $next($request);</div><div class="FixedLine">17      }</div><div class="FixedLine">18  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-17.</span><div class="SimplePara">Creating the HelloMiddleware</div></div></div></div>
            </div><div id="Par66" class="Para">The <span class="EmphasisFontCategoryNonProportional">HelloMiddleware</span> checks the request URI against a case-insensitive regex pattern. If the URI matches the regex pattern, the middleware returns a <span class="EmphasisFontCategoryNonProportional">403 forbidden</span> response error with the <span class="EmphasisFontCategoryNonProportional">response()</span> helper function. If the user is not asking to say hello to a balrog, the request will proceed as expected.</div><div id="Par67" class="Para">In order to use the <span class="EmphasisFontCategoryNonProportional">HelloMiddleware</span> you need to configure it in <span class="EmphasisFontCategoryNonProportional">bootstrap/app.php</span> (Listing <span class="InternalRef"><a href="#Par68">2-18</a></span>).</div><div id="Par68" class="Para">
              <div class="ProgramCode" id="PC18"><div class="FixedLine">66  $app-&gt;middleware([</div><div class="FixedLine">67      App\Http\Middleware\RequestLogMiddleware::class</div><div class="FixedLine">68  ]);</div><div class="FixedLine">69</div><div class="FixedLine">70  $app-&gt;routeMiddleware([</div><div class="FixedLine">71      'hello' =&gt; App\Http\Middleware\HelloMiddleware::class</div><div class="FixedLine">72  ]);</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-18.</span><div class="SimplePara">Registering the HelloMiddleware</div></div></div></div>
            </div><div id="Par69" class="Para">The <span class="EmphasisFontCategoryNonProportional">$app-&gt;routeMiddleware()</span> method takes an associative array. The key <span class="EmphasisFontCategoryNonProportional">hello</span> is a shorthand reference to the middleware class; the shorthand key configures routes to use the middleware (Listing <span class="InternalRef"><a href="#Par70">2-19</a></span>).</div><div id="Par70" class="Para">
              <div class="ProgramCode" id="PC19"><div class="FixedLine">22  $app-&gt;get('/hello/{name}', ['middleware' =&gt; 'hello', <span class="EmphasisTypeBold">function</span> ($name) {</div><div class="FixedLine">23      <span class="EmphasisTypeBold">return</span> "Hello <span class="EmphasisTypeBold">{</span>$name<span class="EmphasisTypeBold">}</span>";</div><div class="FixedLine">24  }]);</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-19.</span><div class="SimplePara">Configuring Your Route to Use the HelloMiddleware</div></div></div></div>
            </div><div id="Par71" class="Para">You have changed the second parameter in <span class="EmphasisFontCategoryNonProportional">$app-&gt;get()</span> to an <span class="EmphasisFontCategoryNonProportional">array</span>. The <span class="EmphasisFontCategoryNonProportional">middleware</span> key instructs your route to run the ‘hello’ middleware you defined in your <span class="EmphasisFontCategoryNonProportional">bootstrap/app.php</span> file. Note that the code example also drops <span class="EmphasisFontCategoryNonProportional">use($app)</span> in your <span class="EmphasisFontCategoryNonProportional">Closure</span> because you are not using <span class="EmphasisFontCategoryNonProportional">$app</span> inside the <span class="EmphasisFontCategoryNonProportional">Closure</span>.</div><div id="Par72" class="Para">Now if you try saying hello to a balrog the middleware will authoritatively stop the request (Listing <span class="InternalRef"><a href="#Par73">2-20</a></span>).</div><div id="Par73" class="Para">
              <div class="ProgramCode" id="PC20"><div class="LineGroup"><div class="FixedLine">$ curl -i http://hello-lumen.app/hello/balrog</div><div class="FixedLine">HTTP/1.1 403 Forbidden</div><div class="FixedLine">Server: nginx/1.9.7</div><div class="FixedLine">Content-Type: text/html; charset=UTF-8</div><div class="FixedLine">Transfer-Encoding: chunked</div><div class="FixedLine">Connection: keep-alive</div><div class="FixedLine">Cache-Control: no-cache</div><div class="FixedLine">Date: Sun, 27 Dec 2015 02:00:27 GMT</div></div><div class="LineGroup"><div class="FixedLine">YOU SHALL NOT PASS!</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-20.</span><div class="SimplePara">Saying Hello to a Balrog</div></div></div></div>
            </div><div id="Par74" class="Para">We are done with your quick tour of middleware. To learn more about middleware, read the full documentation (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/middleware"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/middleware</span>
                </span></a></span>). Another good resource is reading the source code of the middleware that ships with Lumen.</div></div></div><div id="Sec8" class="Section1 RenderAsSection1"><h2 class="Heading">The Request and Response Objects</h2><div id="Par75" class="Para">You will become quite familiar with getting data from requests and returning responses while building APIs with Lumen. We will quickly touch on each so you can get your feet wet. We will be using these objects extensively throughout the book, so using them should become second nature by the end of this book. Let’s dive in to the request object first.</div><div id="Sec9" class="Section2 RenderAsSection2"><h3 class="Heading">The Request</h3><div id="Par76" class="Para">The request object (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/requests"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/requests</span>
                </span></a></span>) represents the HTTP request and is one of the essential objects that you need to familiarize yourself with. It provides methods to access basic information about the HTTP request and to access things like POST data and query string parameters, to name a few. To access the request in your routes, you type-hint the <span class="EmphasisFontCategoryNonProportional">Illuminate\Http\Request</span> class on your route. Type-hinting the request object (Listing <span class="InternalRef"><a href="#Par77">2-21</a></span>) automatically injects the request from the service container (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/container"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/container</span>
                </span></a></span>
          <span class="EmphasisFontCategoryNonProportional">)</span>.</div><div id="Par77" class="Para">
              <div class="ProgramCode" id="PC21"><div class="FixedLine">26  $app-&gt;get('/request', function (Illuminate\Http\Request $request) {</div><div class="FixedLine">27      return "Hello " . $request-&gt;get('name', 'stranger');</div><div class="FixedLine">28  });</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-21.</span><div class="SimplePara">Using the Request Object</div></div></div></div>
            </div><div id="Par78" class="Para">In Listing <span class="InternalRef"><a href="#Par77">2-21</a></span>, the route returns a string from the query string parameter <span class="EmphasisFontCategoryNonProportional">name</span>, and the second argument, <span class="EmphasisFontCategoryNonProportional">'stranger'</span>, is the default value returned when the <span class="EmphasisFontCategoryNonProportional">name</span> parameter is not present in the request. Making a request without the <span class="EmphasisFontCategoryNonProportional">name</span> parameter will return the responses shown in Listing <span class="InternalRef"><a href="#Par79">2-22</a></span>.</div><div id="Par79" class="Para">
              <div class="ProgramCode" id="PC22"><div class="LineGroup"><div class="FixedLine">$ curl http://hello-lumen.app/request</div><div class="FixedLine">Hello stranger</div></div><div class="LineGroup"><div class="FixedLine">$ curl http://hello-lumen.app/request\?name\=Paul</div><div class="FixedLine">Hello Paul</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-22.</span><div class="SimplePara">Experimenting with Request::get()</div></div></div></div>
            </div><div id="Par80" class="Para">The request object has many useful methods, and I highly encourage you to browse the source code and read all the documentation (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/requests"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/requests</span>
                </span></a></span>
          <span class="EmphasisFontCategoryNonProportional">)</span> on requests.</div></div><div id="Sec10" class="Section2 RenderAsSection2"><h3 class="Heading">The Response</h3><div id="Par81" class="Para">Lumen provides a response object to represent an HTTP response which provides convenient methods that make it easy to craft valid HTTP responses and return JSON, which is the response type you will return throughout this book—you are building APIs after all!</div><div id="Par82" class="Para ParaOneEmphasisChild">You can create a response in a number of ways, and I’ll show you a few examples, including crafting a response from the <span class="EmphasisFontCategoryNonProportional">Illuminate\Http\Response</span> object and some convenience functions for easily responding with JSON. We will also build on the request object to show you some basic content negotiation.</div><div id="Par83" class="Para">The first way to create a response is returning an instance of the <span class="EmphasisFontCategoryNonProportional">Illuminate\Http\Response</span> object in a route (Listing <span class="InternalRef"><a href="#Par84">2-23</a></span>).</div><div id="Par84" class="Para">
              <div class="ProgramCode" id="PC23"><div class="FixedLine">30  $app-&gt;get('/response', function (Illuminate\Http\Request $request) {</div><div class="FixedLine">31      return (new Illuminate\Http\Response('Hello stranger', 200))</div><div class="FixedLine">32          -&gt;header('Content-Type', 'text/plain');</div><div class="FixedLine">33  });</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-23.</span><div class="SimplePara">Using the Illuminate Response Object</div></div></div></div>
            </div><div id="Par85" class="Para">In Listing <span class="InternalRef"><a href="#Par84">2-23</a></span>, we return the response object, set the status code to a 200 OK, and set the Content-Type header to <span class="EmphasisFontCategoryNonProportional">text/plain</span>. To expand on this example, let’s do some inline content negotiation and return JSON when the client asks for it (Listing <span class="InternalRef"><a href="#Par86">2-24</a></span>).</div><div id="Par86" class="Para">
              <div class="ProgramCode" id="PC24"><div class="FixedLine">30  $app-&gt;get('/response', function (Illuminate\Http\Request $request) {</div><div class="FixedLine">31      if ($request-&gt;wantsJson()) {</div><div class="FixedLine">32          return response()-&gt;json(['greeting' =&gt; 'Hello stranger']);</div><div class="FixedLine">33      }</div><div class="FixedLine">34</div><div class="FixedLine">35      return (new Illuminate\Http\Response('Hello stranger', 200))</div><div class="FixedLine">36          -&gt;header('Content-Type', 'text/plain');</div><div class="FixedLine">37  });</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-24.</span><div class="SimplePara">Responding with JSON</div></div></div></div>
            </div><div id="Par87" class="Para">In Listing <span class="InternalRef"><a href="#Par86">2-24</a></span>, you use the <span class="EmphasisFontCategoryNonProportional">Request</span> object to check if the client is asking for JSON. If the client wants JSON, you use the <span class="EmphasisFontCategoryNonProportional">response()</span> helper function, which returns an instance of the <span class="EmphasisFontCategoryNonProportional">Laravel\Lumen\Http\ResponseFactory</span>. Now you can get a JSON greeting (Listing <span class="InternalRef"><a href="#Par88">2-25</a></span>).</div><div id="Par88" class="Para">
              <div class="ProgramCode" id="PC25"><div class="LineGroup"><div class="FixedLine">$ curl -H"Accept: application/json" \</div><div class="FixedLine">    http://hello-lumen.app/response</div></div><div class="LineGroup"><div class="FixedLine">{"greeting":"Hello stranger"}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-25.</span><div class="SimplePara">Returning a JSON Response</div></div></div></div>
            </div><div id="Par89" class="Para">The <span class="EmphasisFontCategoryNonProportional">ResponseFactory</span> has three convenient methods: <span class="EmphasisFontCategoryNonProportional">make()</span>, <span class="EmphasisFontCategoryNonProportional">json()</span>, and <span class="EmphasisFontCategoryNonProportional">download(</span>). You’ve seen <span class="EmphasisFontCategoryNonProportional">json()</span> already, but the above route could be written as shown in Listing <span class="InternalRef"><a href="#Par90">2-26</a></span> to use the <span class="EmphasisFontCategoryNonProportional">make()</span> method instead of initializing an instance of the response.</div><div id="Par90" class="Para">
              <div class="ProgramCode" id="PC26"><div class="FixedLine">30  $app-&gt;get('/response', function (Illuminate\Http\Request $request) {</div><div class="FixedLine">31      if ($request-&gt;wantsJson()) {</div><div class="FixedLine">32          return response()-&gt;json(['greeting' =&gt; 'Hello stranger']);</div><div class="FixedLine">33      }</div><div class="FixedLine">34      </div><div class="FixedLine">35      return response()</div><div class="FixedLine">36          -&gt;make('Hello stranger', 200, ['Content-Type' =&gt; 'text/plain']);</div><div class="FixedLine">37  });</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 2-26.</span><div class="SimplePara">Using the ResponseFactory</div></div></div></div>
            </div><div id="Par91" class="Para">Some people might prefer to directly initialize the <span class="EmphasisFontCategoryNonProportional">Response</span> object, but I personally like using the <span class="EmphasisFontCategoryNonProportional">response()</span> helper function. I think the helper function cleans up code nicely and is convenient. Note that the third argument in <span class="EmphasisFontCategoryNonProportional">make()</span> accepts an optional array of HTTP response headers.</div></div></div><div id="Sec11" class="Section1 RenderAsSection1"><h2 class="Heading">Onward</h2><div id="Par92" class="Para">We are done with the tour of the basic parts of Lumen. In the next chapter, we will create another Lumen application and prepare to write test-driven features as we work through the remainder of the book.</div></div></div></body></html>
