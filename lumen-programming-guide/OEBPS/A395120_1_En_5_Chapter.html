<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>Creating, Reading, Updating, and Deleting Books</title><link href="springer_epub.css" type="text/css" rel="styleSheet"/></head><body><div class="ChapterContextInformation"><div class="ContextInformation" id="b978-1-4842-2187-7_5"><div class="ChapterCopyright">© Paul Redmond 2016</div><span class="ContextInformationAuthorEditorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span></span></span><span class="ContextInformationBookTitles"><span class="BookTitle" xml:lang="en">Lumen Programming Guide</span></span><span class="ChapterDOI">10.1007/978-1-4842-2187-7_5</span></div></div><!--Begin Abstract--><div class="MainTitleSection"><h1 class="ChapterTitle" xml:lang="en">5. Creating, Reading, Updating, and Deleting Books</h1></div><div class="AuthorGroup"><div class="AuthorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span><sup>1 <span class="ContactIcon"/></sup></span></div><div class="Affiliations"><div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">Phoenix, Arizona, USA</div></div><div class="ClearBoth"> </div></div></div><!--End Abstract--><div class="Fulltext"><div id="Par1" class="Para">Now that you have a <span class="EmphasisTypeBold">Books</span> model, you are well-equipped to handle the management of books. You will continue to follow your test-driven development workflow as you complete the remaining CRUD operations of the <span class="EmphasisFontCategoryNonProportional">/books</span> API.</div><div id="Par2" class="Para">Listing <span class="InternalRef"><a href="#Par3">5-1</a></span> shows a quick refresher of your <span class="EmphasisFontCategoryNonProportional">/books</span> RESTful endpoints.</div><div id="Par3" class="Para">
          <div class="ProgramCode" id="PC1"><div class="FixedLine">GET    /books       Get all the books</div><div class="FixedLine">POST   /books       Create a new book</div><div class="FixedLine">GET    /books/{id}  Get a book</div><div class="FixedLine">PUT    /books/{id}  Update a book</div><div class="FixedLine">DELETE /books/{id}  Delete a book</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-1.</span><div class="SimplePara">Basic REST /books Resource</div></div></div></div>
        </div><div id="Sec1" class="Section1 RenderAsSection1"><h2 class="Heading">Requesting an Individual Book</h2><div id="Par4" class="Para">You are going to start off with the <span class="EmphasisFontCategoryNonProportional">GET /books/{id}</span> route. Before you start coding, let’s quickly define your high-level acceptance criteria for this route. You can do this within the <span class="EmphasisFontCategoryNonProportional">tests/app/Http/Controllers/BooksControllerTest.php</span> file by defining the skeleton test methods, as shown in Listing <span class="InternalRef"><a href="#Par5">5-2</a></span>.</div><div id="Par5" class="Para">
            <div class="ProgramCode" id="PC2"><div class="FixedLine">28  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">29  <span class="EmphasisTypeBold">public function</span> show_should_return_a_valid_book()</div><div class="FixedLine">30  {</div><div class="FixedLine">31      $this-&gt;markTestIncomplete('Pending test');</div><div class="FixedLine">32  }</div><div class="FixedLine">33</div><div class="FixedLine">34  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">35  <span class="EmphasisTypeBold">public function</span> show_should_fail_when_the_book_id_does_not_exist()</div><div class="FixedLine">36  {</div><div class="FixedLine">37      $this-&gt;markTestIncomplete('Pending test');</div><div class="FixedLine">38  }</div><div class="FixedLine">39</div><div class="FixedLine">40  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">41  <span class="EmphasisTypeBold">public function</span> show_route_should_not_match_an_invalid_route()</div><div class="FixedLine">42  {</div><div class="FixedLine">43      $this-&gt;markTestIncomplete('Pending test');</div><div class="FixedLine">44  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-2.</span><div class="SimplePara">The GET books/:id Acceptance Criteria</div></div></div></div>
          </div><div id="Par6" class="Para">You mark these tests as incomplete while you work through each criterion. Running your test suite will provide the output shown in Listing <span class="InternalRef"><a href="#Par7">5-3</a></span>.</div><div id="Par7" class="Para">
            <div class="ProgramCode" id="PC3"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK, but incomplete, skipped, or risky tests!</div><div class="FixedLine">Tests: 5, Assertions: 3, Incomplete: 3.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-3.</span><div class="SimplePara">Running phpunit with New Pending Tests</div></div></div></div>
          </div><div id="Par8" class="Para">I want to point out that your tests rely on seed data. Using seed data for tests is not ideal, and you will address it in Chapter <span class="ExternalRef"><a href="A395120_1_En_6_Chapter.html"><span class="RefSource">6</span></a></span>. In the meantime, you need to make sure that the database has seed data before running tests that rely on specific data in the database. You can always ensure that the database is fresh by running the code in Listing <span class="InternalRef"><a href="#Par9">5-4</a></span>.</div><div id="Par9" class="Para">
            <div class="ProgramCode" id="PC4"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan migrate:refresh</div><div class="FixedLine">$ php artisan db:seed</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-4.</span><div class="SimplePara">How to Refresh the Migrations and Seed the Database</div></div></div></div>
          </div><div id="Par10" class="Para">Let’s get to work on the first acceptance criterion: <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">show_should_return_a_valid_book</span></span> (Listing <span class="InternalRef"><a href="#Par15">5-5</a></span>). To meet this acceptance criterion, you need to
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par11" class="Para">Find the book in the database.</div></li><li><div id="Par12" class="Para">Respond with the book’s data.</div></li><li><div id="Par13" class="Para">Make sure it responds with a correct status code.</div></li><li><div id="Par14" class="Para">Assert that the JSON data returned is accurate.</div></li></ul></div>
      </div><div id="Par15" class="Para">
            <div class="ProgramCode" id="PC5"><div class="FixedLine">28  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">29  <span class="EmphasisTypeBold">public function</span> show_should_return_a_valid_book()</div><div class="FixedLine">30  {</div><div class="FixedLine">31      $this</div><div class="FixedLine">32          -&gt;get('/books/1')</div><div class="FixedLine">33          -&gt;seeStatusCode(200)</div><div class="FixedLine">34          -&gt;seeJson([</div><div class="FixedLine">35              'id' =&gt; 1,</div><div class="FixedLine">36              'title' =&gt; 'War of the Worlds',</div><div class="FixedLine">37              'description' =&gt; 'A science fiction masterpiece about Martians invading London',</div><div class="FixedLine">38              'author' =&gt; 'H. G. Wells'</div><div class="FixedLine">39          ]);</div><div class="FixedLine">40</div><div class="FixedLine">41      $data = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">42      $this-&gt;assertArrayHasKey('created_at', $data);</div><div class="FixedLine">43      $this-&gt;assertArrayHasKey('updated_at', $data);</div><div class="FixedLine">44  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-5.</span><div class="SimplePara">Testing for a Valid Book</div></div></div></div>
          </div><div id="Par16" class="Para">You’ve already seen <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">seeStatusCode</span></span> and <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">seeJson</span></span>. The only thing new in Listing <span class="InternalRef"><a href="#Par15">5-5</a></span> is the last three lines that get the response body (JSON) and decode it. The test simply checks the existence of <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">created_at</span></span> and <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">updated_at</span></span>, but does not test these values. Your seed data cannot guarantee consistent dates so it’s impossible to test the values. In a later chapter, I will show you how to test date values once you start using proper test data.</div><div id="Par17" class="Para">Next, run the test (Listing <span class="InternalRef"><a href="#Par18">5-6</a></span>), which will definitely fail. Can you come up with the reasons why the test fails?</div><div id="Par18" class="Para">
            <div class="ProgramCode" id="PC6"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::show_should_return_a_valid_bo\</div><div class="FixedLine">ok</div><div class="FixedLine">Failed asserting that 404 matches expected 200.</div></div><div class="LineGroup"><div class="FixedLine">bookr/vendor/laravel/lumen-framework/src/Testing/CrawlerTrait.php:412</div><div class="FixedLine">bookr/tests/app/Http/Controllers/BooksControllerTest.php:33</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-6.</span><div class="SimplePara">Running the Failing Test Suite</div></div></div></div>
          </div><div id="Par19" class="Para">If you inspect the test failure closely, you will see that on <span class="EmphasisTypeBold">line 33</span> your test asserts a <span class="EmphasisTypeBold">200</span> HTTP status code, but a <span class="EmphasisTypeBold">404</span> response is given because no route exists yet. You will need to create a new route and controller method to get your tests back to green. Make the following changes in <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">app/Http/routes.php</span></span> (Listing <span class="InternalRef"><a href="#Par20">5-7</a></span>) and <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">app/Http/Controllers/BooksController.php</span></span> (Listing <span class="InternalRef"><a href="#Par21">5-8</a></span>).</div><div id="Par20" class="Para">
            <div class="ProgramCode" id="PC7"><div class="FixedLine">18  $app-&gt;get('/books', 'BooksController@index');</div><div class="FixedLine">19  $app-&gt;get('/books/{id}', 'BooksController@show');</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-7.</span><div class="SimplePara">Adding Show Route to routes.php</div></div></div></div>
          </div><div id="Par21" class="Para">
            <div class="ProgramCode" id="PC8"><div class="FixedLine">22  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">23   <span class="EmphasisTypeItalic">* GET /books/{id}</span>
          </div><div class="FixedLine">24   <span class="EmphasisTypeItalic">* @param integer $id</span>
          </div><div class="FixedLine">25   <span class="EmphasisTypeItalic">* @return mixed</span>
          </div><div class="FixedLine">26   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">27  <span class="EmphasisTypeBold">public function</span> show($id)</div><div class="FixedLine">28  {</div><div class="FixedLine">29      <span class="EmphasisTypeBold">return</span> Book::findOrFail($id);</div><div class="FixedLine">30  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-8.</span><div class="SimplePara">Adding Show Method to BooksController.php</div></div></div></div>
          </div><div id="Par22" class="Para">The code for <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">BooksController@show</span></span> introduces the <span class="EmphasisFontCategoryNonProportional">findOrFail</span> method; the <span class="EmphasisFontCategoryNonProportional">findOrFail</span> method either returns a record or throws an exception of type <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Illuminate\Database\Eloquent\ModelNotFoundException</span></span>.</div><div id="Par23" class="Para">The new route and the <span class="EmphasisFontCategoryNonProportional">BooksController::show()</span> method should be enough to get your test passing again (Listing <span class="InternalRef"><a href="#Par24">5-9</a></span>).</div><div id="Par24" class="Para">
            <div class="ProgramCode" id="PC9"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=show_should_return_a_valid_book</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 7 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-9.</span><div class="SimplePara">Running PHPUnit Test for Returning a Valid Book</div></div></div></div>
          </div><div id="Par25" class="Para">You will use PHPUnit’s <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">--filter</span></span> flag to only run your latest test. The <span class="EmphasisFontCategoryNonProportional">--filter</span> flag, which accepts a regular expression, is a convenient way to limit which tests run; you will use it extensively in this book.</div><div id="Par26" class="Para">You are again back to green and you can move on to your next acceptance criterion, shown in Listing <span class="InternalRef"><a href="#Par27">5-10</a></span>.</div><div id="Par27" class="Para">
            <div class="ProgramCode" id="PC10"><div class="FixedLine">46  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">47  <span class="EmphasisTypeBold">public function</span> show_should_fail_when_the_book_id_does_not_exist()</div><div class="FixedLine">48  {</div><div class="FixedLine">49      $this</div><div class="FixedLine">50          -&gt;get('/books/99999')</div><div class="FixedLine">51          -&gt;seeStatusCode(404)</div><div class="FixedLine">52          -&gt;seeJson([</div><div class="FixedLine">53              'error' =&gt; [</div><div class="FixedLine">54                  'message' =&gt; 'Book not found'</div><div class="FixedLine">55              ]</div><div class="FixedLine">56          ]);</div><div class="FixedLine">57  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-10.</span><div class="SimplePara">Testing Failure When a Book Does Not Exist</div></div></div></div>
          </div><div id="Par28" class="Para">Next, let’s run the test to make sure it fails (Listing <span class="InternalRef"><a href="#Par29">5-11</a></span>).</div><div id="Par29" class="Para">
            <div class="ProgramCode" id="PC11"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=show_should_fail_when_the_book_id_does_not_exist</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::show_should_fail_when_the_book_id_does_not_exist</div><div class="FixedLine">Invalid JSON was returned from the route. Perhaps an exception was thrown?</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 1, Assertions: 1, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-11.</span><div class="SimplePara">Running PHPUnit After Writing the Test</div></div></div></div>
          </div><div id="Par30" class="Para">Your latest test brings you back to failure. The <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">findOrFail</span></span> method will throw an exception if the id does not match a record in the database, resulting in a <span class="EmphasisTypeBold">404</span> error response with a Content-Type header of text/html. What you really wanted based on your test criteria is a <span class="EmphasisTypeBold">404</span> response with a friendly JSON error message. Time to update your <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">BooksController::store()</span></span> method to catch the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">ModelNotFoundException</span></span> (Listing <span class="InternalRef"><a href="#Par31">5-12</a></span>) and get tests back to green!</div><div id="Par31" class="Para">
            <div class="ProgramCode" id="PC12"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2  </div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Controllers;</div><div class="FixedLine"> 4  </div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> App\Book;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Eloquent\ModelNotFoundException;</div><div class="FixedLine"> 7  </div><div class="FixedLine"> 8  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 9   <span class="EmphasisTypeItalic">* Class BooksController</span>
          </div><div class="FixedLine">10   <span class="EmphasisTypeItalic">* @package App\Http\Controllers</span>
          </div><div class="FixedLine">11   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">12  <span class="EmphasisTypeBold">class BooksController</span>
          </div><div class="FixedLine">13  {</div><div class="FixedLine">14      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">15       <span class="EmphasisTypeItalic">* GET /books</span>
          </div><div class="FixedLine">16       <span class="EmphasisTypeItalic">* @return array</span>
          </div><div class="FixedLine">17       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">18      <span class="EmphasisTypeBold">public function</span> index()</div><div class="FixedLine">19      {</div><div class="FixedLine">20          <span class="EmphasisTypeBold">return</span> Book::all();</div><div class="FixedLine">21      }</div><div class="FixedLine">22</div><div class="FixedLine">23      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">24       <span class="EmphasisTypeItalic">* GET /books/{id}</span>
          </div><div class="FixedLine">25       <span class="EmphasisTypeItalic">* @param integer $id</span>
          </div><div class="FixedLine">26       <span class="EmphasisTypeItalic">* @return mixed</span>
          </div><div class="FixedLine">27       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">28      <span class="EmphasisTypeBold">public function</span> show($id)</div><div class="FixedLine">29      {</div><div class="FixedLine">30          <span class="EmphasisTypeBold">try</span> {</div><div class="FixedLine">31              <span class="EmphasisTypeBold">return</span> Book::findOrFail($id);</div><div class="FixedLine">32          } <span class="EmphasisTypeBold">catch</span> (ModelNotFoundException $e) {</div><div class="FixedLine">33              <span class="EmphasisTypeBold">return</span> response()-&gt;json([</div><div class="FixedLine">34                  'error' =&gt; [</div><div class="FixedLine">35                      'message' =&gt; 'Book not found'</div><div class="FixedLine">36                  ]</div><div class="FixedLine">37              ], 404);</div><div class="FixedLine">38          }</div><div class="FixedLine">39      }</div><div class="FixedLine">40  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-12.</span><div class="SimplePara">Responding to ModelNotFoundException BooksController::show()</div></div></div></div>
          </div><div id="Par32" class="Para">The entire controller is included to avoid confusion. Let’s break down the changes:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par33" class="Para">You wrap the <span class="EmphasisFontCategoryNonProportional">Book::findOrFail()</span> method in a <span class="EmphasisFontCategoryNonProportional">try/catch</span> block so you can catch the exception and respond with a <span class="EmphasisTypeBold">404</span>.</div></li><li><div id="Par34" class="Para">If the id is found, a valid record is returned.</div></li><li><div id="Par35" class="Para ParaOneEmphasisChild">The <span class="EmphasisFontCategoryNonProportional">ModelNotFoundException</span> is imported on line #6.</div></li><li><div id="Par36" class="Para ParaOneEmphasisChild">You introduce the <span class="EmphasisFontCategoryNonProportional">response()</span> helper to create a response object.</div></li><li><div id="Par37" class="Para ParaOneEmphasisChild">You then call <span class="EmphasisFontCategoryNonProportional">json()</span> on the response object to send a JSON response.</div></li><li><div id="Par38" class="Para ParaOneEmphasisChild">The <span class="EmphasisFontCategoryNonProportional">json()</span> method accepts your array of data, and a HTTP status code.</div></li></ul></div>
      </div><div id="Par39" class="Para">Running your test suite will get you back to green (Listing <span class="InternalRef"><a href="#Par40">5-13</a></span>). Getting back to green is a good feeling.</div><div id="Par40" class="Para">
            <div class="ProgramCode" id="PC13"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=show_should_fail_when_the_book_id_does_not_exist</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 2 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-13.</span><div class="SimplePara">Running the Test for an Invalid Book id</div></div></div></div>
          </div><div id="Par41" class="Para">You have one final task to satisfy the acceptance criteria, and then you can move on to the next endpoint. The final test is to ensure that your <span class="EmphasisFontCategoryNonProportional">BooksController::show</span> route only matches integer ids. As of right now, your <span class="EmphasisFontCategoryNonProportional">show</span> route will happily match any parameter. Let’s write a test for the route matching (Listing <span class="InternalRef"><a href="#Par42">5-14</a></span>).</div><div id="Par42" class="Para">
            <div class="ProgramCode" id="PC14"><div class="FixedLine">59  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">60  <span class="EmphasisTypeBold">public function</span> show_route_should_not_match_an_invalid_route()</div><div class="FixedLine">61  {</div><div class="FixedLine">62      $this-&gt;get('/books/this-is-invalid');</div><div class="FixedLine">63</div><div class="FixedLine">64      $this-&gt;assertNotRegExp(</div><div class="FixedLine">65          '/Book not found/',</div><div class="FixedLine">66          $this-&gt;response-&gt;getContent(),</div><div class="FixedLine">67          'BooksController@show route matching when it should not.'</div><div class="FixedLine">68      );</div><div class="FixedLine">69  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-14.</span><div class="SimplePara">A Test for Route Matching</div></div></div></div>
          </div><div id="Par43" class="Para">Your test ensures that the response does not contain <span class="EmphasisFontCategoryNonProportional">Book not found</span> because that would mean the <span class="EmphasisFontCategoryNonProportional">BooksController@show</span> route was executed and the <span class="EmphasisFontCategoryNonProportional">404</span> response for the <span class="EmphasisFontCategoryNonProportional">ModelNotFoundException</span> was sent. You added a helpful message of “BooksController@show route matching when it should not” to explain that you do not want to match the <span class="EmphasisFontCategoryNonProportional">BooksController@show</span> route.</div><div id="Par44" class="Para">Let’s run the test and see if it fails (Listing <span class="InternalRef"><a href="#Par45">5-15</a></span>).</div><div id="Par45" class="Para">
            <div class="ProgramCode" id="PC15"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=show_route_should_not_match_an_invalid_route</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::show_route_should_not_match_an_invalid_route</div><div class="FixedLine">BooksController@show route matching when it should not.</div><div class="FixedLine">Failed asserting that '{"error":{"message":"Book not found"}}' does not match PCRE pattern "/Book not found/".</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/BooksControllerTest.php:68</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 1, Assertions: 1, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-15.</span><div class="SimplePara">Running a Test for Invalid Show Route</div></div></div></div>
          </div><div id="Par46" class="Para">Since you have not changed the <span class="EmphasisFontCategoryNonProportional">BooksController@show</span> code yet, you get an expected failure. You need to change the route parameter to be constrained with a regular expression and then the test will pass (Listing <span class="InternalRef"><a href="#Par47">5-16</a></span>).</div><div id="Par47" class="Para">
            <div class="ProgramCode" id="PC16"><div class="FixedLine">19  $app-&gt;get('/books/{id:[\d]+}', 'BooksController@show');</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-16.</span><div class="SimplePara">Constrain the Show Route with a Regular Expression (app/Http/routes.php).</div></div></div></div>
          </div><div id="Par48" class="Para">Now only requests where the <span class="EmphasisFontCategoryNonProportional">id</span> is an integer will match. Let’s see if you can now pass the test (Listing <span class="InternalRef"><a href="#Par49">5-17</a></span>).</div><div id="Par49" class="Para">
            <div class="ProgramCode" id="PC17"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=show_route_should_not_match_an_invalid_route</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 1 assertion)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-17.</span><div class="SimplePara">Passing the Invalid Route Test</div></div></div></div>
          </div><div id="Par50" class="Para ParaOneEmphasisChild">Your acceptance criteria have been met for the <span class="EmphasisFontCategoryNonProportional">GET /book/{id}</span> route! You are ready to move on to creating new books. Commit your changes.</div><div id="Par51" class="Para ParaTypeImportant">
        <img src="A395120_1_En_5_Figa_HTML.jpg" alt="A395120_1_En_5_Figa_HTML.jpg"/> Git commit Add /books/{id} Route</div><div id="Par52" class="Para ParaTypeImportant">a39f235 (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/a39f235"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/a39f235</span>
              </span></a></span>)</div><div id="Par53" class="Para">Listing <span class="InternalRef"><a href="#Par54">5-18</a></span> shows what your <span class="EmphasisFontCategoryNonProportional">BooksControllerTest</span> class looks like so far.</div><div id="Par54" class="Para">
            <div class="ProgramCode" id="PC18"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine"> 6</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">class BooksControllerTest extends</span> TestCase</div><div class="FixedLine"> 8  {</div><div class="FixedLine"> 9      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">10      <span class="EmphasisTypeBold">public function</span> index_status_code_should_be_200()</div><div class="FixedLine">11      {</div><div class="FixedLine">12          $this-&gt;visit('/books')-&gt;seeStatusCode(200);</div><div class="FixedLine">13      }</div><div class="FixedLine">14</div><div class="FixedLine">15      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">16      <span class="EmphasisTypeBold">public function</span> index_should_return_a_collection_of_records()</div><div class="FixedLine">17      {</div><div class="FixedLine">18          $this</div><div class="FixedLine">19              -&gt;get('/books')</div><div class="FixedLine">20              -&gt;seeJson([</div><div class="FixedLine">21                  'title' =&gt; 'War of the Worlds'</div><div class="FixedLine">22              ])</div><div class="FixedLine">23              -&gt;seeJson([</div><div class="FixedLine">24                  'title' =&gt; 'A Wrinkle in Time'</div><div class="FixedLine">25              ]);</div><div class="FixedLine">26      }</div><div class="FixedLine">27</div><div class="FixedLine">28      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">29      <span class="EmphasisTypeBold">public function</span> show_should_return_a_valid_book()</div><div class="FixedLine">30      {</div><div class="FixedLine">31          $this</div><div class="FixedLine">32              -&gt;get('/books/1')</div><div class="FixedLine">33              -&gt;seeStatusCode(200)</div><div class="FixedLine">34              -&gt;seeJson([</div><div class="FixedLine">35                  'id' =&gt; 1,</div><div class="FixedLine">36                  'title' =&gt; 'War of the Worlds',</div><div class="FixedLine">37                  'description' =&gt; 'A science fiction masterpiece about Martians invading London',</div><div class="FixedLine">38                  'author' =&gt; 'H. G. Wells'</div><div class="FixedLine">39              ]);</div><div class="FixedLine">40</div><div class="FixedLine">41          $data = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">42          $this-&gt;assertArrayHasKey('created_at', $data);</div><div class="FixedLine">43          $this-&gt;assertArrayHasKey('updated_at', $data);</div><div class="FixedLine">44      }</div><div class="FixedLine">45</div><div class="FixedLine">46</div><div class="FixedLine">47      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">48      <span class="EmphasisTypeBold">public function</span> show_should_fail_when_the_book_id_does_not_exist()</div><div class="FixedLine">49      {</div><div class="FixedLine">50          $this</div><div class="FixedLine">51              -&gt;get('/books/99999')</div><div class="FixedLine">52              -&gt;seeStatusCode(404)</div><div class="FixedLine">53              -&gt;seeJson([</div><div class="FixedLine">54                  'error' =&gt; [</div><div class="FixedLine">55                  'message' =&gt; 'Book not found'</div><div class="FixedLine">56              ]</div><div class="FixedLine">57          ]);</div><div class="FixedLine">58      }</div><div class="FixedLine">59</div><div class="FixedLine">60      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">61      <span class="EmphasisTypeBold">public function</span> show_route_should_not_match_an_invalid_route()</div><div class="FixedLine">62      {</div><div class="FixedLine">63          $this-&gt;get('/books/this-is-invalid');</div><div class="FixedLine">64</div><div class="FixedLine">65          $this-&gt;assertNotRegExp(</div><div class="FixedLine">66              '/Book not found/',</div><div class="FixedLine">67               $this-&gt;response-&gt;getContent(),</div><div class="FixedLine">68              'BooksController@show route matching when it should not.'</div><div class="FixedLine">69          );</div><div class="FixedLine">70      }</div><div class="FixedLine">71  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-18.</span><div class="SimplePara">BooksControllerTest</div></div></div></div>
          </div><div id="Par55" class="Para">You have been running specific tests. You need to make sure the whole suite passes before moving to the next feature, so see Listing <span class="InternalRef"><a href="#Par56">5-19</a></span>.</div><div id="Par56" class="Para">
            <div class="ProgramCode" id="PC19"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (5 tests, 13 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-19.</span><div class="SimplePara">Running the Full Test Suite</div></div></div></div>
          </div><div id="Par57" class="Para ParaOneEmphasisChild">Running the <span class="EmphasisTypeBold">whole suite</span> is important before moving on to make sure the entire test harness is sound before writing new features. You will build a dependable, albeit imperfect set of tests you can depend upon when refactoring and making major changes.</div><div id="FPar1" class="FormalPara FormalParaRenderingStyle3 ParaTypeOverview"><div class="Heading">How is the Missing Route Handled?</div><div id="Par58" class="Para">Now that your <span class="EmphasisFontCategoryNonProportional">BooksController::show()</span> route only matches integer ids, how is an invalid route like <span class="EmphasisFontCategoryNonProportional">/books/this-is-invalid</span> handled? If Lumen can’t find a route, the application will throw a <span class="EmphasisFontCategoryNonProportional">NotFoundHttpException</span>. If you investigate the response headers, you can see that Lumen responds with a <span class="EmphasisFontCategoryNonProportional">text/html</span> content type by default:</div><div id="Par59" class="Para">
              <div class="ProgramCode" id="PC20"><div class="LineGroup"><div class="FixedLine">curl -I -H"Content-Type: application/json" \</div><div class="FixedLine">-H"Accept: application/json" \</div><div class="FixedLine">http://localhost:8000/books/<span class="EmphasisTypeBold">this</span>-is-invalid</div></div><div class="LineGroup"><div class="FixedLine">HTTP/1.0 404 <span class="EmphasisTypeBold">Not</span> Found</div><div class="FixedLine">Host: localhost:8000</div><div class="FixedLine">Connection: close</div><div class="FixedLine">Cache-Control: no-cache, <span class="EmphasisTypeBold">private</span>
              </div><div class="FixedLine">date: Sun, 18 Oct 2015 07:25:30 GMT</div><div class="FixedLine">Content-type: text/html; charset=UTF-8</div></div></div>
            </div><div id="Par60" class="Para">The HTML response is not something an API consumer expects and you intend on making error responses JSON. For now, be aware of how things are working. You will revisit handling missing routes exceptions with JSON in the next chapter.</div></div></div><div id="Sec2" class="Section1 RenderAsSection1"><h2 class="Heading">Creating a New Book</h2><div id="Par61" class="Para">The next feature is creating a new book with the <span class="EmphasisFontCategoryNonProportional">POST /books</span> route. You will dive more into Eloquent and see how to handle <span class="EmphasisFontCategoryNonProportional">POST</span> data in the controller. Listing <span class="InternalRef"><a href="#Par62">5-20</a></span> shows the acceptance criteria for creating a new book in the <span class="EmphasisFontCategoryNonProportional">tests/app/Http/Controllers/BooksControllerTest.php</span> file.</div><div id="Par62" class="Para">
            <div class="ProgramCode" id="PC21"><div class="FixedLine">72  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">73  <span class="EmphasisTypeBold">public function</span> store_should_save_new_book_in_the_database()</div><div class="FixedLine">74  {</div><div class="FixedLine">75      $this-&gt;markTestIncomplete('pending');</div><div class="FixedLine">76  }</div><div class="FixedLine">77</div><div class="FixedLine">78  <span class="EmphasisTypeItalic">/** @test */</span>
          </div><div class="FixedLine">79  <span class="EmphasisTypeBold">public function</span> store_should_respond_with_a_201_and_location_header_when_successful()</div><div class="FixedLine">80  {</div><div class="FixedLine">81      $this-&gt;markTestIncomplete('pending');</div><div class="FixedLine">82  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-20.</span><div class="SimplePara">The POST /books Acceptance Criteria</div></div></div></div>
          </div><div id="Par63" class="Para">Let’s start with the <span class="EmphasisFontCategoryNonProportional">store_should_save_new_book_in_the_database</span> test (Listing <span class="InternalRef"><a href="#Par66">5-21</a></span>). When things go as expected, this test will make sure that
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par64" class="Para ParaOneEmphasisChild">The response contains a <span class="EmphasisFontCategoryNonProportional">"created": true</span> JSON fragment.</div></li><li><div id="Par65" class="Para">The book exists in the database.</div></li></ul></div>
      </div><div id="Par66" class="Para">
            <div class="ProgramCode" id="PC22"><div class="FixedLine">72  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">73  <span class="EmphasisTypeBold">public function</span> store_should_save_new_book_in_the_database()</div><div class="FixedLine">74  {</div><div class="FixedLine">75      $this-&gt;post('/books', [</div><div class="FixedLine">76          'title' =&gt; 'The Invisible Man',</div><div class="FixedLine">77          'description' =&gt; 'An invisible man is trapped in the terror of his own creation',</div><div class="FixedLine">78          'author' =&gt; 'H. G. Wells'</div><div class="FixedLine">79      ]);</div><div class="FixedLine">80</div><div class="FixedLine">81      $this</div><div class="FixedLine">82          -&gt;seeJson(['created' =&gt; <span class="EmphasisTypeBold">true</span>])</div><div class="FixedLine">83          -&gt;seeInDatabase('books', ['title' =&gt; 'The Invisible Man']);</div><div class="FixedLine">84  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-21.</span><div class="SimplePara">Testing the Creation of a New Book</div></div></div></div>
          </div><div id="Par67" class="Para">Your test inherits a <span class="EmphasisFontCategoryNonProportional">$this-&gt;post()</span> method, which accepts a URI and an array of post data. The test contains the <span class="EmphasisFontCategoryNonProportional">seeInDatabase()</span> method, which accepts a table name and an associative array in the format of <span class="EmphasisFontCategoryNonProportional">column =&gt; value,</span> and ensures the record is in the database. You can pass multiple columns to further constrain <span class="EmphasisFontCategoryNonProportional">$this-&gt;seeInDatabase()</span> assertions.</div><div id="Par68" class="Para">Running the test suite will result in a failure because you haven’t defined the route or the controller method yet (Listing <span class="InternalRef"><a href="#Par69">5-22</a></span>).</div><div id="Par69" class="Para">
            <div class="ProgramCode" id="PC23"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::store_should_save_new_book_in_the_database</div><div class="FixedLine">Invalid JSON was returned from the route. Perhaps an exception was thrown?</div><div class="FixedLine">...</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 7, Assertions: 13, Failures: 1, Incomplete: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-22.</span><div class="SimplePara">Running the Full Test Suite</div></div></div></div>
          </div><div id="Par70" class="Para">You will start coding by adding a route to <span class="EmphasisFontCategoryNonProportional">app/Http/routes.php</span> (Listing <span class="InternalRef"><a href="#Par71">5-23</a></span>).</div><div id="Par71" class="Para">
            <div class="ProgramCode" id="PC24"><div class="FixedLine">18  $app-&gt;get('/books', 'BooksController@index');</div><div class="FixedLine">19  $app-&gt;get('/books/{id}', 'BooksController@show');</div><div class="FixedLine">20  <span class="EmphasisTypeBold">$app-&gt;post('/books', 'BooksController@store');</span>
          </div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-23.</span><div class="SimplePara">Adding the POST Route</div></div></div></div>
          </div><div id="Par72" class="Para">Your first version of the <span class="EmphasisFontCategoryNonProportional">BooksController@store</span> method is shown in Listing <span class="InternalRef"><a href="#Par73">5-24</a></span>.</div><div id="Par73" class="Para">
            <div class="ProgramCode" id="PC25"><div class="FixedLine">41  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">42   <span class="EmphasisTypeItalic">* POST /books</span>
          </div><div class="FixedLine">43   <span class="EmphasisTypeItalic">* @param Request $request</span>
          </div><div class="FixedLine">44   <span class="EmphasisTypeItalic">* @return \Symfony\Component\HttpFoundation\Response</span>
          </div><div class="FixedLine">45   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">46  <span class="EmphasisTypeBold">public function</span> store(Request $request)</div><div class="FixedLine">47  {</div><div class="FixedLine">48      $book = Book::create($request-&gt;all());</div><div class="FixedLine">49</div><div class="FixedLine">50      <span class="EmphasisTypeBold">return</span> response()-&gt;json(['created' =&gt; <span class="EmphasisTypeBold">true</span>], 201);</div><div class="FixedLine">51  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-24.</span><div class="SimplePara">First Version of the <span class="EmphasisFontCategoryNonProportional">BooksController::store()</span> Method</div></div></div></div>
          </div><div id="Par74" class="Para">The store method is your first example using the service container (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/container"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/container</span>
              </span></a></span>) to do method injection in a controller. The store method accepts an <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Illuminate\Http\Request</span></span> instance that represents the current HTTP request.</div><div id="Par75" class="Para">Inside the method, the first line tries to create a new book in the database by passing post data from the request (<span class="EmphasisFontCategoryNonProportional">$request-&gt;all()</span>) to the Book::create() method. If the <span class="EmphasisFontCategoryNonProportional">Book::create()</span> method succeeds, it will return an instance of the new book. After creating the book, the method returns a <span class="EmphasisFontCategoryNonProportional">JsonResponse</span> object by calling <span class="EmphasisFontCategoryNonProportional">response()-&gt;json(),</span> which accepts an array of data and a status code. The <span class="EmphasisFontCategoryNonProportional">JsonResponse</span> object will convert the array into JSON before being sent to the browser.</div><div id="Par76" class="Para ParaTypeImportant">
        <img src="A395120_1_En_5_Figb_HTML.jpg" alt="A395120_1_En_5_Figb_HTML.jpg"/> Your senses might be warning you that you are allowing mass assignment in the controller. While it is good to always keep mass assignment in mind, Eloquent does guard against mass assignment (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/eloquent#mass-assignment"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/eloquent#mass-assignment</span>
              </span></a></span>), as you will see shortly.</div><div id="Par77" class="Para">Before you run your test, you need to also import <span class="EmphasisFontCategoryNonProportional">Illuminate\Http\Request</span> at the top of the <span class="EmphasisFontCategoryNonProportional">BooksController</span> (Listing <span class="InternalRef"><a href="#Par78">5-25</a></span>).</div><div id="Par78" class="Para">
            <div class="ProgramCode" id="PC26"><div class="FixedLine">1  &lt;?php</div><div class="FixedLine">2</div><div class="FixedLine">3  <span class="EmphasisTypeBold">namespace</span> App\Http\Controllers;</div><div class="FixedLine">4</div><div class="FixedLine">5  <span class="EmphasisTypeBold">use</span> App\Book;</div><div class="FixedLine">6  <span class="EmphasisTypeBold">use Illuminate\Http\Request;</span>
          </div><div class="FixedLine">7  use Illuminate\Database\Eloquent\ModelNotFoundException;</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-25.</span><div class="SimplePara">Importing the Illuminate Request Class in the BooksController</div></div></div></div>
          </div><div id="Par79" class="Para">You might think you’ve covered everything, so your test should pass, but it still fails (Listing <span class="InternalRef"><a href="#Par80">5-26</a></span>).</div><div id="Par80" class="Para">
            <div class="ProgramCode" id="PC27"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=store_should_save_new_book_in_the_database</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::store_should_save_new_book_in_the_database</div><div class="FixedLine">Invalid JSON was returned from the route. Perhaps an exception was thrown?</div><div class="FixedLine">...</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 1, Assertions: 0, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-26.</span><div class="SimplePara">The Failing Test Output</div></div></div></div>
          </div><div id="Par81" class="Para">The error message is identical to the last time you ran this test! You need to dig a little deeper to figure this out. Options include looking at the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">storage/logs/lumen.log</span></span> file or adding some temporary debugging code to the request. Let’s pursue the second option and add some debugging code to the <span class="EmphasisFontCategoryNonProportional">BooksController</span> (Listing <span class="InternalRef"><a href="#Par82">5-27</a></span>).</div><div id="Par82" class="Para">
            <div class="ProgramCode" id="PC28"><div class="FixedLine">42  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">43   <span class="EmphasisTypeItalic">* POST /books</span>
          </div><div class="FixedLine">44   <span class="EmphasisTypeItalic">* @param Request $request</span>
          </div><div class="FixedLine">45   <span class="EmphasisTypeItalic">* @return \Symfony\Component\HttpFoundation\Response</span>
          </div><div class="FixedLine">46   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">47  <span class="EmphasisTypeBold">public function</span> store(Request $request)</div><div class="FixedLine">48  {</div><div class="FixedLine">49      <span class="EmphasisTypeBold">try</span> {</div><div class="FixedLine">50          $book = Book::create($request-&gt;all());</div><div class="FixedLine">51      } <span class="EmphasisTypeBold">catch</span> (\Exception $e) {</div><div class="FixedLine">52          dd(get_class($e));</div><div class="FixedLine">53      }</div><div class="FixedLine">54</div><div class="FixedLine">55      <span class="EmphasisTypeBold">return</span> response()-&gt;json(['created' =&gt; <span class="EmphasisTypeBold">true</span>], 201);</div><div class="FixedLine">56  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-27.</span><div class="SimplePara">Temporary Debugging Code</div></div></div></div>
          </div><div id="Par83" class="Para">You are attempting to debug the <span class="EmphasisFontCategoryNonProportional">store</span> method by catching any exception that happens when calling <span class="EmphasisFontCategoryNonProportional">Book::create()</span>. The code introduces the <span class="EmphasisFontCategoryNonProportional">dd()</span> function, which dumps the passed variable(s) and exits the script.</div><div id="Par84" class="Para">With the debug code in place, run the test again (Listing <span class="InternalRef"><a href="#Par85">5-28</a></span>).</div><div id="Par85" class="Para">
            <div class="ProgramCode" id="PC29"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=store_should_save_new_book_in_the_database</div></div><div class="LineGroup"><div class="FixedLine">"Illuminate\Database\Eloquent\MassAssignmentException"</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-28.</span><div class="SimplePara">Running the Test with Debug Code in Place</div></div></div></div>
          </div><div id="Par86" class="Para">The exception being caught is a mass assignment exception. I mentioned earlier that Eloquent guards against mass assignment out of the box, so you need to configure which fields are mass-assignable using the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">protected $fillable = []</span></span> array in the <span class="EmphasisFontCategoryNonProportional">Book</span> model (Listing <span class="InternalRef"><a href="#Par87">5-29</a></span>).</div><div id="Par87" class="Para">
            <div class="ProgramCode" id="PC30"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Eloquent\Model;</div><div class="FixedLine"> 6</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">class Book extends</span> Model</div><div class="FixedLine"> 8  {</div><div class="FixedLine"> 9      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">10       <span class="EmphasisTypeItalic">* The attributes that are mass assignable</span>
          </div><div class="FixedLine">11       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">12       <span class="EmphasisTypeItalic">* @var array</span>
          </div><div class="FixedLine">13       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">14      <span class="EmphasisTypeBold">protected</span> $fillable = ['title', 'description', 'author'];</div><div class="FixedLine">15  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-29.</span><div class="SimplePara">Defining Mass Assignable Fields (app/Http/Book.php)</div></div></div></div>
          </div><div id="Par88" class="Para ParaTypeImportant">
        <img src="A395120_1_En_5_Figc_HTML.jpg" alt="A395120_1_En_5_Figc_HTML.jpg"/> You can also provide a <span class="EmphasisFontCategoryNonProportional">protected $guarded</span> property with values that should not be mass-assignable. You are taking the route that all columns should be protected, minus the exceptions you add to the <span class="EmphasisFontCategoryNonProportional">$fillable</span> array. See the “Mass Assignment” (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/eloquent#mass-assignment"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/eloquent#mass-assignment</span>
              </span></a></span>) section in the Eloquent documentation for more information.</div><div id="Par89" class="Para">Before you remove the debugging code, try running the test again (Listing <span class="InternalRef"><a href="#Par90">5-30</a></span>).</div><div id="Par90" class="Para">
            <div class="ProgramCode" id="PC31"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=store_should_save_new_book_in_the_database</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 2 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-30.</span><div class="SimplePara">Running the Test After Defining Fillable Columns</div></div></div></div>
          </div><div id="Par91" class="Para">After defining the fillable fields, your test worked as expected! Now you need to revert the debugging code you added (Listing <span class="InternalRef"><a href="#Par92">5-31</a></span>).</div><div id="Par92" class="Para">
            <div class="ProgramCode" id="PC32"><div class="FixedLine">42  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">43   <span class="EmphasisTypeItalic">* POST /books</span>
          </div><div class="FixedLine">44   <span class="EmphasisTypeItalic">* @param Request $request</span>
          </div><div class="FixedLine">45   <span class="EmphasisTypeItalic">* @return \Symfony\Component\HttpFoundation\Response</span>
          </div><div class="FixedLine">46   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">47  <span class="EmphasisTypeBold">public function</span> store(Request $request)</div><div class="FixedLine">48  {</div><div class="FixedLine">49      $book = Book::create($request-&gt;all());</div><div class="FixedLine">50</div><div class="FixedLine">51      <span class="EmphasisTypeBold">return</span> response()-&gt;json(['created' =&gt; <span class="EmphasisTypeBold">true</span>], 201);</div><div class="FixedLine">52  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-31.</span><div class="SimplePara">Reverting the Debugging Code</div></div></div></div>
          </div><div id="Par93" class="Para">The next test criterion makes sure that successfully creating a new book will respond with a <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">201</span></span> status code and a <span class="EmphasisFontCategoryNonProportional">Location</span> header matching the URI of the created resource (Listing <span class="InternalRef"><a href="#Par94">5-32</a></span>).</div><div id="Par94" class="Para">
            <div class="ProgramCode" id="PC33"><div class="FixedLine">86  <span class="EmphasisTypeItalic">/** @test */</span>
          </div><div class="FixedLine">87  <span class="EmphasisTypeBold">public function</span> store_should_respond_with_a_201_and_location_header_when_successful()</div><div class="FixedLine">88  {</div><div class="FixedLine">89      $this-&gt;post('/books', [</div><div class="FixedLine">90          'title' =&gt; 'The Invisible Man',</div><div class="FixedLine">91          'description' =&gt; 'An invisible man is trapped in the terror of his own creation',</div><div class="FixedLine">92          'author' =&gt; 'H. G. Wells'</div><div class="FixedLine">93      ]);</div><div class="FixedLine">94  </div><div class="FixedLine">95      $this</div><div class="FixedLine">96          -&gt;seeStatusCode(201)</div><div class="FixedLine">97          -&gt;seeHeaderWithRegExp('Location', '#/books/[\d]+$#');</div><div class="FixedLine">98  </div><div class="FixedLine">99  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-32.</span><div class="SimplePara">Writing a Test for 201 Status Code and Location Header</div></div></div></div>
          </div><div id="Par95" class="Para">The test will look familiar, except for the <span class="EmphasisFontCategoryNonProportional">seeHeaderWithRegExp</span> method, because you haven’t defined it yet. To provide some convenience around checking header values, you define this custom assertion in the base test class <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">tests/TestCase.php</span></span> that your tests inherit (Listing <span class="InternalRef"><a href="#Par96">5-33</a></span>).</div><div id="Par96" class="Para">
            <div class="ProgramCode" id="PC34"><div class="FixedLine">15  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">16   <span class="EmphasisTypeItalic">* See if the response has a header.</span>
          </div><div class="FixedLine">17   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">18   <span class="EmphasisTypeItalic">* @param $header</span>
          </div><div class="FixedLine">19   <span class="EmphasisTypeItalic">* @return $this</span>
          </div><div class="FixedLine">20   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">21  <span class="EmphasisTypeBold">public function</span> seeHasHeader($header)</div><div class="FixedLine">22  {</div><div class="FixedLine">23      $this-&gt;assertTrue(</div><div class="FixedLine">24          $this-&gt;response-&gt;headers-&gt;has($header),</div><div class="FixedLine">25          "Response should have the header '<span class="EmphasisTypeBold">{</span>$header<span class="EmphasisTypeBold">}</span>' but does not."</div><div class="FixedLine">26      );</div><div class="FixedLine">27</div><div class="FixedLine">28      <span class="EmphasisTypeBold">return</span> $this;</div><div class="FixedLine">29  }</div><div class="FixedLine">30</div><div class="FixedLine">31  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">32   <span class="EmphasisTypeItalic">* Asserts that the response header matches a given regular expression</span>
          </div><div class="FixedLine">33   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">34   <span class="EmphasisTypeItalic">* @param $header</span>
          </div><div class="FixedLine">35   <span class="EmphasisTypeItalic">* @param $regexp</span>
          </div><div class="FixedLine">36   <span class="EmphasisTypeItalic">* @return $this</span>
          </div><div class="FixedLine">37   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">38  <span class="EmphasisTypeBold">public function</span> seeHeaderWithRegExp($header, $regexp)</div><div class="FixedLine">39  {</div><div class="FixedLine">40      $this</div><div class="FixedLine">41          -&gt;seeHasHeader($header)</div><div class="FixedLine">42          -&gt;assertRegExp(</div><div class="FixedLine">43              $regexp,</div><div class="FixedLine">44              $this-&gt;response-&gt;headers-&gt;get($header)</div><div class="FixedLine">45          );</div><div class="FixedLine">46</div><div class="FixedLine">47      <span class="EmphasisTypeBold">return</span> $this;</div><div class="FixedLine">48  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-33.</span><div class="SimplePara">New Test Assertions (tests/TestCase.php)</div></div></div></div>
          </div><div id="Par97" class="Para">You added two public methods that help assert headers. The <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">seeHasHeader()</span></span> method asserts the mere existence of a header. The <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">seeHeaderWithRegExp</span></span> method chains a call to <span class="EmphasisFontCategoryNonProportional">seeHasHeader</span> and then uses PHPUnit’s <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">assertRegExp</span></span> to see if the response header matches the passed regular expression. These methods use <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Illuminate\Http\Response</span></span>, which wraps the <span class="EmphasisFontCategoryNonProportional">Symfony\Component\HttpFoundation\Response</span>. I encourage you to become familiar with the request and response classes because you will use them frequently to build APIs.</div><div id="Par98" class="Para">After defining the new test methods, run the test (Listing <span class="InternalRef"><a href="#Par99">5-34</a></span>).</div><div id="Par99" class="Para">
            <div class="ProgramCode" id="PC35"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit \</div><div class="FixedLine">--filter=store_should_respond_with_a_201_and_location_header_when_successful</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::store_should_respond_with_a_2\</div><div class="FixedLine">01_and_location_header_when_successful</div><div class="FixedLine">Response should have the header 'Location' but does not.</div><div class="FixedLine">Failed asserting that false is true.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/tests/TestCase.php:25</div><div class="FixedLine">/home/vagrant/Code/bookr/tests/TestCase.php:41</div><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/BooksControllerTest.php:97</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 1, Assertions: 2, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-34.</span><div class="SimplePara">Running the Test for the 201 Status Code and Location Header</div></div></div></div>
          </div><div id="Par100" class="Para">Implement the <span class="EmphasisFontCategoryNonProportional">Location</span> header to get your test to pass (Listing <span class="InternalRef"><a href="#Par101">5-35</a></span>).</div><div id="Par101" class="Para">
            <div class="ProgramCode" id="PC36"><div class="FixedLine">42  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">43   <span class="EmphasisTypeItalic">* POST /books</span>
          </div><div class="FixedLine">44   <span class="EmphasisTypeItalic">* @param Request $request</span>
          </div><div class="FixedLine">45   <span class="EmphasisTypeItalic">* @return \Symfony\Component\HttpFoundation\Response</span>
          </div><div class="FixedLine">46   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">47  <span class="EmphasisTypeBold">public function</span> store(Request $request)</div><div class="FixedLine">48  {</div><div class="FixedLine">49      $book = Book::create($request-&gt;all());</div><div class="FixedLine">50</div><div class="FixedLine">51      <span class="EmphasisTypeBold">return</span> response()-&gt;json(['created' =&gt; <span class="EmphasisTypeBold">true</span>], 201, [</div><div class="FixedLine">52          'Location' =&gt; route('books.show', ['id' =&gt; $book-&gt;id])</div><div class="FixedLine">53      ]);</div><div class="FixedLine">54  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-35.</span><div class="SimplePara">Adding Location Header to BooksController@store</div></div></div></div>
          </div><div id="Par102" class="Para">The <span class="EmphasisFontCategoryNonProportional">json()</span> method accepts an associative array of headers as the third argument, and you use this argument to set the <span class="EmphasisFontCategoryNonProportional">Location</span> header. The <span class="EmphasisFontCategoryNonProportional">route()</span> helper method takes a named route (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/routing#named-routes"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/routing#named-routes</span>
              </span></a></span>) to create a URI for the value of the <span class="EmphasisFontCategoryNonProportional">Location</span> header. You haven’t created a named route called <span class="EmphasisFontCategoryNonProportional">books.show</span> yet, so you need to define one now in <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">app/Http/routes.php</span></span> (Listing <span class="InternalRef"><a href="#Par103">5-36</a></span>).</div><div id="Par103" class="Para">
            <div class="ProgramCode" id="PC37"><div class="FixedLine">18  $app-&gt;get('/books', 'BooksController@index');</div><div class="FixedLine">19  <span class="EmphasisTypeBold">$app-&gt;get('/books/{id:[\d]+}', [</span>
          </div><div class="FixedLine">20      <span class="EmphasisTypeBold">'as' =&gt; 'books.show',</span>
          </div><div class="FixedLine">21      <span class="EmphasisTypeBold">'uses' =&gt; 'BooksController@show'</span>
          </div><div class="FixedLine">22  <span class="EmphasisTypeBold">]);</span>
          </div><div class="FixedLine">23  $app-&gt;post('/books', 'BooksController@store');</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-36.</span><div class="SimplePara">Adding the BooksController@show Named Route</div></div></div></div>
          </div><div id="Par104" class="Para">The <span class="EmphasisFontCategoryNonProportional">show</span> route accepts an associative array with the named route <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">'as' =&gt; 'books.show'</span></span> and the <span class="EmphasisFontCategoryNonProportional">'uses'</span> key defines the controller.</div><div id="Par105" class="Para ParaTypeImportant">
        <img src="A395120_1_En_5_Figd_HTML.jpg" alt="A395120_1_En_5_Figd_HTML.jpg"/> The dot notation used in the name route has no special meaning, but the namespace helps with organization. You could have named the route something like “show_book” if you wanted, but I personally follow the dot notation because it feels more organized.</div><div id="Par106" class="Para">Let’s see if you code now passes the test suite (Listing <span class="InternalRef"><a href="#Par107">5-37</a></span>).</div><div id="Par107" class="Para">
            <div class="ProgramCode" id="PC38"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (7 tests, 18 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-37.</span><div class="SimplePara">Running the Full Test Suite</div></div></div></div>
          </div><div id="Par108" class="Para ParaOneEmphasisChild">Passing the tests means you are done with your <span class="EmphasisFontCategoryNonProportional">BooksController@store</span> route.</div><div id="Par109" class="Para ParaTypeImportant">
        <img src="A395120_1_En_5_Fige_HTML.jpg" alt="A395120_1_En_5_Fige_HTML.jpg"/> Git commit: Create a New Book</div><div id="Par110" class="Para ParaTypeImportant">1403e67 (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/1403e67"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/1403e67</span>
              </span></a></span>)</div></div><div id="Sec3" class="Section1 RenderAsSection1"><h2 class="Heading">Updating an Existing Book</h2><div id="Par111" class="Para">Now that you can create a new book, the next feature is the ability to update an existing book. You will begin to understand (if you don’t already) in this section that using your development database for tests is not a good idea; you will cover using a separate test database in Chapter <span class="ExternalRef"><a href="A395120_1_En_6_Chapter.html"><span class="RefSource">6</span></a></span>. I hope you are getting a feel for using test-driven development to drive good design. Good design does not happen all at once, but through small increments of test and code cycles.</div><div id="Par112" class="Para">Listing <span class="InternalRef"><a href="#Par113">5-38</a></span> shows the acceptance criteria for updating an existing book record the BooksControllerTest class (<span class="EmphasisFontCategoryNonProportional">tests/app/Http/Controllers/BooksControllerTest.php</span>).</div><div id="Par113" class="Para">
            <div class="ProgramCode" id="PC39"><div class="FixedLine">101  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">102  <span class="EmphasisTypeBold">public function</span> update_should_only_change_fillable_fields()</div><div class="FixedLine">103  {</div><div class="FixedLine">104      $this-&gt;markTestIncomplete('pending');</div><div class="FixedLine">105  }</div><div class="FixedLine">106</div><div class="FixedLine">107  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">108  <span class="EmphasisTypeBold">public function</span> update_should_fail_with_an_invalid_id()</div><div class="FixedLine">109  {</div><div class="FixedLine">110      $this-&gt;markTestIncomplete('pending');</div><div class="FixedLine">111  }</div><div class="FixedLine">112</div><div class="FixedLine">113  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">114  <span class="EmphasisTypeBold">public function</span> update_should_not_match_an_invalid_route()</div><div class="FixedLine">115  {</div><div class="FixedLine">116      $this-&gt;markTestIncomplete('pending');</div><div class="FixedLine">117  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-38.</span><div class="SimplePara">Acceptance Criteria for Updating a Book</div></div></div></div>
          </div><div id="Par114" class="Para">The first test will ensure that only fillable fields can be changed and that the changes are persisted in the database. The response should also return the updated record data and a <span class="EmphasisFontCategoryNonProportional">200 OK</span> status code (Listing <span class="InternalRef"><a href="#Par115">5-39</a></span>).</div><div id="Par115" class="Para">
            <div class="ProgramCode" id="PC40"><div class="FixedLine">101  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">102  <span class="EmphasisTypeBold">public function</span> update_should_only_change_fillable_fields()</div><div class="FixedLine">103  {</div><div class="FixedLine">104      $this-&gt;notSeeInDatabase('books', [</div><div class="FixedLine">105          'title' =&gt; 'The War of the Worlds'</div><div class="FixedLine">106      ]);</div><div class="FixedLine">107</div><div class="FixedLine">108      $this-&gt;put('/books/1', [</div><div class="FixedLine">109          'id' =&gt; 5,</div><div class="FixedLine">110          'title' =&gt; 'The War of the Worlds',</div><div class="FixedLine">111          'description' =&gt; 'The book is way better than the movie.',</div><div class="FixedLine">112          'author' =&gt; 'Wells, H. G.'</div><div class="FixedLine">113      ]);</div><div class="FixedLine">114</div><div class="FixedLine">115      $this</div><div class="FixedLine">116          -&gt;seeStatusCode(200)</div><div class="FixedLine">117          -&gt;seeJson([</div><div class="FixedLine">118              'id' =&gt; 1,</div><div class="FixedLine">119              'title' =&gt; 'The War of the Worlds',</div><div class="FixedLine">120              'description' =&gt; 'The book is way better than the movie.',</div><div class="FixedLine">121              'author' =&gt; 'Wells, H. G.'</div><div class="FixedLine">122          ])</div><div class="FixedLine">123          -&gt;seeInDatabase('books', [</div><div class="FixedLine">124              'title' =&gt; 'The War of the Worlds'</div><div class="FixedLine">125          ]);</div><div class="FixedLine">126  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-39.</span><div class="SimplePara">Testing for a Successful Book Update</div></div></div></div>
          </div><div id="Par116" class="Para">Your test assumes that a post with an id of <span class="EmphasisFontCategoryNonProportional">1</span> exists in the database from your seed data. You make a <span class="EmphasisFontCategoryNonProportional">PUT</span> request with changes all the fillable fields so you can assert that they get updated. Notice that the test tries to update the <span class="EmphasisFontCategoryNonProportional">id,</span> which should not be allowed. Before making the <span class="EmphasisFontCategoryNonProportional">PUT</span> request, your test makes sure a record doesn’t already exist in the database. After updating the record, the test verifies the response, the status code, and that a record exists with the new changes in the database.</div><div id="Par117" class="Para">Your test will fail with your assertion of a <span class="EmphasisFontCategoryNonProportional">200</span> response status code because you haven’t defined a route; instead you get a <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">405 Method Not Allowed</span></span> response (Listing <span class="InternalRef"><a href="#Par118">5-40</a></span>).</div><div id="Par118" class="Para">
            <div class="ProgramCode" id="PC41"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::update_should_only_change_fillable_fields</div><div class="FixedLine">Expected status code 200, got 405.</div><div class="FixedLine">Failed asserting that 405 matches expected 200.</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 10, Assertions: 20, Failures: 1, Incomplete: 2.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-40.</span><div class="SimplePara">Testing the Updating of a Book</div></div></div></div>
          </div><div id="Par119" class="Para">With the failing test written, define the route (Listing <span class="InternalRef"><a href="#Par120">5-41</a></span>) and the controller implementation (Listing <span class="InternalRef"><a href="#Par121">5-42</a></span>).</div><div id="Par120" class="Para">
            <div class="ProgramCode" id="PC42"><div class="FixedLine">18  $app-&gt;get('/books', 'BooksController@index');</div><div class="FixedLine">19  $app-&gt;get('/books/{id:[\d]+}', [</div><div class="FixedLine">20      'as' =&gt; 'books.show',</div><div class="FixedLine">21      'uses' =&gt; 'BooksController@show'</div><div class="FixedLine">22  ]);</div><div class="FixedLine">23  $app-&gt;post('/books', 'BooksController@store');</div><div class="FixedLine">24  $app-&gt;put('/books/{id:[\d]+}', 'BooksController@update');</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-41.</span><div class="SimplePara">Books Update Route (app/Http/routes.php)</div></div></div></div>
          </div><div id="Par121" class="Para">
            <div class="ProgramCode" id="PC43"><div class="FixedLine">56  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">57   <span class="EmphasisTypeItalic">* PUT /books/{id}</span>
          </div><div class="FixedLine">58   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">59   <span class="EmphasisTypeItalic">* @param Request $request</span>
          </div><div class="FixedLine">60   <span class="EmphasisTypeItalic">* @param $id</span>
          </div><div class="FixedLine">61   <span class="EmphasisTypeItalic">* @return mixed</span>
          </div><div class="FixedLine">62   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">63  <span class="EmphasisTypeBold">public function</span> update(Request $request, $id)</div><div class="FixedLine">64  {</div><div class="FixedLine">65      $book = Book::findOrFail($id);</div><div class="FixedLine">66</div><div class="FixedLine">67      $book-&gt;fill($request-&gt;all());</div><div class="FixedLine">68      $book-&gt;save();</div><div class="FixedLine">69</div><div class="FixedLine">70      <span class="EmphasisTypeBold">return</span> $book;</div><div class="FixedLine">71  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-42.</span><div class="SimplePara">First Attempt at Updating a Book (BooksController.php)</div></div></div></div>
          </div><div id="Par122" class="Para">The controller uses the <span class="EmphasisFontCategoryNonProportional">findOrFail</span> method you’ve already seen, which returns the book if it exists. The <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">$book-&gt;fill()</span></span> method, provided by Eloquent, takes an array of data from the request, but only updates the model’s <span class="EmphasisFontCategoryNonProportional">$fillable</span> fields. Next, the <span class="EmphasisFontCategoryNonProportional">$book-&gt;save()</span> method is called and the updated book returned.</div><div id="Par123" class="Para">Run the tests after writing the implementation to see if you can move on (Listing <span class="InternalRef"><a href="#Par124">5-43</a></span>).</div><div id="Par124" class="Para">
            <div class="ProgramCode" id="PC44"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=update_should_only_change_fillable_fields</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 7 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-43.</span><div class="SimplePara">Running the Update Test</div></div></div></div>
          </div><div id="Par125" class="Para">I will spoil it for you: if you run the test again, it will fail the second time. Why does it fail? Because you are using the development database to run tests. The second time you run your test, it will see the updated record in the database when it should not (Listing <span class="InternalRef"><a href="#Par126">5-44</a></span>).</div><div id="Par126" class="Para">
            <div class="ProgramCode" id="PC45"><div class="FixedLine">$this-&gt;notSeeInDatabase('books', [</div><div class="FixedLine">    'title' =&gt; 'The War of the Worlds'</div><div class="FixedLine">]);</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-44.</span><div class="SimplePara">Your Failing Test, Which Should Pass</div></div></div></div>
          </div><div id="Par127" class="Para">Until you start using a separate test database you will have to purge and seed the data before each test run (Listing <span class="InternalRef"><a href="#Par128">5-45</a></span>).</div><div id="Par128" class="Para">
            <div class="ProgramCode" id="PC46"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan migrate:refresh &amp;&amp; php artisan db:seed</div><div class="FixedLine">$ phpunit --filter=update_should_only_change_fillable_fields</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 7 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-45.</span><div class="SimplePara">Refreshing the Database Before Running Tests</div></div></div></div>
          </div><div id="Par129" class="Para">You are ready to work on the second acceptance criteria: <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">update_should_fail_with_an_invalid_id</span></span>. The final two acceptance criteria don’t need to insert a record; they just make sure that your route matches integer digits and that non-existent records return a 404 response. Let’s break the rules a little and write tests for both features at the same time (Listing <span class="InternalRef"><a href="#Par130">5-46</a></span>).</div><div id="Par130" class="Para">
            <div class="ProgramCode" id="PC47"><div class="FixedLine">127  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">128  <span class="EmphasisTypeBold">public function</span> update_should_fail_with_an_invalid_id()</div><div class="FixedLine">129  {</div><div class="FixedLine">130      $this</div><div class="FixedLine">131          -&gt;put('/books/999999999999999')</div><div class="FixedLine">132          -&gt;seeStatusCode(404)</div><div class="FixedLine">133          -&gt;seeJsonEquals([</div><div class="FixedLine">134              'error' =&gt; [</div><div class="FixedLine">135                  'message' =&gt; 'Book not found'</div><div class="FixedLine">136              ]</div><div class="FixedLine">137          ]);</div><div class="FixedLine">138  }</div><div class="FixedLine">139</div><div class="FixedLine">140  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">141  <span class="EmphasisTypeBold">public function</span> update_should_not_match_an_invalid_route()</div><div class="FixedLine">142  {</div><div class="FixedLine">143      $this-&gt;put('/books/this-is-invalid')</div><div class="FixedLine">144          -&gt;seeStatusCode(404);</div><div class="FixedLine">145  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-46.</span><div class="SimplePara">Writing Remaining Tests for the Update Action (BooksController.php)</div></div></div></div>
          </div><div id="Par131" class="Para">Let’s run all the <span class="EmphasisFontCategoryNonProportional">update_should</span> tests (Listing <span class="InternalRef"><a href="#Par132">5-47</a></span>).</div><div id="Par132" class="Para">
            <div class="ProgramCode" id="PC48"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan migrate:refresh &amp;&amp; php artisan db:seed</div><div class="FixedLine">$ phpunit --filter=update_should</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::update_should_fail_with_an_invalid_id</div><div class="FixedLine">ErrorException: Invalid argument supplied for foreach()</div><div class="FixedLine">…</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 3, Assertions: 9, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-47.</span><div class="SimplePara">Running the Update Tests</div></div></div></div>
          </div><div id="Par133" class="Para">It looks like the only failing test is <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">update_should_fail_with_an_invalid_id</span></span>. You already dealt with this issue in the <span class="EmphasisFontCategoryNonProportional">GET/books/{id}</span> route when testing for an error message, so see if you can fix this test on your own before you see the solution (Listing <span class="InternalRef"><a href="#Par134">5-48</a></span>).</div><div id="Par134" class="Para">
            <div class="ProgramCode" id="PC49"><div class="FixedLine">56  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">57   <span class="EmphasisTypeItalic">* PUT /books/{id}</span>
          </div><div class="FixedLine">58   <span class="EmphasisTypeItalic">* @param Request $request</span>
          </div><div class="FixedLine">59   <span class="EmphasisTypeItalic">* @param $id</span>
          </div><div class="FixedLine">60   <span class="EmphasisTypeItalic">* @return mixed</span>
          </div><div class="FixedLine">61   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">62  <span class="EmphasisTypeBold">public function</span> update(Request $request, $id)</div><div class="FixedLine">63  {</div><div class="FixedLine">64      <span class="EmphasisTypeBold">try</span> {</div><div class="FixedLine">65          $book = Book::findOrFail($id);</div><div class="FixedLine">66      } <span class="EmphasisTypeBold">catch</span> (ModelNotFoundException $e) {</div><div class="FixedLine">67          <span class="EmphasisTypeBold">return</span> response()-&gt;json([</div><div class="FixedLine">68              'error' =&gt; [</div><div class="FixedLine">69                  'message' =&gt; 'Book not found'</div><div class="FixedLine">70              ]</div><div class="FixedLine">71          ], 404);</div><div class="FixedLine">72      }</div><div class="FixedLine">73</div><div class="FixedLine">74      $book-&gt;fill($request-&gt;all());</div><div class="FixedLine">75      $book-&gt;save();</div><div class="FixedLine">76</div><div class="FixedLine">77      <span class="EmphasisTypeBold">return</span> $book;</div><div class="FixedLine">78  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-48.</span><div class="SimplePara">Responding to Missing Books with a 404 (BooksController.php)</div></div></div></div>
          </div><div id="Par135" class="Para">Like the <span class="EmphasisFontCategoryNonProportional">BooksController@show</span> method, the <span class="EmphasisFontCategoryNonProportional">@update</span> method catches the <span class="EmphasisFontCategoryNonProportional">ModelNotFoundException</span> and responds with an error message and a <span class="EmphasisFontCategoryNonProportional">404</span> status code. This should get your test suite passing again (Listing <span class="InternalRef"><a href="#Par136">5-49</a></span>).</div><div id="Par136" class="Para">
            <div class="ProgramCode" id="PC50"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan migrate:refresh &amp;&amp; php artisan db:seed</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (10 tests, 28 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-49.</span><div class="SimplePara">Running the Full Test Suite</div></div></div></div>
          </div><div id="Par137" class="Para ParaTypeImportant">
        <img src="A395120_1_En_5_Figf_HTML.jpg" alt="A395120_1_En_5_Figf_HTML.jpg"/> Git Commit: Update a Book</div><div id="Par138" class="Para ParaTypeImportant">475127d (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/475127d"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/475127d</span>
              </span></a></span>)</div></div><div id="Sec4" class="Section1 RenderAsSection1"><h2 class="Heading">Deleting Books</h2><div id="Par139" class="Para">Deleting books is the last part of CRUD, and the end of this really long chapter. Luckily, deleting is easy. Listing <span class="InternalRef"><a href="#Par140">5-50</a></span> shows the <span class="EmphasisFontCategoryNonProportional">DELETE /books/{id}</span> route criteria.</div><div id="Par140" class="Para">
            <div class="ProgramCode" id="PC51"><div class="FixedLine">148  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">149  <span class="EmphasisTypeBold">public function</span> destroy_should_remove_a_valid_book()</div><div class="FixedLine">150  {</div><div class="FixedLine">151      $this-&gt;markTestIncomplete('pending');</div><div class="FixedLine">152  }</div><div class="FixedLine">153</div><div class="FixedLine">154  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">155  <span class="EmphasisTypeBold">public function</span> destroy_should_return_a_404_with_an_invalid_id()</div><div class="FixedLine">156  {</div><div class="FixedLine">157      $this-&gt;markTestIncomplete('pending');</div><div class="FixedLine">158  }</div><div class="FixedLine">159</div><div class="FixedLine">160  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">161  <span class="EmphasisTypeBold">public function</span> destroy_should_not_match_an_invalid_route()</div><div class="FixedLine">162  {</div><div class="FixedLine">163      $this-&gt;markTestIncomplete('pending');</div><div class="FixedLine">164  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-50.</span><div class="SimplePara">Delete Books Acceptance Criteria (BooksControllerTest.php)</div></div></div></div>
          </div><div id="Par141" class="Para">Your first test will make sure you can successfully delete a book. The test expects a <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">204 No Content</span></span> status code and an empty response when deletion succeeds (Listing <span class="InternalRef"><a href="#Par142">5-51</a></span>).</div><div id="Par142" class="Para">
            <div class="ProgramCode" id="PC52"><div class="FixedLine">142  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">143  <span class="EmphasisTypeBold">public function</span> destroy_should_remove_a_valid_book()</div><div class="FixedLine">144  {</div><div class="FixedLine">145      $this</div><div class="FixedLine">146          -&gt;delete('/books/1')</div><div class="FixedLine">147          -&gt;seeStatusCode(204)</div><div class="FixedLine">148          -&gt;isEmpty();</div><div class="FixedLine">149</div><div class="FixedLine">150      $this-&gt;notSeeInDatabase('books', ['id' =&gt; 1]);</div><div class="FixedLine">151  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-51.</span><div class="SimplePara">Testing for Successful Deletion (BooksControllerTest.php)</div></div></div></div>
          </div><div id="Par143" class="Para">Let’s run the test to make sure it fails (Listing <span class="InternalRef"><a href="#Par144">5-52</a></span>).</div><div id="Par144" class="Para">
            <div class="ProgramCode" id="PC53"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=destroy_should_remove_a_valid_book</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::destroy_should_remove_a_valid_book</div><div class="FixedLine">Expected status code 204, got 405.</div><div class="FixedLine">Failed asserting that 405 matches expected 204.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/vendor/laravel/lumen-framework/src/Testing/CrawlerTrait\</div><div class="FixedLine">.php:412</div><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/BooksControllerTest.php:153</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 1, Assertions: 1, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-52.</span><div class="SimplePara">Running the Test for Destroying a Book</div></div></div></div>
          </div><div id="Par145" class="Para">The failed test responds with a <span class="EmphasisFontCategoryNonProportional">405 Method Not Allowed</span> response. Lumen responds with the <span class="EmphasisFontCategoryNonProportional">405</span> without any work on your part until you define the <span class="EmphasisFontCategoryNonProportional">DELETE /books/{id}</span> route. A failed test means you are ready to implement your first version of the <span class="EmphasisFontCategoryNonProportional">BooksController@destroy</span> method and route (Listing <span class="InternalRef"><a href="#Par146">5-53</a></span>).</div><div id="Par146" class="Para">
            <div class="ProgramCode" id="PC54"><div class="FixedLine">80  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">81   <span class="EmphasisTypeItalic">* DELETE /books/{id}</span>
          </div><div class="FixedLine">82   <span class="EmphasisTypeItalic">* @param $id</span>
          </div><div class="FixedLine">83   <span class="EmphasisTypeItalic">* @return \Illuminate\Http\JsonResponse</span>
          </div><div class="FixedLine">84   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">85  <span class="EmphasisTypeBold">public function</span> destroy($id)</div><div class="FixedLine">86  {</div><div class="FixedLine">87      $book = Book::findOrFail($id);</div><div class="FixedLine">88      $book-&gt;delete();</div><div class="FixedLine">89</div><div class="FixedLine">90      <span class="EmphasisTypeBold">return</span> response(<span class="EmphasisTypeBold">null</span>, 204);</div><div class="FixedLine">91 }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-53.</span><div class="SimplePara">BooksController::destroy() Method (BooksController.php)</div></div></div></div>
          </div><div id="Par147" class="Para">Just like your test outlines, you find the book and call <span class="EmphasisFontCategoryNonProportional">$book-&gt;delete()</span> on the model and omit a response body. You don’t call <span class="EmphasisFontCategoryNonProportional">response()-&gt;json()</span> because you are not sending back a response body with a <span class="EmphasisFontCategoryNonProportional">204</span> response, indicating that the server successfully fulfilled the request but there is no content to send back.</div><div id="Par148" class="Para">You need to define the accompanying route (Listing <span class="InternalRef"><a href="#Par149">5-54</a></span>) and then run the test (Listing <span class="InternalRef"><a href="#Par150">5-55</a></span>).</div><div id="Par149" class="Para">
            <div class="ProgramCode" id="PC55"><div class="FixedLine">18  $app-&gt;get('/books', 'BooksController@index');</div><div class="FixedLine">19  $app-&gt;get('/books/{id:[\d]+}', [</div><div class="FixedLine">20      'as' =&gt; 'books.show',</div><div class="FixedLine">21      'uses' =&gt; 'BooksController@show'</div><div class="FixedLine">22  ]);</div><div class="FixedLine">23  $app-&gt;put('/books/{id:[\d]+}', 'BooksController@update');</div><div class="FixedLine">24  $app-&gt;post('/books', 'BooksController@store');</div><div class="FixedLine">25  $app-&gt;delete('/books/{id:[\d]+}', 'BooksController@destroy');</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-54.</span><div class="SimplePara">The BooksController@destroy Route</div></div></div></div>
          </div><div id="Par150" class="Para">
            <div class="ProgramCode" id="PC56"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=destroy_should_remove_a_valid_book</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 2 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-55.</span><div class="SimplePara">Running the Test for Destroying a Book</div></div></div></div>
          </div><div id="Par151" class="Para">After you delete the record in the database, your test will fail if you run it a second time because the record has been removed. Keep refreshing the migration and seeding data to wrap up this chapter. The final two tests are the same as the <span class="EmphasisFontCategoryNonProportional">PUT /books/{id}</span> tests (Listing <span class="InternalRef"><a href="#Par152">5-56</a></span>).</div><div id="Par152" class="Para">
            <div class="ProgramCode" id="PC57"><div class="FixedLine">158  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">159  <span class="EmphasisTypeBold">public function</span> destroy_should_return_a_404_with_an_invalid_id()</div><div class="FixedLine">160  {</div><div class="FixedLine">161      $this</div><div class="FixedLine">162          -&gt;delete('/books/99999')</div><div class="FixedLine">163          -&gt;seeStatusCode(404)</div><div class="FixedLine">164          -&gt;seeJsonEquals([</div><div class="FixedLine">165              'error' =&gt; [</div><div class="FixedLine">166                  'message' =&gt; 'Book not found'</div><div class="FixedLine">167              ]</div><div class="FixedLine">168          ]);</div><div class="FixedLine">169  }</div><div class="FixedLine">170</div><div class="FixedLine">171  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">172  <span class="EmphasisTypeBold">public function</span> destroy_should_not_match_an_invalid_route()</div><div class="FixedLine">173  {</div><div class="FixedLine">174      $this-&gt;delete('/books/this-is-invalid')</div><div class="FixedLine">175          -&gt;seeStatusCode(404);</div><div class="FixedLine">176  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-56.</span><div class="SimplePara">Final BooksController::destroy() Tests</div></div></div></div>
          </div><div id="Par153" class="Para">You expect that your tests should fail (Listing <span class="InternalRef"><a href="#Par154">5-57</a></span>).</div><div id="Par154" class="Para">
            <div class="ProgramCode" id="PC58"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan migrate:refresh &amp;&amp; php artisan db:seed</div><div class="FixedLine">$ phpunit --filter=destroy_</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::destroy_should_return_a_404_with_an_invalid_id</div><div class="FixedLine">ErrorException: Invalid argument supplied for foreach()</div><div class="FixedLine">...</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 3, Assertions: 4, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-57.</span><div class="SimplePara">Running the Tests for Deleting a Book</div></div></div></div>
          </div><div id="Par155" class="Para">There’s one final test to fail and then you can consider your initial BooksController complete. To pass the final test, you must catch the <span class="EmphasisFontCategoryNonProportional">ModelNotFoundException</span> like your other controller methods (Listing <span class="InternalRef"><a href="#Par156">5-58</a></span>).</div><div id="Par156" class="Para">
            <div class="ProgramCode" id="PC59"><div class="FixedLine"> 80  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 81   <span class="EmphasisTypeItalic">* DELETE /books/{id}</span>
          </div><div class="FixedLine"> 82   <span class="EmphasisTypeItalic">* @param $id</span>
          </div><div class="FixedLine"> 83   <span class="EmphasisTypeItalic">* @return \Illuminate\Http\JsonResponse</span>
          </div><div class="FixedLine"> 84   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine"> 85  <span class="EmphasisTypeBold">public function</span> destroy($id)</div><div class="FixedLine"> 86  {</div><div class="FixedLine"> 87      <span class="EmphasisTypeBold">try</span> {</div><div class="FixedLine"> 88          $book = Book::findOrFail($id);</div><div class="FixedLine"> 89      } <span class="EmphasisTypeBold">catch</span> (ModelNotFoundException $e) {</div><div class="FixedLine"> 90          <span class="EmphasisTypeBold">return</span> response()-&gt;json([</div><div class="FixedLine"> 91              'error' =&gt; [</div><div class="FixedLine"> 92                  'message' =&gt; 'Book not found'</div><div class="FixedLine"> 93              ]</div><div class="FixedLine"> 94          ], 404);</div><div class="FixedLine"> 95      }</div><div class="FixedLine"> 96</div><div class="FixedLine"> 97      $book-&gt;delete();</div><div class="FixedLine"> 98</div><div class="FixedLine"> 99      <span class="EmphasisTypeBold">return</span> response(<span class="EmphasisTypeBold">null</span>, 204);</div><div class="FixedLine">100  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-58.</span><div class="SimplePara">Respond with 404 Error if Missing (BooksController.php)</div></div></div></div>
          </div><div id="Par157" class="Para">This code change should get your tests to pass (Listing <span class="InternalRef"><a href="#Par158">5-59</a></span>).</div><div id="Par158" class="Para">
            <div class="ProgramCode" id="PC60"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan migrate:refresh &amp;&amp; php artisan db:seed</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (13 tests, 33 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-59.</span><div class="SimplePara">Run the Full Test Suite</div></div></div></div>
          </div><div id="Par159" class="Para">Success! You are done with your first version of the BooksController. The following listings show the full source code of the main files you are working on, including <span class="EmphasisFontCategoryNonProportional">BooksController.php</span> (Listing <span class="InternalRef"><a href="#Par160">5-60</a></span>), <span class="EmphasisFontCategoryNonProportional">BooksControllerTest.php</span> (Listing <span class="InternalRef"><a href="#Par161">5-61</a></span>), and <span class="EmphasisFontCategoryNonProportional">routes.php</span> (Listing <span class="InternalRef"><a href="#Par162">5-62</a></span>).</div><div id="Par160" class="Para">
            <div class="ProgramCode" id="PC61"><div class="FixedLine">  1  &lt;?php</div><div class="FixedLine">  2</div><div class="FixedLine">  3  <span class="EmphasisTypeBold">namespace</span> App\Http\Controllers;</div><div class="FixedLine">  4</div><div class="FixedLine">  5  <span class="EmphasisTypeBold">use</span> App\Book;</div><div class="FixedLine">  6  <span class="EmphasisTypeBold">use</span> Illuminate\Http\Request;</div><div class="FixedLine">  7  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Eloquent\ModelNotFoundException;</div><div class="FixedLine">  8</div><div class="FixedLine">  9  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 10   <span class="EmphasisTypeItalic">* Class BooksController</span>
          </div><div class="FixedLine"> 11   <span class="EmphasisTypeItalic">* @package App\Http\Controllers</span>
          </div><div class="FixedLine"> 12   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine"> 13  <span class="EmphasisTypeBold">class BooksController</span>
          </div><div class="FixedLine"> 14  {</div><div class="FixedLine"> 15      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 16       <span class="EmphasisTypeItalic">* GET /books</span>
          </div><div class="FixedLine"> 17       <span class="EmphasisTypeItalic">* @return array</span>
          </div><div class="FixedLine"> 18       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine"> 19      <span class="EmphasisTypeBold">public function</span> index()</div><div class="FixedLine"> 20      {</div><div class="FixedLine"> 21          <span class="EmphasisTypeBold">return</span> Book::all();</div><div class="FixedLine"> 22      }</div><div class="FixedLine"> 23</div><div class="FixedLine"> 24      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 25       <span class="EmphasisTypeItalic">* GET /books/{id}</span>
          </div><div class="FixedLine"> 26       <span class="EmphasisTypeItalic">* @param integer $id</span>
          </div><div class="FixedLine"> 27       <span class="EmphasisTypeItalic">* @return mixed</span>
          </div><div class="FixedLine"> 28       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine"> 29      <span class="EmphasisTypeBold">public function</span> show($id)</div><div class="FixedLine"> 30      {</div><div class="FixedLine"> 31          <span class="EmphasisTypeBold">try</span> {</div><div class="FixedLine"> 32              <span class="EmphasisTypeBold">return</span> Book::findOrFail($id);</div><div class="FixedLine"> 33          } <span class="EmphasisTypeBold">catch</span> (ModelNotFoundException $e) {</div><div class="FixedLine"> 34              <span class="EmphasisTypeBold">return</span> response()-&gt;json([</div><div class="FixedLine"> 35                  'error' =&gt; [</div><div class="FixedLine"> 36                      'message' =&gt; 'Book not found'</div><div class="FixedLine"> 37                  ]</div><div class="FixedLine"> 38              ], 404);</div><div class="FixedLine"> 39          }</div><div class="FixedLine"> 40      }</div><div class="FixedLine"> 41</div><div class="FixedLine"> 42      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 43       <span class="EmphasisTypeItalic">* POST /books</span>
          </div><div class="FixedLine"> 44       <span class="EmphasisTypeItalic">* @param Request $request</span>
          </div><div class="FixedLine"> 45       <span class="EmphasisTypeItalic">* @return \Symfony\Component\HttpFoundation\Response</span>
          </div><div class="FixedLine"> 46       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine"> 47      <span class="EmphasisTypeBold">public function</span> store(Request $request)</div><div class="FixedLine"> 48      {</div><div class="FixedLine"> 49          $book = Book::create($request-&gt;all());</div><div class="FixedLine"> 50</div><div class="FixedLine"> 51          <span class="EmphasisTypeBold">return</span> response()-&gt;json(['created' =&gt; <span class="EmphasisTypeBold">true</span>], 201, [</div><div class="FixedLine"> 52              'Location' =&gt; route('books.show', ['id' =&gt; $book-&gt;id])</div><div class="FixedLine"> 53          ]);</div><div class="FixedLine"> 54      }</div><div class="FixedLine"> 55</div><div class="FixedLine"> 56      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 57       <span class="EmphasisTypeItalic">* PUT /books/{id}</span>
          </div><div class="FixedLine"> 58       <span class="EmphasisTypeItalic">* @param Request $request</span>
          </div><div class="FixedLine"> 59       <span class="EmphasisTypeItalic">* @param $id</span>
          </div><div class="FixedLine"> 60       <span class="EmphasisTypeItalic">* @return mixed</span>
          </div><div class="FixedLine"> 61       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine"> 62      <span class="EmphasisTypeBold">public function</span> update(Request $request, $id)</div><div class="FixedLine"> 63      {</div><div class="FixedLine"> 64          <span class="EmphasisTypeBold">try</span> {</div><div class="FixedLine"> 65              $book = Book::findOrFail($id);</div><div class="FixedLine"> 66          } <span class="EmphasisTypeBold">catch</span> (ModelNotFoundException $e) {</div><div class="FixedLine"> 67              <span class="EmphasisTypeBold">return</span> response()-&gt;json([</div><div class="FixedLine"> 68                  'error' =&gt; [</div><div class="FixedLine"> 69                      'message' =&gt; 'Book not found'</div><div class="FixedLine"> 70                  ]</div><div class="FixedLine"> 71              ], 404);</div><div class="FixedLine"> 72          }</div><div class="FixedLine"> 73</div><div class="FixedLine"> 74          $book-&gt;fill($request-&gt;all());</div><div class="FixedLine"> 75          $book-&gt;save();</div><div class="FixedLine"> 76</div><div class="FixedLine"> 77          <span class="EmphasisTypeBold">return</span> $book;</div><div class="FixedLine"> 78      }</div><div class="FixedLine"> 79</div><div class="FixedLine"> 80      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 81       <span class="EmphasisTypeItalic">* DELETE /books/{id}</span>
          </div><div class="FixedLine"> 82       <span class="EmphasisTypeItalic">* @param $id</span>
          </div><div class="FixedLine"> 83       <span class="EmphasisTypeItalic">* @return \Illuminate\Http\JsonResponse</span>
          </div><div class="FixedLine"> 84       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine"> 85      <span class="EmphasisTypeBold">public function</span> destroy($id)</div><div class="FixedLine"> 86      {</div><div class="FixedLine"> 87          <span class="EmphasisTypeBold">try</span> {</div><div class="FixedLine"> 88              $book = Book::findOrFail($id);</div><div class="FixedLine"> 89          } <span class="EmphasisTypeBold">catch</span> (ModelNotFoundException $e) {</div><div class="FixedLine"> 90              <span class="EmphasisTypeBold">return</span> response()-&gt;json([</div><div class="FixedLine"> 91                  'error' =&gt; [</div><div class="FixedLine"> 92                      'message' =&gt; 'Book not found'</div><div class="FixedLine"> 93                  ]</div><div class="FixedLine"> 94              ], 404);</div><div class="FixedLine"> 95          }</div><div class="FixedLine"> 96</div><div class="FixedLine"> 97          $book-&gt;delete();</div><div class="FixedLine"> 98</div><div class="FixedLine"> 99          <span class="EmphasisTypeBold">return</span> response(<span class="EmphasisTypeBold">null</span>, 204);</div><div class="FixedLine">100      }</div><div class="FixedLine">101  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-60.</span><div class="SimplePara">BooksController.php</div></div></div></div>
          </div><div id="Par161" class="Para">
            <div class="ProgramCode" id="PC62"><div class="FixedLine">  1  &lt;?php</div><div class="FixedLine">  2</div><div class="FixedLine">  3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Http\Controllers;</div><div class="FixedLine">  4</div><div class="FixedLine">  5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine">  6</div><div class="FixedLine">  7  <span class="EmphasisTypeBold">class BooksControllerTest extends</span> TestCase</div><div class="FixedLine">  8  {</div><div class="FixedLine">  9      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine"> 10      <span class="EmphasisTypeBold">public function</span> index_status_code_should_be_200()</div><div class="FixedLine"> 11      {</div><div class="FixedLine"> 12          $this-&gt;visit('/books')-&gt;seeStatusCode(200);</div><div class="FixedLine"> 13      }</div><div class="FixedLine"> 14</div><div class="FixedLine"> 15      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine"> 16      <span class="EmphasisTypeBold">public function</span> index_should_return_a_collection_of_records()</div><div class="FixedLine"> 17      {</div><div class="FixedLine"> 18          $this</div><div class="FixedLine"> 19              -&gt;get('/books')</div><div class="FixedLine"> 20              -&gt;seeJson([</div><div class="FixedLine"> 21                  'title' =&gt; 'War of the Worlds'</div><div class="FixedLine"> 22              ])</div><div class="FixedLine"> 23              -&gt;seeJson([</div><div class="FixedLine"> 24                  'title' =&gt; 'A Wrinkle in Time'</div><div class="FixedLine"> 25              ]);</div><div class="FixedLine"> 26      }</div><div class="FixedLine"> 27</div><div class="FixedLine"> 28      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine"> 29      <span class="EmphasisTypeBold">public function</span> show_should_return_a_valid_book()</div><div class="FixedLine"> 30      {</div><div class="FixedLine"> 31          $this</div><div class="FixedLine"> 32              -&gt;get('/books/1')</div><div class="FixedLine"> 33              -&gt;seeStatusCode(200)</div><div class="FixedLine"> 34              -&gt;seeJson([</div><div class="FixedLine"> 35                  'id' =&gt; 1,</div><div class="FixedLine"> 36                  'title' =&gt; 'War of the Worlds',</div><div class="FixedLine"> 37                  'description' =&gt; 'A science fiction masterpiece about Martians invading London',</div><div class="FixedLine"> 38                  'author' =&gt; 'H. G. Wells'</div><div class="FixedLine"> 39              ]);</div><div class="FixedLine"> 40</div><div class="FixedLine"> 41          $data = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine"> 42          $this-&gt;assertArrayHasKey('created_at', $data);</div><div class="FixedLine"> 43          $this-&gt;assertArrayHasKey('updated_at', $data);</div><div class="FixedLine"> 44      }</div><div class="FixedLine"> 45</div><div class="FixedLine"> 46      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine"> 47      <span class="EmphasisTypeBold">public function</span> show_should_fail_when_the_book_id_does_not_exist()</div><div class="FixedLine"> 48      {</div><div class="FixedLine"> 49          $this</div><div class="FixedLine"> 50              -&gt;get('/books/99999')</div><div class="FixedLine"> 51              -&gt;seeStatusCode(404)</div><div class="FixedLine"> 52              -&gt;seeJson([</div><div class="FixedLine"> 53                  'error' =&gt; [</div><div class="FixedLine"> 54                      'message' =&gt; 'Book not found'</div><div class="FixedLine"> 55                  ]</div><div class="FixedLine"> 56              ]);</div><div class="FixedLine"> 57      }</div><div class="FixedLine"> 58</div><div class="FixedLine"> 59      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine"> 60      <span class="EmphasisTypeBold">public function</span> show_route_should_not_match_an_invalid_route()</div><div class="FixedLine"> 61      {</div><div class="FixedLine"> 62          $this-&gt;get('/books/this-is-invalid');</div><div class="FixedLine"> 63</div><div class="FixedLine"> 64          $this-&gt;assertNotRegExp(</div><div class="FixedLine"> 65              '/Book not found/',</div><div class="FixedLine"> 66              $this-&gt;response-&gt;getContent(),</div><div class="FixedLine"> 67              'BooksController@show route matching when it should not.'</div><div class="FixedLine"> 68          );</div><div class="FixedLine"> 69      }</div><div class="FixedLine"> 70</div><div class="FixedLine"> 71      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine"> 72      <span class="EmphasisTypeBold">public function</span> store_should_save_new_book_in_the_database()</div><div class="FixedLine"> 73      {</div><div class="FixedLine"> 74          $this-&gt;post('/books', [</div><div class="FixedLine"> 75              'title' =&gt; 'The Invisible Man',</div><div class="FixedLine"> 76              'description' =&gt; 'An invisible man is trapped in the terror of his own creation',</div><div class="FixedLine"> 77              'author' =&gt; 'H. G. Wells'</div><div class="FixedLine"> 78          ]);</div><div class="FixedLine"> 79</div><div class="FixedLine"> 80          $this</div><div class="FixedLine"> 81              -&gt;seeJson(['created' =&gt; <span class="EmphasisTypeBold">true</span>])</div><div class="FixedLine"> 82              -&gt;seeInDatabase('books', ['title' =&gt; 'The Invisible Man']);</div><div class="FixedLine"> 83      }</div><div class="FixedLine"> 84</div><div class="FixedLine"> 85      <span class="EmphasisTypeItalic">/** @test */</span>
          </div><div class="FixedLine"> 86      <span class="EmphasisTypeBold">public function</span> store_should_respond_with_a_201_and_location_header_when_successful()</div><div class="FixedLine"> 87      {</div><div class="FixedLine"> 88          $this-&gt;post('/books', [</div><div class="FixedLine"> 89              'title' =&gt; 'The Invisible Man',</div><div class="FixedLine"> 90              'description' =&gt; 'An invisible man is trapped in the terror of his own creation',</div><div class="FixedLine"> 91              'author' =&gt; 'H. G. Wells'</div><div class="FixedLine"> 92          ]);</div><div class="FixedLine"> 93</div><div class="FixedLine"> 94          $this</div><div class="FixedLine"> 95              -&gt;seeStatusCode(201)</div><div class="FixedLine"> 96              -&gt;seeHeaderWithRegExp('Location', '#/books/[\d]+$#');</div><div class="FixedLine"> 97</div><div class="FixedLine"> 98      }</div><div class="FixedLine"> 99</div><div class="FixedLine">100      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">101      <span class="EmphasisTypeBold">public function</span> update_should_only_change_fillable_fields()</div><div class="FixedLine">102      {</div><div class="FixedLine">103          $this-&gt;notSeeInDatabase('books', [</div><div class="FixedLine">104              'title' =&gt; 'The War of the Worlds'</div><div class="FixedLine">105          ]);</div><div class="FixedLine">106</div><div class="FixedLine">107          $this-&gt;put('/books/1', [</div><div class="FixedLine">108              'id' =&gt; 5,</div><div class="FixedLine">109              'title' =&gt; 'The War of the Worlds',</div><div class="FixedLine">110              'description' =&gt; 'The book is way better than the movie.',</div><div class="FixedLine">111              'author' =&gt; 'Wells, H. G.'</div><div class="FixedLine">112          ]);</div><div class="FixedLine">113</div><div class="FixedLine">114          $this</div><div class="FixedLine">115              -&gt;seeStatusCode(200)</div><div class="FixedLine">116              -&gt;seeJson([</div><div class="FixedLine">117                  'id' =&gt; 1,</div><div class="FixedLine">118                  'title' =&gt; 'The War of the Worlds',</div><div class="FixedLine">119                  'description' =&gt; 'The book is way better than the movie.',</div><div class="FixedLine">120                  'author' =&gt; 'Wells, H. G.'</div><div class="FixedLine">121              ])</div><div class="FixedLine">122              -&gt;seeInDatabase('books', [</div><div class="FixedLine">123                  'title' =&gt; 'The War of the Worlds'</div><div class="FixedLine">124              ]);</div><div class="FixedLine">125      }</div><div class="FixedLine">126</div><div class="FixedLine">127      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">128      <span class="EmphasisTypeBold">public function</span> update_should_fail_with_an_invalid_id()</div><div class="FixedLine">129      {</div><div class="FixedLine">130          $this</div><div class="FixedLine">131              -&gt;put('/books/999999999999999')</div><div class="FixedLine">132              -&gt;seeStatusCode(404)</div><div class="FixedLine">133              -&gt;seeJsonEquals([</div><div class="FixedLine">134                  'error' =&gt; [</div><div class="FixedLine">135                      'message' =&gt; 'Book not found'</div><div class="FixedLine">136                  ]</div><div class="FixedLine">137              ]);</div><div class="FixedLine">138      }</div><div class="FixedLine">139</div><div class="FixedLine">140      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">141      <span class="EmphasisTypeBold">public function</span> update_should_not_match_an_invalid_route()</div><div class="FixedLine">142      {</div><div class="FixedLine">143          $this-&gt;put('/books/this-is-invalid')</div><div class="FixedLine">144              -&gt;seeStatusCode(404);</div><div class="FixedLine">145      }</div><div class="FixedLine">146</div><div class="FixedLine">147      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">148      <span class="EmphasisTypeBold">public function</span> destroy_should_remove_a_valid_book()</div><div class="FixedLine">149      {</div><div class="FixedLine">150          $this</div><div class="FixedLine">151              -&gt;delete('/books/1')</div><div class="FixedLine">152              -&gt;seeStatusCode(204)</div><div class="FixedLine">153              -&gt;isEmpty();</div><div class="FixedLine">154</div><div class="FixedLine">155          $this-&gt;notSeeInDatabase('books', ['id' =&gt; 1]);</div><div class="FixedLine">156      }</div><div class="FixedLine">157</div><div class="FixedLine">158      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">159      <span class="EmphasisTypeBold">public function</span> destroy_should_return_a_404_with_an_invalid_id()</div><div class="FixedLine">160      {</div><div class="FixedLine">161          $this</div><div class="FixedLine">162              -&gt;delete('/books/99999')</div><div class="FixedLine">163              -&gt;seeStatusCode(404)</div><div class="FixedLine">164              -&gt;seeJsonEquals([</div><div class="FixedLine">165                  'error' =&gt; [</div><div class="FixedLine">166                      'message' =&gt; 'Book not found'</div><div class="FixedLine">167                  ]</div><div class="FixedLine">168              ]);</div><div class="FixedLine">169      }</div><div class="FixedLine">170</div><div class="FixedLine">171      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">172      <span class="EmphasisTypeBold">public function</span> destroy_should_not_match_an_invalid_route()</div><div class="FixedLine">173      {</div><div class="FixedLine">174          $this-&gt;delete('/books/this-is-invalid')</div><div class="FixedLine">175              -&gt;seeStatusCode(404);</div><div class="FixedLine">176      }</div><div class="FixedLine">177  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-61.</span><div class="SimplePara">BooksControllerTest.php</div></div></div></div>
          </div><div id="Par162" class="Para">
            <div class="ProgramCode" id="PC63"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeItalic">/*</span>
          </div><div class="FixedLine"> 4  <span class="EmphasisTypeItalic">|-------------------------------------------------------------------------</span>
          </div><div class="FixedLine"> 5  <span class="EmphasisTypeItalic">| Application Routes</span>
          </div><div class="FixedLine"> 6  <span class="EmphasisTypeItalic">|-------------------------------------------------------------------------</span>
          </div><div class="FixedLine"> 7  <span class="EmphasisTypeItalic">|</span>
          </div><div class="FixedLine"> 8  <span class="EmphasisTypeItalic">| Here is where you can register all of the routes for an application.</span>
          </div><div class="FixedLine"> 9  <span class="EmphasisTypeItalic">| It is a breeze. Simply tell Lumen the URIs it should respond to</span>
          </div><div class="FixedLine">10  <span class="EmphasisTypeItalic">| and give it the Closure to call when that URI is requested.</span>
          </div><div class="FixedLine">11  <span class="EmphasisTypeItalic">|</span>
          </div><div class="FixedLine">12  <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">13</div><div class="FixedLine">14  $app-&gt;get('/', <span class="EmphasisTypeBold">function</span> () <span class="EmphasisTypeBold">use</span> ($app) {</div><div class="FixedLine">15      <span class="EmphasisTypeBold">return</span> $app-&gt;version();</div><div class="FixedLine">16  });</div><div class="FixedLine">17</div><div class="FixedLine">18  $app-&gt;get('/books', 'BooksController@index');</div><div class="FixedLine">19  $app-&gt;get('/books/{id:[\d]+}', [</div><div class="FixedLine">20      'as' =&gt; 'books.show',</div><div class="FixedLine">21      'uses' =&gt; 'BooksController@show'</div><div class="FixedLine">22  ]);</div><div class="FixedLine">23  $app-&gt;put('/books/{id:[\d]+}', 'BooksController@update');</div><div class="FixedLine">24  $app-&gt;post('/books', 'BooksController@store');</div><div class="FixedLine">25  $app-&gt;delete('/books/{id:[\d]+}', 'BooksController@destroy');</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 5-62.</span><div class="SimplePara">routes.php</div></div></div></div>
          </div><div id="Par163" class="Para">If you are following along, commit your changes before moving on to the next chapter.</div><div id="Par164" class="Para ParaTypeImportant">
        <img src="A395120_1_En_5_Figg_HTML.jpg" alt="A395120_1_En_5_Figg_HTML.jpg"/> Git commit: Delete a Book</div><div id="Par165" class="Para ParaTypeImportant">60ab6ca (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/60ab6ca"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/60ab6ca</span>
              </span></a></span>)</div></div><div id="Sec5" class="Section1 RenderAsSection1"><h2 class="Heading">Conclusion</h2><div id="Par166" class="Para">You covered a lot of ground in this chapter, including
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par167" class="Para">Testing first and then writing a passing implementation</div></li><li><div id="Par168" class="Para">Creating new records in a database with Eloquent</div></li><li><div id="Par169" class="Para">Updating existing records in the database</div></li><li><div id="Par170" class="Para">Deleting existing records in the database</div></li><li><div id="Par171" class="Para">Using correct response codes for creating, updating, and deleting resources</div></li><li><div id="Par172" class="Para">Defining a named route</div></li></ul></div>
      </div><div id="Par173" class="Para ParaOneEmphasisChild">The <span class="EmphasisFontCategoryNonProportional">BooksController</span> is clean and simple, with Eloquent doing the heavy lifting for your data. Your methods are small and concise, which makes code easier to digest and maintain.</div></div></div></body></html>
