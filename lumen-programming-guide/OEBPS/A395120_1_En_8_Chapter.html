<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>Validation</title><link href="springer_epub.css" type="text/css" rel="styleSheet"/></head><body><div class="ChapterContextInformation"><div class="ContextInformation" id="b978-1-4842-2187-7_8"><div class="ChapterCopyright">© Paul Redmond 2016</div><span class="ContextInformationAuthorEditorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span></span></span><span class="ContextInformationBookTitles"><span class="BookTitle" xml:lang="en">Lumen Programming Guide</span></span><span class="ChapterDOI">10.1007/978-1-4842-2187-7_8</span></div></div><!--Begin Abstract--><div class="MainTitleSection"><h1 class="ChapterTitle" xml:lang="en">8. Validation</h1></div><div class="AuthorGroup"><div class="AuthorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span><sup>1 <span class="ContactIcon"/></sup></span></div><div class="Affiliations"><div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">Phoenix, Arizona, USA</div></div><div class="ClearBoth"> </div></div></div><!--End Abstract--><div class="Fulltext"><div id="Par1" class="Para">Your <span class="EmphasisFontCategoryNonProportional">/books</span> API is going smoothly up to this point, but your tests and controllers assume that <span class="EmphasisTypeItalic">good</span> data is being submitted. Your application doesn’t protect against bad data (and empty data) being saved to the database; specifically, the <span class="EmphasisFontCategoryNonProportional">BooksController@store</span> and <span class="EmphasisFontCategoryNonProportional">BooksController@update</span> methods happily save bad data.</div><div id="Par2" class="Para">You will focus your efforts on validating data submitted to the <span class="EmphasisFontCategoryNonProportional">/books</span> API using the validation (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/validation"><span class="RefSource">
              <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/validation</span>
            </span></a></span>) tools provided by Lumen. You will write tests for your validation logic; this will provide you with a good foundation of how write validation tests in your own applications.</div><div id="Sec1" class="Section1 RenderAsSection1"><h2 class="Heading">First Attempt at Validation</h2><div id="Par3" class="Para">You will start out with basic validation and then iteratively add features as you go. Like always, you create tests first.</div><div id="Par4" class="Para">What validation rules do you need? Validation is a combination of business logic and security practices. For example, in your <span class="EmphasisFontCategoryNonProportional">/books</span> API, all books should be required to have a title. For your purposes, the database schema doesn’t allow null values, and you intend to make the <span class="EmphasisFontCategoryNonProportional">title</span>, <span class="EmphasisFontCategoryNonProportional">description</span>, and <span class="EmphasisFontCategoryNonProportional">author</span> fields required. If these fields are present, you will consider them valid.</div><div id="Par5" class="Para">Let’s start by creating a new integration test file (Listing <span class="InternalRef"><a href="#Par6">8-1</a></span>) and the skeleton class (Listing <span class="InternalRef"><a href="#Par7">8-2</a></span>) with a few basic tests for validation.</div><div id="Par6" class="Para">
            <div class="ProgramCode" id="PC1"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ touch tests/app/Http/Controllers/BooksControllerValidationTest.php</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-1.</span><div class="SimplePara">Creating the Test Class</div></div></div></div>
          </div><div id="Par7" class="Para">
            <div class="ProgramCode" id="PC2"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> Illuminate\Http\Response;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> Laravel\Lumen\Testing\DatabaseMigrations;</div><div class="FixedLine"> 8</div><div class="FixedLine"> 9  <span class="EmphasisTypeBold">class BooksControllerValidationTest extends</span> TestCase</div><div class="FixedLine">10  {</div><div class="FixedLine">11      <span class="EmphasisTypeBold">use</span> DatabaseMigrations;</div><div class="FixedLine">12</div><div class="FixedLine">13      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">14      <span class="EmphasisTypeBold">public function</span> it_validates_required_fields_when_creating_a_new_book()</div><div class="FixedLine">15      {</div><div class="FixedLine">16</div><div class="FixedLine">17      }</div><div class="FixedLine">18</div><div class="FixedLine">19      <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">20      <span class="EmphasisTypeBold">public function</span> it_validates_requied_fields_when_updating_a_book()</div><div class="FixedLine">21      {</div><div class="FixedLine">22</div><div class="FixedLine">23      }</div><div class="FixedLine">24  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-2.</span><div class="SimplePara">The Skeleton BooksControllerValidationTest Class</div></div></div></div>
          </div><div id="Par8" class="Para">Take note of the imported <span class="EmphasisFontCategoryNonProportional">Illuminate\Http\Response</span> class that you will use to test expected response codes. You also import the <span class="EmphasisFontCategoryNonProportional">DatabaseMigrations</span> trait to test existing database records and insert new ones.</div><div id="Par9" class="Para">Start writing your first test, making sure that your <span class="EmphasisFontCategoryNonProportional">BooksController@store</span> method validates required fields before creating a new book (Listing <span class="InternalRef"><a href="#Par10">8-3</a></span>).</div><div id="Par10" class="Para">
            <div class="ProgramCode" id="PC3"><div class="FixedLine">13  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">14  <span class="EmphasisTypeBold">public function</span> it_validates_required_fields_when_creating_a_new_book()</div><div class="FixedLine">15  {</div><div class="FixedLine">16      $this-&gt;post('/books', [], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">17</div><div class="FixedLine">18      $this-&gt;assertEquals(Response::HTTP_UNPROCESSABLE_ENTITY, $this-&gt;response-&gt;getStatusCode());</div><div class="FixedLine">19</div><div class="FixedLine">20      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">21</div><div class="FixedLine">22      $this-&gt;assertArrayHasKey('title', $body);</div><div class="FixedLine">23      $this-&gt;assertArrayHasKey('description', $body);</div><div class="FixedLine">24      $this-&gt;assertArrayHasKey('author', $body);</div><div class="FixedLine">25</div><div class="FixedLine">26      $this-&gt;assertEquals(["The title field is required."], $body['title']);</div><div class="FixedLine">27      $this-&gt;assertEquals(["The description field is required."], $body['description']);</div><div class="FixedLine">28      $this-&gt;assertEquals(["The author field is required."], $body['author']);</div><div class="FixedLine">29  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-3.</span><div class="SimplePara">Writing Validation Assertions for the BooksController@store Method</div></div></div></div>
          </div><div id="Par11" class="Para">Your first test tries to create a new book without sending any data; you expect to receive a <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">422 Unprocessable Entity</span></span> status code from the failed validation. Next, you decode the JSON response and assert that certain validation errors are present in the response. The validator formats error messages into an array for each field. Now run your first failing validation test (Listing <span class="InternalRef"><a href="#Par12">8-4</a></span>).</div><div id="Par12" class="Para">
            <div class="ProgramCode" id="PC4"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=it_validates_required_fields_when_creating_a_new_book</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerValidationTest::it_validates_required_fields_when_creating_a_new_book</div><div class="FixedLine">Failed asserting that 201 matches expected 422.</div></div><div class="LineGroup"><div class="FixedLine">bookr/tests/app/Http/Controllers/BooksControllerValidationTest.php:18</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 1, Assertions: 1, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-4.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par13" class="Para">The API responds with a <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">201 Created</span></span> status code which you expect when valid data is submitted, but you expect failure because the data submitted is invalid. With the failed test you are ready to integrate your validation logic in the controller (Listing <span class="InternalRef"><a href="#Par14">8-5</a></span>).</div><div id="Par14" class="Para">
            <div class="ProgramCode" id="PC5"><div class="FixedLine">35  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">36   <span class="EmphasisTypeItalic">* POST /books</span>
          </div><div class="FixedLine">37   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">38   <span class="EmphasisTypeItalic">* @param Request $request</span>
          </div><div class="FixedLine">39   <span class="EmphasisTypeItalic">* @return \Illuminate\Http\JsonResponse</span>
          </div><div class="FixedLine">40   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">41  <span class="EmphasisTypeBold">public function</span> store(Request $request)</div><div class="FixedLine">42  {</div><div class="FixedLine">43      $this-&gt;validate($request, [</div><div class="FixedLine">44          'title' =&gt; 'required',</div><div class="FixedLine">45          'description' =&gt; 'required',</div><div class="FixedLine">46          'author' =&gt; 'required'</div><div class="FixedLine">47      ]);</div><div class="FixedLine">48</div><div class="FixedLine">49      $book = Book::create($request-&gt;all());</div><div class="FixedLine">50      $data = $this-&gt;item($book, <span class="EmphasisTypeBold">new</span> BookTransformer());</div><div class="FixedLine">51</div><div class="FixedLine">52      <span class="EmphasisTypeBold">return</span> response()-&gt;json($data, 201, [</div><div class="FixedLine">53          'Location' =&gt; route('books.show', ['id' =&gt; $book-&gt;id])</div><div class="FixedLine">54      ]);</div><div class="FixedLine">55  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-5.</span><div class="SimplePara">The Validation Implementation for Creating a Book</div></div></div></div>
          </div><div id="Par15" class="Para">The first line of the controller calls the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">validate()</span></span> method, which accepts an <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Illuminate\Http\Request</span></span> instance and an array of validation rules mapped to the request data. You validate the request using the <span class="EmphasisFontCategoryNonProportional">required</span> rule, which means the field must be present. If the <span class="EmphasisFontCategoryNonProportional">validate()</span> method fails, it will throw an <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">HttpResponseException</span></span> with the <span class="EmphasisFontCategoryNonProportional">422 Unprocessable Entity</span> status code, which is what your test expects.</div><div id="FPar1" class="FormalPara FormalParaRenderingStyle3 ParaTypeOverview"><div class="Heading">The Validate Method</div><div id="Par16" class="Para">The <span class="EmphasisFontCategoryNonProportional">validate()</span> method comes from the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Laravel\Lumen\Routing\ProvidesConvenienceMethods</span></span> trait provided by the base <span class="EmphasisFontCategoryNonProportional">Laravel\Lumen\Routing\Controller</span> class.</div><div id="Par17" class="Para">Read the validation documentation (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/validation#available-validation-rules"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/validation#available-validation-rules</span>
                </span></a></span>) to find a complete list of all the validation rules Lumen supports out of the box, as well as how to create your own custom rules.</div></div><div id="Par18" class="Para">Next, test your implementation to see if it succeeds (Listing <span class="InternalRef"><a href="#Par19">8-6</a></span>).</div><div id="Par19" class="Para">
            <div class="ProgramCode" id="PC6"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=it_validates_required_fields_when_creating_a_new_book</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 7 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-6.</span><div class="SimplePara">Testing the BooksController@store Validation Implementation</div></div></div></div>
          </div><div id="Par20" class="Para">Add the same basic validation to the <span class="EmphasisFontCategoryNonProportional">BooksController@update</span> method before doing some refactoring and improvements (Listing <span class="InternalRef"><a href="#Par21">8-7</a></span>).</div><div id="Par21" class="Para">
            <div class="ProgramCode" id="PC7"><div class="FixedLine">31  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">32  <span class="EmphasisTypeBold">public function</span> it_validates_validates_passed_fields_when_updating_a_book()</div><div class="FixedLine">33  {</div><div class="FixedLine">34      $book = factory(\App\Book::class)-&gt;create();</div><div class="FixedLine">35</div><div class="FixedLine">36      $this-&gt;put("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>", [], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">37</div><div class="FixedLine">38      $this-&gt;assertEquals(Response::HTTP_UNPROCESSABLE_ENTITY, $this-&gt;response-&gt;getStatusCode());</div><div class="FixedLine">39</div><div class="FixedLine">40      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">41</div><div class="FixedLine">42      $this-&gt;assertArrayHasKey('title', $body);</div><div class="FixedLine">43      $this-&gt;assertArrayHasKey('description', $body);</div><div class="FixedLine">44      $this-&gt;assertArrayHasKey('author', $body);</div><div class="FixedLine">45</div><div class="FixedLine">46      $this-&gt;assertEquals(["The title field is required."], $body['title']);</div><div class="FixedLine">47      $this-&gt;assertEquals(["The description field is required."], $body['description']);</div><div class="FixedLine">48      $this-&gt;assertEquals(["The author field is required."], $body['author']);</div><div class="FixedLine">49 }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-7.</span><div class="SimplePara">Writing the Validation Test for the BooksController@update Method</div></div></div></div>
          </div><div id="Par22" class="Para">This test creates a valid record in the database and attempts a <span class="EmphasisFontCategoryNonProportional">PUT</span> request with no data. Running the tests will give an error similar to the first validation test (Listing <span class="InternalRef"><a href="#Par23">8-8</a></span>).</div><div id="Par23" class="Para">
            <div class="ProgramCode" id="PC8"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerValidationTest::it_validates_valida\</div><div class="FixedLine">tes_passed_fields_when_updating_a_book</div><div class="FixedLine">Failed asserting that 200 matches expected 422.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/BooksControllerValidationTest.php:38</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 23, Assertions: 114, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-8.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par24" class="Para">The <span class="EmphasisFontCategoryNonProportional">BooksController@update</span> implementation is identical to the <span class="EmphasisFontCategoryNonProportional">BooksController@create</span> method (Listing <span class="InternalRef"><a href="#Par25">8-9</a></span>).</div><div id="Par25" class="Para">
            <div class="ProgramCode" id="PC9"><div class="FixedLine">57  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">58   <span class="EmphasisTypeItalic">* PUT /books/{id}</span>
          </div><div class="FixedLine">59   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">60   <span class="EmphasisTypeItalic">* @param Request $request</span>
          </div><div class="FixedLine">61   <span class="EmphasisTypeItalic">* @param $id</span>
          </div><div class="FixedLine">62   <span class="EmphasisTypeItalic">* @return mixed</span>
          </div><div class="FixedLine">63   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">64  <span class="EmphasisTypeBold">public function</span> update(Request $request, $id)</div><div class="FixedLine">65  {</div><div class="FixedLine">66      <span class="EmphasisTypeBold">try</span> {</div><div class="FixedLine">67          $book = Book::findOrFail($id);</div><div class="FixedLine">68      } <span class="EmphasisTypeBold">catch</span> (ModelNotFoundException $e) {</div><div class="FixedLine">69          <span class="EmphasisTypeBold">return</span> response()-&gt;json([</div><div class="FixedLine">70              'error' =&gt; [</div><div class="FixedLine">71                  'message' =&gt; 'Book not found'</div><div class="FixedLine">72              ]</div><div class="FixedLine">73          ], 404);</div><div class="FixedLine">74      }</div><div class="FixedLine">75</div><div class="FixedLine">76      $this-&gt;validate($request, [</div><div class="FixedLine">77          'title' =&gt; 'required',</div><div class="FixedLine">78          'description' =&gt; 'required',</div><div class="FixedLine">79          'author' =&gt; 'required'</div><div class="FixedLine">80      ]);</div><div class="FixedLine">81</div><div class="FixedLine">82      $book-&gt;fill($request-&gt;all());</div><div class="FixedLine">83      $book-&gt;save();</div><div class="FixedLine">84</div><div class="FixedLine">85      <span class="EmphasisTypeBold">return</span> $this-&gt;item($book, <span class="EmphasisTypeBold">new</span> BookTransformer());</div><div class="FixedLine">86  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-9.</span><div class="SimplePara">Implementing Validation in the BooksController@update Method</div></div></div></div>
          </div><div id="Par26" class="Para">Next, you should run your test to see if you are back to green again (Listing <span class="InternalRef"><a href="#Par27">8-10</a></span>).</div><div id="Par27" class="Para">
            <div class="ProgramCode" id="PC10"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (23 tests, 120 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-10.</span><div class="SimplePara">Running the BooksController@update Validation Test</div></div></div></div>
          </div><div id="Par28" class="Para">With passing tests you’ve provided basic validation for books. Your validation code is ready to be expanded to include more rules and tests to ensure your validation continues to work as expected.</div></div><div id="Sec2" class="Section1 RenderAsSection1"><h2 class="Heading">More Validation Constraints</h2><div id="Par29" class="Para">The second validation rule is limiting the length of the book title. The database is constrained to <span class="EmphasisFontCategoryNonProportional">255</span> characters so you will write your application to match. You will test a few scenarios, including “just long enough” and “just too long.” Add the tests in Listing <span class="InternalRef"><a href="#Par30">8-11</a></span> to the <span class="EmphasisFontCategoryNonProportional">BooksControllerValidationTest</span> file.</div><div id="Par30" class="Para">
            <div class="ProgramCode" id="PC11"><div class="FixedLine">51  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">52  <span class="EmphasisTypeBold">public function</span> title_fails_create_validation_when_just_too_long()</div><div class="FixedLine">53  {</div><div class="FixedLine">54  <span class="EmphasisTypeItalic">// Creating a book</span>
          </div><div class="FixedLine">55  $book = factory(\App\Book::class)-&gt;make();</div><div class="FixedLine">56  $book-&gt;title = str_repeat('a', 256);</div><div class="FixedLine">57</div><div class="FixedLine">58  $this-&gt;post("/books", [</div><div class="FixedLine">59      'title' =&gt; $book-&gt;title,</div><div class="FixedLine">60      'description' =&gt; $book-&gt;description,</div><div class="FixedLine">61      'author' =&gt; $book-&gt;author,</div><div class="FixedLine">62  ], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">63</div><div class="FixedLine">64  $this</div><div class="FixedLine">65      -&gt;seeStatusCode(Response::HTTP_UNPROCESSABLE_ENTITY)</div><div class="FixedLine">66      -&gt;seeJson([</div><div class="FixedLine">67          'title' =&gt; ["The title may not be greater than 255 characters."]</div><div class="FixedLine">68      ])</div><div class="FixedLine">69      -&gt;notSeeInDatabase('books', ['title' =&gt; $book-&gt;title]);</div><div class="FixedLine">70  }</div><div class="FixedLine">71</div><div class="FixedLine">72  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">73  <span class="EmphasisTypeBold">public function</span> title_fails_update_validation_when_just_too_long()</div><div class="FixedLine">74  {</div><div class="FixedLine">75  <span class="EmphasisTypeItalic">// Updating a book</span>
          </div><div class="FixedLine">76  $book = factory(\App\Book::class)-&gt;create();</div><div class="FixedLine">77  $book-&gt;title = str_repeat('a', 256);</div><div class="FixedLine">78</div><div class="FixedLine">79  $this-&gt;put("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>", [</div><div class="FixedLine">80      'title' =&gt; $book-&gt;title,</div><div class="FixedLine">81      'description' =&gt; $book-&gt;description,</div><div class="FixedLine">82      'author' =&gt; $book-&gt;author</div><div class="FixedLine">83  ], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">84</div><div class="FixedLine">85  $this</div><div class="FixedLine">86      -&gt;seeStatusCode(Response::HTTP_UNPROCESSABLE_ENTITY)</div><div class="FixedLine">87      -&gt;seeJson([</div><div class="FixedLine">88          'title' =&gt; ["The title may not be greater than 255 characters."]</div><div class="FixedLine">89      ])</div><div class="FixedLine">90      -&gt;notSeeInDatabase('books', ['title' =&gt; $book-&gt;title]);</div><div class="FixedLine">91  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-11.</span><div class="SimplePara">Testing the “Title Is Too Long” Scenario</div></div></div></div>
          </div><div id="Par31" class="Para">In the first test, the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">factory(\App\Book::class)-&gt;make()</span></span> method was introduced. When you call <span class="EmphasisFontCategoryNonProportional">-&gt;make()</span> from the factory instead of <span class="EmphasisFontCategoryNonProportional">-&gt;create()</span> it gives you an unsaved model that is not persisted in the database. Both tests make the title just too long to pass validation in order to test the threshold of failure. The error message is asserted and you also assert that a record with the invalid title is not in the database.</div><div id="Par32" class="Para">You need to wire up the controller changes to match these tests (Listing <span class="InternalRef"><a href="#Par33">8-12</a></span> and Listing <span class="InternalRef"><a href="#Par34">8-13</a></span>). At this point you should run tests, which will fail because the validation will still pass.</div><div id="Par33" class="Para">
            <div class="ProgramCode" id="PC12"><div class="FixedLine">43  $this-&gt;validate($request, [</div><div class="FixedLine">44      <span class="EmphasisTypeBold">'title' =&gt; 'required|max:255'</span>,</div><div class="FixedLine">45      'description' =&gt; 'required',</div><div class="FixedLine">46      'author' =&gt; 'required'</div><div class="FixedLine">47  ]);</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-12.</span><div class="SimplePara">Adding Max Validation to BooksController@create</div></div></div></div>
          </div><div id="Par34" class="Para">
            <div class="ProgramCode" id="PC13"><div class="FixedLine">76  $this-&gt;validate($request, [</div><div class="FixedLine">77      <span class="EmphasisTypeBold">'title' =&gt; 'required|max:255'</span>,</div><div class="FixedLine">78      'description' =&gt; 'required',</div><div class="FixedLine">79      'author' =&gt; 'required'</div><div class="FixedLine">80  ]);</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-13.</span><div class="SimplePara">Adding Max Validation to BooksController@update</div></div></div></div>
          </div><div id="Par35" class="Para">Validation rules are separated by the pipe <span class="EmphasisFontCategoryNonProportional">|</span> character, thus, title is <span class="EmphasisFontCategoryNonProportional">required</span> and <span class="EmphasisFontCategoryNonProportional">max:255</span> length. Now see if your new validation rules pass (Listing <span class="InternalRef"><a href="#Par36">8-14</a></span>).</div><div id="Par36" class="Para">
            <div class="ProgramCode" id="PC14"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (25 tests, 126 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-14.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par37" class="Para">The next two tests, shown in Listing <span class="InternalRef"><a href="#Par38">8-15</a></span>, will assert that validation passes when you have exactly <span class="EmphasisFontCategoryNonProportional">255</span> characters.</div><div id="Par38" class="Para">
            <div class="ProgramCode" id="PC15"><div class="FixedLine"> 93  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine"> 94  <span class="EmphasisTypeBold">public function</span> title_passes_create_validation_when_exactly_max()</div><div class="FixedLine"> 95  {</div><div class="FixedLine"> 96      <span class="EmphasisTypeItalic">// Creating a new Book</span>
          </div><div class="FixedLine"> 97      $book = factory(\App\Book::class)-&gt;make();</div><div class="FixedLine"> 98      $book-&gt;title = str_repeat('a', 255);</div><div class="FixedLine"> 99</div><div class="FixedLine">100      $this-&gt;post("/books", [</div><div class="FixedLine">101          'title' =&gt; $book-&gt;title,</div><div class="FixedLine">102          'description' =&gt; $book-&gt;description,</div><div class="FixedLine">103          'author' =&gt; $book-&gt;author,</div><div class="FixedLine">104      ], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">105</div><div class="FixedLine">106      $this</div><div class="FixedLine">107          -&gt;seeStatusCode(Response::HTTP_CREATED)</div><div class="FixedLine">108          -&gt;seeInDatabase('books', ['title' =&gt; $book-&gt;title]);</div><div class="FixedLine">109  }</div><div class="FixedLine">110</div><div class="FixedLine">111  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">112  <span class="EmphasisTypeBold">public function</span> title_passes_update_validation_when_exactly_max()</div><div class="FixedLine">113  {</div><div class="FixedLine">114      <span class="EmphasisTypeItalic">// Updating a book</span>
          </div><div class="FixedLine">115      $book = factory(\App\Book::class)-&gt;create();</div><div class="FixedLine">116      $book-&gt;title = str_repeat('a', 255);</div><div class="FixedLine">117</div><div class="FixedLine">118      $this-&gt;put("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>", [</div><div class="FixedLine">119          'title' =&gt; $book-&gt;title,</div><div class="FixedLine">120          'description' =&gt; $book-&gt;description,</div><div class="FixedLine">121          'author' =&gt; $book-&gt;author</div><div class="FixedLine">122      ], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">123</div><div class="FixedLine">124      $this</div><div class="FixedLine">125          -&gt;seeStatusCode(Response::HTTP_OK)</div><div class="FixedLine">126          -&gt;seeInDatabase('books', ['title' =&gt; $book-&gt;title]);</div><div class="FixedLine">127  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-15.</span><div class="SimplePara">Testing That Validation Passes with a Title of Exactly 255 Characters</div></div></div></div>
          </div><div id="Par39" class="Para">The <span class="EmphasisFontCategoryNonProportional">BooksControllerTest</span> class already covers creating a valid book, so you only assert the correct status code, which means validation passed. Last, you check that a new record exists in the database. At this point, your tests should all be passing (Listing <span class="InternalRef"><a href="#Par40">8-16</a></span>), but if the maximum value changes, your tests will fail, indicating business rules around your title length. These tests will guide developers in understanding the business rules around data.</div><div id="Par40" class="Para">
            <div class="ProgramCode" id="PC16"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (27 tests, 130 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-16.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par41" class="Para ParaOneEmphasisChild">You now have additional <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">max:255</span></span> validation for the title that’s working. As you can see, validation is really easy in Lumen, but it can also handle more complex rules. Your data is not complicated at the moment so a few built-in validation rules will suffice.</div></div><div id="Sec3" class="Section1 RenderAsSection1"><h2 class="Heading">Custom Validation Messages</h2><div id="Par42" class="Para">Lumen has good validation messages out of the box, but I will show you how you can customize them if needed. You will use the description field as an example.</div><div id="Par43" class="Para">The first thing to do is update your tests to match the new error message you want to use. The validation test for <span class="EmphasisFontCategoryNonProportional">BooksController@create</span> should look Listing <span class="InternalRef"><a href="#Par44">8-17</a></span> and Listing <span class="InternalRef"><a href="#Par45">8-18</a></span> now.</div><div id="Par44" class="Para">
            <div class="ProgramCode" id="PC17"><div class="FixedLine">13  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">14  <span class="EmphasisTypeBold">public function</span> it_validates_required_fields_when_creating_a_new_book()</div><div class="FixedLine">15  {</div><div class="FixedLine">16      $this-&gt;post('/books', [], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">17</div><div class="FixedLine">18      $this-&gt;assertEquals(Response::HTTP_UNPROCESSABLE_ENTITY, $this-&gt;response-&gt;getStatusCode());</div><div class="FixedLine">19</div><div class="FixedLine">20      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">21</div><div class="FixedLine">22      $this-&gt;assertArrayHasKey('title', $body);</div><div class="FixedLine">23      $this-&gt;assertArrayHasKey('description', $body);</div><div class="FixedLine">24      $this-&gt;assertArrayHasKey('author', $body);</div><div class="FixedLine">25</div><div class="FixedLine">26      $this-&gt;assertEquals(["The title field is required."], $body['title']);</div><div class="FixedLine">27      $this-&gt;assertEquals(</div><div class="FixedLine">28          ["Please provide a description."],</div><div class="FixedLine">29          $body['description']</div><div class="FixedLine">30      );</div><div class="FixedLine">31      $this-&gt;assertEquals(["The author field is required."], $body['author']);</div><div class="FixedLine">32  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-17.</span><div class="SimplePara">Test for Custom Description Validation Message for BooksController@create</div></div></div></div>
          </div><div id="Par45" class="Para">
            <div class="ProgramCode" id="PC18"><div class="FixedLine">34  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">35  <span class="EmphasisTypeBold">public function</span> it_validates_validates_passed_fields_when_updating_a_book()</div><div class="FixedLine">36  {</div><div class="FixedLine">37      $book = factory(\App\Book::class)-&gt;create();</div><div class="FixedLine">38</div><div class="FixedLine">39      $this-&gt;put("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>", [], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">40</div><div class="FixedLine">41      $this-&gt;assertEquals(Response::HTTP_UNPROCESSABLE_ENTITY, $this-&gt;response-&gt;getStatusCode());</div><div class="FixedLine">42</div><div class="FixedLine">43      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">44</div><div class="FixedLine">45      $this-&gt;assertArrayHasKey('title', $body);</div><div class="FixedLine">46      $this-&gt;assertArrayHasKey('description', $body);</div><div class="FixedLine">47      $this-&gt;assertArrayHasKey('author', $body);</div><div class="FixedLine">48</div><div class="FixedLine">49      $this-&gt;assertEquals(["The title field is required."], $body['title']);</div><div class="FixedLine">50      $this-&gt;assertEquals(</div><div class="FixedLine">51          ["Please provide a description."],</div><div class="FixedLine">52          $body['description']</div><div class="FixedLine">53      );</div><div class="FixedLine">54      $this-&gt;assertEquals(["The author field is required."], $body['author']);</div><div class="FixedLine">55  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-18.</span><div class="SimplePara">Test for Custom Description Validation Message for BooksController@update</div></div></div></div>
          </div><div id="Par46" class="Para">The only thing you needed to change was the custom error message for the description field, but the entire test cases are provided for clarity.</div><div id="Par47" class="Para">At this point, the tests are failing, and you are ready to implement your custom message. The <span class="EmphasisFontCategoryNonProportional">Controller::validate()</span> method accepts an optional third argument, which is an associative array of custom validation messages. You can define them with the pattern <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">'attribute.&lt;rule&gt;' =&gt; &lt;message&gt;</span></span> to override a specific field (Listing <span class="InternalRef"><a href="#Par48">8-19</a></span> and Listing <span class="InternalRef"><a href="#Par49">8-20</a></span>).</div><div id="Par48" class="Para">
            <div class="ProgramCode" id="PC19"><div class="FixedLine">43  $this-&gt;validate($request, [</div><div class="FixedLine">44      'title' =&gt; 'required|max:255',</div><div class="FixedLine">45      'description' =&gt; 'required',</div><div class="FixedLine">46      'author' =&gt; 'required'</div><div class="FixedLine">47  ], [</div><div class="FixedLine">48      'description.required' =&gt; 'Please provide a :attribute.'</div><div class="FixedLine">49  ]);</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-19.</span><div class="SimplePara">Adding the Custom Validation Method for the Description</div></div></div></div>
          </div><div id="Par49" class="Para">
            <div class="ProgramCode" id="PC20"><div class="FixedLine">78  $this-&gt;validate($request, [</div><div class="FixedLine">79      'title' =&gt; 'required|max:255',</div><div class="FixedLine">80      'description' =&gt; 'required',</div><div class="FixedLine">81      'author' =&gt; 'required'</div><div class="FixedLine">82  ], [</div><div class="FixedLine">83      'description.required' =&gt; 'Please provide a :attribute.'</div><div class="FixedLine">84  ]);</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-20.</span><div class="SimplePara">Adding the Custom Description Message for BooksController@update</div></div></div></div>
          </div><div id="Par50" class="Para">You added a custom message for the description’s <span class="EmphasisFontCategoryNonProportional">required</span> validation rule. The validator understands certain placeholders like <span class="EmphasisFontCategoryNonProportional">:attribute,</span> which will be resolved to the word “description”. If you were to pass <span class="EmphasisFontCategoryNonProportional">'required' =&gt; 'Please fill out the :attribute.'</span> the custom message would apply to all fields being validated with the required rule.</div><div id="Par51" class="Para">It’s time to run your test suite one last time and see if the new custom message worked (Listing <span class="InternalRef"><a href="#Par52">8-21</a></span>).</div><div id="Par52" class="Para">
            <div class="ProgramCode" id="PC21"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (27 tests, 130 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 8-21.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div></div><div id="Sec4" class="Section1 RenderAsSection1"><h2 class="Heading">Other Approaches</h2><div id="Par53" class="Para">Admittedly, this validation chapter is barebones, and you might be scratching your head wondering if validation logic even belongs in the controller. Shouldn’t the model be responsible for validating data? Not surprisingly, there are differing opinions about where validation should be covered: in the controller or the model within Model-View-Controller (MVC).</div><div id="Par54" class="Para">I try to take a pragmatic approach. In your API thus far, is validation making your controller too complex? Nope. Is the controller processing user input from a request? Yes. The controller is a fine place for validation logic, in my opinion. The key is to keep your code simple; you can always refactor later.</div><div id="Par55" class="Para">That being said, I will touch briefly on another technique used in Laravel (and thus Lumen): validation in models. For example, Dayle Rees wrote about one approach to move validation into models (<span class="ExternalRef"><a href="https://daylerees.com/trick-validation-within-models/"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://daylerees.com/trick-validation-within-models/</span>
              </span></a></span>). Other notable frameworks (such as Rails) also integrate validation rules in the model layer.</div><div id="Par56" class="Para">In your case, you also <span class="EmphasisTypeItalic">have</span> duplicated logic by validating in controller methods. Isn’t that bad? In my opinion, it <span class="EmphasisTypeItalic">can</span> be, but at this point in your API, I would argue that creating a base model and moving validation logic into your Book model would be a premature optimization and more complex than your simple validation rules. Plus, you have validation tests for both endpoints. I encourage you to solve this problem however you feel fits your style; just try to avoid premature optimization and doing it for the sake of doing it. Lumen is flexible enough to allow you to come up with your own approach.</div></div><div id="Sec5" class="Section1 RenderAsSection1"><h2 class="Heading">Conclusion</h2><div id="Par57" class="Para">You breezed through adding basic API validation. At this point, I encourage you to read through the validation documentation (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/validation"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/validation</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> to become more familiar with the available built-in validation rules and making your own custom rules. You should have a good foundation for writing validation rules and tests to ensure your APIs respond to invalid data in a useful way. Validation not only helps keep bad data out of the database, it provides API consumers helpful information when bad data is submitted to the application.</div><div id="Par58" class="Para ParaTypeImportant">
        <img src="A395120_1_En_8_Figa_HTML.jpg" alt="A395120_1_En_8_Figa_HTML.jpg"/> Git commit: Add Book API Validation</div><div id="Par59" class="Para ParaTypeImportant">d4144f0 (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/d4144f0"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/d4144f0</span>
              </span></a></span>)</div></div></div></body></html>
