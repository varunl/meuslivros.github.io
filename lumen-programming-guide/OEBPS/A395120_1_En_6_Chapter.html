<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>Responding to Errors</title><link href="springer_epub.css" type="text/css" rel="styleSheet"/></head><body><div class="ChapterContextInformation"><div class="ContextInformation" id="b978-1-4842-2187-7_6"><div class="ChapterCopyright">© Paul Redmond 2016</div><span class="ContextInformationAuthorEditorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span></span></span><span class="ContextInformationBookTitles"><span class="BookTitle" xml:lang="en">Lumen Programming Guide</span></span><span class="ChapterDOI">10.1007/978-1-4842-2187-7_6</span></div></div><!--Begin Abstract--><div class="MainTitleSection"><h1 class="ChapterTitle" xml:lang="en">6. Responding to Errors</h1></div><div class="AuthorGroup"><div class="AuthorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span><sup>1 <span class="ContactIcon"/></sup></span></div><div class="Affiliations"><div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">Phoenix, Arizona, USA</div></div><div class="ClearBoth"> </div></div></div><!--End Abstract--><div class="Fulltext"><div id="Par1" class="Para">During your work on the Book API in Chapter <span class="ExternalRef"><a href="A395120_1_En_5_Chapter.html"><span class="RefSource">5</span></a></span> it became evident that you need to start using a separate test database. You also don’t have very good error responses for API consumers yet. Responding to a client with an HTML error that expects JSON is not going to cut it anymore. When an API consumer interacts with your API, you want to respond with the correct <span class="EmphasisFontCategoryNonProportional">Content-Type</span> header. For now, you will assume all of your consumers want JSON, and in my experience, JSON is typically what consumers want.</div><div id="Sec1" class="Section1 RenderAsSection1"><h2 class="Heading">Test Database</h2><div id="Par2" class="Para">The main focus of this chapter will be error responses, but before you work on error responses you will side-step and fix your glaring database testing issue. Lumen provides convenient and clever tools out of the box to support creating test data, such as
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par3" class="Para">Model factories</div></li><li><div id="Par4" class="Para">DatabaseMigrations trait</div></li><li><div id="Par5" class="Para">
              <span class="ExternalRef"><a href="https://github.com/fzaninotto/Faker"><span class="RefSource">Faker</span></a></span> data generator (<span class="ExternalRef"><a href="https://github.com/fzaninotto/Faker"><span class="RefSource">
                      <span class="EmphasisFontCategoryNonProportional">https://github.com/fzaninotto/Faker</span>
                    </span></a></span>
              <span class="EmphasisFontCategoryNonProportional">)</span>
            </div></li></ul></div>
      </div><div id="Par6" class="Para">The basic steps needed to start using the test database include
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par7" class="Para">Configuring PHPUnit to use the test database</div></li><li><div id="Par8" class="Para ParaOneEmphasisChild">Creating a model factory definition for the <span class="EmphasisFontCategoryNonProportional">Book</span> model</div></li><li><div id="Par9" class="Para">Modifying existing tests to use factory test data</div></li></ul></div>
      </div><div id="Par10" class="Para">Back in Chapter <span class="ExternalRef"><a href="A395120_1_En_3_Chapter.html"><span class="RefSource">3</span></a></span> you set up the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">bookr_testing</span></span> database during your project setup in the <span class="EmphasisFontCategoryNonProportional">Homestead.yaml</span> file. If you don’t have that database yet, you need to configure it now and rerun the <span class="EmphasisFontCategoryNonProportional">vagrant provision</span>.</div><div id="Par11" class="Para">If you recall your project environment setup, the MySQL database is configured using <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">phpdotenv</span></span>. You take advantage of that to set the test database used within PHPUnit. Open the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">phpunit.xml</span></span> file in the root of the project and you will see opening and closing <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">&lt;php&gt;&lt;/php&gt;</span></span> tags that contain environment variables; you need to add the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">DB_DATABASE</span></span> variable (Listing <span class="InternalRef"><a href="#Par12">6-1</a></span>).</div><div id="Par12" class="Para">
            <div class="ProgramCode" id="PC1"><div class="FixedLine">22  &lt;php&gt;</div><div class="FixedLine">23      &lt;env name="APP_ENV" value="testing"/&gt;</div><div class="FixedLine">24      &lt;!-- <span class="EmphasisTypeItalic">Test Database</span> --&gt;</div><div class="FixedLine">25      <span class="EmphasisTypeBold">&lt;env name="DB_DATABASE" value="bookr_testing"/&gt;</span>
          </div><div class="FixedLine">26      &lt;env name="CACHE_DRIVER" value="array"/&gt;</div><div class="FixedLine">27  &lt;/php&gt;</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-1.</span><div class="SimplePara">Configuring PHPUnit to Use the Testing Database</div></div></div></div>
          </div><div id="Par13" class="Para">I won’t show the output if you run <span class="EmphasisFontCategoryNonProportional">phpunit</span> at this point, but you will get exceptions and failures, lots of them. Switching the database to <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">bookr_testing</span></span> means that you don’t have any tables or data yet. You already have migrations, but to get data in your test database you need to configure a model factory and tweak your tests to take advantage of the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">DatabaseMigrations</span></span> trait that Lumen provides.</div><div id="Sec2" class="Section2 RenderAsSection2"><h3 class="Heading">Model Factories</h3><div id="Par14" class="Para">Model factories provide fake test data that can be used to populate the test data before running a test. Factories generate random fake data you can use in a test, making your test data isolated and repeatable. In fact, each test requiring test data starts with a fresh database.</div><div id="Par15" class="Para">You only have one model right now, so you will define a factory you can use in your <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">BooksControllerTest.php</span></span>. All the model factory definitions should be added in the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">database/factories/ModelFactory.php</span></span> file (Listing <span class="InternalRef"><a href="#Par16">6-2</a></span>).</div><div id="Par16" class="Para">
              <div class="ProgramCode" id="PC2"><div class="FixedLine">21  $factory-&gt;define(App\Book::class, <span class="EmphasisTypeBold">function</span> ($faker) {</div><div class="FixedLine">22      $title = $faker-&gt;sentence(rand(3, 10));</div><div class="FixedLine">23</div><div class="FixedLine">24      <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">25          'title' =&gt; substr($title, 0, strlen($title) - 1),</div><div class="FixedLine">26          'description' =&gt; $faker-&gt;text,</div><div class="FixedLine">27          'author' =&gt; $faker-&gt;name</div><div class="FixedLine">28      ];</div><div class="FixedLine">29  });</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-2.</span><div class="SimplePara">Adding the Book Model Factory</div></div></div></div>
            </div><div id="Par17" class="Para">You define a Book factory with the first argument, <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">App\Book::class</span></span>, which references the model. The second argument in the factory definition is a <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Closure</span></span>, which does the following:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par18" class="Para">Uses Faker (<span class="ExternalRef"><a href="https://github.com/fzaninotto/Faker"><span class="RefSource">
                        <span class="EmphasisFontCategoryNonProportional">https://github.com/fzaninotto/Faker</span>
                      </span></a></span>
                <span class="EmphasisFontCategoryNonProportional">)</span> to generate a random sentence between 3 and 10 words long</div></li><li><div id="Par19" class="Para">Returns an array of fake data using Faker’s various “formatters”</div></li><li><div id="Par20" class="Para ParaOneEmphasisChild">Removes the period (.) from the sentence formatter with <span class="EmphasisFontCategoryNonProportional">substr</span>
              </div></li></ul></div>
        </div></div><div id="Sec3" class="Section2 RenderAsSection2"><h3 class="Heading">Factories in Tests</h3><div id="Par21" class="Para ParaOneEmphasisChild">Now that you’ve defined a book factory (pun intended), you are ready to use it in your test to provide random fake test data. You will update all your existing tests that currently depend on your seeded data to start using the new factory. The only test file you have at this point is <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">tests/app/Http/Controllers/BooksControllerTest.php</span></span>, so open it up in your favorite editor.</div><div id="Par22" class="Para">The first test is <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">index_should_return_a_collection_of_records</span></span>, which ensures that the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">BooksController@index</span></span> method returns a collection of books (Listing <span class="InternalRef"><a href="#Par23">6-3</a></span>).</div><div id="Par23" class="Para">
              <div class="ProgramCode" id="PC3"><div class="FixedLine">15  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">16  <span class="EmphasisTypeBold">public function</span> index_should_return_a_collection_of_records()</div><div class="FixedLine">17  {</div><div class="FixedLine">18      $books = factory('App\Book', 2)-&gt;create();</div><div class="FixedLine">19</div><div class="FixedLine">20      $this-&gt;get('/books');</div><div class="FixedLine">21</div><div class="FixedLine">22      <span class="EmphasisTypeBold">foreach</span> ($books <span class="EmphasisTypeBold">as</span> $book) {</div><div class="FixedLine">23          $this-&gt;seeJson(['title' =&gt; $book-&gt;title]);</div><div class="FixedLine">24      }</div><div class="FixedLine">25  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-3.</span><div class="SimplePara">Refactoring the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">index_should_return_a_collection_of_records</span></span> Test</div></div></div></div>
            </div><div id="Par24" class="Para">The last code snippet is the first example of using the <span class="EmphasisFontCategoryNonProportional">factory()</span> helper function. You indicate that you want to use the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">App\Book</span></span> factory, and that you want it to generate two book models. The second argument is optional, and if you omit it you will get one record back.</div><div id="Par25" class="Para">The <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">factory()</span></span> helper returns an instance of <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Illuminate\Database\Eloquent\FactoryBuilder</span></span>, which has the methods <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">make()</span></span> and <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">create()</span></span>. You want to persist data to the database so you use <span class="EmphasisFontCategoryNonProportional">create()</span>; the <span class="EmphasisFontCategoryNonProportional">make()</span> method will return a model without saving it to the database.</div><div id="Par26" class="Para">The <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">factory()-&gt;create()</span></span> call returns the model instances and you loop over them to make sure each model is represented in the <span class="EmphasisFontCategoryNonProportional">/books</span> response.</div><div id="Par27" class="Para">Now that you’ve see the first example of using a factory, you need a way to migrate and reset your database before each test requiring the database. Enter the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">DatabaseMigrations</span></span> trait provided by the Lumen framework (Listing <span class="InternalRef"><a href="#Par28">6-4</a></span>).</div><div id="Par28" class="Para">
              <div class="ProgramCode" id="PC4"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use Laravel\Lumen\Testing\DatabaseMigrations;</span>
            </div><div class="FixedLine"> 7</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">class BooksControllerTest extends</span> TestCase</div><div class="FixedLine"> 9  {</div><div class="FixedLine">10      <span class="EmphasisTypeBold">use</span> DatabaseMigrations;</div><div class="FixedLine">11      <span class="EmphasisTypeItalic">// ...</span>
            </div><div class="FixedLine">12  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-4.</span><div class="SimplePara">Adding the DatabaseMigrations Trait</div></div></div></div>
            </div><div id="Par29" class="Para">The <span class="EmphasisFontCategoryNonProportional">DatabaseMigrations</span> trait uses a <span class="EmphasisFontCategoryNonProportional">@before</span> PHPUnit annotation to migrate the database automatically.</div><div id="Par30" class="Para ParaTypeImportant">
          <img src="A395120_1_En_6_Figa_HTML.jpg" alt="A395120_1_En_6_Figa_HTML.jpg"/> Learn More About Model Factories</div><div id="Par31" class="Para ParaTypeImportant">See the “Model Factories” (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/testing#model-factories"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/testing#model-factories</span>
                </span></a></span>) section of the official documentation for information on how to use model factories.</div><div id="Par32" class="Para">It is time to run <span class="EmphasisFontCategoryNonProportional">phpunit</span> against your first test refactor (Listing <span class="InternalRef"><a href="#Par33">6-5</a></span>).</div><div id="Par33" class="Para">
              <div class="ProgramCode" id="PC5"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=index_should_return_a_collection_of_records</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 2 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-5.</span><div class="SimplePara">Testing the First Test Refactor</div></div></div></div>
            </div><div id="Par34" class="Para">Now that you have a working test with the Book model factory, you can knock out the remaining test cases that need model data. You will cheat a little and fix the remaining tests before you run the whole test suite again.</div><div id="Par35" class="Para">Next up is the <span class="EmphasisFontCategoryNonProportional">GET /book/{id}</span> route test, shown in Listing <span class="InternalRef"><a href="#Par36">6-6</a></span>.</div><div id="Par36" class="Para">
              <div class="ProgramCode" id="PC6"><div class="FixedLine">31  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">32  <span class="EmphasisTypeBold">public function</span> show_should_return_a_valid_book()</div><div class="FixedLine">33  {</div><div class="FixedLine">34      $book = factory('App\Book')-&gt;create();</div><div class="FixedLine">35      $this</div><div class="FixedLine">36          -&gt;get("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>")</div><div class="FixedLine">37          -&gt;seeStatusCode(200)</div><div class="FixedLine">38          -&gt;seeJson([</div><div class="FixedLine">39              'id' =&gt; $book-&gt;id,</div><div class="FixedLine">40              'title' =&gt; $book-&gt;title,</div><div class="FixedLine">41              'description' =&gt; $book-&gt;description,</div><div class="FixedLine">42              'author' =&gt; $book-&gt;author</div><div class="FixedLine">43          ]);</div><div class="FixedLine">44</div><div class="FixedLine">45      $data = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">46      $this-&gt;assertArrayHasKey('created_at', $data);</div><div class="FixedLine">47      $this-&gt;assertArrayHasKey('updated_at', $data);</div><div class="FixedLine">48  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-6.</span><div class="SimplePara">Refactoring <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">show_should_return_a_valid_book</span></span> to Use Factories</div></div></div></div>
            </div><div id="Par37" class="Para">Note that you use the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">$book-&gt;id</span></span> to build the request URI and then assert the response from the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">$book</span></span> instance. The remainder of the test stays the same.</div><div id="Par38" class="Para">Next up is using a model factory to test that only fillable fields can be updated (Listing <span class="InternalRef"><a href="#Par39">6-7</a></span>).</div><div id="Par39" class="Para">
              <div class="ProgramCode" id="PC7"><div class="FixedLine">104  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">105  <span class="EmphasisTypeBold">public function</span> update_should_only_change_fillable_fields()</div><div class="FixedLine">106  {</div><div class="FixedLine">107      $book = factory('App\Book')-&gt;create([</div><div class="FixedLine">108          'title' =&gt; 'War of the Worlds',</div><div class="FixedLine">109          'description' =&gt; 'A science fiction masterpiece about Martians invading London',</div><div class="FixedLine">110          'author' =&gt; 'H. G. Wells',</div><div class="FixedLine">111      ]);</div><div class="FixedLine">112</div><div class="FixedLine">113      $this-&gt;put("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>", [</div><div class="FixedLine">114          'id' =&gt; 5,</div><div class="FixedLine">115          'title' =&gt; 'The War of the Worlds',</div><div class="FixedLine">116          'description' =&gt; 'The book is way better than the movie.',</div><div class="FixedLine">117          'author' =&gt; 'Wells, H. G.'</div><div class="FixedLine">118      ]);</div><div class="FixedLine">119</div><div class="FixedLine">120      $this</div><div class="FixedLine">121          -&gt;seeStatusCode(200)</div><div class="FixedLine">122          -&gt;seeJson([</div><div class="FixedLine">123              'id' =&gt; 1,</div><div class="FixedLine">124              'title' =&gt; 'The War of the Worlds',</div><div class="FixedLine">125              'description' =&gt; 'The book is way better than the movie.',</div><div class="FixedLine">126              'author' =&gt; 'Wells, H. G.'</div><div class="FixedLine">127          ])</div><div class="FixedLine">128          -&gt;seeInDatabase('books', [</div><div class="FixedLine">129              'title' =&gt; 'The War of the Worlds'</div><div class="FixedLine">130          ]);</div><div class="FixedLine">131  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-7.</span><div class="SimplePara">Refactoring <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">update_should_only_change_fillable_fields</span></span> to Use Model Factories</div></div></div></div>
            </div><div id="Par40" class="Para">The test is the first example of passing an array to the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">factory()-&gt;create()</span></span> to override model values. You are not required to pass specific data to get this test passing, but I think it makes the test more readable. When you pass an array to <span class="EmphasisFontCategoryNonProportional">factory()-&gt;create()</span> (and make) the values override the generated values produced by the Faker library. Note that you removed the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">notSeeInDatabase()</span></span> assertion at the beginning because each test has a clean database, making the test unnecessary.</div><div id="Par41" class="Para">The next test to be refactored with a model factory is the one that ensures that a book can be deleted (Listing <span class="InternalRef"><a href="#Par42">6-8</a></span>).</div><div id="Par42" class="Para">
              <div class="ProgramCode" id="PC8"><div class="FixedLine">153  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">154  <span class="EmphasisTypeBold">public function</span> destroy_should_remove_a_valid_book()</div><div class="FixedLine">155  {</div><div class="FixedLine">156      $book = factory('App\Book')-&gt;create();</div><div class="FixedLine">157      $this</div><div class="FixedLine">158          -&gt;delete("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>")</div><div class="FixedLine">159         -&gt;seeStatusCode(204)</div><div class="FixedLine">160         -&gt;isEmpty();</div><div class="FixedLine">161</div><div class="FixedLine">162      $this-&gt;notSeeInDatabase('books', ['id' =&gt; $book-&gt;id]);</div><div class="FixedLine">163  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-8.</span><div class="SimplePara">Refactoring <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">destroy_should_remove_a_valid_book</span></span> to Use Factories</div></div></div></div>
            </div><div id="Par43" class="Para">Your refactor is done. See if the tests can be passed now (Listing <span class="InternalRef"><a href="#Par44">6-9</a></span>).</div><div id="Par44" class="Para">
              <div class="ProgramCode" id="PC9"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (13 tests, 32 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-9.</span><div class="SimplePara">Test Suite After Model Factory Refactoring</div></div></div></div>
            </div><div id="Par45" class="Para ParaOneEmphasisChild">You can run <span class="EmphasisFontCategoryNonProportional">phpunit</span> multiple times and the tests will pass every time. Yay!</div><div id="Par46" class="Para ParaTypeImportant">
          <img src="A395120_1_En_6_Figb_HTML.jpg" alt="A395120_1_En_6_Figb_HTML.jpg"/> Git commit: Use Model Factories and a Test Database for Tests</div><div id="Par47" class="Para ParaTypeImportant">1c50b61 (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/1c50b61"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/1c50b61</span>
                </span></a></span>)</div></div></div><div id="Sec4" class="Section1 RenderAsSection1"><h2 class="Heading">Better Error Responses</h2><div id="Par48" class="Para ParaOneEmphasisChild">You are ready to improve your APIs error responses. Thus far you get back HTML when you have an application exception like a <span class="EmphasisFontCategoryNonProportional">ModelNotFoundException</span>, but an API consumer should get JSON. You could support other content types too, but you will focus on JSON responses for now.</div><div id="Sec5" class="Section2 RenderAsSection2"><h3 class="Heading">Framework Exception Handling</h3><div id="Par49" class="Para">So how does Lumen deal with exceptions out of the box? The Lumen application bootstraps an application instance (<span class="EmphasisFontCategoryNonProportional">Laravel\Lumen\Application</span>) which contains a few key traits: <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Laravel\Lumen\Concerns\RoutesRequests</span></span> and <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Laravel\Lumen\Concerns\RegistersExceptionHandlers</span></span>. You will find the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Application::run()</span></span> method is contained in the <span class="EmphasisFontCategoryNonProportional">RoutesRequests</span> trait (Listing <span class="InternalRef"><a href="#Par50">6-10</a></span>).</div><div id="Par50" class="Para">
              <div class="ProgramCode" id="PC10"><div class="LineGroup"><div class="FixedLine">/**</div><div class="FixedLine"> * Run the application and send the response.</div><div class="FixedLine"> *</div><div class="FixedLine"> * @param  SymfonyRequest|null  $request</div><div class="FixedLine"> * @return void</div><div class="FixedLine"> */</div><div class="FixedLine">public function run($request = null)</div><div class="FixedLine">{</div><div class="FixedLine">    $response = $this-&gt;dispatch($request);</div></div><div class="LineGroup"><div class="FixedLine">    if ($response instanceof SymfonyResponse) {</div><div class="FixedLine">        $response-&gt;send();</div><div class="FixedLine">    } else {</div><div class="FixedLine">        echo (string) $response;</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    if (count($this-&gt;middleware) &gt; 0) {</div><div class="FixedLine">        $this-&gt;callTerminableMiddleware($response);</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-10.</span><div class="SimplePara">The RoutesRequests Trait’s run() Method</div></div></div></div>
            </div><div id="Par51" class="Para">The trait’s <span class="EmphasisFontCategoryNonProportional">run()</span> method is called from the front controller (<span class="EmphasisFontCategoryNonProportional">public/index.php</span>). The first line dispatches the request, expecting a response back. If you view the source for the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">RoutesRequests::dispatch()</span></span> method, you will see a <span class="EmphasisFontCategoryNonProportional">try/catch</span> where exceptions are caught and handled (Listing <span class="InternalRef"><a href="#Par52">6-11</a></span>).</div><div id="Par52" class="Para">
              <div class="ProgramCode" id="PC11"><div class="LineGroup"><div class="FixedLine">try {</div><div class="FixedLine">    return $this-&gt;sendThroughPipeline($this-&gt;middleware, function () use ($method, $pathInfo) {</div><div class="FixedLine">        if (isset($this-&gt;routes[$method.$pathInfo])) {</div><div class="FixedLine">            return $this-&gt;handleFoundRoute([true, $this-&gt;routes[$method.$pathInfo]['action'], []]);</div><div class="FixedLine">        }</div></div><div class="LineGroup"><div class="FixedLine">        return $this-&gt;handleDispatcherResponse(</div><div class="FixedLine">            $this-&gt;createDispatcher()-&gt;dispatch($method, $pathInfo)</div><div class="FixedLine">        );</div><div class="FixedLine">    });</div><div class="FixedLine">} catch (Exception $e) {</div><div class="FixedLine">    return $this-&gt;sendExceptionToHandler($e);</div><div class="FixedLine">} catch (Throwable $e) {</div><div class="FixedLine">    return $this-&gt;sendExceptionToHandler($e);</div><div class="FixedLine">}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-11.</span><div class="SimplePara">Partial Source of Lumen’s Application::dispatch() Method</div></div></div></div>
            </div><div id="Par53" class="Para">Application exceptions are caught and then <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">sendExceptionToHandler()</span></span> is called. The <span class="EmphasisFontCategoryNonProportional">sendExceptionToHandler()</span> appears as shown in Listing <span class="InternalRef"><a href="#Par54">6-12</a></span> (at the time of writing) in the RegistersExceptionHandlers trait.</div><div id="Par54" class="Para">
              <div class="ProgramCode" id="PC12"><div class="LineGroup"><div class="FixedLine">/**</div><div class="FixedLine"> * Send the exception to the handler and return the response.</div><div class="FixedLine"> *</div><div class="FixedLine"> * @param  \Throwable  $e</div><div class="FixedLine"> * @return Response</div><div class="FixedLine"> */</div><div class="FixedLine">protected function sendExceptionToHandler($e)</div><div class="FixedLine">{</div><div class="FixedLine">    $handler = $this-&gt;resolveExceptionHandler();</div></div><div class="LineGroup"><div class="FixedLine">    if ($e instanceof Error) {</div><div class="FixedLine">        $e = new FatalThrowableError($e);</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    $handler-&gt;report($e);</div></div><div class="LineGroup"><div class="FixedLine">    return $handler-&gt;render($this-&gt;make('request'), $e);</div><div class="FixedLine">}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-12.</span><div class="SimplePara">The Application::sendExceptionToHandler() Method</div></div></div></div>
            </div><div id="Par55" class="Para">The exception handler is resolved from the container on the first line, and is an instance of <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">app/Exceptions/Handler.php</span></span>. The handler instance from the container is responsible for rendering the exception. Lumen uses a contract (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/contracts"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/contracts</span>
                </span></a></span>), specifically the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Illuminate\Contracts\Debug\ExceptionHandler</span></span>, to bind the container to the application’s handler. The <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">bootstrap/app.php</span></span> binds the application handler to the <span class="EmphasisFontCategoryNonProportional">ExceptionHandler</span> contract (Listing <span class="InternalRef"><a href="#Par56">6-13</a></span>).</div><div id="Par56" class="Para">
              <div class="ProgramCode" id="PC13"><div class="FixedLine">41  $app-&gt;singleton(</div><div class="FixedLine">42      Illuminate\Contracts\Debug\ExceptionHandler::class,</div><div class="FixedLine">43      App\Exceptions\Handler::class</div><div class="FixedLine">44  );</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-13.</span><div class="SimplePara">The Exception Handler Contract in bootstrap/app.php</div></div></div></div>
            </div><div id="Par57" class="Para">The <span class="EmphasisFontCategoryNonProportional">Application</span> class will resolve the <span class="EmphasisFontCategoryNonProportional">Handler</span> class in <span class="EmphasisFontCategoryNonProportional">app/Exceptions/Handler.php</span>. Listing <span class="InternalRef"><a href="#Par58">6-14</a></span> shows the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Handler::render()</span></span> method.</div><div id="Par58" class="Para">
              <div class="ProgramCode" id="PC14"><div class="FixedLine">39  /<span class="EmphasisTypeItalic">**</span>
            </div><div class="FixedLine">40   <span class="EmphasisTypeItalic">* Render an exception into an HTTP response.</span>
            </div><div class="FixedLine">41   <span class="EmphasisTypeItalic">*</span>
            </div><div class="FixedLine">42   <span class="EmphasisTypeItalic">* @param \Illuminate\Http\Request $request</span>
            </div><div class="FixedLine">43   <span class="EmphasisTypeItalic">* @param \Exception $e</span>
            </div><div class="FixedLine">44   <span class="EmphasisTypeItalic">* @return \Illuminate\Http\Response</span>
            </div><div class="FixedLine">45   <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">46  <span class="EmphasisTypeBold">public function</span> render($request, Exception $e)</div><div class="FixedLine">47  {</div><div class="FixedLine">48      <span class="EmphasisTypeBold">return parent</span>::render($request, $e);</div><div class="FixedLine">49  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-14.</span><div class="SimplePara">The Exception Handler Render Method</div></div></div></div>
            </div><div id="Par59" class="Para">The application handler defers to the parent class to render out the exception. The parent of the application <span class="EmphasisFontCategoryNonProportional">Handler</span> is the Lumen framework Handler, which you can find at <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">vendor/laravel/lumen-framework/src/Exceptions/Handler.php</span></span>. I’ll leave it to you to investigate the source if you want, but basically the default Handler uses the Symfony Debug component (<span class="ExternalRef"><a href="http://symfony.com/doc/current/components/debug.html"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">http://symfony.com/doc/current/components/debug.html</span>
                </span></a></span>
          <span class="EmphasisFontCategoryNonProportional">) ExceptionHandler</span> class to send a response.</div></div><div id="Sec6" class="Section2 RenderAsSection2"><h3 class="Heading">JSON Exceptions</h3><div id="Par60" class="Para">Now that you understand a bit about how Lumen calls the <span class="EmphasisFontCategoryNonProportional">app/Exception/Handler,</span> you are going to update the <span class="EmphasisFontCategoryNonProportional">Handler::render()</span> method to respond with JSON instead of HTML when appropriate (Listing <span class="InternalRef"><a href="#Par61">6-15</a></span>).</div><div id="Par61" class="Para">
              <div class="ProgramCode" id="PC15"><div class="FixedLine">40  <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">41   <span class="EmphasisTypeItalic">* Render an exception into an HTTP response.</span>
            </div><div class="FixedLine">42   <span class="EmphasisTypeItalic">*</span>
            </div><div class="FixedLine">43   <span class="EmphasisTypeItalic">* @param \Illuminate\Http\Request $request</span>
            </div><div class="FixedLine">44   <span class="EmphasisTypeItalic">* @param \Exception $e</span>
            </div><div class="FixedLine">45   <span class="EmphasisTypeItalic">* @return \Illuminate\Http\Response</span>
            </div><div class="FixedLine">46   <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">47  <span class="EmphasisTypeBold">public function</span> render($request, Exception $e)</div><div class="FixedLine">48  {</div><div class="FixedLine">49      <span class="EmphasisTypeBold">if</span> ($request-&gt;wantsJson() &amp;&amp; !($e instanceof ValidationException)) {</div><div class="FixedLine">50          $response = [</div><div class="FixedLine">51              'message' =&gt; (string) $e-&gt;getMessage(),</div><div class="FixedLine">52              'status' =&gt; 400</div><div class="FixedLine">53          ];</div><div class="FixedLine">54</div><div class="FixedLine">55          <span class="EmphasisTypeBold">if</span> ($e instanceof HttpException) {</div><div class="FixedLine">56              $response['message'] = Response::$statusTexts[$e-&gt;getStatusCode()];</div><div class="FixedLine">57              $response['status'] = $e-&gt;getStatusCode();</div><div class="FixedLine">58          }</div><div class="FixedLine">59</div><div class="FixedLine">60          <span class="EmphasisTypeBold">if</span> ($this-&gt;isDebugMode()) {</div><div class="FixedLine">61              $response['debug'] = [</div><div class="FixedLine">62                  'exception' =&gt; get_class($e),</div><div class="FixedLine">63                  'trace' =&gt; $e-&gt;getTrace()</div><div class="FixedLine">64              ];</div><div class="FixedLine">65          }</div><div class="FixedLine">66</div><div class="FixedLine">67          <span class="EmphasisTypeBold">return</span> response()-&gt;json(['error' =&gt; $response], $response['status']);</div><div class="FixedLine">68      }</div><div class="FixedLine">69</div><div class="FixedLine">70      <span class="EmphasisTypeBold">return parent</span>::render($request, $e);</div><div class="FixedLine">71  }</div><div class="FixedLine">72</div><div class="FixedLine">73  <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">74   <span class="EmphasisTypeItalic">* Determine if the application is in debug mode.</span>
            </div><div class="FixedLine">75   <span class="EmphasisTypeItalic">*</span>
            </div><div class="FixedLine">76   <span class="EmphasisTypeItalic">* @return Boolean</span>
            </div><div class="FixedLine">77   <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">78  <span class="EmphasisTypeBold">public function</span> isDebugMode()</div><div class="FixedLine">79  {</div><div class="FixedLine">80      <span class="EmphasisTypeBold">return</span> (Boolean) env('APP_DEBUG');</div><div class="FixedLine">81  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-15.</span><div class="SimplePara">Checking to See if the User Wants a JSON Response</div></div></div></div>
            </div><div id="Par62" class="Para">You need to import <span class="EmphasisFontCategoryNonProportional">Response</span> at the top of your <span class="EmphasisFontCategoryNonProportional">Handler</span> class or you will get a fatal error (Listing <span class="InternalRef"><a href="#Par63">6-16</a></span>).</div><div id="Par63" class="Para">
              <div class="ProgramCode" id="PC16"><div class="LineGroup"><div class="FixedLine">&lt;?php</div></div><div class="LineGroup"><div class="FixedLine">
                <span class="EmphasisTypeBold">namespace</span> App\Exceptions;</div></div><div class="LineGroup"><div class="FixedLine">
                <span class="EmphasisTypeBold">use</span> Exception;</div><div class="FixedLine">
                    <span class="EmphasisTypeBold">use Symfony\Component\HttpFoundation\Response;</span>
                  </div><div class="FixedLine">
                    <span class="EmphasisTypeItalic">// ...</span>
                  </div></div><div class="LineGroup"><div class="FixedLine">
                <span class="EmphasisTypeBold">class Handler extends</span> ExceptionHandler</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-16.</span><div class="SimplePara">Importing the Response Class</div></div></div></div>
            </div><div id="Par64" class="Para">Let’s break down the changes you made to the <span class="EmphasisFontCategoryNonProportional">render</span> method:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par65" class="Para">
                <span class="EmphasisFontCategoryNonProportional">$request-&gt;wantsJson()</span> checks if the user has “json” in the <span class="EmphasisFontCategoryNonProportional">Accept</span> header.</div></li><li><div id="Par66" class="Para ParaOneEmphasisChild">You skip <span class="EmphasisFontCategoryNonProportional">ValidationException</span>, allowing the parent handler to handle validation exceptions.</div></li><li><div id="Par67" class="Para ParaOneEmphasisChild">If the user doesn’t want JSON, skip and call <span class="EmphasisFontCategoryNonProportional">parent::render()</span> like the original method.</div></li><li><div id="Par68" class="Para">If the user wants JSON, you start building the response array, which will be the returned JSON data.</div></li><li><div id="Par69" class="Para ParaOneEmphasisChild">You start out with the default exception message and a status code of <span class="EmphasisFontCategoryNonProportional">400 Bad Request</span> for generic errors.</div></li><li><div id="Par70" class="Para ParaOneEmphasisChild">If the exception is an instance of <span class="EmphasisFontCategoryNonProportional">Symfony\Component\HttpKernel\Exception\HttpException,</span> change the message and status code of the exception (i.e. status=404, message=Not Found).</div></li><li><div id="Par71" class="Para">If debug mode is enabled, add the exception class and the stack trace.</div></li><li><div id="Par72" class="Para">Finally, return a JSON response with the assembled data.</div></li></ul></div>
        </div><div id="Par73" class="Para">Try your new handler logic out in the console with <span class="EmphasisFontCategoryNonProportional">curl</span> (Listing <span class="InternalRef"><a href="#Par74">6-17</a></span>).</div><div id="Par74" class="Para">
              <div class="ProgramCode" id="PC17"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ curl -H"Accept: application/json" http://bookr.app/foo/bar</div></div><div class="LineGroup"><div class="FixedLine">HTTP/1.0 404 Not Found</div><div class="FixedLine">Host: localhost:8000</div><div class="FixedLine">Connection: close</div><div class="FixedLine">X-Powered-By: PHP/5.6.13</div><div class="FixedLine">Cache-Control: no-cache</div><div class="FixedLine">Date: Sun, 25 Oct 2015 06:37:31 GMT</div><div class="FixedLine">Content-Type: application/json</div></div><div class="LineGroup"><div class="FixedLine">{"error":{"message":"Not Found","status":404}}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-17.</span><div class="SimplePara">Exception Response With Debugging Disabled for Brevity</div></div></div></div>
            </div><div id="Par75" class="Para">If you have debugging turned on, your response will have more data. You should check what happens if you don’t send the <span class="EmphasisFontCategoryNonProportional">Accept</span> header (Listing <span class="InternalRef"><a href="#Par76">6-18</a></span>).</div><div id="Par76" class="Para">
              <div class="ProgramCode" id="PC18"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ curl -I http://bookr.app/foo/bar</div></div><div class="LineGroup"><div class="FixedLine">HTTP/1.1 404 Not Found</div><div class="FixedLine">Server: nginx/1.9.7</div><div class="FixedLine">Content-Type: text/html; charset=UTF-8</div><div class="FixedLine">Connection: keep-alive</div><div class="FixedLine">Cache-Control: no-cache, private</div><div class="FixedLine">date: Wed, 06 Jan 2016 04:28:54 GMT</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-18.</span><div class="SimplePara">Response Example for a Missing Route</div></div></div></div>
            </div><div id="Par77" class="Para">You have not asked for JSON, so the handler defers to the parent class. You can make the determination to always respond with JSON in your own applications, but for now you will keep your check and fall back to the default. The approach you’ve taken to send a JSON response for exceptions is basic, but your approach is good enough to get started. Eventually, you might want to build your own handler(s) for handling exceptions that you can reuse on multiple projects. Start simple, and add complexity when you need it.</div><div id="Par78" class="Para">You could have started writing tests before this change, but I thought it was more important to show you how the handler works under the hood and see the results of your modifications first.</div></div></div><div id="Sec7" class="Section1 RenderAsSection1"><h2 class="Heading">Testing the Exception Handler</h2><div id="Par79" class="Para">You have an exception handler that can respond to JSON, but you need to write tests to make sure it behaves as you expect. You will write unit tests for the handler, and your existing API tests will cover integration tests.</div><div id="Par80" class="Para">A really useful library for unit testing is a mocking library called Mockery (<span class="ExternalRef"><a href="http://docs.mockery.io/en/latest/"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">http://docs.mockery.io/en/latest/</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span>, which will help you mock dependencies with relative ease. Mockery is not a requirement for Lumen so you need to install it with Composer (Listing <span class="InternalRef"><a href="#Par81">6-19</a></span>).</div><div id="Par81" class="Para">
            <div class="ProgramCode" id="PC19"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ composer require --dev mockery/mockery:∼0.9.4</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-19.</span><div class="SimplePara">Requiring Mockery</div></div></div></div>
          </div><div id="Par82" class="Para">Now let’s create your <span class="EmphasisFontCategoryNonProportional">Handler</span> unit test file (Listing <span class="InternalRef"><a href="#Par83">6-20</a></span>).</div><div id="Par83" class="Para">
            <div class="ProgramCode" id="PC20"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ mkdir -p tests/app/Exceptions</div><div class="FixedLine">$ touch tests/app/Exceptions/HandlerTest.php</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-20.</span><div class="SimplePara">Creating the HandlerTest File</div></div></div></div>
          </div><div id="Par84" class="Para">Add the following code in Listing <span class="InternalRef"><a href="#Par85">6-21</a></span> to the new <span class="EmphasisFontCategoryNonProportional">HandlerTest.php</span> file.</div><div id="Par85" class="Para">
            <div class="ProgramCode" id="PC21"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Exceptions;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> \Mockery <span class="EmphasisTypeBold">as</span> m;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> App\Exceptions\Handler;</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">use</span> Illuminate\Http\Request;</div><div class="FixedLine"> 9  <span class="EmphasisTypeBold">use</span> Illuminate\Http\JsonResponse;</div><div class="FixedLine">10</div><div class="FixedLine">11  <span class="EmphasisTypeBold">class HandlerTest extends</span> TestCase</div><div class="FixedLine">12  {</div><div class="FixedLine">13</div><div class="FixedLine">14  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-21.</span><div class="SimplePara">The HandlerTest File (<span class="EmphasisFontCategoryNonProportional">tests/app/Exceptions/HandlerTest.php</span>)</div></div></div></div>
          </div><div id="Par86" class="Para">The following is a list of things you need to test based on the code you’ve written in the <span class="EmphasisFontCategoryNonProportional">Handler::render()</span> method:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par87" class="Para ParaOneEmphasisChild">It responds with HTML when json <span class="EmphasisTypeItalic">is not</span> requested.</div></li><li><div id="Par88" class="Para ParaOneEmphasisChild">It responds with json when json <span class="EmphasisTypeItalic">is</span> requested.</div></li><li><div id="Par89" class="Para">It provides a default status code for non-HTTP exceptions.</div></li><li><div id="Par90" class="Para">It provides common HTTP status codes for HTTP exceptions.</div></li><li><div id="Par91" class="Para ParaOneEmphasisChild">It provides debug information when debugging is <span class="EmphasisTypeItalic">enabled.</span>
            </div></li><li><div id="Par92" class="Para ParaOneEmphasisChild">It skips debugging information when debugging is <span class="EmphasisTypeItalic">disabled.</span>
            </div></li></ul></div>
      </div><div id="Par93" class="Para">Your first test (Listing <span class="InternalRef"><a href="#Par94">6-22</a></span>) will ensure the application responds with HTML when JSON is not requested. Mockery makes mocking dependencies a breeze.</div><div id="Par94" class="Para">
            <div class="ProgramCode" id="PC22"><div class="FixedLine">13  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">14  <span class="EmphasisTypeBold">public function</span> it_responds_with_html_when_json_is_not_accepted()</div><div class="FixedLine">15  {</div><div class="FixedLine">16      <span class="EmphasisTypeItalic">// Make the mock a partial, you only want to mock the `isDebugMode` method</span>
          </div><div class="FixedLine">17      $subject = m::mock(Handler::class)-&gt;makePartial();</div><div class="FixedLine">18      $subject-&gt;shouldNotReceive('isDebugMode');</div><div class="FixedLine">19</div><div class="FixedLine">20      <span class="EmphasisTypeItalic">// Mock the interaction with the Request</span>
          </div><div class="FixedLine">21      $request = m::mock(Request::class);</div><div class="FixedLine">22      $request-&gt;shouldReceive('wantsJson')-&gt;andReturn(<span class="EmphasisTypeBold">false</span>);</div><div class="FixedLine">23</div><div class="FixedLine">24      <span class="EmphasisTypeItalic">// Mock the interaction with the exception</span>
          </div><div class="FixedLine">25      $exception = m::mock(\Exception::class, ['Error!']);</div><div class="FixedLine">26      $exception-&gt;shouldNotReceive('getStatusCode');</div><div class="FixedLine">27      $exception-&gt;shouldNotReceive('getTrace');</div><div class="FixedLine">28      $exception-&gt;shouldNotReceive('getMessage');</div><div class="FixedLine">29</div><div class="FixedLine">30      <span class="EmphasisTypeItalic">// Call the method under test, this is not a mocked method.</span>
          </div><div class="FixedLine">31      $result = $subject-&gt;render($request, $exception);</div><div class="FixedLine">32</div><div class="FixedLine">33      <span class="EmphasisTypeItalic">// Assert that `render` does not return a JsonResponse</span>
          </div><div class="FixedLine">34      $this-&gt;assertNotInstanceOf(JsonResponse::class, $result);</div><div class="FixedLine">35  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-22.</span><div class="SimplePara">Testing That the API Responds with HTML When JSON Is Not Accepted</div></div></div></div>
          </div><div id="Par95" class="Para">You mock the class under test (<span class="EmphasisFontCategoryNonProportional">App\Exceptions\Handler</span>) as a partial mock (<span class="ExternalRef"><a href="http://docs.mockery.io/en/latest/reference/partial_mocks.html"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">http://docs.mockery.io/en/latest/reference/partial_mocks.html</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span>. This allows you to mock certain methods, but the other methods respond normally. In your case, you want to control the <span class="EmphasisFontCategoryNonProportional">return</span> of the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">isDebugMode</span></span> method you created. Mocking <span class="EmphasisFontCategoryNonProportional">isDebugMode</span> allows you to assert that it was never called! The expectation declaration <span class="EmphasisFontCategoryNonProportional">shouldNotReceive</span> means that the mocked method should never receive a call (<span class="ExternalRef"><a href="http://docs.mockery.io/en/latest/reference/expectations.html"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">http://docs.mockery.io/en/latest/reference/expectations.html</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span>.</div><div id="Par96" class="Para">You mock <span class="EmphasisFontCategoryNonProportional">Illuminate\Http\Request</span> and control the flow of the <span class="EmphasisFontCategoryNonProportional">render</span> method by instructing that <span class="EmphasisFontCategoryNonProportional">wantsJson</span> returns <span class="EmphasisFontCategoryNonProportional">false</span>. If <span class="EmphasisFontCategoryNonProportional">wantsJson</span> returns <span class="EmphasisFontCategoryNonProportional">false,</span> the entire block will be skipped and thus <span class="EmphasisFontCategoryNonProportional">Handler::isDebugMode()</span> will not be called. You can see how simple mocks make controlling the flow of the method under test.</div><div id="Par97" class="Para">The last mock you create before calling <span class="EmphasisFontCategoryNonProportional">$subject-&gt;render()</span> is an <span class="EmphasisFontCategoryNonProportional">\Exception</span>. Note in the <span class="EmphasisFontCategoryNonProportional">m::mock()</span> call that you pass an array of constructor arguments (<span class="EmphasisFontCategoryNonProportional">m::mock('ClassName', [arg1,arg2])</span>). Like the partial mock, you set up three <span class="EmphasisFontCategoryNonProportional">shouldNotRecieve</span> expectations for the exception mock: <span class="EmphasisFontCategoryNonProportional">getStatusCode</span>, <span class="EmphasisFontCategoryNonProportional">getTrace</span>, and <span class="EmphasisFontCategoryNonProportional">getMessage</span>.</div><div id="Par98" class="Para">Lastly, you actually call <span class="EmphasisFontCategoryNonProportional">$subject-&gt;render($request, $exception);</span>. You use a PHP assertion to make sure that the <span class="EmphasisFontCategoryNonProportional">render</span> method did not return an instance of the <span class="EmphasisFontCategoryNonProportional">JsonResponse</span> class. Note that because you partially mocked the subject of this test, the <span class="EmphasisFontCategoryNonProportional">render</span> method responds and works normally.</div><div id="Par99" class="Para">Now that you have an understanding of the test, let’s run the first test (Listing <span class="InternalRef"><a href="#Par100">6-23</a></span>).</div><div id="Par100" class="Para">
            <div class="ProgramCode" id="PC23"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=it_responds_with_html_when_json_is_not_accepted</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 1 assertion)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-23.</span><div class="SimplePara">Running the First Handler Unit Test</div></div></div></div>
          </div><div id="Par101" class="Para">Everything passed, but all that work for one assertion!? Fortunately, Mockery provides a way to make expectations count as assertions in PHPUnit. Open up the base <span class="EmphasisFontCategoryNonProportional">TestCase</span> class found in <span class="EmphasisFontCategoryNonProportional">tests/TestCase.php</span> and add the following code in Listing <span class="InternalRef"><a href="#Par102">6-24</a></span>.</div><div id="Par102" class="Para">
            <div class="ProgramCode" id="PC24"><div class="FixedLine">1  &lt;?php</div><div class="FixedLine">2</div><div class="FixedLine">3  <span class="EmphasisTypeBold">use</span> Mockery\Adapter\Phpunit\MockeryPHPUnitIntegration;</div><div class="FixedLine">4</div><div class="FixedLine">5  <span class="EmphasisTypeBold">class TestCase extends</span> Laravel\Lumen\Testing\TestCase</div><div class="FixedLine">6  {</div><div class="FixedLine">7      <span class="EmphasisTypeBold">use</span> MockeryPHPUnitIntegration;</div><div class="FixedLine">8      <span class="EmphasisTypeItalic">// …</span>
          </div><div class="FixedLine">9  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-24.</span><div class="SimplePara">Mockery’s PHPUnit Integration Trait (Partial Source)</div></div></div></div>
          </div><div id="Par103" class="Para">Now you should get more assertions (Listing <span class="InternalRef"><a href="#Par104">6-25</a></span>).</div><div id="Par104" class="Para">
            <div class="ProgramCode" id="PC25"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=it_responds_with_html_when_json_is_not_accepted</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 6 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-25.</span><div class="SimplePara">Running Tests After Adding the Mockery PHPUnit Trait</div></div></div></div>
          </div><div id="Par105" class="Para">Great, you want your hard work and commitment to writing tests mean something. I personally don’t know if I would write all those mocks without the assertion count payoff!</div><div id="FPar1" class="FormalPara FormalParaRenderingStyle3 ParaTypeOverview"><div class="Heading">Mocking</div><div id="Par106" class="Para">Mocking is an invaluable tool in your testing arsenal. It forces you to think about good code design. Mocking the interactions a class has with other dependencies helps you detect complicated code and hard-to-test code. A class with many dependencies can become difficult to mock, which might mean that you should refactor, or perhaps you are mocking things that don’t need to be mocked.</div><div id="Par107" class="Para">Mocking is an easy enough concept to understand, but practical use is an art that takes practice. Don’t give up on using mocking in your tests; the concepts will eventually click! I encourage you to read through the whole Mockery documentation and practice mocking.</div><div id="Par108" class="Para">The phpspec (<span class="ExternalRef"><a href="http://phpspec.readthedocs.org/en/latest/"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">http://phpspec.readthedocs.org/en/latest/</span>
                </span></a></span>
          <span class="EmphasisFontCategoryNonProportional">)</span> library is another good library that uses mocks for tests. In this book, I will stick to PHPUnit + Mockery, but phpspec is an excellent choice too!</div></div><div id="Par109" class="Para">You’ve covered the test for what happens when your app is rendering an exception response but the user doesn’t want JSON back. Now you are going to test the JSON response when the user <span class="EmphasisTypeItalic">wants</span> JSON (Listing <span class="InternalRef"><a href="#Par110">6-26</a></span>).</div><div id="Par110" class="Para">
            <div class="ProgramCode" id="PC26"><div class="FixedLine">37  <span class="EmphasisTypeItalic">/** @test */</span>
          </div><div class="FixedLine">38  <span class="EmphasisTypeBold">public function</span> it_responds_with_json_for_json_consumers()</div><div class="FixedLine">39  {</div><div class="FixedLine">40      $subject = m::mock(Handler::class)-&gt;makePartial();</div><div class="FixedLine">41      $subject</div><div class="FixedLine">42          -&gt;shouldReceive('isDebugMode')</div><div class="FixedLine">43          -&gt;andReturn(<span class="EmphasisTypeBold">false</span>);</div><div class="FixedLine">44</div><div class="FixedLine">45      $request = m::mock(Request::class);</div><div class="FixedLine">46      $request</div><div class="FixedLine">47          -&gt;shouldReceive('wantsJson')</div><div class="FixedLine">48          -&gt;andReturn(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">49</div><div class="FixedLine">50      $exception = m::mock(\Exception::class, ['Doh!']);</div><div class="FixedLine">51      $exception</div><div class="FixedLine">52          -&gt;shouldReceive('getMessage')</div><div class="FixedLine">53          -&gt;andReturn('Doh!');</div><div class="FixedLine">54</div><div class="FixedLine">55      <span class="EmphasisTypeItalic">/** @var JsonResponse $result */</span>
          </div><div class="FixedLine">56      $result = $subject-&gt;render($request, $exception);</div><div class="FixedLine">57      $data = $result-&gt;getData();</div><div class="FixedLine">58</div><div class="FixedLine">59      $this-&gt;assertInstanceOf(JsonResponse::class, $result);</div><div class="FixedLine">60      $this-&gt;assertObjectHasAttribute('error', $data);</div><div class="FixedLine">61      $this-&gt;assertAttributeEquals('Doh!', 'message', $data-&gt;error);</div><div class="FixedLine">62      $this-&gt;assertAttributeEquals(400, 'status', $data-&gt;error);</div><div class="FixedLine">63  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-26.</span><div class="SimplePara">Testing That the API Responds with JSON on an Exception</div></div></div></div>
          </div><div id="Par111" class="Para">The mocks in your latest test are very similar to the first handler test, but this time you mock your method under test to go into the <span class="EmphasisFontCategoryNonProportional">if ($request-&gt;wantsJson()) {</span> logic. Inside the <span class="EmphasisFontCategoryNonProportional">if ($request-&gt;wantsJson()) {</span> statement there are calls that you need to mock that should receive. The <span class="EmphasisFontCategoryNonProportional">$exception</span> mock should receive a call to <span class="EmphasisFontCategoryNonProportional">getMessage</span> and return <span class="EmphasisFontCategoryNonProportional">"Doh!"</span> since that is the parameter you passed to the <span class="EmphasisFontCategoryNonProportional">$exception</span> mock constructor.</div><div id="Par112" class="Para">The <span class="EmphasisFontCategoryNonProportional">$exception</span> is not an instance of <span class="EmphasisFontCategoryNonProportional">Symfony\Component\HttpKernel\Exception\HttpException</span> so your test will use the default status code and message from the exception. You then assert that the method under test returns an instance of <span class="EmphasisFontCategoryNonProportional">Illuminate\Http\JsonResponse</span>. Finally, you assert the response body for the correct keys, values, and status code.</div><div id="Par113" class="Para">A couple more tests and you can call your exception response handler good. The next test needs to import a few classes to the top of your <span class="EmphasisFontCategoryNonProportional">HandlerTest</span> class (Listing <span class="InternalRef"><a href="#Par114">6-27</a></span>).</div><div id="Par114" class="Para">
            <div class="ProgramCode" id="PC27"><div class="LineGroup"><div class="FixedLine">&lt;?php</div></div><div class="LineGroup"><div class="FixedLine">
              <span class="EmphasisTypeBold">namespace</span> Tests\App\Exceptions;</div></div><div class="LineGroup"><div class="FixedLine">
                  <span class="EmphasisTypeItalic">// ...</span>
                </div><div class="FixedLine">
              <span class="EmphasisTypeBold">use</span> Symfony\Component\HttpKernel\Exception\NotFoundHttpException;</div><div class="FixedLine">
              <span class="EmphasisTypeBold">use</span> Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException;</div></div><div class="LineGroup"><div class="FixedLine">
              <span class="EmphasisTypeBold">class HandlerTest extends</span> TestCase</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-27.</span><div class="SimplePara">Adding a Few HTTP Exception Classes (<span class="EmphasisFontCategoryNonProportional">tests/app/Exceptions/HandlerTest.php</span>)</div></div></div></div>
          </div><div id="Par115" class="Para">And now the final test for the <span class="EmphasisFontCategoryNonProportional">Handler.php</span> class. This test ensures that classes extending from <span class="EmphasisFontCategoryNonProportional">HttpException</span> will respond with the matching HTTP request status code and message (Listing <span class="InternalRef"><a href="#Par116">6-28</a></span>).</div><div id="Par116" class="Para">
            <div class="ProgramCode" id="PC28"><div class="FixedLine"> 67  <span class="EmphasisTypeItalic">/** @test */</span>
          </div><div class="FixedLine"> 68  <span class="EmphasisTypeBold">public function</span> it_provides_json_responses_for_http_exceptions()</div><div class="FixedLine"> 69  {</div><div class="FixedLine"> 70      $subject = m::mock(Handler::class)-&gt;makePartial();</div><div class="FixedLine"> 71      $subject</div><div class="FixedLine"> 72          -&gt;shouldReceive('isDebugMode')</div><div class="FixedLine"> 73          -&gt;andReturn(<span class="EmphasisTypeBold">false</span>);</div><div class="FixedLine"> 74</div><div class="FixedLine"> 75      $request = m::mock(Request::class);</div><div class="FixedLine"> 76      $request-&gt;shouldReceive('wantsJson')-&gt;andReturn(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine"> 77</div><div class="FixedLine"> 78      $examples = [</div><div class="FixedLine"> 79          [</div><div class="FixedLine"> 80              'mock' =&gt; NotFoundHttpException::class,</div><div class="FixedLine"> 81              'status' =&gt; 404,</div><div class="FixedLine"> 82              'message' =&gt; 'Not Found'</div><div class="FixedLine"> 83          ],</div><div class="FixedLine"> 84          [</div><div class="FixedLine"> 85              'mock' =&gt; AccessDeniedHttpException::class,</div><div class="FixedLine"> 86              'status' =&gt; 403,</div><div class="FixedLine"> 87              'message' =&gt; 'Forbidden'</div><div class="FixedLine"> 88          ]</div><div class="FixedLine"> 89      ];</div><div class="FixedLine"> 90</div><div class="FixedLine"> 91      <span class="EmphasisTypeBold">foreach</span> ($examples <span class="EmphasisTypeBold">as</span> $e) {</div><div class="FixedLine"> 92          $exception = m::mock($e['mock']);</div><div class="FixedLine"> 93          $exception-&gt;shouldReceive('getMessage')-&gt;andReturn(<span class="EmphasisTypeBold">null</span>);</div><div class="FixedLine"> 94          $exception-&gt;shouldReceive('getStatusCode')-&gt;andReturn($e['status']);</div><div class="FixedLine"> 95</div><div class="FixedLine"> 96          <span class="EmphasisTypeItalic">/** @var JsonResponse $result */</span>
          </div><div class="FixedLine"> 97          $result = $subject-&gt;render($request, $exception);</div><div class="FixedLine"> 98          $data = $result-&gt;getData();</div><div class="FixedLine"> 99</div><div class="FixedLine">100          $this-&gt;assertEquals($e['status'], $result-&gt;getStatusCode());</div><div class="FixedLine">101          $this-&gt;assertEquals($e['message'], $data-&gt;error-&gt;message);</div><div class="FixedLine">102          $this-&gt;assertEquals($e['status'], $data-&gt;error-&gt;status);</div><div class="FixedLine">103      }</div><div class="FixedLine">104  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-28.</span><div class="SimplePara">Testing HTTP Exception Responses</div></div></div></div>
          </div><div id="Par117" class="Para">The <span class="EmphasisFontCategoryNonProportional">$subject</span> and <span class="EmphasisFontCategoryNonProportional">$request</span> mocks should look familiar at this point. After mocking and setting expectations, the test creates an array of <span class="EmphasisFontCategoryNonProportional">$examples</span> that you will loop over to test a few exceptions that extend from the <span class="EmphasisFontCategoryNonProportional">HttpException</span> class. The <span class="EmphasisFontCategoryNonProportional">foreach</span> loop mocks each example and sets mockery expectations. Each loop will do the following:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par118" class="Para">Set <span class="EmphasisFontCategoryNonProportional">shouldReceive</span> expectation for <span class="EmphasisFontCategoryNonProportional">getMessage</span> and <span class="EmphasisFontCategoryNonProportional">getStatusCode.</span>
            </div></li><li><div id="Par119" class="Para ParaOneEmphasisChild">The <span class="EmphasisFontCategoryNonProportional">$subject-&gt;render()</span> call is made on the partially mocked test subject.</div></li><li><div id="Par120" class="Para">Make PHPUnit assertions about the response <span class="EmphasisFontCategoryNonProportional">status</span> and <span class="EmphasisFontCategoryNonProportional">message</span> keys.</div></li></ul></div>
      </div><div id="Par121" class="Para">You are at a point where you should run tests before moving on (Listing <span class="InternalRef"><a href="#Par122">6-29</a></span>).</div><div id="Par122" class="Para">
            <div class="ProgramCode" id="PC29"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=HandlerTest</div></div><div class="LineGroup"><div class="FixedLine">OK (3 tests, 25 assertions)</div></div><div class="LineGroup"><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (16 tests, 57 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-29.</span><div class="SimplePara">Running the Handler Tests and the Full Test Suite</div></div></div></div>
          </div><div id="Par123" class="Para">Before you call it good, let’s refactor the <span class="EmphasisFontCategoryNonProportional">BooksController@show</span> method to not catch exceptions from the <span class="EmphasisFontCategoryNonProportional">Book::findOrFail()</span> method call now that your handler can respond to exceptions. Listing <span class="InternalRef"><a href="#Par124">6-30</a></span> shows the current version of the <span class="EmphasisFontCategoryNonProportional">@show</span> method.</div><div id="Par124" class="Para">
            <div class="ProgramCode" id="PC30"><div class="FixedLine">24  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">25   <span class="EmphasisTypeItalic">* GET /books/{id}</span>
          </div><div class="FixedLine">26   <span class="EmphasisTypeItalic">* @param integer $id</span>
          </div><div class="FixedLine">27   <span class="EmphasisTypeItalic">* @return mixed</span>
          </div><div class="FixedLine">28   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">29  <span class="EmphasisTypeBold">public function</span> show($id)</div><div class="FixedLine">30  {</div><div class="FixedLine">31      <span class="EmphasisTypeBold">try</span> {</div><div class="FixedLine">32          <span class="EmphasisTypeBold">return</span> Book::findOrFail($id);</div><div class="FixedLine">33      } <span class="EmphasisTypeBold">catch</span> (ModelNotFoundException $e) {</div><div class="FixedLine">34          <span class="EmphasisTypeBold">return</span> response()-&gt;json([</div><div class="FixedLine">35              'error' =&gt; [</div><div class="FixedLine">36                  'message' =&gt; 'Book not found'</div><div class="FixedLine">37              ]</div><div class="FixedLine">38          ], 404);</div><div class="FixedLine">39      }</div><div class="FixedLine">40  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-30.</span><div class="SimplePara">Current BooksController@show Method</div></div></div></div>
          </div><div id="Par125" class="Para">Let’s remove the <span class="EmphasisFontCategoryNonProportional">try/catch</span> to see how your <span class="EmphasisFontCategoryNonProportional">App\Exceptions\Handler::render()</span> method handles the <span class="EmphasisFontCategoryNonProportional">findOrFail()</span> call (Listing <span class="InternalRef"><a href="#Par126">6-31</a></span>).</div><div id="Par126" class="Para">
            <div class="ProgramCode" id="PC31"><div class="FixedLine">24  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">25   <span class="EmphasisTypeItalic">* GET /books/{id}</span>
          </div><div class="FixedLine">26   <span class="EmphasisTypeItalic">* @param integer $id</span>
          </div><div class="FixedLine">27   <span class="EmphasisTypeItalic">* @return mixed</span>
          </div><div class="FixedLine">28   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">29  <span class="EmphasisTypeBold">public function</span> show($id)</div><div class="FixedLine">30  {</div><div class="FixedLine">31      <span class="EmphasisTypeBold">return</span> Book::findOrFail($id);</div><div class="FixedLine">32  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-31.</span><div class="SimplePara">Removing try/catch From the BooksController@show Method</div></div></div></div>
          </div><div id="Par127" class="Para">Now try making a request to an invalid record (Listing <span class="InternalRef"><a href="#Par128">6-32</a></span>).</div><div id="Par128" class="Para">
            <div class="ProgramCode" id="PC32"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ curl -i -H"Accept: application/json" http://bookr.app/books/5555</div></div><div class="LineGroup"><div class="FixedLine">HTTP/1.1 400 Bad Request</div><div class="FixedLine">Server: nginx/1.9.7</div><div class="FixedLine">Content-Type: application/json</div><div class="FixedLine">Transfer-Encoding: chunked</div><div class="FixedLine">Connection: keep-alive</div><div class="FixedLine">Cache-Control: no-cache</div><div class="FixedLine">Date: Wed, 06 Jan 2016 05:00:35 GMT</div></div><div class="LineGroup"><div class="FixedLine">{"error":{"message":"No query results for model [App\\Book].","status":400}}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-32.</span><div class="SimplePara">Making a Request for an Invalid Book</div></div></div></div>
          </div><div id="Par129" class="Para">It looks like your <span class="EmphasisFontCategoryNonProportional">Handler.php</span> adjustments are working, but a <span class="EmphasisFontCategoryNonProportional">400</span> is not exactly the right response for a <span class="EmphasisFontCategoryNonProportional">ModelNotFoundException</span>. If you run <span class="EmphasisFontCategoryNonProportional">phpunit,</span> now you will get a failure; your test suite has helped you avoid a bug! Let’s make one last adjustment to your <span class="EmphasisFontCategoryNonProportional">Handler::render()</span> method (Listing <span class="InternalRef"><a href="#Par130">6-33</a></span>) to account for a <span class="EmphasisFontCategoryNonProportional">ModelNotFoundException</span>.</div><div id="Par130" class="Para">
            <div class="ProgramCode" id="PC33"><div class="FixedLine">49  <span class="EmphasisTypeBold">if</span> ($e instanceof HttpException) {</div><div class="FixedLine">50      $response['message'] = Response::$statusTexts[$e-&gt;getStatusCode()];</div><div class="FixedLine">51      $response['status'] = $e-&gt;getStatusCode();</div><div class="FixedLine">52  <span class="EmphasisTypeBold">} else if ($e instanceof ModelNotFoundException) {</span>
          </div><div class="FixedLine">53      <span class="EmphasisTypeBold">$response['message'] = Response::$statusTexts[Response::HTTP_NOT_FOUND];</span>
          </div><div class="FixedLine">54      <span class="EmphasisTypeBold">$response['status'] = Response::HTTP_NOT_FOUND;</span>
          </div><div class="FixedLine">55  <span class="EmphasisTypeBold">}</span>
          </div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-33.</span><div class="SimplePara">Additional Check for ModelNotFoundException</div></div></div></div>
          </div><div id="Par131" class="Para">Try your request again and then run your test suite (Listing <span class="InternalRef"><a href="#Par132">6-34</a></span>).</div><div id="Par132" class="Para">
            <div class="ProgramCode" id="PC34"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ curl -i -H"Accept: application/json" http://bookr.app/books/5555</div></div><div class="LineGroup"><div class="FixedLine">HTTP/1.1 404 Not Found</div><div class="FixedLine">Server: nginx/1.9.7</div><div class="FixedLine">Content-Type: application/json</div><div class="FixedLine">Transfer-Encoding: chunked</div><div class="FixedLine">Connection: keep-alive</div><div class="FixedLine">Cache-Control: no-cache</div><div class="FixedLine">Date: Wed, 06 Jan 2016 05:07:21 GMT</div></div><div class="LineGroup"><div class="FixedLine">{"error":{"message":"Not Found","status":404}}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-34.</span><div class="SimplePara">Making a Request After Changing the Handler</div></div></div></div>
          </div><div id="Par133" class="Para">Much better! Let’s see if your tests are passing now (Listing <span class="InternalRef"><a href="#Par134">6-35</a></span>).</div><div id="Par134" class="Para">
            <div class="ProgramCode" id="PC35"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::show_should_fail_when_the_book_id_does_not_exist</div><div class="FixedLine">Invalid JSON was returned from the route. Perhaps an exception was thrown?</div><div class="FixedLine">…</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 16, Assertions: 56, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-35.</span><div class="SimplePara">Running the Entire Test Suite</div></div></div></div>
          </div><div id="Par135" class="Para">Your failing test claims that you have invalid JSON. It makes sense because your test is not asking for JSON with <span class="EmphasisFontCategoryNonProportional">Accept: application/json</span> and the <span class="EmphasisFontCategoryNonProportional">return parent::render($request, $e);</span> part of your handler is returning a 404 HTML response. If you look at the test, the message you are looking for is “Book not found”, but you can actually update the handler to use the 404 message and status, so you need to change your <span class="EmphasisFontCategoryNonProportional">seeJson()</span> assertion (Listing <span class="InternalRef"><a href="#Par136">6-36</a></span>).</div><div id="Par136" class="Para">
            <div class="ProgramCode" id="PC36"><div class="FixedLine">49  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">50  <span class="EmphasisTypeBold">public function</span> show_should_fail_when_the_book_id_does_not_exist()</div><div class="FixedLine">51  {</div><div class="FixedLine">52      $this</div><div class="FixedLine">53          <span class="EmphasisTypeBold">-&gt;get('/books/99999', ['Accept' =&gt; 'application/json'])</span>
          </div><div class="FixedLine">54          -&gt;seeStatusCode(404)</div><div class="FixedLine">55          -&gt;seeJson([</div><div class="FixedLine">56              <span class="EmphasisTypeBold">'message' =&gt; 'Not Found',</span>
          </div><div class="FixedLine">57              <span class="EmphasisTypeBold">'status' =&gt; 404</span>
          </div><div class="FixedLine">58          ]);</div><div class="FixedLine">59  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-36.</span><div class="SimplePara">Fixing the Broken BooksController@show Test</div></div></div></div>
          </div><div id="Par137" class="Para">The <span class="EmphasisFontCategoryNonProportional">$this-&gt;get()</span> method can pass an array of headers; the <span class="EmphasisFontCategoryNonProportional">Accept</span> header will trigger your <span class="EmphasisFontCategoryNonProportional">Handler::response()</span> JSON logic. Next, you changed the <span class="EmphasisFontCategoryNonProportional">seeJson</span> check to match the <span class="EmphasisFontCategoryNonProportional">ModelNotFoundException</span> response message and status; you gain more consistent <span class="EmphasisFontCategoryNonProportional">404</span> messages by allowing the <span class="EmphasisFontCategoryNonProportional">Handler</span> to deal with them. Run the test suite again (Listing <span class="InternalRef"><a href="#Par138">6-37</a></span>) to see if you are back to green!</div><div id="Par138" class="Para">
            <div class="ProgramCode" id="PC37"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (16 tests, 57 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-37.</span><div class="SimplePara">Running the Full Test Suite</div></div></div></div>
          </div><div id="Par139" class="Para">Much better! You added more logic to your <span class="EmphasisFontCategoryNonProportional">Handler</span> class to deal with the <span class="EmphasisFontCategoryNonProportional">ModelNotFoundException</span> so you need to account for the added code in your test suite. You will add the <span class="EmphasisFontCategoryNonProportional">ModelNotFoundException</span> to your array of examples that you loop through by modifying an existing test (Listing <span class="InternalRef"><a href="#Par140">6-38</a></span>).</div><div id="Par140" class="Para">
            <div class="ProgramCode" id="PC38"><div class="FixedLine"> 73  <span class="EmphasisTypeItalic">/** @test */</span>
          </div><div class="FixedLine"> 74  <span class="EmphasisTypeBold">public function</span> it_provides_json_responses_for_http_exceptions()</div><div class="FixedLine"> 75  {</div><div class="FixedLine"> 76      $subject = m::mock(Handler::class)-&gt;makePartial();</div><div class="FixedLine"> 77      $subject</div><div class="FixedLine"> 78          -&gt;shouldReceive('isDebugMode')</div><div class="FixedLine"> 79          -&gt;andReturn(<span class="EmphasisTypeBold">false</span>);</div><div class="FixedLine"> 80</div><div class="FixedLine"> 81      $request = m::mock(Request::class);</div><div class="FixedLine"> 82      $request-&gt;shouldReceive('wantsJson')-&gt;andReturn(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine"> 83</div><div class="FixedLine"> 84      $examples = [</div><div class="FixedLine"> 85          [</div><div class="FixedLine"> 86              'mock' =&gt; NotFoundHttpException::class,</div><div class="FixedLine"> 87              'status' =&gt; 404,</div><div class="FixedLine"> 88              'message' =&gt; 'Not Found'</div><div class="FixedLine"> 89          ],</div><div class="FixedLine"> 90          [</div><div class="FixedLine"> 91              'mock' =&gt; AccessDeniedHttpException::class,</div><div class="FixedLine"> 92              'status' =&gt; 403,</div><div class="FixedLine"> 93              'message' =&gt; 'Forbidden'</div><div class="FixedLine"> 94          ],</div><div class="FixedLine"> 95          [</div><div class="FixedLine"> 96              'mock' =&gt; ModelNotFoundException::class,</div><div class="FixedLine"> 97              'status' =&gt; 404,</div><div class="FixedLine"> 98              'message' =&gt; 'Not Found'</div><div class="FixedLine"> 99          ]</div><div class="FixedLine">100      ];</div><div class="FixedLine">101</div><div class="FixedLine">102      <span class="EmphasisTypeBold">foreach</span> ($examples <span class="EmphasisTypeBold">as</span> $e) {</div><div class="FixedLine">103          $exception = m::mock($e['mock']);</div><div class="FixedLine">104          $exception-&gt;shouldReceive('getMessage')-&gt;andReturn(<span class="EmphasisTypeBold">null</span>);</div><div class="FixedLine">105          $exception-&gt;shouldReceive('getStatusCode')-&gt;andReturn($e['status']);</div><div class="FixedLine">106</div><div class="FixedLine">107          <span class="EmphasisTypeItalic">/** @var JsonResponse $result */</span>
          </div><div class="FixedLine">108          $result = $subject-&gt;render($request, $exception);</div><div class="FixedLine">109          $data = $result-&gt;getData();</div><div class="FixedLine">110</div><div class="FixedLine">111          $this-&gt;assertEquals($e['status'], $result-&gt;getStatusCode());</div><div class="FixedLine">112          $this-&gt;assertEquals($e['message'], $data-&gt;error-&gt;message);</div><div class="FixedLine">113          $this-&gt;assertEquals($e['status'], $data-&gt;error-&gt;status);</div><div class="FixedLine">114      }</div><div class="FixedLine">115  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-38.</span><div class="SimplePara">Adding the <span class="EmphasisFontCategoryNonProportional">ModelNotFoundException</span> to Your <span class="EmphasisFontCategoryNonProportional">$examples</span> Array</div></div></div></div>
          </div><div id="Par141" class="Para">You need to import the <span class="EmphasisFontCategoryNonProportional">ModelNotFoundException</span> class (Listing <span class="InternalRef"><a href="#Par142">6-39</a></span>) and run the test suite (Listing <span class="InternalRef"><a href="#Par143">6-40</a></span>).</div><div id="Par142" class="Para">
            <div class="ProgramCode" id="PC39"><div class="LineGroup"><div class="FixedLine">&lt;?php</div></div><div class="LineGroup"><div class="FixedLine">
              <span class="EmphasisTypeBold">namespace</span> Tests\App\Exceptions;</div></div><div class="LineGroup"><div class="FixedLine">
                  <span class="EmphasisTypeItalic">// ...</span>
                </div><div class="FixedLine">
                  <span class="EmphasisTypeBold">use Illuminate\Database\Eloquent\ModelNotFoundException;</span>
                </div></div><div class="LineGroup"><div class="FixedLine">
              <span class="EmphasisTypeBold">class HandlerTest extends</span> TestCase</div><div class="FixedLine">{</div><div class="FixedLine">    <span class="EmphasisTypeItalic">// ...</span>
            </div><div class="FixedLine">}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-39.</span><div class="SimplePara">Importing <span class="EmphasisFontCategoryNonProportional">ModelNotFoundException</span> to Your HandlerTest Class</div></div></div></div>
          </div><div id="Par143" class="Para">
            <div class="ProgramCode" id="PC40"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (16 tests, 62 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-40.</span><div class="SimplePara">Running the Full Test Suite</div></div></div></div>
          </div><div id="Par144" class="Para ParaOneEmphasisChild">Adding a check for the <span class="EmphasisFontCategoryNonProportional">ModelNotFoundException</span> was fairly easy! Your Handler is in good shape. You now have test database migrations and factories working and a better exception response handler class.</div><div id="Par145" class="Para ParaTypeImportant">
        <img src="A395120_1_En_6_Figc_HTML.jpg" alt="A395120_1_En_6_Figc_HTML.jpg"/> Git commit: Handle Exceptions with a JSON Response</div><div id="Par146" class="Para ParaTypeImportant">d5e41d7 (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/d5e41d7"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/d5e41d7</span>
              </span></a></span>)</div><div id="Par147" class="Para">Listing <span class="InternalRef"><a href="#Par148">6-40</a></span> contains the final <span class="EmphasisFontCategoryNonProportional">Handler</span> file in full and Listing <span class="InternalRef"><a href="#Par149">6-40</a></span> contains the final HandlerTest file in full.</div><div id="Par148" class="Para">
            <div class="ProgramCode" id="PC41"><div class="LineGroup"><div class="FixedLine">&lt;?php</div></div><div class="LineGroup"><div class="FixedLine">namespace App\Exceptions;</div></div><div class="LineGroup"><div class="FixedLine">use Exception;</div><div class="FixedLine">use Symfony\Component\HttpFoundation\Response;</div><div class="FixedLine">use Illuminate\Validation\ValidationException;</div><div class="FixedLine">use Illuminate\Auth\Access\AuthorizationException;</div><div class="FixedLine">use Illuminate\Database\Eloquent\ModelNotFoundException;</div><div class="FixedLine">use Symfony\Component\HttpKernel\Exception\HttpException;</div><div class="FixedLine">use Laravel\Lumen\Exceptions\Handler as ExceptionHandler;</div></div><div class="LineGroup"><div class="FixedLine">class Handler extends ExceptionHandler</div><div class="FixedLine">{</div><div class="FixedLine">    /**</div><div class="FixedLine">     * A list of the exception types that should not be reported.</div><div class="FixedLine">     *</div><div class="FixedLine">     * @var array</div><div class="FixedLine">     */</div><div class="FixedLine">    protected $dontReport = [</div><div class="FixedLine">        AuthorizationException::class,</div><div class="FixedLine">        HttpException::class,</div><div class="FixedLine">        ModelNotFoundException::class,</div><div class="FixedLine">        ValidationException::class,</div><div class="FixedLine">    ];</div></div><div class="LineGroup"><div class="FixedLine">    /**</div><div class="FixedLine">     * Report or log an exception.</div><div class="FixedLine">     *</div><div class="FixedLine">     * This is a great spot to send exceptions to Sentry, Bugsnag, etc.</div><div class="FixedLine">     *</div><div class="FixedLine">     * @param  \Exception  $e</div><div class="FixedLine">     * @return void</div><div class="FixedLine">     */</div><div class="FixedLine">    public function report(Exception $e)</div><div class="FixedLine">    {</div><div class="FixedLine">        parent::report($e);</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    /**</div><div class="FixedLine">     * Render an exception into an HTTP response.</div><div class="FixedLine">     *</div><div class="FixedLine">     * @param \Illuminate\Http\Request $request</div><div class="FixedLine">     * @param \Exception $e</div><div class="FixedLine">     * @return \Illuminate\Http\Response</div><div class="FixedLine">     */</div><div class="FixedLine">    public function render($request, Exception $e)</div><div class="FixedLine">    {</div><div class="FixedLine">        if ($request-&gt;wantsJson() &amp;&amp; !($e instanceof ValidationException)) {</div><div class="FixedLine">            $response = [</div><div class="FixedLine">                'message' =&gt; (string) $e-&gt;getMessage(),</div><div class="FixedLine">                'status' =&gt; 400</div><div class="FixedLine">            ];</div></div><div class="LineGroup"><div class="FixedLine">            if ($e instanceof HttpException) {</div><div class="FixedLine">                $response['message'] = Response::$statusTexts[$e-&gt;getStatusCode()];</div><div class="FixedLine">                $response['status'] = $e-&gt;getStatusCode();</div><div class="FixedLine">            } else if ($e instanceof ModelNotFoundException) {</div><div class="FixedLine">                $response['message'] = Response::$statusTexts[Response::HTTP_NOT_FOUND];</div><div class="FixedLine">                $response['status'] = Response::HTTP_NOT_FOUND;</div><div class="FixedLine">            }</div></div><div class="LineGroup"><div class="FixedLine">            if ($this-&gt;isDebugMode()) {</div><div class="FixedLine">                $response['debug'] = [</div><div class="FixedLine">                    'exception' =&gt; get_class($e),</div><div class="FixedLine">                    'trace' =&gt; $e-&gt;getTrace()</div><div class="FixedLine">                ];</div><div class="FixedLine">            }</div></div><div class="LineGroup"><div class="FixedLine">            return response()-&gt;json(['error' =&gt; $response], $response['status']);</div><div class="FixedLine">        }</div></div><div class="LineGroup"><div class="FixedLine">        return parent::render($request, $e);</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    /**</div><div class="FixedLine">     * Determine if the application is in debug mode.</div><div class="FixedLine">     *</div><div class="FixedLine">     * @return Boolean</div><div class="FixedLine">     */</div><div class="FixedLine">    public function isDebugMode()</div><div class="FixedLine">    {</div><div class="FixedLine">        return (Boolean) env('APP_DEBUG');</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-41.</span><div class="SimplePara">Final Handler.php File</div></div></div></div>
          </div><div id="Par149" class="Para">
            <div class="ProgramCode" id="PC42"><div class="LineGroup"><div class="FixedLine">&lt;?php</div></div><div class="LineGroup"><div class="FixedLine">namespace Tests\App\Exceptions;</div></div><div class="LineGroup"><div class="FixedLine">use TestCase;</div><div class="FixedLine">use \Mockery as m;</div><div class="FixedLine">use App\Exceptions\Handler;</div><div class="FixedLine">use Illuminate\Http\Request;</div><div class="FixedLine">use Illuminate\Http\JsonResponse;</div><div class="FixedLine">use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;</div><div class="FixedLine">use Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException;</div><div class="FixedLine">use Illuminate\Database\Eloquent\ModelNotFoundException;</div></div><div class="LineGroup"><div class="FixedLine">class HandlerTest extends TestCase</div><div class="FixedLine">{</div><div class="FixedLine">    /** @test **/</div><div class="FixedLine">    public function it_responds_with_html_when_json_is_not_accepted()</div><div class="FixedLine">    {</div><div class="FixedLine">        // Make the mock a partial, you only want to mock the `isDebugMode` method</div><div class="FixedLine">        $subject = m::mock(Handler::class)-&gt;makePartial();</div><div class="FixedLine">        $subject-&gt;shouldNotReceive('isDebugMode');</div></div><div class="LineGroup"><div class="FixedLine">        // Mock the interaction with the Request</div><div class="FixedLine">        $request = m::mock(Request::class);</div><div class="FixedLine">        $request-&gt;shouldReceive('wantsJson')-&gt;andReturn(false);</div></div><div class="LineGroup"><div class="FixedLine">        // Mock the interaction with the exception</div><div class="FixedLine">        $exception = m::mock(\Exception::class, ['Error!']);</div><div class="FixedLine">        $exception-&gt;shouldNotReceive('getStatusCode');</div><div class="FixedLine">        $exception-&gt;shouldNotReceive('getTrace');</div><div class="FixedLine">        $exception-&gt;shouldNotReceive('getMessage');</div></div><div class="LineGroup"><div class="FixedLine">        // Call the method under test, this is not a mocked method.</div><div class="FixedLine">        $result = $subject-&gt;render($request, $exception);</div></div><div class="LineGroup"><div class="FixedLine">        // Assert that `render` does not return a JsonResponse</div><div class="FixedLine">        $this-&gt;assertNotInstanceOf(JsonResponse::class, $result);</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    /** @test */</div><div class="FixedLine">    public function it_responds_with_json_for_json_consumers()</div><div class="FixedLine">    {</div><div class="FixedLine">        $subject = m::mock(Handler::class)-&gt;makePartial();</div><div class="FixedLine">        $subject</div><div class="FixedLine">            -&gt;shouldReceive('isDebugMode')</div><div class="FixedLine">            -&gt;andReturn(false);</div></div><div class="LineGroup"><div class="FixedLine">        $request = m::mock(Request::class);</div><div class="FixedLine">        $request</div><div class="FixedLine">            -&gt;shouldReceive('wantsJson')</div><div class="FixedLine">            -&gt;andReturn(true);</div></div><div class="LineGroup"><div class="FixedLine">        $exception = m::mock(\Exception::class, ['Doh!']);</div><div class="FixedLine">        $exception</div><div class="FixedLine">            -&gt;shouldReceive('getMessage')</div><div class="FixedLine">            -&gt;andReturn('Doh!');</div></div><div class="LineGroup"><div class="FixedLine">        /** @var JsonResponse $result */</div><div class="FixedLine">        $result = $subject-&gt;render($request, $exception);</div><div class="FixedLine">        $data = $result-&gt;getData();</div></div><div class="LineGroup"><div class="FixedLine">        $this-&gt;assertInstanceOf(JsonResponse::class, $result);</div><div class="FixedLine">        $this-&gt;assertObjectHasAttribute('error', $data);</div><div class="FixedLine">        $this-&gt;assertAttributeEquals('Doh!', 'message', $data-&gt;error);</div><div class="FixedLine">        $this-&gt;assertAttributeEquals(400, 'status', $data-&gt;error);</div><div class="FixedLine">    }</div></div><div class="LineGroup"><div class="FixedLine">    /** @test */</div><div class="FixedLine">    public function it_provides_json_responses_for_http_exceptions()</div><div class="FixedLine">    {</div><div class="FixedLine">        $subject = m::mock(Handler::class)-&gt;makePartial();</div><div class="FixedLine">        $subject</div><div class="FixedLine">            -&gt;shouldReceive('isDebugMode')</div><div class="FixedLine">            -&gt;andReturn(false);</div></div><div class="LineGroup"><div class="FixedLine">        $request = m::mock(Request::class);</div><div class="FixedLine">        $request-&gt;shouldReceive('wantsJson')-&gt;andReturn(true);</div></div><div class="LineGroup"><div class="FixedLine">        $examples = [</div><div class="FixedLine">            [</div><div class="FixedLine">                'mock' =&gt; NotFoundHttpException::class,</div><div class="FixedLine">                'status' =&gt; 404,</div><div class="FixedLine">                'message' =&gt; 'Not Found'</div><div class="FixedLine">            ],</div><div class="FixedLine">            [</div><div class="FixedLine">                'mock' =&gt; AccessDeniedHttpException::class,</div><div class="FixedLine">                'status' =&gt; 403,</div><div class="FixedLine">                'message' =&gt; 'Forbidden'</div><div class="FixedLine">            ],</div><div class="FixedLine">            [</div><div class="FixedLine">                'mock' =&gt; ModelNotFoundException::class,</div><div class="FixedLine">                'status' =&gt; 404,</div><div class="FixedLine">                'message' =&gt; 'Not Found'</div><div class="FixedLine">            ]</div><div class="FixedLine">        ];</div></div><div class="LineGroup"><div class="FixedLine">        foreach ($examples as $e) {</div><div class="FixedLine">            $exception = m::mock($e['mock']);</div><div class="FixedLine">            $exception-&gt;shouldReceive('getMessage')-&gt;andReturn(null);</div><div class="FixedLine">            $exception-&gt;shouldReceive('getStatusCode')-&gt;andReturn($e['status']);</div></div><div class="LineGroup"><div class="FixedLine">            /** @var JsonResponse $result */</div><div class="FixedLine">            $result = $subject-&gt;render($request, $exception);</div><div class="FixedLine">            $data = $result-&gt;getData();</div></div><div class="LineGroup"><div class="FixedLine">            $this-&gt;assertEquals($e['status'], $result-&gt;getStatusCode());</div><div class="FixedLine">            $this-&gt;assertEquals($e['message'], $data-&gt;error-&gt;message);</div><div class="FixedLine">            $this-&gt;assertEquals($e['status'], $data-&gt;error-&gt;status);</div><div class="FixedLine">        }</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 6-42.</span><div class="SimplePara">Final HandlerTest.php</div></div></div></div>
          </div></div><div id="Sec8" class="Section1 RenderAsSection1"><h2 class="Heading">Conclusion</h2><div id="Par150" class="Para">Your API now responds to exceptions more intelligently, and API consumers will get better feedback when things go wrong. Along the way, you worked on
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par151" class="Para">Defining model factories</div></li><li><div id="Par152" class="Para">Using a dedicated test database</div></li><li><div id="Par153" class="Para">Installing and using Mockery</div></li><li><div id="Par154" class="Para ParaOneEmphasisChild">Customizing the <span class="EmphasisFontCategoryNonProportional">App\Exceptions\Handler</span> response</div></li><li><div id="Par155" class="Para">Understanding how Lumen responds to exceptions</div></li></ul></div>
      </div><div id="Par156" class="Para">I hope you spend more time on your own playing with Mockery; it’s a wonderful mocking library. Mocking takes time and practice but is well worth the effort.</div></div></div></body></html>
