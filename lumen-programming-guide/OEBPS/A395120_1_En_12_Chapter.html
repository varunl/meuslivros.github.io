<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>Ratings</title><link href="springer_epub.css" type="text/css" rel="styleSheet"/></head><body><div class="ChapterContextInformation"><div class="ContextInformation" id="b978-1-4842-2187-7_12"><div class="ChapterCopyright">© Paul Redmond 2016</div><span class="ContextInformationAuthorEditorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span></span></span><span class="ContextInformationBookTitles"><span class="BookTitle" xml:lang="en">Lumen Programming Guide</span></span><span class="ChapterDOI">10.1007/978-1-4842-2187-7_12</span></div></div><!--Begin Abstract--><div class="MainTitleSection"><h1 class="ChapterTitle" xml:lang="en">12. Ratings</h1></div><div class="AuthorGroup"><div class="AuthorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span><sup>1 <span class="ContactIcon"/></sup></span></div><div class="Affiliations"><div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">Phoenix, Arizona, USA</div></div><div class="ClearBoth"> </div></div></div><!--End Abstract--><div class="Fulltext"><div id="Par1" class="Para">The final chapter will focus on adding the ability to rate things. When you think of ratings, you might think of book ratings, but actually you can apply ratings to multiple things. Specifically, you will add ratings to <span class="EmphasisTypeItalic">authors</span>. Using Eloquent makes it easy to apply data like ratings to multiple models (as you will see shortly) using polymorphic relationships (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/eloquent-relationships#polymorphic-relations"><span class="RefSource">
              <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/eloquent-relationships#polymorphic-relations</span>
            </span></a></span>). Polymorphic relationships allow a model (ratings) to belong to more than one model. In the context of your API, ratings make sense for authors, books, and bundles.</div><div id="Par2" class="Para">Your ratings will be a five star rating system based on an integer value between <span class="EmphasisFontCategoryNonProportional">1</span> and <span class="EmphasisFontCategoryNonProportional">5</span>. You will be laying all the groundwork in this chapter so that adding ratings to multiple models in your API will be almost effortless.</div><div id="Sec1" class="Section1 RenderAsSection1"><h2 class="Heading">Database Design</h2><div id="Par3" class="Para">Eloquent provides polymorphic associations out of the box and it’s really easy to get something working quickly. Your database design will start by defining a migration for the <span class="EmphasisFontCategoryNonProportional">ratings</span> table. Based on the polymorphic documentation, you should come up with something like Listing <span class="InternalRef"><a href="#Par4">12-1</a></span>.</div><div id="Par4" class="Para">
            <div class="ProgramCode" id="PC1"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan make:migration \</div><div class="FixedLine">create_ratings_table --create=ratings</div><div class="FixedLine">Created Migration: 2015_12_12_061605_create_ratings_table</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-1.</span><div class="SimplePara">Creating the Ratings Table Migration</div></div></div></div>
          </div><div id="Par5" class="Para">The migration for the ratings table will define the value, the associated model id, and the model type (Listing <span class="InternalRef"><a href="#Par6">12-2</a></span>).</div><div id="Par6" class="Para">
            <div class="ProgramCode" id="PC2"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Schema\Blueprint;</div><div class="FixedLine"> 4  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Migrations\Migration;</div><div class="FixedLine"> 5</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">class CreateRatingsTable extends</span> Migration</div><div class="FixedLine"> 7  {</div><div class="FixedLine"> 8      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 9       <span class="EmphasisTypeItalic">* Run the migrations.</span>
          </div><div class="FixedLine">10       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">11       <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">12       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">13      <span class="EmphasisTypeBold">public function</span> up()</div><div class="FixedLine">14      {</div><div class="FixedLine">15          Schema::create('ratings', <span class="EmphasisTypeBold">function</span> (Blueprint $table) {</div><div class="FixedLine">16              $table-&gt;increments('id');</div><div class="FixedLine">17              $table-&gt;integer('value')-&gt;unsigned();</div><div class="FixedLine">18              $table-&gt;integer('rateable_id')-&gt;unsigned();</div><div class="FixedLine">19              $table-&gt;string('rateable_type');</div><div class="FixedLine">20              $table-&gt;timestamps();</div><div class="FixedLine">21          });</div><div class="FixedLine">22      }</div><div class="FixedLine">23</div><div class="FixedLine">24      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">25       <span class="EmphasisTypeItalic">* Reverse the migrations.</span>
          </div><div class="FixedLine">26       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">27       <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">28       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">29      <span class="EmphasisTypeBold">public function</span> down()</div><div class="FixedLine">30      {</div><div class="FixedLine">31          Schema::drop('ratings');</div><div class="FixedLine">32      }</div><div class="FixedLine">33  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-2.</span><div class="SimplePara">Ratings Table Database Migration Code</div></div></div></div>
          </div><div id="Par7" class="Para">Your migration defines an unsigned integer field of <span class="EmphasisFontCategoryNonProportional">value</span> to hold the rating. The polymorphic association needs two other fields: <span class="EmphasisFontCategoryNonProportional">rateable_id</span> and <span class="EmphasisFontCategoryNonProportional">rateable_type</span>. The former is the id of the “owning” model (Author) and the latter is the class name of the “owning” model (<span class="EmphasisFontCategoryNonProportional">App\Author</span>). The rest of the migration should be familiar at this point.</div><div id="Par8" class="Para">With the ratings table defined, your next step is to create a new <span class="EmphasisFontCategoryNonProportional">Rating</span> model and update your <span class="EmphasisFontCategoryNonProportional">Author</span> model to support ratings. Create the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">app/Rating.php</span></span> model with the code in Listing <span class="InternalRef"><a href="#Par9">12-3</a></span>.</div><div id="Par9" class="Para">
            <div class="ProgramCode" id="PC3"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Eloquent\Model;</div><div class="FixedLine"> 6</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">class Rating extends</span> Model</div><div class="FixedLine"> 8  {</div><div class="FixedLine"> 9      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">10       <span class="EmphasisTypeItalic">* @inheritdoc</span>
          </div><div class="FixedLine">11       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">12      <span class="EmphasisTypeBold">protected</span> $fillable = ['value'];</div><div class="FixedLine">13</div><div class="FixedLine">14      <span class="EmphasisTypeBold">public function</span> rateable()</div><div class="FixedLine">15      {</div><div class="FixedLine">16          <span class="EmphasisTypeBold">return</span> $this-&gt;morphTo();</div><div class="FixedLine">17      }</div><div class="FixedLine">18  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-3.</span><div class="SimplePara">The Rating Model</div></div></div></div>
          </div><div id="Par10" class="Para">Notice the correlation between the method name of <span class="EmphasisFontCategoryNonProportional">rateable()</span> and the database field name prefix of <span class="EmphasisFontCategoryNonProportional">rateable_</span>. The <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">return $this-&gt;morphTo()</span></span> call is defining the polymorphic inverse relationship. You also define the <span class="EmphasisFontCategoryNonProportional">value</span> field as the only fillable field since the other fields will be managed by Eloquent automatically.</div><div id="Par11" class="Para">Next, you are going to create a PHP Trait (<span class="ExternalRef"><a href="http://php.net/manual/en/language.oop5.traits.php"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">http://php.net/manual/en/language.oop5.traits.php</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> that models can use to add the other end of the polymorphic relationship easily. Create a file at <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">app/Rateable.php</span></span> with the code in Listing <span class="InternalRef"><a href="#Par12">12-4</a></span>.</div><div id="Par12" class="Para">
            <div class="ProgramCode" id="PC4"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 6   <span class="EmphasisTypeItalic">* Trait to enable polymorphic ratings on a model.</span>
          </div><div class="FixedLine"> 7   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine"> 8   <span class="EmphasisTypeItalic">* @package App</span>
          </div><div class="FixedLine"> 9   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">10  <span class="EmphasisTypeBold">trait</span> Rateable</div><div class="FixedLine">11  {</div><div class="FixedLine">12      <span class="EmphasisTypeBold">public function</span> ratings()</div><div class="FixedLine">13      {</div><div class="FixedLine">14          <span class="EmphasisTypeBold">return</span> $this-&gt;morphMany(Rating::class, 'rateable');</div><div class="FixedLine">15      }</div><div class="FixedLine">16  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-4.</span><div class="SimplePara">The Rateable Trait</div></div></div></div>
          </div><div id="Par13" class="Para">When a model uses the <span class="EmphasisFontCategoryNonProportional">Rateable</span> trait, the <span class="EmphasisFontCategoryNonProportional">ratings()</span> method will define a one-to-many polymorphic relationship, meaning that the <span class="EmphasisFontCategoryNonProportional">Author</span> model will have many ratings and a single <span class="EmphasisFontCategoryNonProportional">Rating</span> will <span class="EmphasisTypeItalic">belongTo</span> an <span class="EmphasisFontCategoryNonProportional">Author</span>. Other models can add this trait to implement ratings, and this makes it easy at a glance to see that a model is “rateable.”</div><div id="Par14" class="Para">Next, add the new trait to the <span class="EmphasisFontCategoryNonProportional">Author</span> and <span class="EmphasisFontCategoryNonProportional">Book</span> models (Listing <span class="InternalRef"><a href="#Par15">12-5</a></span>).</div><div id="Par15" class="Para">
            <div class="ProgramCode" id="PC5"><div class="LineGroup"><div class="FixedLine">
              <span class="EmphasisTypeBold">class Book extends</span> Model</div><div class="FixedLine">{</div><div class="FixedLine">    <span class="EmphasisTypeBold">use</span> Rateable;</div></div><div class="LineGroup"><div class="FixedLine">    <span class="EmphasisTypeItalic">// ...</span>
            </div><div class="FixedLine">}</div></div><div class="LineGroup"><div class="FixedLine">
              <span class="EmphasisTypeBold">class Author extends</span> Model</div><div class="FixedLine">{</div><div class="FixedLine">    <span class="EmphasisTypeBold">use</span> Rateable;</div></div><div class="LineGroup"><div class="FixedLine">    <span class="EmphasisTypeItalic">// ...</span>
            </div><div class="FixedLine">}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-5.</span><div class="SimplePara">Adding the Rateable Trait</div></div></div></div>
          </div><div id="Par16" class="Para">I’ve provided one code sample for both models since adding the trait is such a small amount of code. Now your models can store ratings in the database! You are ready to create a factory and seed data now for ratings.</div><div id="Par17" class="Para">First, append the factory in Listing <span class="InternalRef"><a href="#Par18">12-6</a></span> to the <span class="EmphasisFontCategoryNonProportional">database/factories/ModelFactory.php</span> file.</div><div id="Par18" class="Para">
            <div class="ProgramCode" id="PC6"><div class="FixedLine">48  $factory-&gt;define(\App\Rating::class, <span class="EmphasisTypeBold">function</span> ($faker) {</div><div class="FixedLine">49      <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">50          'value' =&gt; rand(1, 5)</div><div class="FixedLine">51      ];</div><div class="FixedLine">52  });</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-6.</span><div class="SimplePara">The Rating Factory</div></div></div></div>
          </div><div id="Par19" class="Para">The factory randomly assigns 1-5 stars for a rating. Note that you will not use <span class="EmphasisFontCategoryNonProportional">factory()-&gt;create()</span> on the ratings factory. You will mostly use <span class="EmphasisFontCategoryNonProportional">factory()-&gt;make()</span> and then save the ratings through other models.</div><div id="Par20" class="Para">To use your new factory, you will refactor the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">database/seeds/BooksTableSeeder.php</span></span> file to insert ratings into <span class="EmphasisFontCategoryNonProportional">author</span> and <span class="EmphasisFontCategoryNonProportional">book</span> seed data (Listing <span class="InternalRef"><a href="#Par21">12-7</a></span>).</div><div id="Par21" class="Para">
            <div class="ProgramCode" id="PC7"><div class="FixedLine"> 9  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">10   <span class="EmphasisTypeItalic">* Run the database seeds.</span>
          </div><div class="FixedLine">11   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">12   <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">13   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">14  <span class="EmphasisTypeBold">public function</span> run()</div><div class="FixedLine">15  {</div><div class="FixedLine">16      $authors = factory(App\Author::class, 10)-&gt;create();</div><div class="FixedLine">17      $authors-&gt;each(<span class="EmphasisTypeBold">function</span> ($author) {</div><div class="FixedLine">18          $author-&gt;ratings()-&gt;saveMany(</div><div class="FixedLine">19              factory(App\Rating::class, rand(20, 50))-&gt;make()</div><div class="FixedLine">20          );</div><div class="FixedLine">21</div><div class="FixedLine">22          $booksCount = rand(1, 5);</div><div class="FixedLine">23</div><div class="FixedLine">24          <span class="EmphasisTypeBold">while</span> ($booksCount &gt; 0) {</div><div class="FixedLine">25              $book = factory(App\Book::class)-&gt;make();</div><div class="FixedLine">26              $author-&gt;books()-&gt;save($book);</div><div class="FixedLine">27              $book-&gt;ratings()-&gt;saveMany(</div><div class="FixedLine">28                  factory(App\Rating::class, rand(20, 50))-&gt;make()</div><div class="FixedLine">29              );</div><div class="FixedLine">30              $booksCount--;</div><div class="FixedLine">31          }</div><div class="FixedLine">32      });</div><div class="FixedLine">33  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-7.</span><div class="SimplePara">Adding Ratings to the Books Database Seeder</div></div></div></div>
          </div><div id="Par22" class="Para">Now your database seeder is creating ratings for each author, and then ratings for each book. You use <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">rand(20, 50)</span></span> to add between 20 and 50 ratings with <span class="EmphasisFontCategoryNonProportional">ratings()-&gt;saveMany()</span>. As noted earlier, you call <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">factory(App\Rating::class, rand(20, 50))-&gt;make()</span></span> and use the associated models to persist ratings to the database. You should be able to seed the database now with the artisan command (Listing <span class="InternalRef"><a href="#Par23">12-8</a></span>).</div><div id="Par23" class="Para">
            <div class="ProgramCode" id="PC8"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan migrate:refresh</div><div class="FixedLine">...</div><div class="FixedLine">$ php artisan db:seed</div><div class="FixedLine">Seeded: BooksTableSeeder</div><div class="FixedLine">Seeded: BundlesTableSeeder</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-8.</span><div class="SimplePara">Migrating and Seeding the Database</div></div></div></div>
          </div><div id="Par24" class="Para ParaOneEmphasisChild">If you inspect the database you should see ratings in the <span class="EmphasisFontCategoryNonProportional">ratings</span> table for both authors and books. Eloquent and Laravel make it easy to model data quickly and get stuff done!</div></div><div id="Sec2" class="Section1 RenderAsSection1"><h2 class="Heading">Rating an Author</h2><div id="Par25" class="Para">The design of the author ratings API will be a nested resource specific to author ratings. The following are examples of the author rating endpoints you will be writing:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par26" class="Para ParaOneEmphasisChild">
              <span class="EmphasisFontCategoryNonProportional">POST /authors/1/ratings</span> for adding a new rating</div></li><li><div id="Par27" class="Para ParaOneEmphasisChild">
              <span class="EmphasisFontCategoryNonProportional">DELETE /authors/1/ratings/1</span> for deleting an existing author rating</div></li></ul></div>
      </div><div id="Par28" class="Para">Define the new author rating routes in <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">app/Http/routes.php</span></span> to get started (Listing <span class="InternalRef"><a href="#Par29">12-9</a></span>).</div><div id="Par29" class="Para">
            <div class="ProgramCode" id="PC9"><div class="FixedLine">27  $app-&gt;group([</div><div class="FixedLine">28      'prefix' =&gt; '/authors',</div><div class="FixedLine">29      'namespace' =&gt; 'App\Http\Controllers'</div><div class="FixedLine">30  ], <span class="EmphasisTypeBold">function</span> (\Laravel\Lumen\Application $app) {</div><div class="FixedLine">31      $app-&gt;get('/', 'AuthorsController@index');</div><div class="FixedLine">32      $app-&gt;post('/', 'AuthorsController@store');</div><div class="FixedLine">33      $app-&gt;get('/{id:[\d]+}', [</div><div class="FixedLine">34          'as' =&gt; 'authors.show',</div><div class="FixedLine">35          'uses' =&gt; 'AuthorsController@show'</div><div class="FixedLine">36      ]);</div><div class="FixedLine">37      $app-&gt;put('/{id:[\d]+}', 'AuthorsController@update');</div><div class="FixedLine">38      $app-&gt;delete('/{id:[\d]+}', 'AuthorsController@destroy');</div><div class="FixedLine">39</div><div class="FixedLine">40      <span class="EmphasisTypeBoldItalic">// Author ratings</span>
          </div><div class="FixedLine">41      <span class="EmphasisTypeBold">$app-&gt;post('/{id:[\d]+}/ratings', 'AuthorsRatingsController@store');</span>
          </div><div class="FixedLine">42      <span class="EmphasisTypeBold">$app-&gt;delete(</span>
          </div><div class="FixedLine">43          <span class="EmphasisTypeBold">'/{authorId:[\d]+}/ratings/{ratingId:[\d]+}',</span>
          </div><div class="FixedLine">44          <span class="EmphasisTypeBold">'AuthorsRatingsController@destroy'</span>
          </div><div class="FixedLine">45      <span class="EmphasisTypeBold">);</span>
          </div><div class="FixedLine">46  });</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-9.</span><div class="SimplePara">Author Ratings Routes in app/Http/routes.php</div></div></div></div>
          </div><div id="Par30" class="Para">Note the <span class="EmphasisFontCategoryNonProportional">{authorId:[\d]+}</span> route param, which is needed to differentiate with the <span class="EmphasisFontCategoryNonProportional">ratingId</span>—route params must be unique. You will organize author rating management in a new controller but nest the routes within the <span class="EmphasisFontCategoryNonProportional">/authors</span> resource routes.</div><div id="Sec3" class="Section2 RenderAsSection2"><h3 class="Heading">Adding an Author Rating</h3><div id="Par31" class="Para">The first route you will test is adding a new rating to an author. When the Controller endpoint is complete you will expect a response similar to Listing <span class="InternalRef"><a href="#Par32">12-10</a></span>.</div><div id="Par32" class="Para">
              <div class="ProgramCode" id="PC10"><div class="FixedLine">{</div><div class="FixedLine">    <span class="EmphasisTypeBold">"data"</span>:{</div><div class="FixedLine">        <span class="EmphasisTypeBold">"id"</span>:1409,</div><div class="FixedLine">        <span class="EmphasisTypeBold">"value"</span>:"5",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"type"</span>:"App\\Author",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"links"</span>:[</div><div class="FixedLine">            {</div><div class="FixedLine">                <span class="EmphasisTypeBold">"rel"</span>:"author",</div><div class="FixedLine">                <span class="EmphasisTypeBold">"href"</span>:"http:\/\/localhost:8000\/authors\/1"</div><div class="FixedLine">            }</div><div class="FixedLine">        ],</div><div class="FixedLine">        <span class="EmphasisTypeBold">"created"</span>:"2015-12-12T16:42:24+0000",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"updated"</span>:"2015-12-12T16:42:24+0000"</div><div class="FixedLine">    }</div><div class="FixedLine">}</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-10.</span><div class="SimplePara">Example Response from AuthorsRatingsController@store</div></div></div></div>
            </div><div id="Par33" class="Para">Let’s get to work on writing tests and a controller for your work. First, let’s create the Author’s ratings controller and test (Listing <span class="InternalRef"><a href="#Par34">12-11</a></span>).</div><div id="Par34" class="Para">
              <div class="ProgramCode" id="PC11"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ touch tests/app/Http/Controllers/AuthorsRatingsControllerTest.php</div><div class="FixedLine">$ touch app/Http/Controllers/AuthorsRatingsController.php</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-11.</span><div class="SimplePara">Creating the AuthorRatingsController and Test File</div></div></div></div>
            </div><div id="Par35" class="Para">Your first test in the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">tests/app/Http/Controllers/AuthorsRatingsControllerTest.php</span></span> file will test adding a new rating to an author (Listing <span class="InternalRef"><a href="#Par36">12-12</a></span>).</div><div id="Par36" class="Para">
              <div class="ProgramCode" id="PC12"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> Laravel\Lumen\Testing\DatabaseMigrations;</div><div class="FixedLine"> 7</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">class AuthorsRatingsControllerTest extends</span> TestCase</div><div class="FixedLine"> 9  {</div><div class="FixedLine">10      <span class="EmphasisTypeBold">use</span> DatabaseMigrations;</div><div class="FixedLine">11</div><div class="FixedLine">12      <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">13      <span class="EmphasisTypeBold">public function</span> store_can_add_a_rating_to_an_author()</div><div class="FixedLine">14      {</div><div class="FixedLine">15          $author = factory(\App\Author::class)-&gt;create();</div><div class="FixedLine">16</div><div class="FixedLine">17          $this-&gt;post(</div><div class="FixedLine">18              "/authors/<span class="EmphasisTypeBold">{</span>$author-&gt;id<span class="EmphasisTypeBold">}</span>/ratings",</div><div class="FixedLine">19              ['value' =&gt; 5],</div><div class="FixedLine">20              ['Accept' =&gt; 'application/json']</div><div class="FixedLine">21          );</div><div class="FixedLine">22</div><div class="FixedLine">23          $this</div><div class="FixedLine">24              -&gt;seeStatusCode(201)</div><div class="FixedLine">25              -&gt;seeJson([</div><div class="FixedLine">26                  'value' =&gt; 5</div><div class="FixedLine">27              ])</div><div class="FixedLine">28              -&gt;seeJson([</div><div class="FixedLine">29                  'rel' =&gt; 'author',</div><div class="FixedLine">30                  'href' =&gt; route('authors.show', ['id' =&gt; $author-&gt;id])</div><div class="FixedLine">31              ]);</div><div class="FixedLine">32</div><div class="FixedLine">33          $body = $this-&gt;response-&gt;getData(<span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">34          $this-&gt;assertArrayHasKey('data', $body);</div><div class="FixedLine">35</div><div class="FixedLine">36          $data = $body['data'];</div><div class="FixedLine">37          $this-&gt;assertArrayHasKey('links', $data);</div><div class="FixedLine">38      }</div><div class="FixedLine">39  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-12.</span><div class="SimplePara">Test for Adding Author Ratings</div></div></div></div>
            </div><div id="Par37" class="Para">This test submits a rating of “5” and makes sure that the value is returned. The test also checks for a <span class="EmphasisFontCategoryNonProportional">links</span> key which will contain an <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">href</span></span> to the created rating resource and an href to the author associated with this rating.</div><div id="FPar1" class="FormalPara FormalParaRenderingStyle3 ParaTypeOverview"><div class="Heading">Hateoas</div><div id="Par38" class="Para">For those keeping track, this book hasn’t talked about or addressed HATEOAS (<span class="ExternalRef"><a href="https://en.wikipedia.org/wiki/HATEOAS"><span class="RefSource">
                    <span class="EmphasisFontCategoryNonProportional">https://en.wikipedia.org/wiki/HATEOAS</span>
                  </span></a></span>
            <span class="EmphasisFontCategoryNonProportional">)</span> (Hypermedia as the Engine of Application State) much at all, but I have provided a few examples how you can use the <span class="EmphasisFontCategoryNonProportional">route()</span> helper function to make generating links between data simple.</div><div id="Par39" class="Para">You can leverage Fractal transformers to take care of HATEOAS data and I encourage you to learn more of the theory and good practices around writing RESTful services, including HATEOAS, if you are not familiar.</div></div><div id="Par40" class="Para">Before you start working on the controller, you will need another Fractal transformer for ratings. The transformer will need to be a little smarter than your previous transformers since it will transform multiple types, and you want to provide additional data about a rating and how it relates to other models.</div><div id="Par41" class="Para">Create the new rating transformer file and accompanying test (Listing <span class="InternalRef"><a href="#Par42">12-13</a></span>).</div><div id="Par42" class="Para">
              <div class="ProgramCode" id="PC13"><div class="FixedLine">$ touch tests/app/Transformer/RatingTransformerTest.php</div><div class="FixedLine">$ touch app/Transformer/RatingTransformer.php</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-13.</span><div class="SimplePara">Creating the RatingTransformer and Test Files</div></div></div></div>
            </div><div id="Par43" class="Para">The initial <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">RatingTransformerTest</span></span> class will include the basic initialization test you add for each transformer and a test to transform an author rating (Listing <span class="InternalRef"><a href="#Par44">12-14</a></span>).</div><div id="Par44" class="Para">
              <div class="ProgramCode" id="PC14"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Transformer;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> App\Transformer\RatingTransformer;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> Laravel\Lumen\Testing\DatabaseMigrations;</div><div class="FixedLine"> 8</div><div class="FixedLine"> 9  <span class="EmphasisTypeBold">class RatingTransformerTest extends</span> TestCase</div><div class="FixedLine">10  {</div><div class="FixedLine">11      <span class="EmphasisTypeBold">use</span> DatabaseMigrations;</div><div class="FixedLine">12</div><div class="FixedLine">13      <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">14       <span class="EmphasisTypeItalic">* @var RatingTransformer</span>
            </div><div class="FixedLine">15       <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">16      <span class="EmphasisTypeBold">private</span> $subject;</div><div class="FixedLine">17</div><div class="FixedLine">18      <span class="EmphasisTypeBold">public function</span> setUp()</div><div class="FixedLine">19      {</div><div class="FixedLine">20          <span class="EmphasisTypeBold">parent</span>::setUp();</div><div class="FixedLine">21</div><div class="FixedLine">22          $this-&gt;subject = <span class="EmphasisTypeBold">new</span> RatingTransformer();</div><div class="FixedLine">23      }</div><div class="FixedLine">24</div><div class="FixedLine">25      <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">26      <span class="EmphasisTypeBold">public function</span> it_can_be_initialized()</div><div class="FixedLine">27      {</div><div class="FixedLine">28          $this-&gt;assertInstanceOf(RatingTransformer::class, $this-&gt;subject);</div><div class="FixedLine">29      }</div><div class="FixedLine">30</div><div class="FixedLine">31      <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">32      <span class="EmphasisTypeBold">public function</span> it_can_transform_a_rating_for_an_author()</div><div class="FixedLine">33      {</div><div class="FixedLine">34          $author = factory(\App\Author::class)-&gt;create();</div><div class="FixedLine">35          $rating = $author-&gt;ratings()-&gt;save(</div><div class="FixedLine">36              factory(\App\Rating::class)-&gt;make()</div><div class="FixedLine">37          );</div><div class="FixedLine">38</div><div class="FixedLine">39</div><div class="FixedLine">40          $actual = $this-&gt;subject-&gt;transform($rating);</div><div class="FixedLine">41</div><div class="FixedLine">42          $this-&gt;assertEquals($rating-&gt;id, $actual['id']);</div><div class="FixedLine">43          $this-&gt;assertEquals($rating-&gt;value, $actual['value']);</div><div class="FixedLine">44          $this-&gt;assertEquals($rating-&gt;rateable_type, $actual['type']);</div><div class="FixedLine">45          $this-&gt;assertEquals(</div><div class="FixedLine">46              $rating-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">47              $actual['created']</div><div class="FixedLine">48          );</div><div class="FixedLine">49          $this-&gt;assertEquals(</div><div class="FixedLine">50              $rating-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">51              $actual['created']</div><div class="FixedLine">52          );</div><div class="FixedLine">53</div><div class="FixedLine">54          $this-&gt;assertArrayHasKey('links', $actual);</div><div class="FixedLine">55          $links = $actual['links'];</div><div class="FixedLine">56          $this-&gt;assertCount(1, $links);</div><div class="FixedLine">57          $authorLink = $links[0];</div><div class="FixedLine">58</div><div class="FixedLine">59          $this-&gt;assertArrayHasKey('rel', $authorLink);</div><div class="FixedLine">60          $this-&gt;assertEquals('author', $authorLink['rel']);</div><div class="FixedLine">61          $this-&gt;assertArrayHasKey('href', $authorLink);</div><div class="FixedLine">62          $this-&gt;assertEquals(</div><div class="FixedLine">63              route('authors.show', ['id' =&gt; $author-&gt;id]),</div><div class="FixedLine">64              $authorLink['href']</div><div class="FixedLine">65          );</div><div class="FixedLine">66      }</div><div class="FixedLine">67  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-14.</span><div class="SimplePara">Initial RatingTransformerTest Class</div></div></div></div>
            </div><div id="Par45" class="Para">Like all the other transformer tests you’ve covered, you test that the transformer can be initialized. The <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">it_can_transform_a_rating_for_an_author</span></span> test checks for keys and values to make sure the transformer formats data as you expect. The test also verifies the <span class="EmphasisFontCategoryNonProportional">links</span> property, which should contain an author resource with an href to the author API entity.</div><div id="Par46" class="Para">Listing <span class="InternalRef"><a href="#Par47">12-15</a></span> shows what your first <span class="EmphasisFontCategoryNonProportional">RatingTransformer</span> implementation looks like.</div><div id="Par47" class="Para">
              <div class="ProgramCode" id="PC15"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Transformer;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> App\Rating;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> League\Fractal\TransformerAbstract;</div><div class="FixedLine"> 7</div><div class="FixedLine"> 8  <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine"> 9   <span class="EmphasisTypeItalic">* Class RatingTransformer</span>
            </div><div class="FixedLine">10   <span class="EmphasisTypeItalic">* @package App\Transformer</span>
            </div><div class="FixedLine">11   <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">12  <span class="EmphasisTypeBold">class RatingTransformer extends</span> TransformerAbstract</div><div class="FixedLine">13  {</div><div class="FixedLine">14      <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">15       <span class="EmphasisTypeItalic">* Transform a Rating</span>
            </div><div class="FixedLine">16       <span class="EmphasisTypeItalic">*</span>
            </div><div class="FixedLine">17       <span class="EmphasisTypeItalic">* @param Rating $rating</span>
            </div><div class="FixedLine">18       <span class="EmphasisTypeItalic">* @return array</span>
            </div><div class="FixedLine">19       <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">20      <span class="EmphasisTypeBold">public function</span> transform(Rating $rating)</div><div class="FixedLine">21      {</div><div class="FixedLine">22          <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">23              'id' =&gt; $rating-&gt;id,</div><div class="FixedLine">24              'value' =&gt; $rating-&gt;value,</div><div class="FixedLine">25              'type' =&gt; $rating-&gt;rateable_type,</div><div class="FixedLine">26              'links' =&gt; [</div><div class="FixedLine">27                  [</div><div class="FixedLine">28                      'rel' =&gt; 'author',</div><div class="FixedLine">29                      'href' =&gt; route('authors.show', ['id' =&gt; $rating-&gt;rateable_id])</div><div class="FixedLine">30                  ]</div><div class="FixedLine">31              ],</div><div class="FixedLine">32              'created' =&gt; $rating-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">33              'updated' =&gt; $rating-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">34          ];</div><div class="FixedLine">35      }</div><div class="FixedLine">36  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-15.</span><div class="SimplePara">First Version of the RatingTransformer Implementation</div></div></div></div>
            </div><div id="Par48" class="Para">You’ve side-stepped the failing test for <span class="EmphasisFontCategoryNonProportional">RatingsAuthorsController</span> that you originally wrote in this section to work on the <span class="EmphasisFontCategoryNonProportional">RatingTransformer</span>. You cannot run the full test suite, but the initial passing version of the <span class="EmphasisFontCategoryNonProportional">RatingTransfomer</span> hard-codes the author link data and your <span class="EmphasisFontCategoryNonProportional">RatingTransformer</span> tests should pass now (Listing <span class="InternalRef"><a href="#Par49">12-16</a></span>).</div><div id="Par49" class="Para">
              <div class="ProgramCode" id="PC16"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=RatingTransformerTest</div></div><div class="LineGroup"><div class="FixedLine">OK (2 tests, 12 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-16.</span><div class="SimplePara">Running Tests for the RatingTransformer</div></div></div></div>
            </div><div id="Par50" class="Para">Before you write the passing implementation for the <span class="EmphasisFontCategoryNonProportional">AuthorsRatingsController,</span> let’s refactor the transformer to be more dynamic and capable of transforming a rating for other entities (Listing <span class="InternalRef"><a href="#Par51">12-17</a></span>).</div><div id="Par51" class="Para">
              <div class="ProgramCode" id="PC17"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Transformer;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> App\Rating;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> League\Fractal\TransformerAbstract;</div><div class="FixedLine"> 7</div><div class="FixedLine"> 8  <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine"> 9   <span class="EmphasisTypeItalic">* Class RatingTransformer</span>
            </div><div class="FixedLine">10   <span class="EmphasisTypeItalic">* @package App\Transformer</span>
            </div><div class="FixedLine">11   <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">12  <span class="EmphasisTypeBold">class RatingTransformer extends</span> TransformerAbstract</div><div class="FixedLine">13  {</div><div class="FixedLine">14      <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">15       <span class="EmphasisTypeItalic">* Transform a Rating</span>
            </div><div class="FixedLine">16       <span class="EmphasisTypeItalic">*</span>
            </div><div class="FixedLine">17       <span class="EmphasisTypeItalic">* @param Rating $rating</span>
            </div><div class="FixedLine">18       <span class="EmphasisTypeItalic">* @return array</span>
            </div><div class="FixedLine">19       <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">20      <span class="EmphasisTypeBold">public function</span> transform(Rating $rating)</div><div class="FixedLine">21      {</div><div class="FixedLine">22          <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">23              'id' =&gt; $rating-&gt;id,</div><div class="FixedLine">24              'value' =&gt; $rating-&gt;value,</div><div class="FixedLine">25              'type' =&gt; $rating-&gt;rateable_type,</div><div class="FixedLine">26              'links' =&gt; [</div><div class="FixedLine">27                  [</div><div class="FixedLine">28                      'rel' =&gt; $this-&gt;getModelName($rating-&gt;rateable_type),</div><div class="FixedLine">29                      'href' =&gt; $this-&gt;getModelUrl($rating)</div><div class="FixedLine">30                  ]</div><div class="FixedLine">31              ],</div><div class="FixedLine">32              'created' =&gt; $rating-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">33              'updated' =&gt; $rating-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">34          ];</div><div class="FixedLine">35      }</div><div class="FixedLine">36</div><div class="FixedLine">37      <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">38       <span class="EmphasisTypeItalic">* Get a human-friendly model name</span>
            </div><div class="FixedLine">39       <span class="EmphasisTypeItalic">*</span>
            </div><div class="FixedLine">40       <span class="EmphasisTypeItalic">* @param $rateable_type</span>
            </div><div class="FixedLine">41       <span class="EmphasisTypeItalic">* @return string</span>
            </div><div class="FixedLine">42       <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">43      <span class="EmphasisTypeBold">private function</span> getModelName($rateable_type)</div><div class="FixedLine">44      {</div><div class="FixedLine">45          <span class="EmphasisTypeBold">return</span> strtolower(preg_replace("/^App<span class="EmphasisTypeBold">\\</span>\/", '', $rateable_type));</div><div class="FixedLine">46      }</div><div class="FixedLine">47</div><div class="FixedLine">48      <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">49       <span class="EmphasisTypeItalic">* Generate a URL to the rated model resyource</span>
            </div><div class="FixedLine">50       <span class="EmphasisTypeItalic">*</span>
            </div><div class="FixedLine">51       <span class="EmphasisTypeItalic">* @param Rating $rating</span>
            </div><div class="FixedLine">52       <span class="EmphasisTypeItalic">* @return string</span>
            </div><div class="FixedLine">53       <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">54      <span class="EmphasisTypeBold">private function</span> getModelUrl(Rating $rating)</div><div class="FixedLine">55      {</div><div class="FixedLine">56          $author = \App\Author::class;</div><div class="FixedLine">57          $book = \App\Author::class;</div><div class="FixedLine">58</div><div class="FixedLine">59          <span class="EmphasisTypeBold">switch</span> ($rating-&gt;rateable_type) {</div><div class="FixedLine">60              <span class="EmphasisTypeBold">case</span> $author:</div><div class="FixedLine">61                  $named = 'authors.show';</div><div class="FixedLine">62                  <span class="EmphasisTypeBold">break</span>;</div><div class="FixedLine">63              <span class="EmphasisTypeBold">case</span> $book:</div><div class="FixedLine">64                  $named = 'books.show';</div><div class="FixedLine">65                  <span class="EmphasisTypeBold">break</span>;</div><div class="FixedLine">66              <span class="EmphasisTypeBold">default</span>:</div><div class="FixedLine">67                  <span class="EmphasisTypeBold">throw new</span> \RuntimeException(sprintf(</div><div class="FixedLine">68                      'Rateable model type for %s is not defined',</div><div class="FixedLine">69                      $rating-&gt;rateable_type</div><div class="FixedLine">70                  ));</div><div class="FixedLine">71          }</div><div class="FixedLine">72</div><div class="FixedLine">73          <span class="EmphasisTypeBold">return</span> route($named, ['id' =&gt; $rating-&gt;rateable_id]);</div><div class="FixedLine">74      }</div><div class="FixedLine">75  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-17.</span><div class="SimplePara">Refactoring the RatingTransformer to Support Multiple Models</div></div></div></div>
            </div><div id="Par52" class="Para">You’ve added two <span class="EmphasisFontCategoryNonProportional">private</span> methods for dealing with dynamic model data, <span class="EmphasisFontCategoryNonProportional">getModelName()</span> and <span class="EmphasisFontCategoryNonProportional">getModelUrl()</span>. These methods are not <span class="EmphasisTypeItalic">perfect</span> but they get the job done by providing a more human-readable <span class="EmphasisFontCategoryNonProportional">rel</span> type. You will have to keep adding more models to the <span class="EmphasisFontCategoryNonProportional">switch</span> statement in <span class="EmphasisFontCategoryNonProportional">getModelUrl()</span> method when you want to make something “rateable,” but for now it works.</div><div id="Par53" class="Para">Your tests should still pass after the refactor. In real life, you might have to deal with failures along the way, but through the power of <span class="EmphasisFontCategoryNonProportional">books</span>, you get the passing code immediately (Listing <span class="InternalRef"><a href="#Par54">12-18</a></span>).</div><div id="Par54" class="Para">
              <div class="ProgramCode" id="PC18"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=RatingTransformerTest</div></div><div class="LineGroup"><div class="FixedLine">OK (2 tests, 12 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-18.</span><div class="SimplePara">Running the RatingTransformer Tests After Refactoring</div></div></div></div>
            </div><div id="Par55" class="Para">The <span class="EmphasisFontCategoryNonProportional">getModelUrl()</span> will throw an exception if it doesn’t recognize the <span class="EmphasisFontCategoryNonProportional">$rating-&gt;rateable_type</span> so you need to write a test for that (Listing <span class="InternalRef"><a href="#Par56">12-19</a></span>).</div><div id="Par56" class="Para">
              <div class="ProgramCode" id="PC19"><div class="FixedLine">68  <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">69   <span class="EmphasisTypeItalic">* @test</span>
            </div><div class="FixedLine">70   <span class="EmphasisTypeItalic">* @expectedException \RuntimeException</span>
            </div><div class="FixedLine">71   <span class="EmphasisTypeItalic">* @expectedExceptionMessage Rateable model type for Foo\Bar is not defined</span>
            </div><div class="FixedLine">72   <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">73  <span class="EmphasisTypeBold">public function</span> it_throws_an_exception_when_a_model_is_not_defined()</div><div class="FixedLine">74  {</div><div class="FixedLine">75      $rating = factory(\App\Rating::class)-&gt;create([</div><div class="FixedLine">76          'value' =&gt; 5,</div><div class="FixedLine">77          'rateable_type' =&gt; 'Foo\Bar',</div><div class="FixedLine">78          'rateable_id' =&gt; 1</div><div class="FixedLine">79      ]);</div><div class="FixedLine">80</div><div class="FixedLine">81      $this-&gt;subject-&gt;transform($rating);</div><div class="FixedLine">82  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-19.</span><div class="SimplePara">Test for a Thrown Exception in RatingTranformerTest</div></div></div></div>
            </div><div id="Par57" class="Para">You directly create a rating with a fake <span class="EmphasisFontCategoryNonProportional">rateable_type</span> to trigger the exception. This test also uses PHPUnit test annotations (<span class="ExternalRef"><a href="https://phpunit.de/manual/current/en/appendixes.annotations.html#appendixes.annotations.expectedException"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">https://phpunit.de/manual/current/en/appendixes.annotations.html#appendixes.annotations.expectedException</span>
                </span></a></span>
          <span class="EmphasisFontCategoryNonProportional">)</span> to ensure that <span class="EmphasisFontCategoryNonProportional">\RuntimeException</span> is thrown with the correct message.</div><div id="Par58" class="Para">Your transformer passes fully and is ready to use. You can now starting writing the first version of your controller at <span class="EmphasisFontCategoryNonProportional">app/Http/Controllers/AuthorsRatingsController.php</span> and get your tests to pass (Listing <span class="InternalRef"><a href="#Par59">12-20</a></span>).</div><div id="Par59" class="Para">
              <div class="ProgramCode" id="PC20"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> App\Author;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> Illuminate\Http\Request;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> App\Transformer\RatingTransformer;</div><div class="FixedLine"> 8</div><div class="FixedLine"> 9  <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">10   <span class="EmphasisTypeItalic">* Manage an Author's Ratings</span>
            </div><div class="FixedLine">11   <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">12  <span class="EmphasisTypeBold">class AuthorsRatingsController extends</span> Controller</div><div class="FixedLine">13  {</div><div class="FixedLine">14      <span class="EmphasisTypeBold">public function</span> store(Request $request, $authorId)</div><div class="FixedLine">15      {</div><div class="FixedLine">16          $author = Author::findOrFail($authorId);</div><div class="FixedLine">17</div><div class="FixedLine">18          $rating = $author-&gt;ratings()-&gt;create(['value' =&gt; $request-&gt;get('value')]);</div><div class="FixedLine">19          $data = $this-&gt;item($rating, <span class="EmphasisTypeBold">new</span> RatingTransformer());</div><div class="FixedLine">20</div><div class="FixedLine">21          <span class="EmphasisTypeBold">return</span> response()-&gt;json($data, 201);</div><div class="FixedLine">22      }</div><div class="FixedLine">23 }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-20.</span><div class="SimplePara">The AuthorsRatings Controller</div></div></div></div>
            </div><div id="Par60" class="Para">The controller simply checks for a valid author and creates a new rating associated with the author. The controller returns the new rating data with a <span class="EmphasisFontCategoryNonProportional">201 created</span> response. The full test suite should pass now that you’ve implemented the controller (Listing <span class="InternalRef"><a href="#Par61">12-21</a></span>).</div><div id="Par61" class="Para">
              <div class="ProgramCode" id="PC21"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (57 tests, 299 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-21.</span><div class="SimplePara">Running the Full Test Suite</div></div></div></div>
            </div><div id="Par62" class="Para">For your own satisfaction, you can post a rating via the command line on ‘nix systems, as shown in Listing <span class="InternalRef"><a href="#Par63">12-22</a></span>.</div><div id="Par63" class="Para">
              <div class="ProgramCode" id="PC22"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan migrate:refresh</div><div class="FixedLine">$ php artisan db:seed</div><div class="FixedLine">$ curl --data "value=5" -X POST http://bookr.app/authors/1/ratings</div><div class="FixedLine">{</div><div class="FixedLine">    "data":{</div><div class="FixedLine">        "id":1188,</div><div class="FixedLine">        "value":"5",</div><div class="FixedLine">        "type":"App\\Author",</div><div class="FixedLine">        "links":[</div><div class="FixedLine">            {</div><div class="FixedLine">                "rel":"author",</div><div class="FixedLine">                "href":"http:\/\/bookr.app\/authors\/1"</div><div class="FixedLine">            }</div><div class="FixedLine">        ],</div><div class="FixedLine">        "created":"2016-02-02T05:55:42+0000",</div><div class="FixedLine">        "updated":"2016-02-02T05:55:42+0000"</div><div class="FixedLine">    }</div><div class="FixedLine">}</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-22.</span><div class="SimplePara">Adding an Author Rating with Curl</div></div></div></div>
            </div><div id="Par64" class="Para">Now that the code has passed the tests, you will write a test to ensure you get a <span class="EmphasisFontCategoryNonProportional">404</span> response back when the author id is invalid in <span class="EmphasisFontCategoryNonProportional">AuthorsRatingsControllerTest</span> (Listing <span class="InternalRef"><a href="#Par65">12-23</a></span>).</div><div id="Par65" class="Para">
              <div class="ProgramCode" id="PC23"><div class="FixedLine">40  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">41  <span class="EmphasisTypeBold">public function</span> store_fails_when_the_author_is_invalid()</div><div class="FixedLine">42  {</div><div class="FixedLine">43      $this-&gt;post('/authors/1/ratings', [], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">44      $this-&gt;seeStatusCode(404);</div><div class="FixedLine">45  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-23.</span><div class="SimplePara">Test for Trying to Add a Rating to an Invalid Author</div></div></div></div>
            </div><div id="Par66" class="Para">Since you already wrote <span class="EmphasisFontCategoryNonProportional">Author::findOrFail($authorId);</span> this test will pass. Be careful of tests that pass without writing additional code. To verify that your test is indeed valid, temporarily update the controller to Listing <span class="InternalRef"><a href="#Par67">12-24</a></span>.</div><div id="Par67" class="Para">
              <div class="ProgramCode" id="PC24"><div class="FixedLine">14  <span class="EmphasisTypeBold">public function</span> store(Request $request, $authorId)</div><div class="FixedLine">15  {</div><div class="FixedLine">16      $author = Author::find($authorId);</div><div class="FixedLine">17</div><div class="FixedLine">18      $rating = $author-&gt;ratings()-&gt;create(['value' =&gt; $request-&gt;get('value')]);</div><div class="FixedLine">19      $data = $this-&gt;item($rating, <span class="EmphasisTypeBold">new</span> RatingTransformer());</div><div class="FixedLine">20</div><div class="FixedLine">21      <span class="EmphasisTypeBold">return</span> response()-&gt;json($data, 201);</div><div class="FixedLine">22  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-24.</span><div class="SimplePara">Revert AuthorsRatingsController to Make Test Fail</div></div></div></div>
            </div><div id="Par68" class="Para">After changing the <span class="EmphasisFontCategoryNonProportional">AuthorsRatingsController::store()</span> method, you should get the test failure shown in Listing <span class="InternalRef"><a href="#Par69">12-25</a></span>.</div><div id="Par69" class="Para">
              <div class="ProgramCode" id="PC25"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\AuthorsRatingsControllerTest::store_fails_when_the\</div><div class="FixedLine">_author_is_invalid</div><div class="FixedLine">Failed asserting that 400 matches expected 404.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/vendor/laravel/lumen-framework/src/Testing/CrawlerTrait\</div><div class="FixedLine">.php:412</div><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/AuthorsRatingsControllerTest.php:44</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 58, Assertions: 300, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-25.</span><div class="SimplePara">Test Failure After Reverting the AuthorsRatingsController</div></div></div></div>
            </div><div id="Par70" class="Para">Your test will guard against to responding with a 404 when the database lookup fails. Revert the <span class="EmphasisFontCategoryNonProportional">AuthorsRatingsController.php</span> file to Listing <span class="InternalRef"><a href="#Par71">12-26</a></span> to get back to green.</div><div id="Par71" class="Para">
              <div class="ProgramCode" id="PC26"><div class="FixedLine">14  <span class="EmphasisTypeBold">public function</span> store(Request $request, $authorId)</div><div class="FixedLine">15  {</div><div class="FixedLine">16      $author = Author::findOrFail($authorId);</div><div class="FixedLine">17</div><div class="FixedLine">18      $rating = $author-&gt;ratings()-&gt;create(['value' =&gt; $request-&gt;get('value')]);</div><div class="FixedLine">19      $data = $this-&gt;item($rating, <span class="EmphasisTypeBold">new</span> RatingTransformer());</div><div class="FixedLine">20</div><div class="FixedLine">21      <span class="EmphasisTypeBold">return</span> response()-&gt;json($data, 201);</div><div class="FixedLine">22  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-26.</span><div class="SimplePara">Restoring the Correct Store Method</div></div></div></div>
            </div><div id="Par72" class="Para">Check the tests to make sure everything is working as expected (Listing <span class="InternalRef"><a href="#Par73">12-27</a></span>).</div><div id="Par73" class="Para">
              <div class="ProgramCode" id="PC27"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (58 tests, 300 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-27.</span><div class="SimplePara">Running the Full Test Suite</div></div></div></div>
            </div></div><div id="Sec4" class="Section2 RenderAsSection2"><h3 class="Heading">Deleting an Author Rating</h3><div id="Par74" class="Para">Your next feature will be the ability to <span class="EmphasisTypeItalic">delete</span> an existing author rating. You already defined the application delete route earlier in this chapter (Listing <span class="InternalRef"><a href="#Par75">12-28</a></span>).</div><div id="Par75" class="Para">
              <div class="ProgramCode" id="PC28"><div class="FixedLine">$app-&gt;delete(</div><div class="FixedLine">    '/{authorId}:[\d]+}/ratings/{ratingId:[\d]+}',</div><div class="FixedLine">    'AuthorsRatingsController@destroy'</div><div class="FixedLine">);</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-28.</span><div class="SimplePara">The Delete Route for Author Ratings</div></div></div></div>
            </div><div id="Par76" class="Para">The outline for your acceptance criteria:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par77" class="Para">Delete should remove an existing rating from an author.</div></li><li><div id="Par78" class="Para ParaOneEmphasisChild">The <span class="EmphasisFontCategoryNonProportional">ratings</span> table should no longer associate the rating to the author.</div></li><li><div id="Par79" class="Para">The rating should no longer exist in the database.</div></li></ul></div>
        </div><div id="Par80" class="Para">Let’s write the first failing test for deleting a rating from an author in the <span class="EmphasisFontCategoryNonProportional">AuthorsRatingsControllerTest</span> (Listing <span class="InternalRef"><a href="#Par81">12-29</a></span>).</div><div id="Par81" class="Para">
              <div class="ProgramCode" id="PC29"><div class="FixedLine">47  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">48  <span class="EmphasisTypeBold">public function</span> destroy_can_delete_an_author_rating()</div><div class="FixedLine">49  {</div><div class="FixedLine">50      $author = factory(\App\Author::class)-&gt;create();</div><div class="FixedLine">51      $ratings = $author-&gt;ratings()-&gt;saveMany(</div><div class="FixedLine">52          factory(\App\Rating::class, 2)-&gt;make()</div><div class="FixedLine">53      );</div><div class="FixedLine">54</div><div class="FixedLine">55      $this-&gt;assertCount(2, $ratings);</div><div class="FixedLine">56</div><div class="FixedLine">57      $ratings-&gt;each(<span class="EmphasisTypeBold">function</span> (\App\Rating $rating) <span class="EmphasisTypeBold">use</span> ($author) {</div><div class="FixedLine">58          $this-&gt;seeInDatabase('ratings', [</div><div class="FixedLine">59              'rateable_id' =&gt; $author-&gt;id,</div><div class="FixedLine">60              'id' =&gt; $rating-&gt;id</div><div class="FixedLine">61          ]);</div><div class="FixedLine">62      });</div><div class="FixedLine">63</div><div class="FixedLine">64      $ratingToDelete = $ratings-&gt;first();</div><div class="FixedLine">65      $this</div><div class="FixedLine">66          -&gt;delete(</div><div class="FixedLine">67              "/authors/<span class="EmphasisTypeBold">{</span>$author-&gt;id<span class="EmphasisTypeBold">}</span>/ratings/<span class="EmphasisTypeBold">{</span>$ratingToDelete-&gt;id<span class="EmphasisTypeBold">}</span>"</div><div class="FixedLine">68          )</div><div class="FixedLine">69          -&gt;seeStatusCode(204);</div><div class="FixedLine">70</div><div class="FixedLine">71      $dbAuthor = \App\Author::find($author-&gt;id);</div><div class="FixedLine">72      $this-&gt;assertCount(1, $dbAuthor-&gt;ratings);</div><div class="FixedLine">73      $this-&gt;notSeeInDatabase(</div><div class="FixedLine">74          'ratings',</div><div class="FixedLine">75          ['id' =&gt; $ratingToDelete-&gt;id]</div><div class="FixedLine">76      );</div><div class="FixedLine">77  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-29.</span><div class="SimplePara">Test to Delete a Rating from an Author</div></div></div></div>
            </div><div id="Par82" class="Para ParaOneEmphasisChild">First, you seed data for the test; data factory code should look familiar because it is basically the same as the database seeding you saw earlier in this chapter. You then check to make sure that you save two ratings in the database with <span class="EmphasisFontCategoryNonProportional">ratings()-&gt;saveMany()</span> so you can verify that the rating count decreases by one after deleting one rating. Next, you loop through each rating and just double check that each rating is properly associated with the author.</div><div id="Par83" class="Para">With the data seeded and verifying associations, your test gets the rating to be deleted and makes the <span class="EmphasisFontCategoryNonProportional">DELETE</span> request and you expect a <span class="EmphasisFontCategoryNonProportional">204</span> status code in return. Last, you verify that the rating was removed by getting the author from the database and asserting that the author only has one rating, and the rating you deleted is no longer in the <span class="EmphasisFontCategoryNonProportional">ratings</span> table.</div><div id="Par84" class="Para">Technically, the framework takes care of the database associations checked in this test, but extra checking does not hurt and makes me feel safer that my test is accurate.</div><div id="Par85" class="Para">Moving on, you make sure your new test causes a failure (Listing <span class="InternalRef"><a href="#Par86">12-30</a></span>).</div><div id="Par86" class="Para">
              <div class="ProgramCode" id="PC30"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\AuthorsRatingsControllerTest::destroy_can_delete_an_author_rating</div><div class="FixedLine">Failed asserting that 404 matches expected 204.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/vendor/laravel/lumen-framework/src/Testing/CrawlerTrait.php:412</div><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/AuthorsRatingsControllerTest.php:69</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 59, Assertions: 304, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-30.</span><div class="SimplePara">Running the Failing Test</div></div></div></div>
            </div><div id="Par87" class="Para">With the failing test in place, let’s write the first implementation of the <span class="EmphasisFontCategoryNonProportional">AuthorsRatingsController@destroy</span> method (Listing <span class="InternalRef"><a href="#Par88">12-31</a></span>).</div><div id="Par88" class="Para">
              <div class="ProgramCode" id="PC31"><div class="FixedLine">24  <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">25   <span class="EmphasisTypeItalic">* @param $authorId</span>
            </div><div class="FixedLine">26   <span class="EmphasisTypeItalic">* @param $ratingId</span>
            </div><div class="FixedLine">27   <span class="EmphasisTypeItalic">* @return \Laravel\Lumen\Http\ResponseFactory</span>
            </div><div class="FixedLine">28   <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">29  <span class="EmphasisTypeBold">public function</span> destroy($authorId, $ratingId)</div><div class="FixedLine">30  {</div><div class="FixedLine">31      <span class="EmphasisTypeItalic">/** @var \App\Author $author */</span>
            </div><div class="FixedLine">32      $author = Author::findOrFail($authorId);</div><div class="FixedLine">33      $author</div><div class="FixedLine">34          -&gt;ratings()</div><div class="FixedLine">35          -&gt;findOrFail($ratingId)</div><div class="FixedLine">36          -&gt;delete();</div><div class="FixedLine">37</div><div class="FixedLine">38      <span class="EmphasisTypeBold">return</span> response(<span class="EmphasisTypeBold">null</span>, 204);</div><div class="FixedLine">39  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-31.</span><div class="SimplePara">Implementation for Deleting an Author Rating</div></div></div></div>
            </div><div id="Par89" class="Para">Your controller ensures the author exists and then uses the author to find the <span class="EmphasisFontCategoryNonProportional">$ratingId</span>. The request can fail if the <span class="EmphasisFontCategoryNonProportional">$authorId</span> is invalid <span class="EmphasisTypeItalic">or</span> the <span class="EmphasisFontCategoryNonProportional">$ratingId</span> is invalid. You should write some additional tests in the <span class="EmphasisFontCategoryNonProportional">AuthorsRatingsControllerTest</span> class just to ensure that this method fails in the way you expect (Listing <span class="InternalRef"><a href="#Par90">12-32</a></span>).</div><div id="Par90" class="Para">
              <div class="ProgramCode" id="PC32"><div class="FixedLine"> 79  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine"> 80  <span class="EmphasisTypeBold">public function</span> destroy_should_not_delete_ratings_from_another_author()</div><div class="FixedLine"> 81  {</div><div class="FixedLine"> 82      $authors = factory(\App\Author::class, 2)-&gt;create();</div><div class="FixedLine"> 83      $authors-&gt;each(<span class="EmphasisTypeBold">function</span> (\App\Author $author) {</div><div class="FixedLine"> 84          $author-&gt;ratings()-&gt;saveMany(</div><div class="FixedLine"> 85              factory(\App\Rating::class, 2)-&gt;make()</div><div class="FixedLine"> 86          );</div><div class="FixedLine"> 87      });</div><div class="FixedLine"> 88</div><div class="FixedLine"> 89      $firstAuthor = $authors-&gt;first();</div><div class="FixedLine"> 90      $rating = $authors</div><div class="FixedLine"> 91          -&gt;last()</div><div class="FixedLine"> 92          -&gt;ratings()</div><div class="FixedLine"> 93          -&gt;first();</div><div class="FixedLine"> 94</div><div class="FixedLine"> 95      $this-&gt;delete(</div><div class="FixedLine"> 96          "/authors/<span class="EmphasisTypeBold">{</span>$firstAuthor-&gt;id<span class="EmphasisTypeBold">}</span>/ratings/<span class="EmphasisTypeBold">{</span>$rating-&gt;id<span class="EmphasisTypeBold">}</span>",</div><div class="FixedLine"> 97          [],</div><div class="FixedLine"> 98          ['Accept' =&gt; 'application/json']</div><div class="FixedLine"> 99      )-&gt;seeStatusCode(404);</div><div class="FixedLine">100  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-32.</span><div class="SimplePara">Test API Cannot Delete Another Author’s Rating</div></div></div></div>
            </div><div id="Par91" class="Para">The test creates factory data for two authors. You then grab the first author and a rating from the second author. Your delete request expects a <span class="EmphasisFontCategoryNonProportional">404</span> response because the rating id is invalid in the context of the author from which you try to delete a rating. This test will pass because you’ve already added <span class="EmphasisFontCategoryNonProportional">$author-&gt;ratings()-&gt;findOrFail($ratingId)</span> to the controller’s <span class="EmphasisFontCategoryNonProportional">destroy</span> method. You can swap out the code to get the test failing.</div><div id="Par92" class="Para">You should also expect a <span class="EmphasisFontCategoryNonProportional">404</span> if the author id is not valid in the <span class="EmphasisFontCategoryNonProportional">AuthorsRatingsControllerTest</span>. You have already seen variations of this test multiple times in this book.</div><div id="Par93" class="Para">
              <div class="ProgramCode" id="PC33"><div class="FixedLine">102  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">103  <span class="EmphasisTypeBold">public function</span> destroy_fails_when_the_author_is_invalid()</div><div class="FixedLine">104  {</div><div class="FixedLine">105      $this-&gt;delete(</div><div class="FixedLine">106          '/authors/1/ratings/1',</div><div class="FixedLine">107          [],</div><div class="FixedLine">108          ['Accept' =&gt; 'application/json']</div><div class="FixedLine">109      )-&gt;seeStatusCode(404);</div><div class="FixedLine">110  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-33.</span><div class="SimplePara">Test Expecting a 404 When the Author Is Invalid</div></div></div></div>
            </div><div id="Par94" class="Para">You code should fully pass, but you’ll run the test suite once more before moving on to the next topic (Listing <span class="InternalRef"><a href="#Par95">12-34</a></span>).</div><div id="Par95" class="Para">
              <div class="ProgramCode" id="PC34"><div class="LineGroup"><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (61 tests, 308 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-34.</span><div class="SimplePara">Running the Full Test Suite</div></div></div></div>
            </div><div id="Par96" class="Para">You are done with managing author ratings, although I did not cover all the API endpoints you might make to manage ratings an application. You could also provide an endpoint to do bulk operations, like removing multiple ratings with one request when it makes sense. You should be equipped with enough knowledge now to develop and test these concepts.</div></div></div><div id="Sec5" class="Section1 RenderAsSection1"><h2 class="Heading">Ratings in the Author API</h2><div id="Par97" class="Para">Now that you have the database schema and basic rating management, you are going to add rating data to the <span class="EmphasisFontCategoryNonProportional">/author</span> API. Your feature will be to provide an API that includes an author’s rating average and rating count. When building this feature you need to keep in mind <span class="EmphasisTypeItalic">how</span> the ratings might be used. In the simplest form, perhaps an author page will show a five star graphical scale.</div><div id="Par98" class="Para">The API needs to provide enough information to allow the UI to display the ratings. The consumer might need to know things like the maximum rating possible, how many people rated the author, the average rating, and the average rating as a percentage.</div><div id="Par99" class="Para">With that data in mind, your first attempt might look like Listing <span class="InternalRef"><a href="#Par100">12-35</a></span>.</div><div id="Par100" class="Para">
            <div class="ProgramCode" id="PC35"><div class="FixedLine">{</div><div class="FixedLine">    <span class="EmphasisTypeBold">"data"</span>:{</div><div class="FixedLine">        <span class="EmphasisTypeBold">"id"</span>:1,</div><div class="FixedLine">        <span class="EmphasisTypeBold">"name"</span>:"Roslyn Medhurst",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"gender"</span>:"female",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"biography"</span>:"Nemo accusantium et blanditiis.",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"rating"</span>:{</div><div class="FixedLine">            <span class="EmphasisTypeBold">"average"</span>:3.32,</div><div class="FixedLine">            <span class="EmphasisTypeBold">"max"</span>:5,</div><div class="FixedLine">            <span class="EmphasisTypeBold">"percent"</span>:66.4,</div><div class="FixedLine">            <span class="EmphasisTypeBold">"count"</span>:56</div><div class="FixedLine">        },</div><div class="FixedLine">        <span class="EmphasisTypeBold">"created"</span>:"2015-12-12T14:36:50+0000",</div><div class="FixedLine">        <span class="EmphasisTypeBold">"updated"</span>:"2015-12-12T14:36:50+0000"</div><div class="FixedLine">    }</div><div class="FixedLine">}</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-35.</span><div class="SimplePara">Example Author Response With Ratings</div></div></div></div>
          </div><div id="Par101" class="Para">Now that you have an idea of what your API might respond with, your test plan will include:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par102" class="Para">Testing typical rating values when an author has been rated</div></li><li><div id="Par103" class="Para">Testing the rating data when an author has not been rated yet</div></li></ul></div>
      </div><div id="Par104" class="Para">You’ll start by writing new tests in the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">tests/app/Transformer/AuthorTransformerTest.php</span></span> class. The first test you will cover is to modify the existing <span class="EmphasisFontCategoryNonProportional">it_can_transform_an_author</span> test to add rating data (Listing <span class="InternalRef"><a href="#Par105">12-36</a></span>).</div><div id="Par105" class="Para">
            <div class="ProgramCode" id="PC36"><div class="FixedLine">25  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">26  <span class="EmphasisTypeBold">public function</span> it_can_transform_an_author()</div><div class="FixedLine">27  {</div><div class="FixedLine">28      $author = factory(\App\Author::class)-&gt;create();</div><div class="FixedLine">29</div><div class="FixedLine">30      $author-&gt;ratings()-&gt;save(</div><div class="FixedLine">31          factory(\App\Rating::class)-&gt;make(['value' =&gt; 5])</div><div class="FixedLine">32      );</div><div class="FixedLine">33</div><div class="FixedLine">34      $author-&gt;ratings()-&gt;save(</div><div class="FixedLine">35          factory(\App\Rating::class)-&gt;make(['value' =&gt; 3])</div><div class="FixedLine">36      );</div><div class="FixedLine">37</div><div class="FixedLine">38      $actual = $this-&gt;subject-&gt;transform($author);</div><div class="FixedLine">39</div><div class="FixedLine">40      $this-&gt;assertEquals($author-&gt;id, $actual['id']);</div><div class="FixedLine">41      $this-&gt;assertEquals($author-&gt;name, $actual['name']);</div><div class="FixedLine">42      $this-&gt;assertEquals($author-&gt;gender, $actual['gender']);</div><div class="FixedLine">43      $this-&gt;assertEquals($author-&gt;biography, $actual['biography']);</div><div class="FixedLine">44      $this-&gt;assertEquals($author-&gt;created_at-&gt;toIso8601String(), $actual['created']);</div><div class="FixedLine">45      $this-&gt;assertEquals($author-&gt;updated_at-&gt;toIso8601String(), $actual['created']);</div><div class="FixedLine">46</div><div class="FixedLine">47      <span class="EmphasisTypeItalic">// Rating</span>
          </div><div class="FixedLine">48      $this-&gt;assertArrayHasKey('rating', $actual);</div><div class="FixedLine">49      $this-&gt;assertInternalType('array', $actual['rating']);</div><div class="FixedLine">50      $this-&gt;assertEquals(4, $actual['rating']['average']);</div><div class="FixedLine">51      $this-&gt;assertEquals(5, $actual['rating']['max']);</div><div class="FixedLine">52      $this-&gt;assertEquals(80, $actual['rating']['percent']);</div><div class="FixedLine">53      $this-&gt;assertEquals(2, $actual['rating']['count']);</div><div class="FixedLine">54  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-36.</span><div class="SimplePara">Testing the AuthorTransformer Rating Data</div></div></div></div>
          </div><div id="Par106" class="Para ParaOneEmphasisChild">You start by adding ratings to the author data under test. To make it easy to calculate averages, you add two ratings individually, and <span class="EmphasisFontCategoryNonProportional">factory()-&gt;make()</span> allows you to override the rating value. Next, you add assertions that the rating key exists and is an array. Last, you verify the value of each individual rating key you expect.</div><div id="Par107" class="Para">Your test will fail with the error shown in Listing <span class="InternalRef"><a href="#Par108">12-37</a></span>.</div><div id="Par108" class="Para">
            <div class="ProgramCode" id="PC37"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=it_can_transform_an_author</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Transformer\AuthorTransformerTest::it_can_transform_an_author</div><div class="FixedLine">Failed asserting that an array has the key 'rating'.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Transformer/AuthorTransformerTest.php:48</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 1, Assertions: 7, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-37.</span><div class="SimplePara">Running the Modified Test</div></div></div></div>
          </div><div id="Par109" class="Para">Your implementation of this feature will update the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">app/Transformer/AuthorTransformer.php</span></span> file to include the “ratings” key and do all the ratings calculations (Listing <span class="InternalRef"><a href="#Par110">12-38</a></span>).</div><div id="Par110" class="Para">
            <div class="ProgramCode" id="PC38"><div class="FixedLine">19  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">20   <span class="EmphasisTypeItalic">* Transform an author model</span>
          </div><div class="FixedLine">21   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">22   <span class="EmphasisTypeItalic">* @param Author $author</span>
          </div><div class="FixedLine">23   <span class="EmphasisTypeItalic">* @return array</span>
          </div><div class="FixedLine">24   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">25  <span class="EmphasisTypeBold">public function</span> transform(Author $author)</div><div class="FixedLine">26  {</div><div class="FixedLine">27      <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">28          'id'        =&gt; $author-&gt;id,</div><div class="FixedLine">29          'name'      =&gt; $author-&gt;name,</div><div class="FixedLine">30          'gender'    =&gt; $author-&gt;gender,</div><div class="FixedLine">31          'biography' =&gt; $author-&gt;biography,</div><div class="FixedLine">32          'rating' =&gt; [</div><div class="FixedLine">33              'average' =&gt; (float) sprintf(</div><div class="FixedLine">34                  "%.2f",</div><div class="FixedLine">35                  $author-&gt;ratings-&gt;avg('value')</div><div class="FixedLine">36              ),</div><div class="FixedLine">37              'max' =&gt; (float) sprintf("%.2f", 5),</div><div class="FixedLine">38              'percent' =&gt; (float) sprintf(</div><div class="FixedLine">39                  "%.2f",</div><div class="FixedLine">40                  ($author-&gt;ratings-&gt;avg('value') / 5) * 100</div><div class="FixedLine">41              ),</div><div class="FixedLine">42              'count' =&gt; $author-&gt;ratings-&gt;count(),</div><div class="FixedLine">43          ],</div><div class="FixedLine">44          'created'   =&gt; $author-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">45          'updated'   =&gt; $author-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">46      ];</div><div class="FixedLine">47  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-38.</span><div class="SimplePara">Implementing Ratings in the AuthorTransformer</div></div></div></div>
          </div><div id="Par111" class="Para">If you run the test suite, things should pass again (Listing <span class="InternalRef"><a href="#Par112">12-39</a></span>).</div><div id="Par112" class="Para">
            <div class="ProgramCode" id="PC39"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (61 tests, 314 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-39.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par113" class="Para">Your change will affect all of your responses containing an author. Unfortunately, the rating data is lazy-loaded right now, meaning that each <span class="EmphasisFontCategoryNonProportional">Author</span> record in the <span class="EmphasisFontCategoryNonProportional">/authors</span> request will result in a new query. If you are returning <span class="EmphasisFontCategoryNonProportional">100</span> authors in your response, that will result in <span class="EmphasisFontCategoryNonProportional">100</span> queries to the <span class="EmphasisFontCategoryNonProportional">ratings</span> table. Listing <span class="InternalRef"><a href="#Par114">12-40</a></span> is an example from the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">app/storage/logs/lumen.log</span></span> file where I am outputting queries from the ORM.</div><div id="Par114" class="Para">
            <div class="ProgramCode" id="PC40"><div class="FixedLine">[2015-12-17 21:20:56] lumen.INFO: select * from `ratings` where `ratings`.`ratea\</div><div class="FixedLine">ble_id` = ? and `ratings`.`rateable_id` is not null and `ratings`.`rateable_type\</div><div class="FixedLine">` = ? [1,"App\\Author"]</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-40.</span><div class="SimplePara">Example of a Lazy-Loaded Query</div></div></div></div>
          </div><div id="Par115" class="Para">To get this type of logging working in your app, you are going to use the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">app/Providers/AppServiceProvider.php</span></span> class to add some database logging so you can visualize the actual queries generated by Eloquent (Listing <span class="InternalRef"><a href="#Par116">12-41</a></span>).</div><div id="Par116" class="Para">
            <div class="ProgramCode" id="PC41"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Providers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> DB;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> Log;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> Illuminate\Support\ServiceProvider;</div><div class="FixedLine"> 8</div><div class="FixedLine"> 9  <span class="EmphasisTypeBold">class AppServiceProvider extends</span> ServiceProvider</div><div class="FixedLine">10  {</div><div class="FixedLine">11      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">12       <span class="EmphasisTypeItalic">* Register any application services.</span>
          </div><div class="FixedLine">13       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">14       <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">15       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">16      <span class="EmphasisTypeBold">public function</span> register()</div><div class="FixedLine">17      {</div><div class="FixedLine">18          <span class="EmphasisTypeItalic">//</span>
          </div><div class="FixedLine">19      }</div><div class="FixedLine">20</div><div class="FixedLine">21      <span class="EmphasisTypeBold">public function</span> boot()</div><div class="FixedLine">22      {</div><div class="FixedLine">23          <span class="EmphasisTypeBold">if (env('DB_LOGGING', false) === true) {</span>
          </div><div class="FixedLine">24              <span class="EmphasisTypeBold">DB::listen(function($query) {</span>
          </div><div class="FixedLine">25                  <span class="EmphasisTypeBold">Log::info($query-&gt;sql, $query-&gt;bindings, $query-&gt;time);</span>
          </div><div class="FixedLine">26              <span class="EmphasisTypeBold">});</span>
          </div><div class="FixedLine">27          <span class="EmphasisTypeBold">}</span>
          </div><div class="FixedLine">28      }</div><div class="FixedLine">29  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-41.</span><div class="SimplePara">Adding Database Logging to the AppServiceProvider</div></div></div></div>
          </div><div id="Par117" class="Para">You’ve added a listener that will log out the SQL query and bindings when the environment variable <span class="EmphasisFontCategoryNonProportional">DB_LOGGING=true</span> is set. To start using this listener, you need to enable the <span class="EmphasisFontCategoryNonProportional">AppServiceProvider</span> and configure the environment variable.</div><div id="Par118" class="Para">To enable the <span class="EmphasisFontCategoryNonProportional">AppServiceProvider,</span> open up <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">bootstrap/app.php</span></span> and look for the “Register Service Providers” section and uncomment the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">AppServiceProvider</span></span> class (Listing <span class="InternalRef"><a href="#Par119">12-42</a></span>).</div><div id="Par119" class="Para">
            <div class="ProgramCode" id="PC42"><div class="FixedLine">81  $app-&gt;register(App\Providers\AppServiceProvider::class);</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-42.</span><div class="SimplePara">Enabling the AppServiceProvider in bootstrap/app.php</div></div></div></div>
          </div><div id="Par120" class="Para">Add the following to your <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">.env</span></span> file in the root of the project (I would also recommend adding it to the .<span class="EmphasisFontCategoryNonProportional">env</span> example file for other developers to grab). Setting the variable to true (Listing <span class="InternalRef"><a href="#Par121">12-43</a></span>) enables logging.</div><div id="Par121" class="Para">
            <div class="ProgramCode" id="PC43"><div class="FixedLine">DB_LOGGING=<span class="EmphasisTypeBold">true</span>
          </div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-43.</span><div class="SimplePara">Enabling DB Logging in .env</div></div></div></div>
          </div><div id="Par122" class="Para">Setting it to false or not defining the variable will disable logging (Listing <span class="InternalRef"><a href="#Par123">12-44</a></span>).</div><div id="Par123" class="Para">
            <div class="ProgramCode" id="PC44"><div class="FixedLine">DB_LOGGING=<span class="EmphasisTypeBold">false</span>
          </div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-44.</span><div class="SimplePara">Disabling DB Logging in .env.example</div></div></div></div>
          </div><div id="FPar2" class="FormalPara FormalParaRenderingStyle1 ParaTypeImportant"><div class="Heading">
          <img src="A395120_1_En_12_Figa_HTML.jpg" alt="A395120_1_En_12_Figa_HTML.jpg"/> Chatty Logs</div><div id="Par124" class="Para ParaOneEmphasisChild">It’s probably not a good idea to use <span class="EmphasisFontCategoryNonProportional">DB::listen()</span> to log database queries in production; use the DB logging feature as a development convenience to see SQL queries. You can just as easily enable MySQL’s logging capabilities to get the same effect. I prefer to toggle it on/off in development because I don’t always need (or want) to see database logs while I develop.</div></div><div id="Par125" class="Para ParaOneEmphasisChild">Now that you have database logging in place, make a request to the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">/authors</span></span> endpoint to visualize the queries. In the next section, you will work on preventing excess queries to get author rating data.</div></div><div id="Sec6" class="Section1 RenderAsSection1"><h2 class="Heading">Eager Loading Ratings</h2><div id="Par126" class="Para">After taking an aside and understanding that your transformer can create additional unnecessary (and unintentional) queries, what can you do about it? Enter eager loading (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/eloquent-relationships#eager-loading"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/eloquent-relationships#eager-loading</span>
              </span></a></span>).</div><div id="Par127" class="Para">The official documentation for eager loading does a great job of explaining the (potential) problem and how to avoid it. Let’s update your <span class="EmphasisFontCategoryNonProportional">AuthorsController@index</span> method to use eager loading and check how your database logging changes compared to doing a query for each individual author. Open the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">app/Http/Controllers/AuthorsController.php</span></span> file and update the index route (Listing <span class="InternalRef"><a href="#Par128">12-45</a></span>).</div><div id="Par128" class="Para">
            <div class="ProgramCode" id="PC45"><div class="FixedLine">11  <span class="EmphasisTypeBold">public function</span> index()</div><div class="FixedLine">12  {</div><div class="FixedLine">13      $authors = Author::with('ratings')-&gt;get();</div><div class="FixedLine">14</div><div class="FixedLine">15      <span class="EmphasisTypeBold">return</span> $this-&gt;collection($authors, <span class="EmphasisTypeBold">new</span> AuthorTransformer());</div><div class="FixedLine">16  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-45.</span><div class="SimplePara">Using Eager Loading on the Authors Index Route</div></div></div></div>
          </div><div id="Par129" class="Para">If you make a request to <span class="EmphasisFontCategoryNonProportional">/authors</span> with database logging turned on, the request should only generate two queries (Listing <span class="InternalRef"><a href="#Par130">12-46</a></span>).</div><div id="Par130" class="Para">
            <div class="ProgramCode" id="PC46"><div class="FixedLine">[2015-12-18 05:33:07] lumen.INFO: select * from `authors`</div><div class="FixedLine">[2015-12-18 05:33:07] lumen.INFO: select * from `ratings` where `ratings`.`ratea\</div><div class="FixedLine">ble_id` in (?, ?, ?, ?, ?, ?, ?, ?, ?, ?) and `ratings`.`rateable_type` = ? [1,2\</div><div class="FixedLine">,3,4,5,6,7,8,9,10,"App\\Author"]</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-46.</span><div class="SimplePara">Queries Logged with Eager Loading</div></div></div></div>
          </div><div id="Par131" class="Para">Much better! Now your transformer is not creating unnecessary queries.</div><div id="Par132" class="Para ParaTypeImportant">
        <img src="A395120_1_En_12_Figb_HTML.jpg" alt="A395120_1_En_12_Figb_HTML.jpg"/> You Can Still Generate Extra Queries!</div><div id="Par133" class="Para ParaTypeImportant">In the <span class="EmphasisFontCategoryNonProportional">AuthorTransformer</span> you can still create extra queries by calling the <span class="EmphasisFontCategoryNonProportional">$author-&gt;ratings()</span> method. For example, <span class="EmphasisFontCategoryNonProportional">$author-&gt;ratings()-&gt;avg('value')</span> makes an additional query even if you use eager loading to get the author and ratings. You should use <span class="EmphasisFontCategoryNonProportional">$author-&gt;ratings-&gt;avg('value')</span> as seen in your transformer to avoid extra queries.</div><div id="Par134" class="Para">At this point, you should run the test suite again since you changed your code to use eager loading (Listing <span class="InternalRef"><a href="#Par135">12-47</a></span>).</div><div id="Par135" class="Para">
            <div class="ProgramCode" id="PC47"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (61 tests, 314 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 12-47.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par136" class="Para ParaOneEmphasisChild">The remaining author routes in the <span class="EmphasisFontCategoryNonProportional">AuthorsController</span> don’t really need to use eager loading because only one record is being requested and you will not generate additional queries. Eager loading is most important when you are getting a collection of records and looping over them.</div><div id="Par137" class="Para ParaTypeImportant">
        <img src="A395120_1_En_12_Figc_HTML.jpg" alt="A395120_1_En_12_Figc_HTML.jpg"/> Git Commit: Add Author Ratings</div><div id="Par138" class="Para ParaTypeImportant">c5989e9 (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/c5989e9"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/c5989e9</span>
              </span></a></span>)</div></div><div id="Sec7" class="Section1 RenderAsSection1"><h2 class="Heading">Conclusion</h2><div id="Par139" class="Para">In this chapter, you learned how to use polymorphic relationships in your API and then expose the data from your Fractal transformer. You are well-equipped to add ratings to books and then use the API to create your own front end too! Along the way you learned about <span class="ExternalRef"><a href="http://laravel.com/docs/5.1/eloquent-relationships#eager-loading"><span class="RefSource">eager loading</span></a></span> (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/eloquent-relationships#eager-loading"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/eloquent-relationships#eager-loading</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> and just touched on the subject of query optimization.</div></div></div></body></html>
