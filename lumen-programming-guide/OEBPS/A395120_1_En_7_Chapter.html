<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>Leveling Up Responses</title><link href="springer_epub.css" type="text/css" rel="styleSheet"/></head><body><div class="ChapterContextInformation"><div class="ContextInformation" id="b978-1-4842-2187-7_7"><div class="ChapterCopyright">© Paul Redmond 2016</div><span class="ContextInformationAuthorEditorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span></span></span><span class="ContextInformationBookTitles"><span class="BookTitle" xml:lang="en">Lumen Programming Guide</span></span><span class="ChapterDOI">10.1007/978-1-4842-2187-7_7</span></div></div><!--Begin Abstract--><div class="MainTitleSection"><h1 class="ChapterTitle" xml:lang="en">7. Leveling Up Responses</h1></div><div class="AuthorGroup"><div class="AuthorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span><sup>1 <span class="ContactIcon"/></sup></span></div><div class="Affiliations"><div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">Phoenix, Arizona, USA</div></div><div class="ClearBoth"> </div></div></div><!--End Abstract--><div class="Fulltext"><div id="Par1" class="Para">Your API responses work fine, but at the moment they don’t scale very well. You need to make them more consistent across all endpoints by using conventions, as well as anticipate adding things like pagination to your response. If you’ve consumed a few APIs, you have probably noticed that response data formats vary between each API. Understanding each API format can be challenging enough, but add inconsistencies between endpoints within the same API and it can be a frustrating user experience.</div><div id="Par2" class="Para">Your current API response for all books looks something like Listing <span class="InternalRef"><a href="#Par3">7-1</a></span>.</div><div id="Par3" class="Para">
          <div class="ProgramCode" id="PC1"><div class="FixedLine">[{</div><div class="FixedLine">    "<span class="EmphasisTypeBold">id</span>": 1,</div><div class="FixedLine">    "<span class="EmphasisTypeBold">title</span>": "War of the Worlds",</div><div class="FixedLine">    "<span class="EmphasisTypeBold">description</span>": "A science fiction masterpiece about Martians invading London",</div><div class="FixedLine">    "<span class="EmphasisTypeBold">author</span>": "H. G. Wells",</div><div class="FixedLine">    "<span class="EmphasisTypeBold">created_at</span>": "2015-10-21 06:54:33",</div><div class="FixedLine">    "<span class="EmphasisTypeBold">updated_at</span>": "2015-10-21 06:54:33"</div><div class="FixedLine">}, {</div><div class="FixedLine">    "<span class="EmphasisTypeBold">id</span>": 2,</div><div class="FixedLine">    "<span class="EmphasisTypeBold">title</span>": "A Wrinkle in Time",</div><div class="FixedLine">    "<span class="EmphasisTypeBold">description</span>": "A young girl goes on a mission to save her father who has gone missing after working on a mysterious project called a tesseract.",</div><div class="FixedLine">    "<span class="EmphasisTypeBold">author</span>": "Madeleine L'Engle",</div><div class="FixedLine">    "<span class="EmphasisTypeBold">created_at</span>": "2015-10-21 06:54:33",</div><div class="FixedLine">    "<span class="EmphasisTypeBold">updated_at</span>": "2015-10-21 06:54:33"</div><div class="FixedLine">}]</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-1.</span><div class="SimplePara">The GET /books JSON Response</div></div></div></div>
        </div><div id="Par4" class="Para ParaOneEmphasisChild">The data format not <span class="EmphasisTypeItalic">bad</span> per se, but what if you want to add metadata like pagination? Where will it go? It’s easy to see how quickly your current response will crumble. Plus, right now each controller is responsible for formatting its response.</div><div id="Sec1" class="Section1 RenderAsSection1"><h2 class="Heading">Introducing Fractal</h2><div id="Par5" class="Para">I believe that the response handling code is one of the most critical parts of an API, and so you need to offload the responsibility from the controller to a service that the controller can use. You could write the code from scratch on your own, but Fractal (<span class="ExternalRef"><a href="http://fractal.thephpleague.com/"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">http://fractal.thephpleague.com/</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> provides a good (and flexible) solution for us. Fractal describes itself as follows:
<div class="UnorderedList"><ul class="UnorderedListMarkNone"><li><div id="Par6" class="Para">Fractal provides a presentation and transformation layer for complex data output, the like found in RESTful APIs, and works really well with JSON. Think of this as a view layer for your JSON/YAML/etc.</div></li><li><div id="Par7" class="Para">When building an API it is common for people to just grab stuff from the database and pass it to json_encode(). This might be passable for “trivial” APIs but if they are in use by the public, or used by mobile applications then this will quickly lead to inconsistent output.</div></li></ul></div>
      </div><div id="Par8" class="Para">Sounds exactly like what you need! Out of the box you can quickly get a format like that shown in Listing <span class="InternalRef"><a href="#Par9">7-2</a></span>.</div><div id="Par9" class="Para">
            <div class="ProgramCode" id="PC2"><div class="FixedLine">{</div><div class="FixedLine">    "<span class="EmphasisTypeBold">data</span>": [{</div><div class="FixedLine">        "<span class="EmphasisTypeBold">id</span>": 1,</div><div class="FixedLine">        "<span class="EmphasisTypeBold">title</span>": "War of the Worlds",</div><div class="FixedLine">        "<span class="EmphasisTypeBold">description</span>": "A science fiction masterpiece about Martians invading London",</div><div class="FixedLine">        "<span class="EmphasisTypeBold">author</span>": "H. G. Wells",</div><div class="FixedLine">        "<span class="EmphasisTypeBold">created_at</span>": "2015-10-21 06:54:33",</div><div class="FixedLine">        "<span class="EmphasisTypeBold">updated_at</span>": "2015-10-21 06:54:33"</div><div class="FixedLine">}, {</div><div class="FixedLine">        "<span class="EmphasisTypeBold">id</span>": 2,</div><div class="FixedLine">        "<span class="EmphasisTypeBold">title</span>": "A Wrinkle in Time",</div><div class="FixedLine">        "<span class="EmphasisTypeBold">description</span>": "A young girl goes on a mission to save her father who has gone missing after working on a mysterious project called a tesseract.",</div><div class="FixedLine">        "<span class="EmphasisTypeBold">author</span>": "Madeleine L'Engle",</div><div class="FixedLine">        "<span class="EmphasisTypeBold">created_at</span>": "2015-10-21 06:54:33",</div><div class="FixedLine">        "<span class="EmphasisTypeBold">updated_at</span>": "2015-10-21 06:54:33"</div><div class="FixedLine">    }]</div><div class="FixedLine">}</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-2.</span><div class="SimplePara">Example JSON Response Using Fractal</div></div></div></div>
          </div><div id="Par10" class="Para ParaOneEmphasisChild">With the response content in a <span class="EmphasisFontCategoryNonProportional">"data"</span> key, you can add other things to the response without mixing it in with the book data. Fractal encourages good data design, and responses will be consistent across the API.</div><div id="Par11" class="Para">You need to install Fractal with Composer and then configure it so you can use it in your controllers. Various libraries exist to even integrate Fractal, but you are going to roll your own. Sometimes rolling your own is better than adding a dependency. Using Fractal is simple enough to use that you don’t need to use a Laravel/Lumen integration.</div><div id="Par12" class="Para">I try to keep application dependencies to a minimum and invest in dependencies where it counts. You add complexity to your application with each new dependency and you increase the size of your application. Always weigh the value of using a vendor vs. rolling your own. In your case, Fractal makes sense and provides a good value for data transformation; but by rolling your own service provider to integrate Fractal you will learn (if you haven’t used them in Laravel) how to write services.</div></div><div id="Sec2" class="Section1 RenderAsSection1"><h2 class="Heading">First Version of API Response Formatting</h2><div id="Par13" class="Para">Let’s get to work on your first version of refactoring response formatting. You could start integrating Fractal immediately, but that’s not an iterative approach. First, you will write test specifications and make the minimum change needed to support your response changes. Once you have the tests in place, you will be ready to make the move to the Fractal library.</div><div id="Par14" class="Para">You will cover the <span class="EmphasisFontCategoryNonProportional">BooksController@index</span> route test first (Listing <span class="InternalRef"><a href="#Par15">7-3</a></span>).</div><div id="Par15" class="Para">
            <div class="ProgramCode" id="PC3"><div class="FixedLine">18  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">19  <span class="EmphasisTypeBold">public function</span> index_should_return_a_collection_of_records()</div><div class="FixedLine">20  {</div><div class="FixedLine">21      $books = factory('App\Book', 2)-&gt;create();</div><div class="FixedLine">22</div><div class="FixedLine">23      $this-&gt;get('/books');</div><div class="FixedLine">24      $expected = [</div><div class="FixedLine">25          'data' =&gt; $books-&gt;toArray()</div><div class="FixedLine">26      ];</div><div class="FixedLine">27</div><div class="FixedLine">28      $this-&gt;seeJsonEquals($expected);</div><div class="FixedLine">29  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-3.</span><div class="SimplePara">Updating the BooksController@index Test</div></div></div></div>
          </div><div id="Par16" class="Para">You remove the foreach loop and use the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Collection::toArray()</span></span> method to create the expected JSON response. You check the data with <span class="EmphasisFontCategoryNonProportional">seeJsonEquals()</span> to make sure your response matches the actual response.</div><div id="Par17" class="Para">You should have a failing test now (Listing <span class="InternalRef"><a href="#Par18">7-4</a></span>).</div><div id="Par18" class="Para">
            <div class="ProgramCode" id="PC4"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::index_should_return_a_collect\</div><div class="FixedLine">ion_of_records</div><div class="FixedLine">Failed asserting that two strings are equal.</div><div class="FixedLine">--- Expected</div><div class="FixedLine">+++ Actual</div><div class="FixedLine">@@ @@</div><div class="FixedLine">-'{"data":[{"author":"Dortha Hodkiewicz"...</div><div class="FixedLine">+'[{"author":"Dortha Hodkiewicz",...</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/vendor/laravel/lumen-framework/src/Testing/CrawlerTrait\</div><div class="FixedLine">.php:338</div><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/BooksControllerTest.php:28</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 16, Assertions: 61, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-4.</span><div class="SimplePara">Failing PHPUnit Test</div></div></div></div>
          </div><div id="Par19" class="Para">Getting your test back to green is achieved by changing your return from a model collection to an array with a <span class="EmphasisFontCategoryNonProportional">data</span> key (Listing <span class="InternalRef"><a href="#Par20">7-5</a></span>). After your change, the test suite should be back to green (Listing <span class="InternalRef"><a href="#Par21">7-6</a></span>).</div><div id="Par20" class="Para">
            <div class="ProgramCode" id="PC5"><div class="FixedLine">15  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">16   <span class="EmphasisTypeItalic">* GET /books</span>
          </div><div class="FixedLine">17   <span class="EmphasisTypeItalic">* @return array</span>
          </div><div class="FixedLine">18   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">19  <span class="EmphasisTypeBold">public function</span> index()</div><div class="FixedLine">20  {</div><div class="FixedLine">21      <span class="EmphasisTypeBold">return</span> ['data' =&gt; Book::all()-&gt;toArray()];</div><div class="FixedLine">22  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-5.</span><div class="SimplePara">BooksController@index Data Implementation</div></div></div></div>
          </div><div id="Par21" class="Para">
            <div class="ProgramCode" id="PC6"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (16 tests, 61 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-6.</span><div class="SimplePara">Passing PHPUnit Test for BooksController@index</div></div></div></div>
          </div><div id="Par22" class="Para">Next, update the <span class="EmphasisFontCategoryNonProportional">BooksController@show</span> test (Listing <span class="InternalRef"><a href="#Par23">7-7</a></span>).</div><div id="Par23" class="Para">
            <div class="ProgramCode" id="PC7"><div class="FixedLine">31  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">32  <span class="EmphasisTypeBold">public function</span> show_should_return_a_valid_book()</div><div class="FixedLine">33  {</div><div class="FixedLine">34      $book = factory('App\Book')-&gt;create();</div><div class="FixedLine">35      $expected = [</div><div class="FixedLine">36          'data' =&gt; $book-&gt;toArray()</div><div class="FixedLine">37      ];</div><div class="FixedLine">38      $this</div><div class="FixedLine">39          -&gt;get("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>")</div><div class="FixedLine">40          -&gt;seeStatusCode(200)</div><div class="FixedLine">41          -&gt;seeJsonEquals($expected);</div><div class="FixedLine">42  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-7.</span><div class="SimplePara">Updating the BooksController@show Test</div></div></div></div>
          </div><div id="Par24" class="Para">Your modified test now expects the book data to be inside the data key. Let’s make sure your test fails now (Listing <span class="InternalRef"><a href="#Par25">7-8</a></span>).</div><div id="Par25" class="Para">
            <div class="ProgramCode" id="PC8"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::show_should_return_a_valid_bo\</div><div class="FixedLine">ok</div><div class="FixedLine">Failed asserting that two strings are equal.</div><div class="FixedLine">--- Expected</div><div class="FixedLine">+++ Actual</div><div class="FixedLine">@@ @@</div><div class="FixedLine">-'{"data":{"author":"Dr. Wyman Brown"...</div><div class="FixedLine">+'{"author":"Dr. Wyman Brown"...</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/vendor/laravel/lumen-framework/src/Testing/CrawlerTrait\</div><div class="FixedLine">.php:338</div><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/BooksControllerTest.php:41</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 16, Assertions: 56, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-8.</span><div class="SimplePara">Failing PHPUnit Test for the BooksController@show Route</div></div></div></div>
          </div><div id="Par26" class="Para">Getting your test passing with the minimum amount of code is similar to your <span class="EmphasisFontCategoryNonProportional">BooksController@index</span> change (Listing <span class="InternalRef"><a href="#Par27">7-9</a></span>).</div><div id="Par27" class="Para">
            <div class="ProgramCode" id="PC9"><div class="FixedLine">24  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">25   <span class="EmphasisTypeItalic">* GET /books/{id}</span>
          </div><div class="FixedLine">26   <span class="EmphasisTypeItalic">* @param integer $id</span>
          </div><div class="FixedLine">27   <span class="EmphasisTypeItalic">* @return mixed</span>
          </div><div class="FixedLine">28   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">29  <span class="EmphasisTypeBold">public function</span> show($id)</div><div class="FixedLine">30  {</div><div class="FixedLine">31      <span class="EmphasisTypeBold">return</span> ['data' =&gt; Book::findOrFail($id)-&gt;toArray()];</div><div class="FixedLine">32  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-9.</span><div class="SimplePara">Getting the BooksController@show Route Back to Green</div></div></div></div>
          </div><div id="Par28" class="Para">The code change in Listing <span class="InternalRef"><a href="#Par29">7-10</a></span> gets your suite passing again.</div><div id="Par29" class="Para">
            <div class="ProgramCode" id="PC10"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (16 tests, 56 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-10.</span><div class="SimplePara">Passing Tests After Updating BooksController@show</div></div></div></div>
          </div><div id="Par30" class="Para">The remaining routes are <span class="EmphasisFontCategoryNonProportional">store</span> and the <span class="EmphasisFontCategoryNonProportional">update</span>. In the original <span class="EmphasisFontCategoryNonProportional">BooksController@store</span> method you cheated a little bit and responded with <span class="EmphasisFontCategoryNonProportional">{"created": true}</span>, but let’s return the new record data instead (Listing <span class="InternalRef"><a href="#Par31">7-11</a></span>).</div><div id="Par31" class="Para">
            <div class="ProgramCode" id="PC11"><div class="FixedLine">71  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">72  <span class="EmphasisTypeBold">public function</span> store_should_save_new_book_in_the_database()</div><div class="FixedLine">73  {</div><div class="FixedLine">74      $this-&gt;post('/books', [</div><div class="FixedLine">75          'title' =&gt; 'The Invisible Man',</div><div class="FixedLine">76          'description' =&gt; 'An invisible man is trapped in the terror of his own creation',</div><div class="FixedLine">77          'author' =&gt; 'H. G. Wells'</div><div class="FixedLine">78      ]);</div><div class="FixedLine">79</div><div class="FixedLine">80      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">81      $this-&gt;assertArrayHasKey('data', $body);</div><div class="FixedLine">82</div><div class="FixedLine">83      $data = $body['data'];</div><div class="FixedLine">84      $this-&gt;assertEquals('The Invisible Man', $data['title']);</div><div class="FixedLine">85      $this-&gt;assertEquals(</div><div class="FixedLine">86          'An invisible man is trapped in the terror of his own creation',</div><div class="FixedLine">87          $data['description']</div><div class="FixedLine">88      );</div><div class="FixedLine">89      $this-&gt;assertEquals('H. G. Wells', $data['author']);</div><div class="FixedLine">90      $this-&gt;assertTrue($data['id'] &gt; 0, 'Expected a positive integer, but did not see one.');</div><div class="FixedLine">91      $this-&gt;seeInDatabase('books', ['title' =&gt; 'The Invisible Man']);</div><div class="FixedLine">92  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-11.</span><div class="SimplePara">Updating the BooksController@store Response</div></div></div></div>
          </div><div id="Par32" class="Para">Your failing test confirms that you are ready to get the test back to green (Listing <span class="InternalRef"><a href="#Par33">7-12</a></span>).</div><div id="Par33" class="Para">
            <div class="ProgramCode" id="PC12"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::store_should_save_new_book_in\</div><div class="FixedLine">_the_database</div><div class="FixedLine">Failed asserting that an array has the key 'data'.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/BooksControllerTest.php:78</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 16, Assertions: 55, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-12.</span><div class="SimplePara">Failing BooksController@store Test</div></div></div></div>
          </div><div id="Par34" class="Para">The implementation swaps out the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">"created": true</span></span> JSON with the newly created book data (Listing <span class="InternalRef"><a href="#Par35">7-13</a></span>).</div><div id="Par35" class="Para">
            <div class="ProgramCode" id="PC13"><div class="FixedLine">34  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">35   <span class="EmphasisTypeItalic">* POST /books</span>
          </div><div class="FixedLine">36   <span class="EmphasisTypeItalic">* @param Request $request</span>
          </div><div class="FixedLine">37   <span class="EmphasisTypeItalic">* @return \Symfony\Component\HttpFoundation\Response</span>
          </div><div class="FixedLine">38   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">39  <span class="EmphasisTypeBold">public function</span> store(Request $request)</div><div class="FixedLine">40  {</div><div class="FixedLine">41      $book = Book::create($request-&gt;all());</div><div class="FixedLine">42</div><div class="FixedLine">43      <span class="EmphasisTypeBold">return</span> response()-&gt;json(['data' =&gt; $book-&gt;toArray()], 201, [</div><div class="FixedLine">44          'Location' =&gt; route('books.show', ['id' =&gt; $book-&gt;id])</div><div class="FixedLine">45      ]);</div><div class="FixedLine">46  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-13.</span><div class="SimplePara">Updating the BooksController@store Method</div></div></div></div>
          </div><div id="Par36" class="Para">Your suite should be fully passing again after your code change (Listing <span class="InternalRef"><a href="#Par37">7-14</a></span>).</div><div id="Par37" class="Para">
            <div class="ProgramCode" id="PC14"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (16 tests, 60 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-14.</span><div class="SimplePara">Passing BooksController@store Test</div></div></div></div>
          </div><div id="Par38" class="Para">The <span class="EmphasisFontCategoryNonProportional">BooksController@update</span> test is next. Update the code as shown in Listing <span class="InternalRef"><a href="#Par39">7-15</a></span> before writing the test to illustrate a caveat of using <span class="EmphasisFontCategoryNonProportional">seeJson()</span>.</div><div id="Par39" class="Para">
            <div class="ProgramCode" id="PC15"><div class="FixedLine">48  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">49   <span class="EmphasisTypeItalic">* PUT /books/{id}</span>
          </div><div class="FixedLine">50   <span class="EmphasisTypeItalic">* @param Request $request</span>
          </div><div class="FixedLine">51   <span class="EmphasisTypeItalic">* @param $id</span>
          </div><div class="FixedLine">52   <span class="EmphasisTypeItalic">* @return mixed</span>
          </div><div class="FixedLine">53   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">54  <span class="EmphasisTypeBold">public function</span> update(Request $request, $id)</div><div class="FixedLine">55  {</div><div class="FixedLine">56      <span class="EmphasisTypeBold">try</span> {</div><div class="FixedLine">57          $book = Book::findOrFail($id);</div><div class="FixedLine">58      } <span class="EmphasisTypeBold">catch</span> (ModelNotFoundException $e) {</div><div class="FixedLine">59          <span class="EmphasisTypeBold">return</span> response()-&gt;json([</div><div class="FixedLine">60              'error' =&gt; [</div><div class="FixedLine">61                  'message' =&gt; 'Book not found'</div><div class="FixedLine">62              ]</div><div class="FixedLine">63          ], 404);</div><div class="FixedLine">64      }</div><div class="FixedLine">65</div><div class="FixedLine">66      $book-&gt;fill($request-&gt;all());</div><div class="FixedLine">67      $book-&gt;save();</div><div class="FixedLine">68</div><div class="FixedLine">69      <span class="EmphasisTypeBold">return</span> ['data' =&gt; $book-&gt;toArray()];</div><div class="FixedLine">70  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-15.</span><div class="SimplePara">Updating the BooksController@update Method</div></div></div></div>
          </div><div id="Par40" class="Para">You’ve made a code change, and you should expect your tests to fail now (Listing <span class="InternalRef"><a href="#Par41">7-16</a></span>), but they don’t!</div><div id="Par41" class="Para">
            <div class="ProgramCode" id="PC16"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (16 tests, 60 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-16.</span><div class="SimplePara">Running Tests After Changing BooksController@update. Will They Fail?</div></div></div></div>
          </div><div id="Par42" class="Para">The controller change did not cause your tests to fail—not good. You’ve introduced a breaking change to the API that your tests failed to catch. Your test does some response checking with <span class="EmphasisFontCategoryNonProportional">seeJson</span>, but it doesn’t check the integrity of the JSON response. The <span class="EmphasisFontCategoryNonProportional">seeJson()</span> method checks <span class="EmphasisTypeItalic">fragments</span> of JSON but not the location of the data. Be careful when you are writing tests to ensure the response format carefully. The <span class="EmphasisFontCategoryNonProportional">seeJson()</span> method is not to blame; you need to test for the <span class="EmphasisFontCategoryNonProportional">data</span> key (Listing <span class="InternalRef"><a href="#Par43">7-17</a></span>).</div><div id="Par43" class="Para">
            <div class="ProgramCode" id="PC17"><div class="FixedLine">110  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">111  <span class="EmphasisTypeBold">public function</span> update_should_only_change_fillable_fields()</div><div class="FixedLine">112  {</div><div class="FixedLine">113      $book = factory('App\Book')-&gt;create([</div><div class="FixedLine">114          'title' =&gt; 'War of the Worlds',</div><div class="FixedLine">115          'description' =&gt; 'A science fiction masterpiece about Martians invading London',</div><div class="FixedLine">116          'author' =&gt; 'H. G. Wells',</div><div class="FixedLine">117      ]);</div><div class="FixedLine">118</div><div class="FixedLine">119      $this-&gt;notSeeInDatabase('books', [</div><div class="FixedLine">120          'title' =&gt; 'The War of the Worlds',</div><div class="FixedLine">121          'description' =&gt; 'The book is way better than the movie.',</div><div class="FixedLine">122          'author' =&gt; 'Wells, H. G.'</div><div class="FixedLine">123      ]);</div><div class="FixedLine">124</div><div class="FixedLine">125      $this-&gt;put("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>", [</div><div class="FixedLine">126          'id' =&gt; 5,</div><div class="FixedLine">127          'title' =&gt; 'The War of the Worlds',</div><div class="FixedLine">128          'description' =&gt; 'The book is way better than the movie.',</div><div class="FixedLine">129          'author' =&gt; 'Wells, H. G.'</div><div class="FixedLine">130      ]);</div><div class="FixedLine">131</div><div class="FixedLine">132      $this</div><div class="FixedLine">133          -&gt;seeStatusCode(200)</div><div class="FixedLine">134          -&gt;seeJson([</div><div class="FixedLine">135              'id' =&gt; 1,</div><div class="FixedLine">136              'title' =&gt; 'The War of the Worlds',</div><div class="FixedLine">137              'description' =&gt; 'The book is way better than the movie.',</div><div class="FixedLine">138              'author' =&gt; 'Wells, H. G.',</div><div class="FixedLine">139          ])</div><div class="FixedLine">140          -&gt;seeInDatabase('books', [</div><div class="FixedLine">141              'title' =&gt; 'The War of the Worlds'</div><div class="FixedLine">142          ]);</div><div class="FixedLine">143</div><div class="FixedLine">144      <span class="EmphasisTypeItalic">// Verify the data key in the response</span>
          </div><div class="FixedLine">145      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">146      $this-&gt;assertArrayHasKey('data', $body);</div><div class="FixedLine">147  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-17.</span><div class="SimplePara">Checking for the Data Key in the Response</div></div></div></div>
          </div><div id="Par44" class="Para">At the end of the test you check the response body for the existence of the <span class="EmphasisFontCategoryNonProportional">data</span> key. If you revert the controller change you did first, you should now get a failing test (Listing <span class="InternalRef"><a href="#Par45">7-18</a></span>).</div><div id="Par45" class="Para">
            <div class="ProgramCode" id="PC18"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::update_should_only_change_fil\</div><div class="FixedLine">lable_fields</div><div class="FixedLine">Failed asserting that an array has the key 'data'.</div><div class="FixedLine">...</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 16, Assertions: 62, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-18.</span><div class="SimplePara">Testing Results of Reverting the BooksController@update Route</div></div></div></div>
          </div><div id="Par46" class="Para">The test suite should be fully passing again. If you reverted the <span class="EmphasisFontCategoryNonProportional">BooksController@update</span> method to see the test fail, put the change back (Listing <span class="InternalRef"><a href="#Par47">7-19</a></span>).</div><div id="Par47" class="Para">
            <div class="ProgramCode" id="PC19"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (16 tests, 62 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-19.</span><div class="SimplePara">Fully Passing Test Suite</div></div></div></div>
          </div><div id="Par48" class="Para ParaTypeImportant">
        <img src="A395120_1_En_7_Figa_HTML.jpg" alt="A395120_1_En_7_Figa_HTML.jpg"/> Git commit: Contain Book Responses in a <span class="EmphasisFontCategoryNonProportional">data</span> Attribute</div><div id="Par49" class="Para ParaTypeImportant">9ded4b6 (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/9ded4b6"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/9ded4b6</span>
              </span></a></span>)</div></div><div id="Sec3" class="Section1 RenderAsSection1"><h2 class="Heading">The Fractal Response Class</h2><div id="Par50" class="Para ParaOneEmphasisChild">Now that your tests are passing again, you are free to start refactoring code or adding new features. I could end the chapter now, but experience says that changing arrays to include a <span class="EmphasisFontCategoryNonProportional">data</span> key like you’ve done isn’t going to scale very well. It does afford you passing tests and gives you the green light to refactor and make sure your tests still pass. As mentioned at the beginning of the chapter, you are going to lean on the Fractal library for handling your response data.</div><div id="Par51" class="Para">The first step is installing the Fractal (<span class="ExternalRef"><a href="http://fractal.thephpleague.com/"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">http://fractal.thephpleague.com/</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> library as a composer dependency (Listing <span class="InternalRef"><a href="#Par52">7-20</a></span>).</div><div id="Par52" class="Para">
            <div class="ProgramCode" id="PC20"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ composer require league/fractal=^0.13.0</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-20.</span><div class="SimplePara">Installing Fractal with Composer</div></div></div></div>
          </div><div id="Par53" class="Para">You will take the following steps to refactor responses:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par54" class="Para">Create a transformer (<span class="ExternalRef"><a href="http://fractal.thephpleague.com/transformers/"><span class="RefSource">
                      <span class="EmphasisFontCategoryNonProportional">http://fractal.thephpleague.com/transformers/</span>
                    </span></a></span>
              <span class="EmphasisFontCategoryNonProportional">)</span> for the <span class="EmphasisFontCategoryNonProportional">Book</span> model.</div></li><li><div id="Par55" class="Para">Create a dedicated Fractal service to transform models.</div></li><li><div id="Par56" class="Para">Create a service provider <span class="EmphasisFontCategoryNonProportional">(</span>
              <span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/providers"><span class="RefSource">
                      <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/providers</span>
                    </span></a></span>
              <span class="EmphasisFontCategoryNonProportional">)</span> to define the Fractal service.</div></li><li><div id="Par57" class="Para ParaOneEmphasisChild">Use the service in the <span class="EmphasisFontCategoryNonProportional">BooksController</span> to return responses.</div></li></ul></div>
      </div><div id="Sec4" class="Section2 RenderAsSection2"><h3 class="Heading">The Book Transformer</h3><div id="Par58" class="Para">The first step is creating a transformer for the <span class="EmphasisFontCategoryNonProportional">Book</span> model. Transformers in Fractal are responsible for transforming data into an array format. Your application will pass Eloquent models into transformers, and the transformer will be responsible for formatting the model data into an array. You will see shortly how this works in your controllers, but first, you will write a test-driven <span class="EmphasisFontCategoryNonProportional">Book</span> transformer.</div><div id="Par59" class="Para">Create the transformer test class (Listing <span class="InternalRef"><a href="#Par60">7-21</a></span>).</div><div id="Par60" class="Para">
              <div class="ProgramCode" id="PC21"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ mkdir -p tests/app/Transformer/</div><div class="FixedLine">$ touch tests/app/Transformer/BookTransformerTest.php</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-21.</span><div class="SimplePara">Creating the BookTransformerTest.php Test</div></div></div></div>
            </div><div id="Par61" class="Para">Listing <span class="InternalRef"><a href="#Par62">7-22</a></span> shows the skeleton of your implementation class.</div><div id="Par62" class="Para">
              <div class="ProgramCode" id="PC22"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Transformer;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> App\Book;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> App\Transformer\BookTransformer;</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">use</span> League\Fractal\TransformerAbstract;</div><div class="FixedLine"> 9  <span class="EmphasisTypeBold">use Laravel\Lumen\Testing\DatabaseMigrations</span>;</div><div class="FixedLine">10</div><div class="FixedLine">11  <span class="EmphasisTypeBold">class BookTransformerTest extends</span> TestCase</div><div class="FixedLine">12  {</div><div class="FixedLine">13      <span class="EmphasisTypeBold">use</span> DatabaseMigrations;</div><div class="FixedLine">14</div><div class="FixedLine">15      <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">16      <span class="EmphasisTypeBold">public function</span> it_can_be_initialized()</div><div class="FixedLine">17      {</div><div class="FixedLine">18          $subject = <span class="EmphasisTypeBold">new</span> BookTransformer();</div><div class="FixedLine">19          $this-&gt;assertInstanceOf(TransformerAbstract::class, $subject);</div><div class="FixedLine">20      }</div><div class="FixedLine">21  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-22.</span><div class="SimplePara">The BookTransformerTest Class Skeleton</div></div></div></div>
            </div><div id="Par63" class="Para">I like to write an initialization test for unit tests. I find that starting with a simple initialization test gets me past the mental hurdle of starting to write tests for a class, and I can start building off of that first test that just gets my foot in the door.</div><div id="Par64" class="Para">What happens if you run this test without creating the class (Listing <span class="InternalRef"><a href="#Par65">7-23</a></span>)?</div><div id="Par65" class="Para">
              <div class="ProgramCode" id="PC23"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=BookTransformerTest</div></div><div class="LineGroup"><div class="FixedLine">There was 1 error:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Transformer\BookTransformerTest::it_can_be_initialized</div><div class="FixedLine">Error: Class 'App\Transformer\BookTransformer' not found</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Transformer/BookTransformerTest.php:18</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 1, Assertions: 0, Errors: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-23.</span><div class="SimplePara">First Test Run For The BookTransforerTest</div></div></div></div>
            </div><div id="Par66" class="Para">Obviously, you haven’t defined the <span class="EmphasisFontCategoryNonProportional">BookTransformer</span> yet, but it’s nice that PHPUnit can keep us honest; to get the initialization test passing you must define the class (Listing <span class="InternalRef"><a href="#Par67">7-24</a></span>).</div><div id="Par67" class="Para">
              <div class="ProgramCode" id="PC24"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ mkdir -p app/Transformer</div><div class="FixedLine">$ touch app/Transformer/BookTransformer.php</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-24.</span><div class="SimplePara">Creating the BookTransformer Class</div></div></div></div>
            </div><div id="Par68" class="Para">
              <div class="ProgramCode" id="PC25"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Transformer;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> League\Fractal\TransformerAbstract;</div><div class="FixedLine"> 6</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">class BookTransformer extends</span> TransformerAbstract</div><div class="FixedLine"> 8  {</div><div class="FixedLine"> 9</div><div class="FixedLine">10  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><div class="SimplePara">Define the BookTransformer Class</div></div></div></div>
            </div><div id="Par69" class="Para ParaOneEmphasisChild">Fractal transformers extend the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">League\Fractal\TransformerAbstract</span></span> class provided by Fractal. All your transformers should extend this class.</div><div id="Par70" class="Para">Now that you have your <span class="EmphasisFontCategoryNonProportional">BookTransformer</span> class, your test should pass now (Listing <span class="InternalRef"><a href="#Par71">7-25</a></span>).</div><div id="Par71" class="Para">
              <div class="ProgramCode" id="PC26"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=BookTransformerTest</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 1 assertion)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-25.</span><div class="SimplePara">The Initializable Test Passes</div></div></div></div>
            </div><div id="Par72" class="Para">Ok, now you are ready to write your next test describing how the <span class="EmphasisFontCategoryNonProportional">BookTransformer</span> should transform a <span class="EmphasisFontCategoryNonProportional">Book</span> model (Listing <span class="InternalRef"><a href="#Par73">7-26</a></span>). Transforming model data will allow all controllers rendering book data to use a consistent transformation.</div><div id="Par73" class="Para">
              <div class="ProgramCode" id="PC27"><div class="FixedLine">22  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">23  <span class="EmphasisTypeBold">public function</span> it_transforms_a_book_model()</div><div class="FixedLine">24  {</div><div class="FixedLine">25      $book = factory(Book::class)-&gt;create();</div><div class="FixedLine">26      $subject = <span class="EmphasisTypeBold">new</span> BookTransformer();</div><div class="FixedLine">27</div><div class="FixedLine">28      $transform = $subject-&gt;transform($book);</div><div class="FixedLine">29</div><div class="FixedLine">30      $this-&gt;assertArrayHasKey('id', $transform);</div><div class="FixedLine">31      $this-&gt;assertArrayHasKey('title', $transform);</div><div class="FixedLine">32      $this-&gt;assertArrayHasKey('description', $transform);</div><div class="FixedLine">33      $this-&gt;assertArrayHasKey('author', $transform);</div><div class="FixedLine">34      $this-&gt;assertArrayHasKey('created_at', $transform);</div><div class="FixedLine">35      $this-&gt;assertArrayHasKey('updated_at', $transform);</div><div class="FixedLine">36  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-26.</span><div class="SimplePara">Test to Transform a Book Model</div></div></div></div>
            </div><div id="Par74" class="Para">You can see the missing method you have not defined in the transformer—the <span class="EmphasisFontCategoryNonProportional">transform()</span> method. The test passes a model from the factory that exists in the database, and then asserts that the model has all the keys you expect a book response to contain. The book must exist in the database because your transformer is transforming existing records, including the <span class="EmphasisFontCategoryNonProportional">id</span> attribute.</div><div id="Par75" class="Para">You are ready to write the <span class="EmphasisFontCategoryNonProportional">BookTransformer::transform()</span> implementation. The <span class="EmphasisFontCategoryNonProportional">transform</span> method allows you to define a public data interface of the book model while the internal details are hidden. This means that your internal logic can change but the API consumer continues to get the same data interface (Listing <span class="InternalRef"><a href="#Par76">7-27</a></span>).</div><div id="Par76" class="Para">
              <div class="ProgramCode" id="PC28"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Transformer;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> App\Book;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> League\Fractal\TransformerAbstract;</div><div class="FixedLine"> 7</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">class BookTransformer extends</span> TransformerAbstract</div><div class="FixedLine"> 9  {</div><div class="FixedLine">10      <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">11       <span class="EmphasisTypeItalic">* Transform a Book model into an array</span>
            </div><div class="FixedLine">12       <span class="EmphasisTypeItalic">*</span>
            </div><div class="FixedLine">13       <span class="EmphasisTypeItalic">* @param Book $book</span>
            </div><div class="FixedLine">14       <span class="EmphasisTypeItalic">* @return array</span>
            </div><div class="FixedLine">15       <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">16      <span class="EmphasisTypeBold">public function</span> transform(Book $book)</div><div class="FixedLine">17      {</div><div class="FixedLine">18          <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">19              'id'          =&gt; $book-&gt;id,</div><div class="FixedLine">20              'title'       =&gt; $book-&gt;title,</div><div class="FixedLine">21              'description' =&gt; $book-&gt;description,</div><div class="FixedLine">22              'author'      =&gt; $book-&gt;author,</div><div class="FixedLine">23              'created'     =&gt; $book-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">24              'updated'     =&gt; $book-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">25          ];</div><div class="FixedLine">26      }</div><div class="FixedLine">27  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-27.</span><div class="SimplePara">Writing the BookTransformer::transform() Method</div></div></div></div>
            </div><div id="Par77" class="Para">Note that the <span class="EmphasisFontCategoryNonProportional">created</span> and <span class="EmphasisFontCategoryNonProportional">updated</span> keys do not match your database column. What is really cool about using Fractal transformers is abstracting the API format from the database schema when it makes sense. In this case, is it necessary to change <span class="EmphasisFontCategoryNonProportional">created_at</span> into <span class="EmphasisFontCategoryNonProportional">created</span>? Probably not, but it serves as an illustration of how you can change the background implementation details and <span class="EmphasisTypeItalic">continue to provide consistent data transformation</span> to the API user.</div><div id="Par78" class="Para">As an example, say that when a new book is created in the database you immediately offer it for sale in your online store. Imagine that the application needs to display how long ago the title was released in a relative format (Listing <span class="InternalRef"><a href="#Par79">7-28</a></span>).</div><div id="Par79" class="Para">
              <div class="ProgramCode" id="PC29"><div class="FixedLine">1  <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">2      'id' =&gt; $book-&gt;id,</div><div class="FixedLine">3      'title' =&gt; $book-&gt;title,</div><div class="FixedLine">4      'description' =&gt; $book-&gt;description,</div><div class="FixedLine">5      'author' =&gt; $book-&gt;author,</div><div class="FixedLine">6      'created' =&gt; $book-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">7      'updated' =&gt; $book-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">8      'released' =&gt; $book-&gt;created_at-&gt;diffForHumans()</div><div class="FixedLine">9  ]</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-28.</span><div class="SimplePara">Example Transformation</div></div></div></div>
            </div><div id="Par80" class="Para">In this example, the <span class="EmphasisFontCategoryNonProportional">released</span> key is tied to <span class="EmphasisFontCategoryNonProportional">created_at</span> field and uses Carbon’s (<span class="ExternalRef"><a href="http://carbon.nesbot.com/"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">http://carbon.nesbot.com/</span>
                </span></a></span>
          <span class="EmphasisFontCategoryNonProportional">)diffForHumans()</span> method to provide a relative date. In the future, you could change the <span class="EmphasisFontCategoryNonProportional">'released'</span> key to use a <span class="EmphasisFontCategoryNonProportional">'published'</span> datetime column from the database and the implementation details would be invisible to consumers. Note that the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">created_at</span></span> and <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">updated_at</span></span> properties in the example are also Carbon instances.</div><div id="FPar1" class="FormalPara FormalParaRenderingStyle3 ParaTypeOverview"><div class="Heading">Date Mutators</div><div id="Par81" class="Para">Eloquent automatically provides a <span class="EmphasisFontCategoryNonProportional">Carbon</span> instance for <span class="EmphasisFontCategoryNonProportional">created_at</span> and <span class="EmphasisFontCategoryNonProportional">updated_at</span>, but you can configure your model to provide <span class="EmphasisFontCategoryNonProportional">Carbon</span> for other fields. See the “Date Mutators” section (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/eloquent-mutators#date-mutators"><span class="RefSource">
                    <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/eloquent-mutators#date-mutators</span>
                  </span></a></span>) in the Laravel documentation.</div></div><div id="Par82" class="Para">Next, you need to run your implementation to see if it satisfies your test (Listing <span class="InternalRef"><a href="#Par83">7-29</a></span>).</div><div id="Par83" class="Para">
              <div class="ProgramCode" id="PC30"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=BookTransformerTest::it_transforms_a_book_model</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Transformer\BookTransformerTest::it_transforms_a_book_model</div><div class="FixedLine">Failed asserting that an array has the key 'created_at'.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Transformer/BookTransformerTest.php:34</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 1, Assertions: 6, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-29.</span><div class="SimplePara">Runing the BookTransformer Test</div></div></div></div>
            </div><div id="Par84" class="Para">Whoops! Your test was looking for <span class="EmphasisFontCategoryNonProportional">created_at</span> but you designed your transformer to use <span class="EmphasisFontCategoryNonProportional">created</span>. Let’s fix the test to match your transformer (Listing <span class="InternalRef"><a href="#Par85">7-30</a></span>) and run the test again.</div><div id="Par85" class="Para">
              <div class="ProgramCode" id="PC31"><div class="FixedLine">34  $this-&gt;assertArrayHasKey('created', $transform);</div><div class="FixedLine">35  $this-&gt;assertArrayHasKey('updated', $transform);</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-30.</span><div class="SimplePara">Fixing the BookTransformerTest to Match BookTransformer::transform()</div></div></div></div>
            </div><div id="Par86" class="Para">With your created and updated key assertions, let’s run your test again (Listing <span class="InternalRef"><a href="#Par87">7-31</a></span>).</div><div id="Par87" class="Para">
              <div class="ProgramCode" id="PC32"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=BookTransformerTest::it_transforms_a_book_model</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 7 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-31.</span><div class="SimplePara">Running PHPUnit Test for the BookTransfomer</div></div></div></div>
            </div></div><div id="Sec5" class="Section2 RenderAsSection2"><h3 class="Heading">The Fractal Response Class</h3><div id="Par88" class="Para">It’s time to move on to your Fractal response class. If you look at the Fractal documentation for a simple transformer example (<span class="ExternalRef"><a href="http://fractal.thephpleague.com/simple-example/"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">http://fractal.thephpleague.com/simple-example/</span>
                </span></a></span>
          <span class="EmphasisFontCategoryNonProportional">),</span> you will see that you need a <span class="EmphasisFontCategoryNonProportional">League\Fractal\Manager</span> class. You could use the manager class directly in your controllers, but let’s provide a service for the Fractal manager.</div><div id="Par89" class="Para">You will call your service <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">App\Http\Response\FractalResponse</span></span> and start by writing some tests for it (Listing <span class="InternalRef"><a href="#Par90">7-32</a></span>).</div><div id="Par90" class="Para">
              <div class="ProgramCode" id="PC33"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ mkdir -p app/Http/Response</div><div class="FixedLine">$ touch app/Http/Response/FractalResponse.php</div><div class="FixedLine">$ mkdir -p tests/app/Http/Response</div><div class="FixedLine">$ touch tests/app/Http/Response/FractalResponseTest.php</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-32.</span><div class="SimplePara">Setting Up the FractalResponse Files</div></div></div></div>
            </div><div id="Par91" class="Para">Write the class initialization test first (Listing <span class="InternalRef"><a href="#Par92">7-33</a></span>).</div><div id="Par92" class="Para">
              <div class="ProgramCode" id="PC34"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Http\Response;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> App\Http\Response\FractalResponse;</div><div class="FixedLine"> 7</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">class FractalResponseTest extends</span> TestCase</div><div class="FixedLine"> 9  {</div><div class="FixedLine">10      <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">11      <span class="EmphasisTypeBold">public function</span> it_can_be_initialized()</div><div class="FixedLine">12      {</div><div class="FixedLine">13          $this-&gt;assertInstanceOf(FractalResponse::class, <span class="EmphasisTypeBold">new</span> FractalResponse());</div><div class="FixedLine">14      }</div><div class="FixedLine">15  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-33.</span><div class="SimplePara">Test for FractalResponse Initialization</div></div></div></div>
            </div><div id="Par93" class="Para">Running the test will fail at this point. Listing <span class="InternalRef"><a href="#Par94">7-34</a></span> shows the initial class skeleton to get it passing again.</div><div id="Par94" class="Para">
              <div class="ProgramCode" id="PC35"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Response;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">class FractalResponse</span>
            </div><div class="FixedLine"> 6  {</div><div class="FixedLine"> 7      <span class="EmphasisTypeBold">public function</span> __construct()</div><div class="FixedLine"> 8      {</div><div class="FixedLine"> 9</div><div class="FixedLine">10      }</div><div class="FixedLine">11  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-34.</span><div class="SimplePara">Initial FractalResponse Skeleton Class</div></div></div></div>
            </div><div id="Par95" class="Para">The <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> constructor will have a few dependencies: a <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">League\Fractal\Manager</span></span> instance and a <span class="EmphasisFontCategoryNonProportional">DataArraySerializer</span> (<span class="ExternalRef"><a href="http://fractal.thephpleague.com/serializers/#dataarrayserializer"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">http://fractal.thephpleague.com/serializers/#dataarrayserializer</span>
                </span></a></span>
          <span class="EmphasisFontCategoryNonProportional">)</span> instance.</div><div id="Par96" class="Para">Serializers provide structure around your data without affecting transformers—in your case, that means wrapping your transformer output in a <span class="EmphasisFontCategoryNonProportional">"data"</span> property using the <span class="EmphasisFontCategoryNonProportional">DataArraySerializer</span>. The manager sets the serializer by calling <span class="EmphasisFontCategoryNonProportional">setSerializer()</span> and passing a serializer instance. Serializers extend from the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">League\Fractal\Serializer\SerializerAbstract</span></span> class so you can even write your unit tests against the abstract implementation!</div><div id="Par97" class="Para">Let’s flesh out your FractalResponse initialization dependencies in a test (Listing <span class="InternalRef"><a href="#Par98">7-35</a></span>).</div><div id="Par98" class="Para">
              <div class="ProgramCode" id="PC36"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Http\Response;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> Mockery <span class="EmphasisTypeBold">as</span> m;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> League\Fractal\Manager;</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">use</span> App\Http\Response\FractalResponse;</div><div class="FixedLine"> 9  <span class="EmphasisTypeBold">use</span> League\Fractal\Serializer\SerializerAbstract;</div><div class="FixedLine">10</div><div class="FixedLine">11  <span class="EmphasisTypeBold">class FractalResponseTest extends</span> TestCase</div><div class="FixedLine">12  {</div><div class="FixedLine">13      <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">14      <span class="EmphasisTypeBold">public function</span> it_can_be_initialized()</div><div class="FixedLine">15      {</div><div class="FixedLine">16          $manager = m::mock(Manager::class);</div><div class="FixedLine">17          $serializer = m::mock(SerializerAbstract::class);</div><div class="FixedLine">18</div><div class="FixedLine">19          $manager</div><div class="FixedLine">20              -&gt;shouldReceive('setSerializer')</div><div class="FixedLine">21              -&gt;with($serializer)</div><div class="FixedLine">22              -&gt;once()</div><div class="FixedLine">23              -&gt;andReturn($manager);</div><div class="FixedLine">24</div><div class="FixedLine">25          $fractal = <span class="EmphasisTypeBold">new</span> FractalResponse($manager, $serializer);</div><div class="FixedLine">26          $this-&gt;assertInstanceOf(FractalResponse::class, $fractal);</div><div class="FixedLine">27      }</div><div class="FixedLine">28  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-35.</span><div class="SimplePara">Testing the FractalResponse with a Manager Dependency</div></div></div></div>
            </div><div id="Par99" class="Para">The whole class is provided for clarity. Note the use of Mockery’s <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">shouldReceive</span></span> method, which sets an expectation that <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> calls <span class="EmphasisFontCategoryNonProportional">setSerializer</span> once. The test mocks <span class="EmphasisFontCategoryNonProportional">SerializerAbstract</span> and expects that the manager will receive a call to <span class="EmphasisFontCategoryNonProportional">setSerializer</span> with the mock. The last part of test asserts the <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> class was successfully initialized.</div><div id="Par100" class="Para">It’s time to ensure that your new test fails (Listing <span class="InternalRef"><a href="#Par101">7-36</a></span>).</div><div id="Par101" class="Para">
              <div class="ProgramCode" id="PC37"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=FractalResponseTest</div></div><div class="LineGroup"><div class="FixedLine">There was 1 error:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Response\FractalResponseTest::it_can_be_initialized</div><div class="FixedLine">Mockery\Exception\InvalidCountException: Method setSerializer(object(Mockery_7_L\</div><div class="FixedLine">eague_Fractal_Serializer_SerializerAbstract)) from Mockery_6_League_Fractal_Manager should be called</div><div class="FixedLine">exactly 1 times but called 0 times.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/vendor/mockery/mockery/library/Mockery/CountValidator/Exact.php:37</div><div class="FixedLine">/home/vagrant/Code/bookr/vendor/mockery/mockery/library/Mockery/Expectation.php:271</div><div class="FixedLine">/home/vagrant/Code/bookr/vendor/mockery/mockery/library/Mockery/ExpectationDirector.php:120</div><div class="FixedLine">/home/vagrant/Code/bookr/vendor/mockery/mockery/library/Mockery/Container.php:297</div><div class="FixedLine">/home/vagrant/Code/bookr/vendor/mockery/mockery/library/Mockery/Container.php:282</div><div class="FixedLine">/home/vagrant/Code/bookr/vendor/mockery/mockery/library/Mockery.php:142</div><div class="FixedLine">/home/vagrant/Code/bookr/vendor/mockery/mockery/library/Mockery/Adapter/Phpunit/MockeryPHPUnitIntegration.php:24</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 1, Assertions: 2, Errors: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-36.</span><div class="SimplePara">Testing Initialization of FractalResponse</div></div></div></div>
            </div><div id="Par102" class="Para">You will notice that Mockery expected <span class="EmphasisFontCategoryNonProportional">setSerializer()</span> to be called once, but you haven’t introduced the manager and serializer parameters in the constructor. Now you are ready to write out your implementation (Listing <span class="InternalRef"><a href="#Par103">7-37</a></span>).</div><div id="Par103" class="Para">
              <div class="ProgramCode" id="PC38"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Response;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> League\Fractal\Manager;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> League\Fractal\Serializer\SerializerAbstract;</div><div class="FixedLine"> 7</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">class FractalResponse</span>
            </div><div class="FixedLine"> 9  {</div><div class="FixedLine">10      <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">11       <span class="EmphasisTypeItalic">* @var Manager</span>
            </div><div class="FixedLine">12       <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">13      <span class="EmphasisTypeBold">private</span> $manager;</div><div class="FixedLine">14</div><div class="FixedLine">15      <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">16       <span class="EmphasisTypeItalic">* @var SerializerAbstract</span>
            </div><div class="FixedLine">17       <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">18      <span class="EmphasisTypeBold">private</span> $serializer;</div><div class="FixedLine">19</div><div class="FixedLine">20      <span class="EmphasisTypeBold">public function</span> __construct(Manager $manager, SerializerAbstract $serializer)</div><div class="FixedLine">21      {</div><div class="FixedLine">22          $this-&gt;manager = $manager;</div><div class="FixedLine">23          $this-&gt;serializer = $serializer;</div><div class="FixedLine">24          $this-&gt;manager-&gt;setSerializer($serializer);</div><div class="FixedLine">25      }</div><div class="FixedLine">26  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-37.</span><div class="SimplePara">FractalResponse Defines the Manager and Serializer Dependencies</div></div></div></div>
            </div><div id="Par104" class="Para ParaOneEmphasisChild">Your constructor type hints <span class="EmphasisFontCategoryNonProportional">SerializerAbstract,</span> which allows you to accept any instance that extends the abstract class so you can swap it out whenever you wish.</div><div id="Par105" class="Para">The <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> class is not very useful right now; you are ready to add a few methods that controllers can use to create response data. You know, based on your <span class="EmphasisFontCategoryNonProportional">BooksController,</span> that you need to support serializing collections and individual records. You will define two public methods, <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">FractalResponse::item()</span></span> and <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">FractalResponse::collection()</span></span>, which will use Resources (<span class="ExternalRef"><a href="http://fractal.thephpleague.com/resources/"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">http://fractal.thephpleague.com/resources/</span>
                </span></a></span>
          <span class="EmphasisFontCategoryNonProportional">)</span> to transform the data and convert it into an array.</div><div id="Par106" class="Para">Listing <span class="InternalRef"><a href="#Par107">7-38</a></span> is an example of how you will use your service.</div><div id="Par107" class="Para">
              <div class="ProgramCode" id="PC39"><div class="LineGroup"><div class="FixedLine">
                    <span class="EmphasisTypeItalic">// BooksController::show()</span>
                  </div><div class="FixedLine">
                <span class="EmphasisTypeBold">return</span> $this-&gt;fractal-&gt;item($book, <span class="EmphasisTypeBold">new</span> BookTransformer());</div></div><div class="LineGroup"><div class="FixedLine">
                    <span class="EmphasisTypeItalic">// BooksController::index()</span>
                  </div><div class="FixedLine">
                <span class="EmphasisTypeBold">return</span> $this-&gt;fractal-&gt;collection($books, <span class="EmphasisTypeBold">new</span> BookTransformer());</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-38.</span><div class="SimplePara">Example FractalResponse Method Usage</div></div></div></div>
            </div><div id="Par108" class="Para">You will start with the <span class="EmphasisFontCategoryNonProportional">FractalResponse::item()</span> method first. The basic usage of Fractal to return an item might look like Listing <span class="InternalRef"><a href="#Par109">7-39</a></span>.</div><div id="Par109" class="Para">
              <div class="ProgramCode" id="PC40"><div class="LineGroup"><div class="FixedLine">$data = ['bar' =&gt; 'bar'];</div><div class="FixedLine">$manager = <span class="EmphasisTypeBold">new</span> \League\Fractal\Manager();</div><div class="FixedLine">$item = <span class="EmphasisTypeBold">new</span> \League\Fractal\Resource\Item($data, <span class="EmphasisTypeBold">function</span> (<span class="EmphasisTypeBold">array</span> $data) {</div><div class="FixedLine">    <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">        'foo' =&gt; $data['bar']</div><div class="FixedLine">    ];</div><div class="FixedLine">});</div></div><div class="LineGroup"><div class="FixedLine">$manager-&gt;createData($item)-&gt;toArray();</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-39.</span><div class="SimplePara">Example Usage of Fractal Manager Item</div></div></div></div>
            </div><div id="Par110" class="Para">In this code, you create a <span class="EmphasisFontCategoryNonProportional">Manager</span> instance and an <span class="EmphasisFontCategoryNonProportional">Item</span> resource. The manager calls <span class="EmphasisFontCategoryNonProportional">createData(),</span> which returns an instance of <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">League\Fractal\Scope</span></span>, and then you chain a <span class="EmphasisFontCategoryNonProportional">toArray()</span> call on the scope. This simple example illustrates using a <span class="EmphasisFontCategoryNonProportional">Closure</span> but you will pass a transformer object in your implementation.</div><div id="Par111" class="Para">With that in mind, write a test for your FractalResponse::item() method (Listing <span class="InternalRef"><a href="#Par112">7-40</a></span>).</div><div id="Par112" class="Para">
              <div class="ProgramCode" id="PC41"><div class="FixedLine">29  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine">30  <span class="EmphasisTypeBold">public function</span> it_can_transform_an_item()</div><div class="FixedLine">31  {</div><div class="FixedLine">32      <span class="EmphasisTypeItalic">// Transformer</span>
            </div><div class="FixedLine">33      $transformer = m::mock('League\Fractal\TransformerAbstract');</div><div class="FixedLine">34</div><div class="FixedLine">35      <span class="EmphasisTypeItalic">// Scope</span>
            </div><div class="FixedLine">36      $scope = m::mock('League\Fractal\Scope');</div><div class="FixedLine">37      $scope</div><div class="FixedLine">38          -&gt;shouldReceive('toArray')</div><div class="FixedLine">39          -&gt;once()</div><div class="FixedLine">40          -&gt;andReturn(['foo' =&gt; 'bar']);</div><div class="FixedLine">41</div><div class="FixedLine">42      <span class="EmphasisTypeItalic">// Serializer</span>
            </div><div class="FixedLine">43      $serializer = m::mock('League\Fractal\Serializer\SerializerAbstract');</div><div class="FixedLine">44</div><div class="FixedLine">45      $manager = m::mock('League\Fractal\Manager');</div><div class="FixedLine">46      $manager</div><div class="FixedLine">47          -&gt;shouldReceive('setSerializer')</div><div class="FixedLine">48          -&gt;with($serializer)</div><div class="FixedLine">49          -&gt;once();</div><div class="FixedLine">50</div><div class="FixedLine">51      $manager</div><div class="FixedLine">52          -&gt;shouldReceive('createData')</div><div class="FixedLine">53          -&gt;once()</div><div class="FixedLine">54          -&gt;andReturn($scope);</div><div class="FixedLine">55</div><div class="FixedLine">56      $subject = <span class="EmphasisTypeBold">new</span> FractalResponse($manager, $serializer);</div><div class="FixedLine">57      $this-&gt;assertInternalType(</div><div class="FixedLine">58          'array',</div><div class="FixedLine">59          $subject-&gt;item(['foo' =&gt; 'bar'], $transformer)</div><div class="FixedLine">60      );</div><div class="FixedLine">61  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-40.</span><div class="SimplePara">Test for the FractalResponse::item() Method</div></div></div></div>
            </div><div id="Par113" class="Para">This is a pretty long test, so let’s break it down:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par114" class="Para">You mock a transformer that the <span class="EmphasisFontCategoryNonProportional">item</span> method will accept (<span class="EmphasisFontCategoryNonProportional">BookTransformer</span>).</div></li><li><div id="Par115" class="Para">You mock a <span class="EmphasisFontCategoryNonProportional">Scope</span> object that will be returned from the <span class="EmphasisFontCategoryNonProportional">Manager::createData()</span> method call.</div></li><li><div id="Par116" class="Para">You mock the serializer to initialize your class.</div></li><li><div id="Par117" class="Para">You mock the manager class, which should receive a call to <span class="EmphasisFontCategoryNonProportional">createdData</span> and <span class="EmphasisFontCategoryNonProportional">setSerializer.</span>
              </div></li><li><div id="Par118" class="Para">Finally, you initialize the class under test and assert that the <span class="EmphasisFontCategoryNonProportional">item</span> method returns the internal type <span class="EmphasisFontCategoryNonProportional">array</span>.</div></li></ul></div>
        </div><div id="Par119" class="Para">I must say, it’s pretty neat when tests help design how you write your implementation. Now that you have a failing test (you can run it on your own) you are ready to write some code (Listing <span class="InternalRef"><a href="#Par120">7-41</a></span>).</div><div id="Par120" class="Para">
              <div class="ProgramCode" id="PC42"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Response;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> League\Fractal\Manager;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> League\Fractal\Resource\Item;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> League\Fractal\TransformerAbstract;</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">use</span> League\Fractal\Serializer\SerializerAbstract;</div><div class="FixedLine"> 9</div><div class="FixedLine">10  <span class="EmphasisTypeBold">class FractalResponse</span>
            </div><div class="FixedLine">11  {</div><div class="FixedLine">12      <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">13       <span class="EmphasisTypeItalic">* @var Manager</span>
            </div><div class="FixedLine">14       <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">15      <span class="EmphasisTypeBold">private</span> $manager;</div><div class="FixedLine">16</div><div class="FixedLine">17      <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">18       <span class="EmphasisTypeItalic">* @var SerializerAbstract</span>
            </div><div class="FixedLine">19       <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">20      <span class="EmphasisTypeBold">private</span> $serializer;</div><div class="FixedLine">21</div><div class="FixedLine">22      <span class="EmphasisTypeBold">public function</span> __construct(Manager $manager, SerializerAbstract $serializer)</div><div class="FixedLine">23      {</div><div class="FixedLine">24          $this-&gt;manager = $manager;</div><div class="FixedLine">25          $this-&gt;serializer = $serializer;</div><div class="FixedLine">26          $this-&gt;manager-&gt;setSerializer($serializer);</div><div class="FixedLine">27      }</div><div class="FixedLine">28</div><div class="FixedLine">29      <span class="EmphasisTypeBold">public function</span> item($data, TransformerAbstract $transformer, $resourceKey = <span class="EmphasisTypeBold">null</span>)</div><div class="FixedLine">30      {</div><div class="FixedLine">31          $resource = <span class="EmphasisTypeBold">new</span> Item($data, $transformer, $resourceKey);</div><div class="FixedLine">32</div><div class="FixedLine">33          <span class="EmphasisTypeBold">return</span> $this-&gt;manager-&gt;createData($resource)-&gt;toArray();</div><div class="FixedLine">34      }</div><div class="FixedLine">35  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-41.</span><div class="SimplePara">The FractalResponse::item() Implementation</div></div></div></div>
            </div><div id="Par121" class="Para">The <span class="EmphasisFontCategoryNonProportional">item()</span> method accepts the data to be transformed, a transformer (<span class="EmphasisFontCategoryNonProportional">BookTransformer</span>), and a resource key. You will not be using the resource key, but you want to support the full <span class="EmphasisFontCategoryNonProportional">League\Fractal\Resource\Item</span> API. You create a new <span class="EmphasisFontCategoryNonProportional">League\Fractal\Resource\Item</span> instance and pass it to the manager’s <span class="EmphasisFontCategoryNonProportional">createData</span> method. The <span class="EmphasisFontCategoryNonProportional">createData</span> method returns a <span class="EmphasisFontCategoryNonProportional">League\Fractal\Scope</span> instance and you call <span class="EmphasisFontCategoryNonProportional">toArray</span> to return array data from the <span class="EmphasisFontCategoryNonProportional">League\Fractal\Scope</span> instance.</div><div id="Par122" class="Para ParaTypeImportant">
          <img src="A395120_1_En_7_Figb_HTML.jpg" alt="A395120_1_En_7_Figb_HTML.jpg"/> You can read about resource keys in the official Fractal serializer (<span class="ExternalRef"><a href="http://fractal.thephpleague.com/serializers/"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">http://fractal.thephpleague.com/serializers/</span>
                </span></a></span>
          <span class="EmphasisFontCategoryNonProportional">)</span> documentation</div><div id="Par123" class="Para">You are ready to run the tests after your first stab at the implementation (Listing <span class="InternalRef"><a href="#Par124">7-42</a></span>).</div><div id="Par124" class="Para">
              <div class="ProgramCode" id="PC43"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (20 tests, 75 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-42.</span><div class="SimplePara">Testing the FractalResponse::item() Implementation</div></div></div></div>
            </div><div id="Par125" class="Para">You can move on to your <span class="EmphasisFontCategoryNonProportional">collection</span> method test. The <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">FractalResponse::collection()</span></span> method is very similar to the <span class="EmphasisFontCategoryNonProportional">item</span> method, so I won’t spend much time on it. You will be passing the <span class="EmphasisFontCategoryNonProportional">collection</span> method an <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Illuminate\Database\Eloquent\Collection</span></span> to iterate over the collection and transform each item. Listing <span class="InternalRef"><a href="#Par126">7-43</a></span> shows the test for the <span class="EmphasisFontCategoryNonProportional">collection</span> method.</div><div id="Par126" class="Para">
              <div class="ProgramCode" id="PC44"><div class="FixedLine"> 63  <span class="EmphasisTypeItalic">/** @test **/</span>
            </div><div class="FixedLine"> 64  <span class="EmphasisTypeBold">public function</span> it_can_transform_a_collection()</div><div class="FixedLine"> 65  {</div><div class="FixedLine"> 66      $data = [</div><div class="FixedLine"> 67          ['foo' =&gt; 'bar'],</div><div class="FixedLine"> 68          ['fizz' =&gt; 'buzz'],</div><div class="FixedLine"> 69      ];</div><div class="FixedLine"> 70</div><div class="FixedLine"> 71      <span class="EmphasisTypeItalic">// Transformer</span>
            </div><div class="FixedLine"> 72      $transformer = m::mock('League\Fractal\TransformerAbstract');</div><div class="FixedLine"> 73</div><div class="FixedLine"> 74      <span class="EmphasisTypeItalic">// Scope</span>
            </div><div class="FixedLine"> 75      $scope = m::mock('League\Fractal\Scope');</div><div class="FixedLine"> 76      $scope</div><div class="FixedLine"> 77          -&gt;shouldReceive('toArray')</div><div class="FixedLine"> 78          -&gt;once()</div><div class="FixedLine"> 79          -&gt;andReturn($data);</div><div class="FixedLine"> 80</div><div class="FixedLine"> 81      <span class="EmphasisTypeItalic">// Serializer</span>
            </div><div class="FixedLine"> 82      $serializer = m::mock('League\Fractal\Serializer\SerializerAbstract');</div><div class="FixedLine"> 83</div><div class="FixedLine"> 84      $manager = m::mock('League\Fractal\Manager');</div><div class="FixedLine"> 85      $manager</div><div class="FixedLine"> 86          -&gt;shouldReceive('setSerializer')</div><div class="FixedLine"> 87          -&gt;with($serializer)</div><div class="FixedLine"> 88          -&gt;once();</div><div class="FixedLine"> 89</div><div class="FixedLine"> 90      $manager</div><div class="FixedLine"> 91          -&gt;shouldReceive('createData')</div><div class="FixedLine"> 92          -&gt;once()</div><div class="FixedLine"> 93          -&gt;andReturn($scope);</div><div class="FixedLine"> 94</div><div class="FixedLine"> 95      $subject = <span class="EmphasisTypeBold">new</span> FractalResponse($manager, $serializer);</div><div class="FixedLine"> 96      $this-&gt;assertInternalType(</div><div class="FixedLine"> 97          'array',</div><div class="FixedLine"> 98          $subject-&gt;collection($data, $transformer)</div><div class="FixedLine"> 99      );</div><div class="FixedLine">100  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-43.</span><div class="SimplePara">Initial Test for the FractalResponse::collection() Method</div></div></div></div>
            </div><div id="Par127" class="Para">This test is nearly identical to your <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">FractalResponseTest::it_can_transform_an_item()</span></span> <span class="EmphasisFontCategoryNonProportional">test</span>. The only difference is that you are calling the <span class="EmphasisFontCategoryNonProportional">collection</span> method instead. You could merge the <span class="EmphasisFontCategoryNonProportional">item</span> and <span class="EmphasisFontCategoryNonProportional">collection</span> tests into one, but let’s leave them separate for clarity.</div><div id="Par128" class="Para">Listing <span class="InternalRef"><a href="#Par129">7-44</a></span> shows the implementation for <span class="EmphasisFontCategoryNonProportional">FractalResponse::collection()</span>.</div><div id="Par129" class="Para">
              <div class="ProgramCode" id="PC45"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Response;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> League\Fractal\Manager;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> League\Fractal\Resource\Item;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> League\Fractal\TransformerAbstract;</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">use</span> League\Fractal\Resource\Collection;</div><div class="FixedLine"> 9  <span class="EmphasisTypeBold">use</span> League\Fractal\Serializer\SerializerAbstract;</div><div class="FixedLine">10</div><div class="FixedLine">11  <span class="EmphasisTypeBold">class FractalResponse</span>
            </div><div class="FixedLine">12  {</div><div class="FixedLine">13      <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">14       <span class="EmphasisTypeItalic">* @var Manager</span>
            </div><div class="FixedLine">15       <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">16      <span class="EmphasisTypeBold">private</span> $manager;</div><div class="FixedLine">17</div><div class="FixedLine">18      <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">19       <span class="EmphasisTypeItalic">* @var SerializerAbstract</span>
            </div><div class="FixedLine">20       <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">21      <span class="EmphasisTypeBold">private</span> $serializer;</div><div class="FixedLine">22</div><div class="FixedLine">23      <span class="EmphasisTypeBold">public function</span> __construct(Manager $manager, SerializerAbstract $serializer)</div><div class="FixedLine">24      {</div><div class="FixedLine">25          $this-&gt;manager = $manager;</div><div class="FixedLine">26          $this-&gt;serializer = $serializer;</div><div class="FixedLine">27          $this-&gt;manager-&gt;setSerializer($serializer);</div><div class="FixedLine">28      }</div><div class="FixedLine">29</div><div class="FixedLine">30      <span class="EmphasisTypeBold">public function</span> item($data, TransformerAbstract $transformer, $resourceKey = <span class="EmphasisTypeBold">null</span>)</div><div class="FixedLine">31      {</div><div class="FixedLine">32          $resource = <span class="EmphasisTypeBold">new</span> Item($data, $transformer, $resourceKey);</div><div class="FixedLine">33</div><div class="FixedLine">34          <span class="EmphasisTypeBold">return</span> $this-&gt;manager-&gt;createData($resource)-&gt;toArray();</div><div class="FixedLine">35      }</div><div class="FixedLine">36</div><div class="FixedLine">37      <span class="EmphasisTypeBold">public function</span> collection($data, TransformerAbstract $transformer, $resourceKey = <span class="EmphasisTypeBold">null</span>)</div><div class="FixedLine">38      {</div><div class="FixedLine">39          $resource = <span class="EmphasisTypeBold">new</span> Collection($data, $transformer, $resourceKey);</div><div class="FixedLine">40</div><div class="FixedLine">41          <span class="EmphasisTypeBold">return</span> $this-&gt;manager-&gt;createData($resource)-&gt;toArray();</div><div class="FixedLine">42      }</div><div class="FixedLine">43  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-44.</span><div class="SimplePara">The FractalResponse::collection() Implementation</div></div></div></div>
            </div><div id="Par130" class="Para">The <span class="EmphasisFontCategoryNonProportional">collection</span> endpoint initializes a <span class="EmphasisFontCategoryNonProportional">League\Fractal\Resource\Collection</span> instance, but everything else is exactly the same. Both the <span class="EmphasisFontCategoryNonProportional">item</span> and <span class="EmphasisFontCategoryNonProportional">collection</span> methods duplicate creating the data and converting it to an array. All tests should be passing, so you are now able to refactor out the duplication (Listing <span class="InternalRef"><a href="#Par131">7-45</a></span>).</div><div id="Par131" class="Para">
              <div class="ProgramCode" id="PC46"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Response;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> League\Fractal\Manager;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> League\Fractal\Resource\Item;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> League\Fractal\TransformerAbstract;</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">use</span> League\Fractal\Resource\Collection;</div><div class="FixedLine"> 9  <span class="EmphasisTypeBold">use</span> League\Fractal\Resource\ResourceInterface;</div><div class="FixedLine">10  <span class="EmphasisTypeBold">use</span> League\Fractal\Serializer\SerializerAbstract;</div><div class="FixedLine">11</div><div class="FixedLine">12  <span class="EmphasisTypeBold">class FractalResponse</span>
            </div><div class="FixedLine">13  {</div><div class="FixedLine">14      <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">15       <span class="EmphasisTypeItalic">* @var Manager</span>
            </div><div class="FixedLine">16       <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">17      <span class="EmphasisTypeBold">private</span> $manager;</div><div class="FixedLine">18</div><div class="FixedLine">19      <span class="EmphasisTypeItalic">/**</span>
            </div><div class="FixedLine">20       <span class="EmphasisTypeItalic">* @var SerializerAbstract</span>
            </div><div class="FixedLine">21       <span class="EmphasisTypeItalic">*/</span>
            </div><div class="FixedLine">22      <span class="EmphasisTypeBold">private</span> $serializer;</div><div class="FixedLine">23</div><div class="FixedLine">24      <span class="EmphasisTypeBold">public function</span> __construct(Manager $manager, SerializerAbstract $serializer)</div><div class="FixedLine">25      {</div><div class="FixedLine">26          $this-&gt;manager = $manager;</div><div class="FixedLine">27          $this-&gt;serializer = $serializer;</div><div class="FixedLine">28          $this-&gt;manager-&gt;setSerializer($serializer);</div><div class="FixedLine">29      }</div><div class="FixedLine">30</div><div class="FixedLine">31      <span class="EmphasisTypeBold">public function</span> item($data, TransformerAbstract $transformer, $resourceKey = <span class="EmphasisTypeBold">null</span>)</div><div class="FixedLine">32      {</div><div class="FixedLine">33          <span class="EmphasisTypeBold">return</span> $this-&gt;createDataArray(</div><div class="FixedLine">34              <span class="EmphasisTypeBold">new</span> Item($data, $transformer, $resourceKey)</div><div class="FixedLine">35          );</div><div class="FixedLine">36      }</div><div class="FixedLine">37</div><div class="FixedLine">38      <span class="EmphasisTypeBold">public function</span> collection($data, TransformerAbstract $transformer, $resourceKey = <span class="EmphasisTypeBold">null</span>)</div><div class="FixedLine">39      {</div><div class="FixedLine">40          <span class="EmphasisTypeBold">return</span> $this-&gt;createDataArray(</div><div class="FixedLine">41              <span class="EmphasisTypeBold">new</span> Collection($data, $transformer, $resourceKey)</div><div class="FixedLine">42          );</div><div class="FixedLine">43      }</div><div class="FixedLine">44</div><div class="FixedLine">45      <span class="EmphasisTypeBold">private function</span> createDataArray(ResourceInterface $resource)</div><div class="FixedLine">46      {</div><div class="FixedLine">47          <span class="EmphasisTypeBold">return</span> $this-&gt;manager-&gt;createData($resource)-&gt;toArray();</div><div class="FixedLine">48      }</div><div class="FixedLine">49  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-45.</span><div class="SimplePara">Refactoring FractalResponse::item() and FractalResponse::collection()</div></div></div></div>
            </div><div id="Par132" class="Para">After your refactor, you should run the test suite again to make sure all tests still pass (Listing <span class="InternalRef"><a href="#Par133">7-46</a></span>).</div><div id="Par133" class="Para">
              <div class="ProgramCode" id="PC47"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (21 tests, 79 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-46.</span><div class="SimplePara">Making Sure Tests Still Pass After the Refactoring</div></div></div></div>
            </div><div id="Par134" class="Para">You didn’t do anything ground-breaking, but you did consolidated duplicate code while using your passing tests to refactor. Refactoring is an important part of the test-driven process because the goal is to get tests passing with minimal code, and then improve the minimal code while keeping tests passing.</div><div id="Par135" class="Para ParaTypeImportant">
          <img src="A395120_1_En_7_Figc_HTML.jpg" alt="A395120_1_En_7_Figc_HTML.jpg"/> Git commit: Add FractalResponse Class</div><div id="Par136" class="Para ParaTypeImportant">f1123c8 (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/f1123c8"><span class="RefSource">
                  <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/f1123c8</span>
                </span></a></span>)</div></div></div><div id="Sec6" class="Section1 RenderAsSection1"><h2 class="Heading">Fractal Response Service</h2><div id="Par137" class="Para">The <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> class is ready to be used in your <span class="EmphasisFontCategoryNonProportional">BooksController</span>. What is really cool is that you wrote the implementation in isolation, but the tests provide a good degree of confidence that it will work. Writing it in isolation also has the benefit of helping you resist the temptation to start integrating before fully testing.</div><div id="Par138" class="Para">How should you go about integrating the <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> class in your controllers? One option would be to create an instance of <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> in the controller, as shown in Listing <span class="InternalRef"><a href="#Par139">7-47</a></span>.</div><div id="Par139" class="Para">
            <div class="ProgramCode" id="PC48"><div class="FixedLine">1  <span class="EmphasisTypeBold">public function</span> __construct() {</div><div class="FixedLine">2      <span class="EmphasisTypeItalic">// …</span>
          </div><div class="FixedLine">3      $this-&gt;fractal = <span class="EmphasisTypeBold">new</span> FractalResponse($manager, $serializer);</div><div class="FixedLine">4  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-47.</span><div class="SimplePara">One Option: Using the FractalResponse Object in the Controller</div></div></div></div>
          </div><div id="Par140" class="Para">Constructing a new instance of the <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> in the controller means that you also need to create an instance of the manager and serializer, and pass them to the <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> constructor. Doing this by hand each time you need them sounds like a bad time.</div><div id="Par141" class="Para">A facade would work, and that is definitely a viable option (Listing <span class="InternalRef"><a href="#Par142">7-48</a></span>).</div><div id="Par142" class="Para">
            <div class="ProgramCode" id="PC49"><div class="FixedLine">1  <span class="EmphasisTypeItalic">// An individual book</span>
          </div><div class="FixedLine">2  <span class="EmphasisTypeBold">return</span> FractalResponse::item($book, <span class="EmphasisTypeBold">new</span> BookTransformer());</div><div class="FixedLine">3</div><div class="FixedLine">4  <span class="EmphasisTypeItalic">// A collection of books</span>
          </div><div class="FixedLine">5  <span class="EmphasisTypeBold">return</span> FractalResponse::collection($books, <span class="EmphasisTypeBold">new</span> BookTransformer());</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-48.</span><div class="SimplePara">Using the Façade Option</div></div></div></div>
          </div><div id="Par143" class="Para">In this book you will not use either option; instead you will define a Service Provider (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/providers"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/providers</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> to resolve a fully initialized <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> instance anywhere you need it. Laravel provides a powerful and easy-to-use service container (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/container"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/container</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> that you will use to define a <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> service.</div><div id="Par144" class="Para ParaOneEmphasisChild">Service providers are used to bootstrap the application by registering service container bindings (among other things) which can be resolved from the service container. This means that you need to define a service for the <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> class that you can resolve out of the container.</div><div id="Par145" class="Para">In Lumen, providers are configured in the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">bootstrap/app.php</span></span> file. Listing <span class="InternalRef"><a href="#Par146">7-49</a></span> shows what the section looks like by default at the time of writing.</div><div id="Par146" class="Para">
            <div class="ProgramCode" id="PC50"><div class="FixedLine">70  <span class="EmphasisTypeItalic">/*</span>
          </div><div class="FixedLine">71  <span class="EmphasisTypeItalic">|--------------------------------------------------------------------------</span>
          </div><div class="FixedLine">72  <span class="EmphasisTypeItalic">| Register Service Providers</span>
          </div><div class="FixedLine">73  <span class="EmphasisTypeItalic">|--------------------------------------------------------------------------</span>
          </div><div class="FixedLine">74  <span class="EmphasisTypeItalic">|</span>
          </div><div class="FixedLine">75  <span class="EmphasisTypeItalic">| Here you will register all of the application's service providers which</span>
          </div><div class="FixedLine">76  <span class="EmphasisTypeItalic">| are used to bind services into the container. Service providers are</span>
          </div><div class="FixedLine">77  <span class="EmphasisTypeItalic">| totally optional, so you are not required to uncomment this line.</span>
          </div><div class="FixedLine">78  <span class="EmphasisTypeItalic">|</span>
          </div><div class="FixedLine">79  <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">80</div><div class="FixedLine">81  <span class="EmphasisTypeItalic">// $app-&gt;register(App\Providers\AppServiceProvider::class);</span>
          </div><div class="FixedLine">82  <span class="EmphasisTypeItalic">// $app-&gt;register(App\Providers\AuthServiceProvider::class);</span>
          </div><div class="FixedLine">83  <span class="EmphasisTypeItalic">// $app-&gt;register(App\Providers\EventServiceProvider::class);</span>
          </div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-49.</span><div class="SimplePara">Boilerplate Service Provider Configuration</div></div></div></div>
          </div><div id="Par147" class="Para">As you can see, the framework provides an <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">AppServiceProvider</span></span> class that you could use to register application services. You will create your own service provider class because you will benefit from learning how to create one, but more commonly you would use the <span class="EmphasisFontCategoryNonProportional">AppServiceProvider</span> to define your application services.</div><div id="Par148" class="Para">Let’s start by creating your new service provider class (Listing <span class="InternalRef"><a href="#Par149">7-50</a></span>).</div><div id="Par149" class="Para">
            <div class="ProgramCode" id="PC51"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ touch app/Providers/FractalServiceProvider.php</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-50.</span><div class="SimplePara">Creating the FractalServiceProvider Class</div></div></div></div>
          </div><div id="Par150" class="Para">Add the code in Listing <span class="InternalRef"><a href="#Par151">7-51</a></span> to the newly created file.</div><div id="Par151" class="Para">
            <div class="ProgramCode" id="PC52"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Providers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> Illuminate\Support\ServiceProvider;</div><div class="FixedLine"> 6</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">class FractalServiceProvider extends</span> ServiceProvider</div><div class="FixedLine"> 8  {</div><div class="FixedLine"> 9      <span class="EmphasisTypeBold">public function</span> register()</div><div class="FixedLine">10      {</div><div class="FixedLine">11</div><div class="FixedLine">12      }</div><div class="FixedLine">13</div><div class="FixedLine">14      <span class="EmphasisTypeBold">public function</span> boot()</div><div class="FixedLine">15      {</div><div class="FixedLine">16</div><div class="FixedLine">17      }</div><div class="FixedLine">18  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-51.</span><div class="SimplePara">A Skeleton FractalServiceProvider Class</div></div></div></div>
          </div><div id="Par152" class="Para">Service providers can be defined anywhere you want; however, let’s use the convention provided in Lumen, which is under the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">App\Providers</span></span> namespace. Service providers must define a <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">register()</span></span> method. The sole purpose of the <span class="EmphasisFontCategoryNonProportional">register</span> method is to bind things to the service container.</div><div id="Par153" class="Para">The <span class="EmphasisFontCategoryNonProportional">boot</span> method is called after all other services have been registered, and is optional. One example of using the <span class="EmphasisFontCategoryNonProportional">boot</span> method is loading configuration that your provider needs. You don’t need to use <span class="EmphasisFontCategoryNonProportional">boot</span> in the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">FractalServiceProvider</span></span>, but it was included for awareness. I will not delve into the full ServiceProvider API; read the service provider documentation (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/providers"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/providers</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> and browse the source code to learn more.</div><div id="Par154" class="Para">With a bit of background behind us, let’s register your service (Listing <span class="InternalRef"><a href="#Par155">7-52</a></span>).</div><div id="Par155" class="Para">
            <div class="ProgramCode" id="PC53"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Providers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> League\Fractal\Manager;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> App\Http\Response\FractalResponse;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> Illuminate\Support\ServiceProvider;</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">use</span> League\Fractal\Serializer\DataArraySerializer;</div><div class="FixedLine"> 9</div><div class="FixedLine">10  <span class="EmphasisTypeBold">class FractalServiceProvider extends</span> ServiceProvider</div><div class="FixedLine">11  {</div><div class="FixedLine">12      <span class="EmphasisTypeBold">public function</span> register()</div><div class="FixedLine">13      {</div><div class="FixedLine">14          <span class="EmphasisTypeItalic">// Bind the DataArraySerializer to an interface contract</span>
          </div><div class="FixedLine">15          $this-&gt;app-&gt;bind(</div><div class="FixedLine">16              'League\Fractal\Serializer\SerializerAbstract',</div><div class="FixedLine">17              'League\Fractal\Serializer\DataArraySerializer'</div><div class="FixedLine">18          );</div><div class="FixedLine">19</div><div class="FixedLine">20          $this-&gt;app-&gt;bind(FractalResponse::class, <span class="EmphasisTypeBold">function</span> ($app) {</div><div class="FixedLine">21              $manager = <span class="EmphasisTypeBold">new</span> Manager();</div><div class="FixedLine">22              $serializer = $app['League\Fractal\Serializer\SerializerAbstract'];</div><div class="FixedLine">23  </div><div class="FixedLine">24              <span class="EmphasisTypeBold">return new</span> FractalResponse($manager, $serializer);</div><div class="FixedLine">25          });</div><div class="FixedLine">26</div><div class="FixedLine">27          $this-&gt;app-&gt;alias(FractalResponse::class, 'fractal');</div><div class="FixedLine">28      }</div><div class="FixedLine">29  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-52.</span><div class="SimplePara">Defining the FractalResponse Service</div></div></div></div>
          </div><div id="Par156" class="Para">The first thing the <span class="EmphasisFontCategoryNonProportional">register</span> method does is bind the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">DataArraySerializer</span></span> implementation to the abstract serializer. When you type-hint <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">League\Fractal\Serializer\SerializerAbstract</span></span> the container will resolve <span class="EmphasisFontCategoryNonProportional">League\Fractal\Serializer\DataArraySerializer</span> for you. Binding is powerful because when you code to an interface you can change the implementation in the provider, and classes consuming the service will not know the difference.</div><div id="Par157" class="Para">Secondly, you define your <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> service. The <span class="EmphasisFontCategoryNonProportional">$this-&gt;app-&gt;bind()</span> call accepts the abstract name, and the second argument can be a concrete implementation (like your <span class="EmphasisFontCategoryNonProportional">DataArraySerializer</span> class) or a <span class="EmphasisFontCategoryNonProportional">Closure</span>. When you pass a <span class="EmphasisFontCategoryNonProportional">Closure,</span> it accepts your application instance (<span class="EmphasisFontCategoryNonProportional">$app</span>) as an argument. In the closure, you construct a <span class="EmphasisFontCategoryNonProportional">League\Fractal\Manager</span> instance and reference the <span class="EmphasisFontCategoryNonProportional">SerializerAbstract</span> from the container, which was the contract you bound to the <span class="EmphasisFontCategoryNonProportional">DataArraySerializer</span>. Lastly, you create and return the <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> instance.</div><div id="Par158" class="Para">The last thing you do in the <span class="EmphasisFontCategoryNonProportional">register</span> method is call <span class="EmphasisFontCategoryNonProportional">$this-&gt;app-&gt;alias(),</span> which will alias your service to a shorter name when you ask for it from the container. The alias is a convenient short name to the service but is not required.</div><div id="Par159" class="Para">You can now access your service in a few ways (Listing <span class="InternalRef"><a href="#Par160">7-53</a></span>).</div><div id="Par160" class="Para">
            <div class="ProgramCode" id="PC54"><div class="LineGroup"><div class="FixedLine">$fractal = app('App\Http\Response\FractalResponse');</div><div class="FixedLine">$fractal = \App::make('App\Http\Response\FractalResponse');</div></div><div class="LineGroup"><div class="FixedLine">
                  <span class="EmphasisTypeItalic">// Using the alias you defined:</span>
                </div><div class="FixedLine">$fractal = app('fractal');</div></div><div class="LineGroup"><div class="FixedLine">
                  <span class="EmphasisTypeItalic">// Or via constructor hinting for the classes the container resolves</span>
                </div><div class="FixedLine">
              <span class="EmphasisTypeBold">class MyController extends</span> Controller</div><div class="FixedLine">{</div><div class="FixedLine">    <span class="EmphasisTypeBold">public function</span> __construct(App\Http\Response\FractalResponse $fractal)</div><div class="FixedLine">    {</div><div class="FixedLine">        $this-&gt;fractal = $fractal;</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-53.</span><div class="SimplePara">Different Ways to Resolve the FractalResponse Service</div></div></div></div>
          </div><div id="Par161" class="Para ParaOneEmphasisChild">For your particular use case, you will use the constructor to easily provide all of your controllers with the <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> service.</div><div id="Par162" class="Para">The next step in finishing the service provider is registering the provider in your application. Open the <span class="EmphasisFontCategoryNonProportional">bootstrap/app.php</span> file and add the code in Listing <span class="InternalRef"><a href="#Par163">7-54</a></span>.</div><div id="Par163" class="Para">
            <div class="ProgramCode" id="PC55"><div class="FixedLine">81  <span class="EmphasisTypeItalic">// $app-&gt;register(App\Providers\AppServiceProvider::class);</span>
          </div><div class="FixedLine">82  <span class="EmphasisTypeItalic">// $app-&gt;register(App\Providers\AuthServiceProvider::class);</span>
          </div><div class="FixedLine">83  <span class="EmphasisTypeItalic">// $app-&gt;register(App\Providers\EventServiceProvider::class);</span>
          </div><div class="FixedLine">84</div><div class="FixedLine">85  $app-&gt;register(\App\Providers\FractalServiceProvider::class);</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-54.</span><div class="SimplePara">Registering the FractalServiceProvider</div></div></div></div>
          </div><div id="Par164" class="Para">You can now resolve the <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> class from the service container, and you are ready to integrate the service into your <span class="EmphasisFontCategoryNonProportional">BooksController</span> class in the next section. Onward!</div></div><div id="Sec7" class="Section1 RenderAsSection1"><h2 class="Heading">Integrating the Fractal Response Service</h2><div id="Par165" class="Para">Your final task is integrating the <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> service. You could make each controller resolve the service out of the container, but you want to provide consistency across all your responses. The <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">App\Http\Controllers\Controller</span></span> class sounds like a good place to resolve the service because all controllers extend from it. Edit <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">app/Http/Controllers/Controller.php</span></span> and add the code from Listing <span class="InternalRef"><a href="#Par166">7-55</a></span> for your controllers to use.</div><div id="Par166" class="Para">
            <div class="ProgramCode" id="PC56"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> App\Http\Response\FractalResponse;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> Laravel\Lumen\Routing\Controller <span class="EmphasisTypeBold">as</span> BaseController;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> League\Fractal\TransformerAbstract;</div><div class="FixedLine"> 8</div><div class="FixedLine"> 9  <span class="EmphasisTypeBold">class Controller extends</span> BaseController</div><div class="FixedLine">10  {</div><div class="FixedLine">11      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">12       <span class="EmphasisTypeItalic">* @var FractalResponse</span>
          </div><div class="FixedLine">13       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">14      <span class="EmphasisTypeBold">private</span> $fractal;</div><div class="FixedLine">15</div><div class="FixedLine">16      <span class="EmphasisTypeBold">public function</span> __construct(FractalResponse $fractal)</div><div class="FixedLine">17      {</div><div class="FixedLine">18          $this-&gt;fractal = $fractal;</div><div class="FixedLine">19      }</div><div class="FixedLine">20</div><div class="FixedLine">21      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">22       <span class="EmphasisTypeItalic">* @param $data</span>
          </div><div class="FixedLine">23       <span class="EmphasisTypeItalic">* @param TransformerAbstract $transformer</span>
          </div><div class="FixedLine">24       <span class="EmphasisTypeItalic">* @param null $resourceKey</span>
          </div><div class="FixedLine">25       <span class="EmphasisTypeItalic">* @return array</span>
          </div><div class="FixedLine">26       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">27      <span class="EmphasisTypeBold">public function</span> item($data, TransformerAbstract $transformer, $resourceKey = <span class="EmphasisTypeBold">null</span>)</div><div class="FixedLine">29      {</div><div class="FixedLine">30          <span class="EmphasisTypeBold">return</span> $this-&gt;fractal-&gt;item($data, $transformer, $resourceKey);</div><div class="FixedLine">31      }</div><div class="FixedLine">32</div><div class="FixedLine">33      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">34       <span class="EmphasisTypeItalic">* @param $data</span>
          </div><div class="FixedLine">35       <span class="EmphasisTypeItalic">* @param TransformerAbstract $transformer</span>
          </div><div class="FixedLine">36       <span class="EmphasisTypeItalic">* @param null $resourceKey</span>
          </div><div class="FixedLine">37       <span class="EmphasisTypeItalic">* @return array</span>
          </div><div class="FixedLine">38       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">39      <span class="EmphasisTypeBold">public function</span> collection($data, TransformerAbstract $transformer, $resourceKey = <span class="EmphasisTypeBold">null</span>)</div><div class="FixedLine">41      {</div><div class="FixedLine">42          <span class="EmphasisTypeBold">return</span> $this-&gt;fractal-&gt;collection($data, $transformer, $resourceKey);</div><div class="FixedLine">43      }</div><div class="FixedLine">44  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-55.</span><div class="SimplePara">Integrating the FractalResponse Service in the Base Controller</div></div></div></div>
          </div><div id="Par167" class="Para">The constructor method type-hints the <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> argument that the service container will resolve automatically when initializing the controller. The <span class="EmphasisFontCategoryNonProportional">item</span> and <span class="EmphasisFontCategoryNonProportional">collection</span> methods are pass-through methods to the <span class="EmphasisFontCategoryNonProportional">FractalResponse</span> service. You could make the methods more generic like <span class="EmphasisFontCategoryNonProportional">respondWithItem</span> and take care of the response, but what you have is good enough for now. You can refactor when you sense duplication and brittle code.</div><div id="Par168" class="Para">Let’s try your first integration with the <span class="EmphasisFontCategoryNonProportional">BooksController</span>. Be sure to add <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">use App\Transformer\BookTransformer</span></span>; and <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">extends Controller</span></span> to start using the base application controller at the top of <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">app/Http/Controllers/BooksController.php</span></span> (Listing <span class="InternalRef"><a href="#Par169">7-56</a></span>).</div><div id="Par169" class="Para">
            <div class="ProgramCode" id="PC57"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> App\Book;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> Illuminate\Http\Request;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> App\Transformer\BookTransformer;</div><div class="FixedLine"> 8  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Eloquent\ModelNotFoundException;</div><div class="FixedLine"> 9</div><div class="FixedLine">10  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">11   <span class="EmphasisTypeItalic">* Class BooksController</span>
          </div><div class="FixedLine">12   <span class="EmphasisTypeItalic">* @package App\Http\Controllers</span>
          </div><div class="FixedLine">13   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">14  <span class="EmphasisTypeBold">class BooksController extends</span> Controller</div><div class="FixedLine">15  {</div><div class="FixedLine">16      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">17       <span class="EmphasisTypeItalic">* GET /books</span>
          </div><div class="FixedLine">18       <span class="EmphasisTypeItalic">* @return array</span>
          </div><div class="FixedLine">19       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">20      <span class="EmphasisTypeBold">public function</span> index()</div><div class="FixedLine">21      {</div><div class="FixedLine">22          <span class="EmphasisTypeBold">return</span> $this-&gt;collection(Book::all(), <span class="EmphasisTypeBold">new</span> BookTransformer());</div><div class="FixedLine">23      }</div><div class="FixedLine">24      <span class="EmphasisTypeItalic">// ...</span>
          </div><div class="FixedLine">25  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-56.</span><div class="SimplePara">Using the FractalResponse Service in the BooksController</div></div></div></div>
          </div><div id="Par170" class="Para">Importantly, the <span class="EmphasisFontCategoryNonProportional">BooksController</span> is now extending the base <span class="EmphasisFontCategoryNonProportional">Controller</span> class found in the same folder. <span class="EmphasisTypeBold">Don’t forget to extend this controller now</span>, because you need it to inherit the <span class="EmphasisFontCategoryNonProportional">collection</span> and <span class="EmphasisFontCategoryNonProportional">item</span> methods you just wrote! The <span class="EmphasisFontCategoryNonProportional">BooksController@index</span> method calls the <span class="EmphasisFontCategoryNonProportional">App\Http\Controller::collection()</span> method and passes the Eloquent collection and the <span class="EmphasisFontCategoryNonProportional">BookTransformer</span> as parameters. The method returns an <span class="EmphasisFontCategoryNonProportional">array</span> that will resemble the JSON response in Listing <span class="InternalRef"><a href="#Par171">7-57</a></span>.</div><div id="Par171" class="Para">
            <div class="ProgramCode" id="PC58"><div class="FixedLine">{</div><div class="FixedLine">    "data": [</div><div class="FixedLine">        {</div><div class="FixedLine">            "author": "H. G. Wells",</div><div class="FixedLine">            "created": "2015-10-21T06:54:33+0000",</div><div class="FixedLine">            "description": "A science fiction masterpiece about Martians invading London",</div><div class="FixedLine">            "id": 1,</div><div class="FixedLine">            "title": "War of the Worlds",</div><div class="FixedLine">            "updated": "2015-10-21T06:54:33+0000"</div><div class="FixedLine">        },</div><div class="FixedLine">        {</div><div class="FixedLine">            "author": "Madeleine L'Engle",</div><div class="FixedLine">            "created": "2015-10-21T06:54:33+0000",</div><div class="FixedLine">            "description": "A young girl goes on a mission to save her father who has gone missing after working on a mysterious project called a tesseract.",</div><div class="FixedLine">            "id": 2,</div><div class="FixedLine">            "title": "A Wrinkle in Time",</div><div class="FixedLine">            "updated": "2015-10-21T06:54:33+0000"</div><div class="FixedLine">        }</div><div class="FixedLine">    ]</div><div class="FixedLine">}</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-57.</span><div class="SimplePara">The /books Response Using the FractalResponse Service</div></div></div></div>
          </div><div id="Par172" class="Para">Let’s run a test to see if your integration is working (Listing <span class="InternalRef"><a href="#Par173">7-58</a></span>).</div><div id="Par173" class="Para">
            <div class="ProgramCode" id="PC59"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::index_should_return_a_collection_of_records</div><div class="FixedLine">Failed asserting that two strings are equal.</div><div class="FixedLine">...</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-58.</span><div class="SimplePara">Test Failure After Integrating Fractal</div></div></div></div>
          </div><div id="Par174" class="Para">It looks like your response test doesn’t match the response from the controller. If you recall, the <span class="EmphasisFontCategoryNonProportional">BooksControllerTest</span> test was updated earlier when you added the <span class="EmphasisFontCategoryNonProportional">data</span> key (Listing <span class="InternalRef"><a href="#Par175">7-59</a></span>).</div><div id="Par175" class="Para">
            <div class="ProgramCode" id="PC60"><div class="LineGroup"><div class="FixedLine">
                  <span class="EmphasisTypeItalic">/** @test **/</span>
                </div><div class="FixedLine">
              <span class="EmphasisTypeBold">public function</span> index_should_return_a_collection_of_records()</div><div class="FixedLine">{</div><div class="FixedLine">    $books = factory('App\Book', 2)-&gt;create();</div></div><div class="LineGroup"><div class="FixedLine">    $this-&gt;get('/books');</div></div><div class="LineGroup"><div class="FixedLine">    $expected = [</div><div class="FixedLine">        'data' =&gt; $books-&gt;toArray()</div><div class="FixedLine">    ];</div></div><div class="LineGroup"><div class="FixedLine">    $this-&gt;seeJsonEquals($expected);</div><div class="FixedLine">}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-59.</span><div class="SimplePara">Your Index Test for a Collection of Books</div></div></div></div>
          </div><div id="Par176" class="Para">The <span class="EmphasisFontCategoryNonProportional">$books-&gt;toArray()</span> method will do the equivalent of <span class="EmphasisFontCategoryNonProportional">(string) $book-&gt;created_at</span> to the date, but your new transformer is using <span class="EmphasisFontCategoryNonProportional">$book-&gt;created_at-&gt;toIso8601String()</span>. The transformer is also defining a <span class="EmphasisFontCategoryNonProportional">created</span> property but your test is expecting a <span class="EmphasisFontCategoryNonProportional">created_at</span> property. Let’s fix the test to pass again (Listing <span class="InternalRef"><a href="#Par177">7-60</a></span>).</div><div id="Par177" class="Para">
            <div class="ProgramCode" id="PC61"><div class="FixedLine">18  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">19  <span class="EmphasisTypeBold">public function</span> index_should_return_a_collection_of_records()</div><div class="FixedLine">20  {</div><div class="FixedLine">21      $books = factory('App\Book', 2)-&gt;create();</div><div class="FixedLine">22</div><div class="FixedLine">23      $this-&gt;get('/books');</div><div class="FixedLine">24</div><div class="FixedLine">25      $content = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">26      $this-&gt;assertArrayHasKey('data', $content);</div><div class="FixedLine">27</div><div class="FixedLine">28      <span class="EmphasisTypeBold">foreach</span> ($books <span class="EmphasisTypeBold">as</span> $book) {</div><div class="FixedLine">29          $this-&gt;seeJson([</div><div class="FixedLine">30              'id' =&gt; $book-&gt;id,</div><div class="FixedLine">31              'title' =&gt; $book-&gt;title,</div><div class="FixedLine">32              'description' =&gt; $book-&gt;description,</div><div class="FixedLine">33              'author' =&gt; $book-&gt;author,</div><div class="FixedLine">34              'created' =&gt; $book-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">35              'updated' =&gt; $book-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">36          ]);</div><div class="FixedLine">37      }</div><div class="FixedLine">38  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-60.</span><div class="SimplePara">Changing the Test to Assert the BookTransformer Correctly</div></div></div></div>
          </div><div id="Par178" class="Para">After getting the <span class="EmphasisFontCategoryNonProportional">/books</span> response, you check for the <span class="EmphasisFontCategoryNonProportional">data</span> key and then loop through the factory models to ensure they are all in the response correctly. With your change in place, you will see if the tests pass now (Listing <span class="InternalRef"><a href="#Par179">7-61</a></span>).</div><div id="Par179" class="Para">
            <div class="ProgramCode" id="PC62"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (21 tests, 92 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-61.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par180" class="Para">The <span class="EmphasisFontCategoryNonProportional">BooksController@show</span> method is next (Listing <span class="InternalRef"><a href="#Par181">7-62</a></span>).</div><div id="Par181" class="Para">
            <div class="ProgramCode" id="PC63"><div class="FixedLine">25  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">26   <span class="EmphasisTypeItalic">* GET /books/{id}</span>
          </div><div class="FixedLine">27   <span class="EmphasisTypeItalic">* @param integer $id</span>
          </div><div class="FixedLine">28   <span class="EmphasisTypeItalic">* @return mixed</span>
          </div><div class="FixedLine">29   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">30  <span class="EmphasisTypeBold">public function</span> show($id)</div><div class="FixedLine">31  {</div><div class="FixedLine">32      <span class="EmphasisTypeBold">return</span> $this-&gt;item(Book::findOrFail($id), <span class="EmphasisTypeBold">new</span> BookTransformer());</div><div class="FixedLine">33  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-62.</span><div class="SimplePara">Updating BooksController@show to Use Fractal</div></div></div></div>
          </div><div id="Par182" class="Para">The <span class="EmphasisFontCategoryNonProportional">@show</span> method is using the inherited <span class="EmphasisFontCategoryNonProportional">Controller::item()</span> method you built earlier. You are refactoring at this point so you should expect your tests to pass. If not, you need to fix them before moving on (Listing <span class="InternalRef"><a href="#Par183">7-63</a></span>).</div><div id="Par183" class="Para">
            <div class="ProgramCode" id="PC64"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::show_should_return_a_valid_book</div><div class="FixedLine">Failed asserting that two strings are equal.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-63.</span><div class="SimplePara">Running the Test Suite after Refactoring BooksController@show</div></div></div></div>
          </div><div id="Par184" class="Para">Darn! If you have a keen eye, you can see that you have the same issue in the <span class="EmphasisFontCategoryNonProportional">BooksController@show</span> test that you just fixed for the <span class="EmphasisFontCategoryNonProportional">BooksController@index</span> test (Listing <span class="InternalRef"><a href="#Par185">7-64</a></span>).</div><div id="Par185" class="Para">
            <div class="ProgramCode" id="PC65"><div class="FixedLine">40  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">41  <span class="EmphasisTypeBold">public function</span> show_should_return_a_valid_book()</div><div class="FixedLine">42  {</div><div class="FixedLine">43      $book = factory('App\Book')-&gt;create();</div><div class="FixedLine">44</div><div class="FixedLine">45      $this</div><div class="FixedLine">46          -&gt;get("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>")</div><div class="FixedLine">47          -&gt;seeStatusCode(200);</div><div class="FixedLine">48</div><div class="FixedLine">49      <span class="EmphasisTypeItalic">// Get the response and assert the data key exists</span>
          </div><div class="FixedLine">50      $content = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">51      $this-&gt;assertArrayHasKey('data', $content);</div><div class="FixedLine">52      $data = $content['data'];</div><div class="FixedLine">53</div><div class="FixedLine">54      <span class="EmphasisTypeItalic">// Assert the Book Properties match</span>
          </div><div class="FixedLine">55      $this-&gt;assertEquals($book-&gt;id, $data['id']);</div><div class="FixedLine">56      $this-&gt;assertEquals($book-&gt;title, $data['title']);</div><div class="FixedLine">57      $this-&gt;assertEquals($book-&gt;description, $data['description']);</div><div class="FixedLine">58      $this-&gt;assertEquals($book-&gt;author, $data['author']);</div><div class="FixedLine">59      $this-&gt;assertEquals($book-&gt;created_at-&gt;toIso8601String(), $data['created']);</div><div class="FixedLine">60      $this-&gt;assertEquals($book-&gt;updated_at-&gt;toIso8601String(), $data['created']);</div><div class="FixedLine">61  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-64.</span><div class="SimplePara">Updating the BooksController@show Test</div></div></div></div>
          </div><div id="Par186" class="Para">Your test now asserts each property instead of the whole model data all at once. With this change, and more granular checking, let’s see if the tests are passing now (Listing <span class="InternalRef"><a href="#Par187">7-65</a></span>).</div><div id="Par187" class="Para">
            <div class="ProgramCode" id="PC66"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (21 tests, 98 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-65.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par188" class="Para">Your next refactor is the <span class="EmphasisFontCategoryNonProportional">BooksController@store</span> method (Listing <span class="InternalRef"><a href="#Par189">7-66</a></span>).</div><div id="Par189" class="Para">
            <div class="ProgramCode" id="PC67"><div class="FixedLine">35  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">36   <span class="EmphasisTypeItalic">* POST /books</span>
          </div><div class="FixedLine">37   <span class="EmphasisTypeItalic">* @param Request $request</span>
          </div><div class="FixedLine">38   <span class="EmphasisTypeItalic">* @return \Symfony\Component\HttpFoundation\Response</span>
          </div><div class="FixedLine">39   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">40  <span class="EmphasisTypeBold">public function</span> store(Request $request)</div><div class="FixedLine">41  {</div><div class="FixedLine">42      $book = Book::create($request-&gt;all());</div><div class="FixedLine">43      $data = $this-&gt;item($book, <span class="EmphasisTypeBold">new</span> BookTransformer());</div><div class="FixedLine">44</div><div class="FixedLine">45      <span class="EmphasisTypeBold">return</span> response()-&gt;json($data, 201, [</div><div class="FixedLine">46          'Location' =&gt; route('books.show', ['id' =&gt; $book-&gt;id])</div><div class="FixedLine">47      ]);</div><div class="FixedLine">48  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-66.</span><div class="SimplePara">Refactoring BooksController@store to Use Fractal</div></div></div></div>
          </div><div id="Par190" class="Para">Nothing in this example that you haven’t seen before, so let’s run the tests (Listing <span class="InternalRef"><a href="#Par191">7-67</a></span>).</div><div id="Par191" class="Para">
            <div class="ProgramCode" id="PC68"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (21 tests, 98 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-67.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par192" class="Para">Your tests pass, but you should review them to make sure they still cover everything. If you look at the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">store_should_save_new_book_in_the_database</span></span> test, notice that it doesn’t check for the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">created</span></span> or <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">updated</span></span> field. You can either provide extra assertions to check, or you can rely on the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">BookTransformer::it_transforms_a_book_model()</span></span> test to ensure that this works correctly. Your test is an integration test, so let’s add the additional checks. You cannot guarantee at this point that the <span class="EmphasisFontCategoryNonProportional">BookTransformer</span> is being used.</div><div id="Par193" class="Para">You have one problem, though: if you assert the value of <span class="EmphasisFontCategoryNonProportional">created</span> and <span class="EmphasisFontCategoryNonProportional">updated,</span> how do you know what to expect? These fields are populated dynamically when the book is created. Lucky for us, Lumen uses the Carbon (<span class="ExternalRef"><a href="http://carbon.nesbot.com/"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">http://carbon.nesbot.com/</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> library to work with dates in Eloquent.</div><div id="Par194" class="Para">If you browse the Carbon documentation or the API, you will find the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">Carbon::setTestNow()</span></span> method; you need to mock the time so you know what to expect! Mocking <span class="EmphasisFontCategoryNonProportional">Carbon</span> makes testing dates really easy!</div><div id="Par195" class="Para">In preparation to updating your test, you need to add a <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">setUp</span></span> and <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">tearDown</span></span> method so you can test dates in each test and then reset Carbon afterwards (Listing <span class="InternalRef"><a href="#Par196">7-68</a></span>).</div><div id="Par196" class="Para">
            <div class="ProgramCode" id="PC69"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> Tests\App\Http\Controllers;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> TestCase;</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">use</span> Carbon\Carbon;</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">use</span> Illuminate\Foundation\Testing\DatabaseMigrations;</div><div class="FixedLine"> 8</div><div class="FixedLine"> 9  <span class="EmphasisTypeBold">class BooksControllerTest extends</span> TestCase</div><div class="FixedLine">10  {</div><div class="FixedLine">11      <span class="EmphasisTypeBold">use</span> DatabaseMigrations;</div><div class="FixedLine">12</div><div class="FixedLine">13      <span class="EmphasisTypeBold">public function</span> setUp()</div><div class="FixedLine">14      {</div><div class="FixedLine">15          <span class="EmphasisTypeBold">parent</span>::setUp();</div><div class="FixedLine">16</div><div class="FixedLine">17          Carbon::setTestNow(Carbon::now('UTC'));</div><div class="FixedLine">18      }</div><div class="FixedLine">19</div><div class="FixedLine">20      <span class="EmphasisTypeBold">public function</span> tearDown()</div><div class="FixedLine">21      {</div><div class="FixedLine">22          <span class="EmphasisTypeBold">parent</span>::tearDown();</div><div class="FixedLine">23</div><div class="FixedLine">24          Carbon::setTestNow();</div><div class="FixedLine">25      }</div><div class="FixedLine">26      <span class="EmphasisTypeItalic">// …</span>
          </div><div class="FixedLine">27  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-68.</span><div class="SimplePara">Mocking Carbon in the BooksControllerTest Class (Partial Source)</div></div></div></div>
          </div><div id="Par197" class="Para">At the top of your <span class="EmphasisFontCategoryNonProportional">BooksControllerTest</span> you import Carbon with use <span class="EmphasisFontCategoryNonProportional">Carbon\Carbon;</span>. You override the <span class="EmphasisFontCategoryNonProportional">setUp</span> and <span class="EmphasisFontCategoryNonProportional">tearDown</span> methods (see <span class="ExternalRef"><a href="https://phpunit.de/manual/current/en/fixtures.html"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://phpunit.de/manual/current/en/fixtures.html</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> to mock Carbon.</div><div id="Par198" class="Para">Calling <span class="EmphasisFontCategoryNonProportional">Carbon::setTestNow(Carbon::now('UTC'));</span> will mock your tests to use the current time. Once the test is over, you call <span class="EmphasisFontCategoryNonProportional">Carbon::setTestNow();</span> in the <span class="EmphasisFontCategoryNonProportional">tearDown</span> method to reset Carbon to its normal behavior.</div><div id="Par199" class="Para">Now that you’ve mocked Carbon, you can write your test expectations (Listing <span class="InternalRef"><a href="#Par200">7-69</a></span>).</div><div id="Par200" class="Para">
            <div class="ProgramCode" id="PC70"><div class="FixedLine">104  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">105  <span class="EmphasisTypeBold">public function</span> store_should_save_new_book_in_the_database()</div><div class="FixedLine">106  {</div><div class="FixedLine">107      $this-&gt;post('/books', [</div><div class="FixedLine">108          'title' =&gt; 'The Invisible Man',</div><div class="FixedLine">109          'description' =&gt; 'An invisible man is trapped in the terror of his own creation',</div><div class="FixedLine">110          'author' =&gt; 'H. G. Wells'</div><div class="FixedLine">111      ]);</div><div class="FixedLine">112</div><div class="FixedLine">113      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">114      $this-&gt;assertArrayHasKey('data', $body);</div><div class="FixedLine">115</div><div class="FixedLine">116      $data = $body['data'];</div><div class="FixedLine">117      $this-&gt;assertEquals('The Invisible Man', $data['title']);</div><div class="FixedLine">118      $this-&gt;assertEquals(</div><div class="FixedLine">119          'An invisible man is trapped in the terror of his own creation',</div><div class="FixedLine">120          $data['description']</div><div class="FixedLine">121      );</div><div class="FixedLine">122      $this-&gt;assertEquals('H. G. Wells', $data['author']);</div><div class="FixedLine">123      $this-&gt;assertTrue($data['id'] &gt; 0, 'Expected a positive integer, but did not see one.');</div><div class="FixedLine">124</div><div class="FixedLine">125      $this-&gt;assertArrayHasKey('created', $data);</div><div class="FixedLine">126      $this-&gt;assertEquals(Carbon::now()-&gt;toIso8601String(), $data['created']);</div><div class="FixedLine">127      $this-&gt;assertArrayHasKey('updated', $data);</div><div class="FixedLine">128      $this-&gt;assertEquals(Carbon::now()-&gt;toIso8601String(), $data['updated']);</div><div class="FixedLine">129</div><div class="FixedLine">130      $this-&gt;seeInDatabase('books', ['title' =&gt; 'The Invisible Man']);</div><div class="FixedLine">131  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-69.</span><div class="SimplePara">Updating the BooksController@store Test to Assert Created and Updated Values</div></div></div></div>
          </div><div id="Par201" class="Para">Near the end of the test you assert that the response has the <span class="EmphasisFontCategoryNonProportional">created</span> and <span class="EmphasisFontCategoryNonProportional">updated</span> keys, and you use carbon to make sure the dates are in ISO 8601 (<span class="ExternalRef"><a href="http://www.iso.org/iso/home/standards/iso8601.htm"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">http://www.iso.org/iso/home/standards/iso8601.htm</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> format.</div><div id="Par202" class="Para">Let’s make sure your new assertions pass (Listing <span class="InternalRef"><a href="#Par203">7-70</a></span>).</div><div id="Par203" class="Para">
            <div class="ProgramCode" id="PC71"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (21 tests, 102 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-70.</span><div class="SimplePara">Running the Entire Test Suite</div></div></div></div>
          </div><div id="Par204" class="Para">And your tests all pass! You are on the final method refactor and then you are done. The <span class="EmphasisFontCategoryNonProportional">BooksController@update</span> method will be similar to the <span class="EmphasisFontCategoryNonProportional">store</span> method (Listing <span class="InternalRef"><a href="#Par205">7-71</a></span>).</div><div id="Par205" class="Para">
            <div class="ProgramCode" id="PC72"><div class="FixedLine">50  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">51   <span class="EmphasisTypeItalic">* PUT /books/{id}</span>
          </div><div class="FixedLine">52   <span class="EmphasisTypeItalic">* @param Request $request</span>
          </div><div class="FixedLine">53   <span class="EmphasisTypeItalic">* @param $id</span>
          </div><div class="FixedLine">54   <span class="EmphasisTypeItalic">* @return mixed</span>
          </div><div class="FixedLine">55   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">56  <span class="EmphasisTypeBold">public function</span> update(Request $request, $id)</div><div class="FixedLine">57  {</div><div class="FixedLine">58      <span class="EmphasisTypeBold">try</span> {</div><div class="FixedLine">59          $book = Book::findOrFail($id);</div><div class="FixedLine">60      } <span class="EmphasisTypeBold">catch</span> (ModelNotFoundException $e) {</div><div class="FixedLine">61          <span class="EmphasisTypeBold">return</span> response()-&gt;json([</div><div class="FixedLine">62              'error' =&gt; [</div><div class="FixedLine">63                  'message' =&gt; 'Book not found'</div><div class="FixedLine">64              ]</div><div class="FixedLine">65          ], 404);</div><div class="FixedLine">66      }</div><div class="FixedLine">67</div><div class="FixedLine">68      $book-&gt;fill($request-&gt;all());</div><div class="FixedLine">69      $book-&gt;save();</div><div class="FixedLine">70</div><div class="FixedLine">71      <span class="EmphasisTypeBold">return</span> $this-&gt;item($book, <span class="EmphasisTypeBold">new</span> BookTransformer());</div><div class="FixedLine">72  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-71.</span><div class="SimplePara">Refactoring BooksController@update</div></div></div></div>
          </div><div id="Par206" class="Para">The only change here is returning a transformed model. Let’s check the test (Listing <span class="InternalRef"><a href="#Par207">7-72</a></span>).</div><div id="Par207" class="Para">
            <div class="ProgramCode" id="PC73"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (21 tests, 102 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-72.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par208" class="Para">And you are still green!</div><div id="Par209" class="Para">Next, add response checks and assert the dates in the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">update_should_only_change_fillable_fields</span></span> test (Listing <span class="InternalRef"><a href="#Par210">7-73</a></span>).</div><div id="Par210" class="Para">
            <div class="ProgramCode" id="PC74"><div class="FixedLine">150  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">151  <span class="EmphasisTypeBold">public function</span> update_should_only_change_fillable_fields()</div><div class="FixedLine">152  {</div><div class="FixedLine">153      $book = factory('App\Book')-&gt;create([</div><div class="FixedLine">154          'title' =&gt; 'War of the Worlds',</div><div class="FixedLine">155          'description' =&gt; 'A science fiction masterpiece about Martians invading London',</div><div class="FixedLine">156          'author' =&gt; 'H. G. Wells',</div><div class="FixedLine">157      ]);</div><div class="FixedLine">158</div><div class="FixedLine">159      $this-&gt;notSeeInDatabase('books', [</div><div class="FixedLine">160          'title' =&gt; 'The War of the Worlds',</div><div class="FixedLine">161          'description' =&gt; 'The book is way better than the movie.',</div><div class="FixedLine">162          'author' =&gt; 'Wells, H. G.'</div><div class="FixedLine">163      ]);</div><div class="FixedLine">164</div><div class="FixedLine">165      $this-&gt;put("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>", [</div><div class="FixedLine">166          'id' =&gt; 5,</div><div class="FixedLine">167          'title' =&gt; 'The War of the Worlds',</div><div class="FixedLine">168          'description' =&gt; 'The book is way better than the movie.',</div><div class="FixedLine">169          'author' =&gt; 'Wells, H. G.'</div><div class="FixedLine">170      ]);</div><div class="FixedLine">171</div><div class="FixedLine">172      $this</div><div class="FixedLine">173          -&gt;seeStatusCode(200)</div><div class="FixedLine">174          -&gt;seeJson([</div><div class="FixedLine">175              'id' =&gt; 1,</div><div class="FixedLine">176              'title' =&gt; 'The War of the Worlds',</div><div class="FixedLine">177              'description' =&gt; 'The book is way better than the movie.',</div><div class="FixedLine">178              'author' =&gt; 'Wells, H. G.',</div><div class="FixedLine">179          ])</div><div class="FixedLine">180          -&gt;seeInDatabase('books', [</div><div class="FixedLine">181              'title' =&gt; 'The War of the Worlds'</div><div class="FixedLine">182          ]);</div><div class="FixedLine">183</div><div class="FixedLine">184      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">185      $this-&gt;assertArrayHasKey('data', $body);</div><div class="FixedLine">186</div><div class="FixedLine">187      $data = $body['data'];</div><div class="FixedLine">188      $this-&gt;assertArrayHasKey('created', $data);</div><div class="FixedLine">189      $this-&gt;assertEquals(Carbon::now()-&gt;toIso8601String(), $data['created']);</div><div class="FixedLine">190      $this-&gt;assertArrayHasKey('updated', $data);</div><div class="FixedLine">191      $this-&gt;assertEquals(Carbon::now()-&gt;toIso8601String(), $data['updated']);</div><div class="FixedLine">192  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-73.</span><div class="SimplePara">Adding Additional Checks for BooksController@update</div></div></div></div>
          </div><div id="Par211" class="Para">At the end of the test method you added assertions for the <span class="EmphasisFontCategoryNonProportional">created</span> and <span class="EmphasisFontCategoryNonProportional">updated</span> values, just like in your last test. Time for the moment of truth: running the whole suite one last time (Listing <span class="InternalRef"><a href="#Par212">7-74</a></span>).</div><div id="Par212" class="Para">
            <div class="ProgramCode" id="PC75"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (21 tests, 106 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 7-74.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par213" class="Para ParaTypeImportant">
        <img src="A395120_1_En_7_Figd_HTML.jpg" alt="A395120_1_En_7_Figd_HTML.jpg"/> Git commit: Integrate the FractalResponse Service</div><div id="Par214" class="Para ParaTypeImportant">845f27e (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/845f27e"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/845f27e</span>
              </span></a></span>)</div></div><div id="Sec8" class="Section1 RenderAsSection1"><h2 class="Heading">Conclusion</h2><div id="Par215" class="Para">You’ve had a long journey in this chapter, but now you have a decent way to generate consistent responses in your app. Along the way you learned
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par216" class="Para">How to write the minimum amount of code to get tests to pass</div></li><li><div id="Par217" class="Para ParaOneEmphasisChild">To refactor <span class="EmphasisTypeItalic">only</span> after getting tests to pass</div></li><li><div id="Par218" class="Para">How to create and install a service provider</div></li><li><div id="Par219" class="Para">How to use the service container</div></li><li><div id="Par220" class="Para">The basics of the Fractal library</div></li></ul></div>
      </div><div id="Par221" class="Para">At this point I encourage you to read more about the service container (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/container"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/container</span>
              </span></a></span>) and service providers (<span class="ExternalRef"><a href="https://lumen.laravel.com/docs/5.2/providers"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://lumen.laravel.com/docs/5.2/providers</span>
              </span></a></span>) in the official documentation. The container and providers are related concepts that you will use frequently when you develop Lumen applications.</div></div></div></body></html>
