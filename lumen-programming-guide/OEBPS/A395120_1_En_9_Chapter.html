<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><title>Authors</title><link href="springer_epub.css" type="text/css" rel="styleSheet"/></head><body><div class="ChapterContextInformation"><div class="ContextInformation" id="b978-1-4842-2187-7_9"><div class="ChapterCopyright">© Paul Redmond 2016</div><span class="ContextInformationAuthorEditorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span></span></span><span class="ContextInformationBookTitles"><span class="BookTitle" xml:lang="en">Lumen Programming Guide</span></span><span class="ChapterDOI">10.1007/978-1-4842-2187-7_9</span></div></div><!--Begin Abstract--><div class="MainTitleSection"><h1 class="ChapterTitle" xml:lang="en">9. Authors</h1></div><div class="AuthorGroup"><div class="AuthorNames"><span class="Author"><span class="AuthorName">Paul Redmond</span><sup>1 <span class="ContactIcon"/></sup></span></div><div class="Affiliations"><div class="Affiliation" id="Aff2"><span class="AffiliationNumber">(1)</span><div class="AffiliationText">Phoenix, Arizona, USA</div></div><div class="ClearBoth"> </div></div></div><!--End Abstract--><div class="Fulltext"><div id="Par1" class="Para">So far your <span class="EmphasisFontCategoryNonProportional">/books</span> endpoint provides an <span class="EmphasisFontCategoryNonProportional">author</span> column on the <span class="EmphasisFontCategoryNonProportional">books</span> database table. Making authors a string field on the books table was intentional so that you could focus on other primary concepts of building your API, but now you are ready to create proper author data and provide API endpoints for author data.</div><div id="Par2" class="Para">This chapter will cover the following:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par3" class="Para">Creating the authors database schema</div></li><li><div id="Par4" class="Para">Creating a relationship between book data and authors</div></li><li><div id="Par5" class="Para">Creating API endpoints for author information</div></li><li><div id="Par6" class="Para ParaOneEmphasisChild">Modifying your <span class="EmphasisFontCategoryNonProportional">/books</span> endpoint to use new author data</div></li></ul></div>
    </div><div id="Sec1" class="Section1 RenderAsSection1"><h2 class="Heading">The Authors Database Schema</h2><div id="Par7" class="Para">Creating the <span class="EmphasisFontCategoryNonProportional">authors</span> database table involves a few migrations:
<div class="OrderedList"><ol><li class="ListItem"><span class="ItemNumber">1.</span><div class="ItemContent"><div><div id="Par8" class="Para ParaOneEmphasisChild">Create a new <span class="EmphasisFontCategoryNonProportional">authors</span> database table.</div></div></div><div class="ClearBoth"> </div></li><li class="ListItem"><span class="ItemNumber">2.</span><div class="ItemContent"><div><div id="Par9" class="Para">Associate authors and books.</div></div></div><div class="ClearBoth"> </div></li><li class="ListItem"><span class="ItemNumber">3.</span><div class="ItemContent"><div><div id="Par10" class="Para">Remove the deprecated <span class="EmphasisFontCategoryNonProportional">author</span> column on the <span class="EmphasisFontCategoryNonProportional">books</span> table.</div></div></div><div class="ClearBoth"> </div></li></ol></div>
      </div><div id="Par11" class="Para">You will start by creating the new <span class="EmphasisFontCategoryNonProportional">authors</span> database table. If you remember when you created the <span class="EmphasisFontCategoryNonProportional">books</span> table you have an artisan command to create migration scripts (Listing <span class="InternalRef"><a href="#Par12">9-1</a></span>).</div><div id="Par12" class="Para">
            <div class="ProgramCode" id="PC1"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan make:migration create_authors_table --create=authors</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-1.</span><div class="SimplePara">Creating the Authors Database Migration</div></div></div></div>
          </div><div id="Par13" class="Para">Add the columns shown in Listing <span class="InternalRef"><a href="#Par14">9-2</a></span> to the <span class="EmphasisFontCategoryNonProportional">up()</span> method.</div><div id="Par14" class="Para">
            <div class="ProgramCode" id="PC2"><div class="FixedLine"> 8  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 9   <span class="EmphasisTypeItalic">* Run the migrations.</span>
          </div><div class="FixedLine">10   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">11   <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">12   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">13  <span class="EmphasisTypeBold">public function</span> up()</div><div class="FixedLine">14  {</div><div class="FixedLine">15      Schema::create('authors', <span class="EmphasisTypeBold">function</span> (Blueprint $table) {</div><div class="FixedLine">16          $table-&gt;increments('id');</div><div class="FixedLine">17          $table-&gt;string('name');</div><div class="FixedLine">18          $table-&gt;enum('gender', ['male', 'female']);</div><div class="FixedLine">19          $table-&gt;text('biography');</div><div class="FixedLine">20          $table-&gt;timestamps();</div><div class="FixedLine">21      });</div><div class="FixedLine">22  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-2.</span><div class="SimplePara">The Authors Table Migration</div></div></div></div>
          </div><div id="Par15" class="Para ParaOneEmphasisChild">This time around I will move at a quicker pace, so you might want to review your original migration of the <span class="EmphasisFontCategoryNonProportional">books</span> table.</div><div id="Par16" class="Para">The <span class="EmphasisFontCategoryNonProportional">up</span> migration might be the first time you’ve seen the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">$table-&gt;text()</span></span> method and <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">$table-&gt;enum()</span></span> in a migration:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par17" class="Para ParaOneEmphasisChild">The <span class="EmphasisFontCategoryNonProportional">text()</span> method is the TEXT equivalent for the database.</div></li><li><div id="Par18" class="Para ParaOneEmphasisChild">The <span class="EmphasisFontCategoryNonProportional">enum()</span> method is equivalent to a relational database ENUM field.</div></li></ul></div>
      </div><div id="Par19" class="Para">You can go ahead and run the migration to try it out (Listing <span class="InternalRef"><a href="#Par20">9-3</a></span>).</div><div id="Par20" class="Para">
            <div class="ProgramCode" id="PC3"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan migrate:refresh</div><div class="FixedLine">Rolled back: 2015_12_29_234835_create_books_table</div><div class="FixedLine">Migrated: 2015_12_29_234835_create_books_table</div><div class="FixedLine">Migrated: 2016_01_20_050526_create_authors_table</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-3.</span><div class="SimplePara">Running the Database Migration</div></div></div></div>
          </div><div id="Par21" class="Para ParaTypeImportant ParaOneEmphasisChild">Keep in mind that commands like <span class="EmphasisFontCategoryNonProportional">migrate:refresh</span> will remove data from the database, but this is a good thing in development because you can depend on seed data to quickly get a repeatable development environment.</div><div id="Par22" class="Para">The next migration will define the database association between the <span class="EmphasisFontCategoryNonProportional">books</span> table and the <span class="EmphasisFontCategoryNonProportional">authors</span> table. Because you are using Eloquent you have access to the following types of relationships:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par23" class="Para">One-to-one</div></li><li><div id="Par24" class="Para">One-to-many</div></li><li><div id="Par25" class="Para">Many-to-many</div></li><li><div id="Par26" class="Para">Has-many-through</div></li><li><div id="Par27" class="Para">Polymorphic relationships</div></li><li><div id="Par28" class="Para">Many-to-many polymorphic relationships</div></li></ul></div>
      </div><div id="Par29" class="Para">You can read more about model relationships (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/eloquent-relationships"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/eloquent-relationships</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> in the Laravel documentation. You will pick one-to-many, although a many-to-many relationship might be better suited if you are allowing multiple authors.</div><div id="Par30" class="Para">For the purposes of your API, a book will only have <span class="EmphasisTypeItalic">one</span> author, and you will define that relationship with a new migration (Listing <span class="InternalRef"><a href="#Par31">9-4</a></span>).</div><div id="Par31" class="Para">
            <div class="ProgramCode" id="PC4"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan make:migration \</div><div class="FixedLine">associate_books_with_authors --table=books</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-4.</span><div class="SimplePara">Making the Migration to Associate Books and Authors</div></div></div></div>
          </div><div id="Par32" class="Para ParaOneEmphasisChild">Your API is not in production yet, so you could modify the original books migration that creates the <span class="EmphasisFontCategoryNonProportional">books</span> table. Changing the existing migration is much cleaner when you are developing a new application; if your application is already in production, you must create another migration. You are creating a new migration in this case so that you can get familiar with how to write migrations for a production API that already has production data.</div><div id="Par33" class="Para">This migration is a little trickier than your previous experience with migrations (Listing <span class="InternalRef"><a href="#Par34">9-5</a></span>).</div><div id="Par34" class="Para">
            <div class="ProgramCode" id="PC5"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Schema\Blueprint;</div><div class="FixedLine"> 4  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Migrations\Migration;</div><div class="FixedLine"> 5</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">class AssociateBooksWithAuthors extends</span> Migration</div><div class="FixedLine"> 7  {</div><div class="FixedLine"> 8      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 9       <span class="EmphasisTypeItalic">* Run the migrations.</span>
          </div><div class="FixedLine">10       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">11       <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">12       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">13      <span class="EmphasisTypeBold">public function</span> up()</div><div class="FixedLine">14      {</div><div class="FixedLine">15          Schema::table('books', <span class="EmphasisTypeBold">function</span> (Blueprint $table) {</div><div class="FixedLine">16</div><div class="FixedLine">17              <span class="EmphasisTypeItalic">// Create the author_id column as an unsigned integer</span>
          </div><div class="FixedLine">18              $table-&gt;integer('author_id')-&gt;after('id')-&gt;unsigned();</div><div class="FixedLine">19</div><div class="FixedLine">20              <span class="EmphasisTypeItalic">// Create a basic index for the author_id column</span>
          </div><div class="FixedLine">21              $table-&gt;index('author_id');</div><div class="FixedLine">22</div><div class="FixedLine">23              <span class="EmphasisTypeItalic">// Create a foreign key constraint and cascade on delete.</span>
          </div><div class="FixedLine">24              $table</div><div class="FixedLine">25                  -&gt;foreign('author_id')</div><div class="FixedLine">26                  -&gt;references('id')</div><div class="FixedLine">27                  -&gt;on('authors')</div><div class="FixedLine">28                  -&gt;onDelete('cascade');</div><div class="FixedLine">29          });</div><div class="FixedLine">30      }</div><div class="FixedLine">31</div><div class="FixedLine">32      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">33       <span class="EmphasisTypeItalic">* Reverse the migrations.</span>
          </div><div class="FixedLine">34       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">35       <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">36       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">37      <span class="EmphasisTypeBold">public function</span> down()</div><div class="FixedLine">38      {</div><div class="FixedLine">39          Schema::table('books', <span class="EmphasisTypeBold">function</span> (Blueprint $table) {</div><div class="FixedLine">40              <span class="EmphasisTypeItalic">// Drop the foreign key first</span>
          </div><div class="FixedLine">41              $table-&gt;dropForeign('books_author_id_foreign');</div><div class="FixedLine">42</div><div class="FixedLine">43              <span class="EmphasisTypeItalic">// Now drop the basic index</span>
          </div><div class="FixedLine">44              $table-&gt;dropIndex('books_author_id_index');</div><div class="FixedLine">45</div><div class="FixedLine">46              <span class="EmphasisTypeItalic">// Lastly, now it's safe to drop the column</span>
          </div><div class="FixedLine">47              $table-&gt;dropColumn('author_id');</div><div class="FixedLine">48          });</div><div class="FixedLine">49      }</div><div class="FixedLine">50  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-5.</span><div class="SimplePara">The Migration to Associate Authors and Books</div></div></div></div>
          </div><div id="Par35" class="Para">I will start by explaining the <span class="EmphasisFontCategoryNonProportional">up</span> method:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par36" class="Para">Create an unsigned integer column <span class="EmphasisFontCategoryNonProportional">author_id</span> <span class="EmphasisTypeItalic">after</span> the <span class="EmphasisFontCategoryNonProportional">id</span> column.</div></li><li><div id="Par37" class="Para ParaOneEmphasisChild">Add a basic index to the <span class="EmphasisFontCategoryNonProportional">author_id</span> column.</div></li><li><div id="Par38" class="Para ParaOneEmphasisChild">Add a foreign key associated with the <span class="EmphasisFontCategoryNonProportional">authors.id</span> column.</div></li><li><div id="Par39" class="Para">The foreign key should cascade on delete.</div></li></ul></div>
      </div><div id="Par40" class="Para">The <span class="EmphasisFontCategoryNonProportional">down</span> method looks simple but is actually a little trickier:
<div class="UnorderedList"><ul class="UnorderedListMarkBullet"><li><div id="Par41" class="Para ParaOneEmphasisChild">You <span class="EmphasisTypeItalic">must</span> drop the foreign key first.</div></li><li><div id="Par42" class="Para ParaOneEmphasisChild">You then <span class="EmphasisTypeItalic">must</span> drop the index.</div></li><li><div id="Par43" class="Para ParaOneEmphasisChild">Finally, you are safe to drop the <span class="EmphasisFontCategoryNonProportional">author_id</span> column.</div></li></ul></div>
      </div><div id="Par44" class="Para">A migration should be able to be applied and rolled back without error cleanly. You will try out applying and rolling back to make sure your migration is working as expected (Listing <span class="InternalRef"><a href="#Par45">9-6</a></span>).</div><div id="Par45" class="Para">
            <div class="ProgramCode" id="PC6"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan migrate:refresh</div><div class="FixedLine">Rolled back: 2016_07_31_195159_associate_books_with_authors</div><div class="FixedLine">Rolled back: 2016_07_31_194721_create_authors_table</div><div class="FixedLine">Rolled back: 2016_07_28_232137_create_books_table</div><div class="FixedLine">Migrated: 2016_07_28_232137_create_books_table</div><div class="FixedLine">Migrated: 2016_07_31_194721_create_authors_table</div><div class="FixedLine">Migrated: 2016_07_31_195159_associate_books_with_authors</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-6.</span><div class="SimplePara">Making Sure Migrations Can Be Applied and Rolled Back</div></div></div></div>
          </div><div id="Par46" class="Para">Now that you have a working migration, you need to update your seed data for the <span class="EmphasisFontCategoryNonProportional">books</span> table and create a new factory for authors. First, you need an Eloquent model for <span class="EmphasisFontCategoryNonProportional">authors</span> (Listing <span class="InternalRef"><a href="#Par47">9-7</a></span>).</div><div id="Par47" class="Para">
            <div class="ProgramCode" id="PC7"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ touch app/Author.php</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-7.</span><div class="SimplePara">Creating the Author Model File</div></div></div></div>
          </div><div id="Par48" class="Para">Your <span class="EmphasisFontCategoryNonProportional">Author</span> model will look like Listing <span class="InternalRef"><a href="#Par49">9-8</a></span>.</div><div id="Par49" class="Para">
            <div class="ProgramCode" id="PC8"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Eloquent\Model;</div><div class="FixedLine"> 6</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">class Author extends</span> Model</div><div class="FixedLine"> 8  {</div><div class="FixedLine"> 9      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">10       <span class="EmphasisTypeItalic">* The attributes that are mass assignable</span>
          </div><div class="FixedLine">11       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">12       <span class="EmphasisTypeItalic">* @var array</span>
          </div><div class="FixedLine">13       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">14      <span class="EmphasisTypeBold">protected</span> $fillable = ['name', 'biography', 'gender'];</div><div class="FixedLine">15</div><div class="FixedLine">16      <span class="EmphasisTypeBold">public function</span> books()</div><div class="FixedLine">17      {</div><div class="FixedLine">18          <span class="EmphasisTypeBold">return</span> $this-&gt;hasMany(Book::class);</div><div class="FixedLine">19      }</div><div class="FixedLine">20  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-8.</span><div class="SimplePara">The Author Model Class</div></div></div></div>
          </div><div id="Par50" class="Para">The <span class="EmphasisFontCategoryNonProportional">$fillable</span> property was introduced in the <span class="EmphasisFontCategoryNonProportional">Book</span> model and defines mass-assignable columns. Next, you define a <span class="EmphasisFontCategoryNonProportional">books()</span> method that has the one-to-many relationship with the <span class="EmphasisFontCategoryNonProportional">Book</span> model. The <span class="EmphasisFontCategoryNonProportional">hasMany</span> method takes the <span class="EmphasisFontCategoryNonProportional">Book</span> model class name. By convention, the <span class="EmphasisFontCategoryNonProportional">Author</span> model will use <span class="EmphasisFontCategoryNonProportional">author_id</span> on the <span class="EmphasisFontCategoryNonProportional">books</span> table to look up associations.</div><div id="Par51" class="Para">Next, you need to adjust your <span class="EmphasisFontCategoryNonProportional">Book</span> model to include the <span class="EmphasisFontCategoryNonProportional">authors</span> association (Listing <span class="InternalRef"><a href="#Par52">9-9</a></span>).</div><div id="Par52" class="Para">
            <div class="ProgramCode" id="PC9"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">namespace</span> App;</div><div class="FixedLine"> 4</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Eloquent\Model;</div><div class="FixedLine"> 6</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">class Book extends</span> Model</div><div class="FixedLine"> 8  {</div><div class="FixedLine"> 9      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">10       <span class="EmphasisTypeItalic">* The attributes that are mass assignable</span>
          </div><div class="FixedLine">11       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">12       <span class="EmphasisTypeItalic">* @var array</span>
          </div><div class="FixedLine">13       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">14      <span class="EmphasisTypeBold">protected</span> $fillable = ['title', 'description', 'author'];</div><div class="FixedLine">15</div><div class="FixedLine">16      <span class="EmphasisTypeBold">public function</span> author()</div><div class="FixedLine">17      {</div><div class="FixedLine">18          <span class="EmphasisTypeBold">return</span> $this-&gt;belongsTo(Author::class);</div><div class="FixedLine">19      }</div><div class="FixedLine">20  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-9.</span><div class="SimplePara">The Book Model Association with Authors</div></div></div></div>
          </div><div id="Par53" class="Para">By convention, the <span class="EmphasisFontCategoryNonProportional">belongsTo</span> method sets up the association with the <span class="EmphasisFontCategoryNonProportional">Author</span> model and Eloquent will take the <span class="EmphasisFontCategoryNonProportional">author_id</span> and find the author record with the <span class="EmphasisFontCategoryNonProportional">Author.id</span> field. You can tweak the foreign key name as the second argument in <span class="EmphasisFontCategoryNonProportional">belongsTo</span>, but let’s follow the naming conventions that automatically take care of it.</div><div id="Par54" class="Para ParaTypeImportant">The Eloquent relationships (<span class="ExternalRef"><a href="https://laravel.com/docs/5.2/eloquent-relationships"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://laravel.com/docs/5.2/eloquent-relationships</span>
              </span></a></span>
        <span class="EmphasisFontCategoryNonProportional">)</span> documentation explains in detail how you can customize model associations and how to use them.</div><div id="Par55" class="Para">With the one-to-many association in place, Eloquent can load data about the associated models, as shown in Listing <span class="InternalRef"><a href="#Par56">9-10</a></span>.</div><div id="Par56" class="Para">
            <div class="ProgramCode" id="PC10"><div class="LineGroup"><div class="FixedLine">$book = Book::find(1);</div><div class="FixedLine">
              <span class="EmphasisTypeBold">echo</span> $book-&gt;author-&gt;name;</div></div><div class="LineGroup"><div class="FixedLine">$author = Author::find(1);</div><div class="FixedLine">
              <span class="EmphasisTypeBold">foreach</span> ($author-&gt;books <span class="EmphasisTypeBold">as</span> $book) {</div><div class="FixedLine">    <span class="EmphasisTypeBold">echo</span> $book-&gt;title;</div><div class="FixedLine">}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-10.</span><div class="SimplePara">Example of Using Eloquent Associations</div></div></div></div>
          </div><div id="Par57" class="Para">The models are ready to go, and you have your schema migration working! Now you need to add a new factory definition for authors and update the seed data. Start by adding the factory definition to <span class="EmphasisFontCategoryNonProportional">database/factories/ModelFactory.php</span> (Listing <span class="InternalRef"><a href="#Par58">9-11</a></span>).</div><div id="Par58" class="Para">
            <div class="ProgramCode" id="PC11"><div class="FixedLine">31  $factory-&gt;define(App\Author::class, <span class="EmphasisTypeBold">function</span> ($faker) {</div><div class="FixedLine">32      <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">33          'name' =&gt; $faker-&gt;name,</div><div class="FixedLine">34          'biography' =&gt; join(" ", $faker-&gt;sentences(rand(3, 5))),</div><div class="FixedLine">35          'gender' =&gt; rand(1, 6) % 2 === 0 ? 'male' : 'female'</div><div class="FixedLine">36      ];</div><div class="FixedLine">37  });</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-11.</span><div class="SimplePara">The Author Model Factory</div></div></div></div>
          </div><div id="Par59" class="Para">The <span class="EmphasisFontCategoryNonProportional">biography</span> key uses the <span class="EmphasisFontCategoryNonProportional">$faker-&gt;sentences()</span> method from the <span class="EmphasisFontCategoryNonProportional">Faker\Provider\Lorem</span> provider. The <span class="EmphasisFontCategoryNonProportional">$faker-&gt;sentences()</span> method takes an integer for the first parameter, which determines how many sentences will be generated. You use a random number between 3 and 5 sentences and join the array with an empty space (“ ”). The <span class="EmphasisFontCategoryNonProportional">gender</span> key can either be <span class="EmphasisFontCategoryNonProportional">male</span> or <span class="EmphasisFontCategoryNonProportional">female</span> and you use the modulus operator to randomly pick male or female. An even random number will be male, and an odd number will be female.</div><div id="Par60" class="Para">Next, you will put your new factory to work by using it to seed book and author data. You will modify the <span class="EmphasisFontCategoryNonProportional">database/seeds/BooksTableSeeder.php</span> to use your model association (Listing <span class="InternalRef"><a href="#Par61">9-12</a></span>).</div><div id="Par61" class="Para">
            <div class="ProgramCode" id="PC12"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">use</span> Carbon\Carbon;</div><div class="FixedLine"> 4  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Seeder;</div><div class="FixedLine"> 5  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Eloquent\Model;</div><div class="FixedLine"> 6</div><div class="FixedLine"> 7  <span class="EmphasisTypeBold">class BooksTableSeeder extends</span> Seeder</div><div class="FixedLine"> 8  {</div><div class="FixedLine"> 9      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">10       <span class="EmphasisTypeItalic">* Run the database seeds.</span>
          </div><div class="FixedLine">11       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">12       <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">13       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">14      <span class="EmphasisTypeBold">public function</span> run()</div><div class="FixedLine">15      {</div><div class="FixedLine">16          factory(App\Author::class, 10)-&gt;create()-&gt;each(<span class="EmphasisTypeBold">function</span> ($author) {</div><div class="FixedLine">17              $booksCount = rand(1, 5);</div><div class="FixedLine">18</div><div class="FixedLine">19              <span class="EmphasisTypeBold">while</span> ($booksCount &gt; 0) {</div><div class="FixedLine">20                  $author-&gt;books()-&gt;save(factory(App\Book::class)-&gt;make());</div><div class="FixedLine">21                  $booksCount--;</div><div class="FixedLine">22              }</div><div class="FixedLine">23          });</div><div class="FixedLine">24      }</div><div class="FixedLine">25  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-12.</span><div class="SimplePara">Seed Author and Book Data</div></div></div></div>
          </div><div id="Par62" class="Para">The modified <span class="EmphasisFontCategoryNonProportional">BooksTableSeeder</span> is not complicated; it creates 10 authors and then iterates over each record with a <span class="EmphasisFontCategoryNonProportional">Closure</span> callback. Inside the <span class="EmphasisFontCategoryNonProportional">each</span> callback you get a random <span class="EmphasisFontCategoryNonProportional">$booksCount</span> integer to determine how many books an author will have. The <span class="EmphasisFontCategoryNonProportional">while</span> loop is used to keep creating new books for the author until the <span class="EmphasisFontCategoryNonProportional">$bookCount</span> is 0.</div><div id="Par63" class="Para">Feel free to purge your database and run the seeder again to try it out (Listing <span class="InternalRef"><a href="#Par64">9-13</a></span>).</div><div id="Par64" class="Para">
            <div class="ProgramCode" id="PC13"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan migrate:refresh</div><div class="FixedLine">$ php artisan db:seed</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-13.</span><div class="SimplePara">Purging the Database and Applying the Modified BooksTableSeeder</div></div></div></div>
          </div><div id="Par65" class="Para ParaOneEmphasisChild">Keep in mind that if your application were in production, you would need to migrate the data <span class="EmphasisTypeItalic">and</span> the schema. Since you are in early development you don’t need to worry about losing data in the database.</div><div id="Par66" class="Para">You have one final migration that will remove the <span class="EmphasisFontCategoryNonProportional">authors</span> column in the database (Listing <span class="InternalRef"><a href="#Par67">9-14</a></span>).</div><div id="Par67" class="Para">
            <div class="ProgramCode" id="PC14"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan make:migration \</div><div class="FixedLine">remove_books_authors_column --table=books</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-14.</span><div class="SimplePara">Migration to Remove the Authors Column from the Books Table</div></div></div></div>
          </div><div id="Par68" class="Para">The migration will drop the <span class="EmphasisFontCategoryNonProportional">author</span> column on <span class="EmphasisFontCategoryNonProportional">up</span> and add it back on <span class="EmphasisFontCategoryNonProportional">down</span>. Like I mentioned, if this application were in production you might have to find all the authors and migrate them over to the new <span class="EmphasisFontCategoryNonProportional">authors</span> table inside the <span class="EmphasisFontCategoryNonProportional">up</span> method. The <span class="EmphasisFontCategoryNonProportional">down</span> callback would reverse the effects of migrating the <span class="EmphasisFontCategoryNonProportional">authors</span> column to a new table. Again, since you are in early development, you could also just remove this column from the original books migration. I want to provide you with more exposure to database migrations, so let’s use a new migration to demonstrate dropping a column via a migration.</div><div id="Par69" class="Para">Listing <span class="InternalRef"><a href="#Par70">9-15</a></span> shows a simple migration for removing the <span class="EmphasisFontCategoryNonProportional">author</span> column.</div><div id="Par70" class="Para">
            <div class="ProgramCode" id="PC15"><div class="FixedLine"> 1  &lt;?php</div><div class="FixedLine"> 2</div><div class="FixedLine"> 3  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Schema\Blueprint;</div><div class="FixedLine"> 4  <span class="EmphasisTypeBold">use</span> Illuminate\Database\Migrations\Migration;</div><div class="FixedLine"> 5</div><div class="FixedLine"> 6  <span class="EmphasisTypeBold">class RemoveBooksAuthorsColumn extends</span> Migration</div><div class="FixedLine"> 7  {</div><div class="FixedLine"> 8      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine"> 9       <span class="EmphasisTypeItalic">* Run the migrations.</span>
          </div><div class="FixedLine">10       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">11       <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">12       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">13      <span class="EmphasisTypeBold">public function</span> up()</div><div class="FixedLine">14      {</div><div class="FixedLine">15          Schema::table('books', <span class="EmphasisTypeBold">function</span> (Blueprint $table) {</div><div class="FixedLine">16              $table-&gt;dropColumn('author');</div><div class="FixedLine">17          });</div><div class="FixedLine">18      }</div><div class="FixedLine">19</div><div class="FixedLine">20      <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">21       <span class="EmphasisTypeItalic">* Reverse the migrations.</span>
          </div><div class="FixedLine">22       <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">23       <span class="EmphasisTypeItalic">* @return void</span>
          </div><div class="FixedLine">24       <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">25      <span class="EmphasisTypeBold">public function</span> down()</div><div class="FixedLine">26      {</div><div class="FixedLine">27          Schema::table('books', <span class="EmphasisTypeBold">function</span> (Blueprint $table) {</div><div class="FixedLine">28              $table-&gt;string('author');</div><div class="FixedLine">29          });</div><div class="FixedLine">30      }</div><div class="FixedLine">31  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-15.</span><div class="SimplePara">Cleaning Up the Author Column on the books Table</div></div></div></div>
          </div><div id="Par71" class="Para">Time to run the migration and see what happens (Listing <span class="InternalRef"><a href="#Par72">9-16</a></span>).</div><div id="Par72" class="Para">
            <div class="ProgramCode" id="PC16"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan migrate:refresh</div><div class="FixedLine">Rolled back: 2016_07_31_195159_associate_books_with_authors</div><div class="FixedLine">Rolled back: 2016_07_31_194721_create_authors_table</div><div class="FixedLine">Rolled back: 2016_07_28_232137_create_books_table</div><div class="FixedLine">Migrated: 2016_07_28_232137_create_books_table</div><div class="FixedLine">Migrated: 2016_07_31_194721_create_authors_table</div><div class="FixedLine">Migrated: 2016_07_31_195159_associate_books_with_authors</div><div class="FixedLine">Migrated: 2016_07_31_201317_remove_books_authors_column</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-16.</span><div class="SimplePara">Refreshing the Database Migrations</div></div></div></div>
          </div><div id="Par73" class="Para">You will get errors now if you run <span class="EmphasisFontCategoryNonProportional">php artisan db:seed</span> after running the migration to remove the <span class="EmphasisFontCategoryNonProportional">authors</span> column from the <span class="EmphasisFontCategoryNonProportional">books</span> table. You need to fix the db seeder, which is now broken due to the database migration (Listing <span class="InternalRef"><a href="#Par74">9-17</a></span>).</div><div id="Par74" class="Para">
            <div class="ProgramCode" id="PC17"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan db:seed</div><div class="FixedLine">...</div><div class="FixedLine">[PDOException]</div><div class="FixedLine">  SQLSTATE[42S22]: Column not found: 1054 Unknown column 'author' in 'field list'</div><div class="FixedLine">...</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-17.</span><div class="SimplePara">The Broken Database Seeder</div></div></div></div>
          </div><div id="Par75" class="Para">To fix the seeder you need to remove the <span class="EmphasisFontCategoryNonProportional">author</span> key in the <span class="EmphasisFontCategoryNonProportional">Book</span> factory. Open the <span class="EmphasisFontCategoryNonProportional">database/factories/ModelFactory.php</span> file and locate the <span class="EmphasisFontCategoryNonProportional">Book</span> factory (Listing <span class="InternalRef"><a href="#Par76">9-18</a></span>).</div><div id="Par76" class="Para">
            <div class="ProgramCode" id="PC18"><div class="FixedLine">21  $factory-&gt;define(App\Book::class, <span class="EmphasisTypeBold">function</span> ($faker) {</div><div class="FixedLine">22      $title = $faker-&gt;sentence(rand(3, 10));</div><div class="FixedLine">23</div><div class="FixedLine">24      <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">25          'title' =&gt; substr($title, 0, strlen($title) - 1),</div><div class="FixedLine">26          'description' =&gt; $faker-&gt;text,</div><div class="FixedLine">27      ];</div><div class="FixedLine">28  });</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-18.</span><div class="SimplePara">Removing the Author Key from the Book Factory</div></div></div></div>
          </div><div id="Par77" class="Para">Now you can refresh seed data successfully (Listing <span class="InternalRef"><a href="#Par78">9-19</a></span>).</div><div id="Par78" class="Para">
            <div class="ProgramCode" id="PC19"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ php artisan migrate:refresh</div><div class="FixedLine">...</div><div class="FixedLine">$ php artisan db:seed</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-19.</span><div class="SimplePara">Successfully Seeding the Database</div></div></div></div>
          </div><div id="Par79" class="Para ParaOneEmphasisChild">That wraps up your database schema and migration. You have a new <span class="EmphasisFontCategoryNonProportional">authors</span> table and you’ve cleaned up migrations and database seeding. At this point, the tests will blow up, so you need to find out what broke and fix it.</div></div><div id="Sec2" class="Section1 RenderAsSection1"><h2 class="Heading">Fixing Broken Tests</h2><div id="Par80" class="Para">You need to fix the tests that are failing as the result of schema changes. Although fixing broken tests isn’t the most glamorous part of programming, it’s nice to know that your test suite catches broken code before you ship it.</div><div id="Par81" class="Para">Since you just changed your database schema, it makes sense that various tests adding database records would break since you removed the <span class="EmphasisFontCategoryNonProportional">authors</span> column from the <span class="EmphasisFontCategoryNonProportional">books</span> table. You have a validation requirement of an author name in your <span class="EmphasisFontCategoryNonProportional">PUT /books</span> and <span class="EmphasisFontCategoryNonProportional">POST /books</span> endpoints too, which doesn’t exist in your schema.</div><div id="Par82" class="Para ParaOneEmphasisChild">If you inspect the <span class="EmphasisFontCategoryNonProportional">BooksControllerTest</span> you will see this factory call a few times:</div><div id="Par83" class="Para">
            <div class="ProgramCode" id="PC20"><div class="FixedLine">$books = factory('App\Book', 2)-&gt;create();</div></div>
          </div><div id="Par84" class="Para">Similar to the <span class="EmphasisFontCategoryNonProportional">BooksTableSeeder</span> change you made in this chapter, various tests will need to create an author and then associate that author with a book. It makes sense to create a method to avoid boilerplate code everywhere. Add the code in Listing <span class="InternalRef"><a href="#Par85">9-20</a></span> to the <span class="EmphasisFontCategoryNonProportional">tests/TestCase.php</span> from which your tests extend.</div><div id="Par85" class="Para">
            <div class="ProgramCode" id="PC21"><div class="FixedLine">54  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">55   <span class="EmphasisTypeItalic">* Convenience method for creating a book with an author</span>
          </div><div class="FixedLine">56   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">57   <span class="EmphasisTypeItalic">* @param int $count</span>
          </div><div class="FixedLine">58   <span class="EmphasisTypeItalic">* @return mixed</span>
          </div><div class="FixedLine">59   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">60  <span class="EmphasisTypeBold">protected function</span> bookFactory($count = 1)</div><div class="FixedLine">61  {</div><div class="FixedLine">62      $author = factory(\App\Author::class)-&gt;create();</div><div class="FixedLine">63      $books = factory(\App\Book::class, $count)-&gt;make();</div><div class="FixedLine">64</div><div class="FixedLine">65      <span class="EmphasisTypeBold">if</span> ($count === 1) {</div><div class="FixedLine">66          $books-&gt;author()-&gt;associate($author);</div><div class="FixedLine">67          $books-&gt;save();</div><div class="FixedLine">68      } <span class="EmphasisTypeBold">else</span> {</div><div class="FixedLine">69          <span class="EmphasisTypeBold">$books-&gt;each(function ($book) use ($author) {</span>
          </div><div class="FixedLine">70              $book-&gt;author()-&gt;associate($author);</div><div class="FixedLine">71              $book-&gt;save();</div><div class="FixedLine">72          });</div><div class="FixedLine">73      }</div><div class="FixedLine">74</div><div class="FixedLine">75      <span class="EmphasisTypeBold">return</span> $books;</div><div class="FixedLine">76  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-20.</span><div class="SimplePara">A Book Factory Method in tests/TestCase.php</div></div></div></div>
          </div><div id="Par86" class="Para">The <span class="EmphasisFontCategoryNonProportional">bookFactory</span> method is creating an author in the database. Next, the method calls <span class="EmphasisFontCategoryNonProportional">make()</span> to populate a <span class="EmphasisFontCategoryNonProportional">Book</span> model instance that is not yet saved in the database. The <span class="EmphasisFontCategoryNonProportional">author_id</span> column is required by a foreign key constraint so you need to call <span class="EmphasisFontCategoryNonProportional">make()</span> so you can attach the <span class="EmphasisFontCategoryNonProportional">author_id</span> before inserting the record in the database. The <span class="EmphasisFontCategoryNonProportional">if</span> statement checks to see how many books should be created. If only one book needs to be created, you attach the author to the book; otherwise you loop through each book and attach the author to all books.</div><div id="Par87" class="Para ParaOneEmphasisChild">Now that you have a convenient way of creating books and authors in the test database, you need to determine which tests need fixing. The easiest way to do that is to run the whole <span class="EmphasisFontCategoryNonProportional">phpunit</span> suite and go through each error one by one. As you find an error, you update it and run the test in isolation until it passes. You then move on to the next error, and so on, until you get back to green.</div><div id="Par88" class="Para">I will spare you the output from all of the failures, but the first one you will work on is this error (Listing <span class="InternalRef"><a href="#Par89">9-21</a></span>).</div><div id="Par89" class="Para">
            <div class="ProgramCode" id="PC22"><div class="LineGroup"><div class="FixedLine">Tests\App\Http\Controllers\BooksControllerTest::store_should_save_new_book_in_the_database</div><div class="FixedLine">PHPUnit_Framework_Exception: Argument #2 (No Value) of PHPUnit_Framework_Assert:\</div><div class="FixedLine">:assertArrayHasKey() must be a array or ArrayAccess</div></div><div class="LineGroup"><div class="FixedLine">bookr/tests/app/Http/Controllers/BooksControllerTest.php:108</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-21.</span><div class="SimplePara">PHPUnit Error Output</div></div></div></div>
          </div><div id="Par90" class="Para">The <span class="EmphasisFontCategoryNonProportional">BooksController@store</span> method is obviously breaking. Let’s find out what’s happening (Listing <span class="InternalRef"><a href="#Par91">9-22</a></span>).</div><div id="Par91" class="Para">
            <div class="ProgramCode" id="PC23"><div class="FixedLine">104  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">105  <span class="EmphasisTypeBold">public function</span> store_should_save_new_book_in_the_database()</div><div class="FixedLine">106  {</div><div class="FixedLine">107      $this-&gt;post('/books', [</div><div class="FixedLine">108          'title' =&gt; 'The Invisible Man',</div><div class="FixedLine">109          'description' =&gt; 'An invisible man is trapped in the terror of his own creation',</div><div class="FixedLine">110          'author' =&gt; 'H. G. Wells'</div><div class="FixedLine">111      ]);</div><div class="FixedLine">112</div><div class="FixedLine">113      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">114      <span class="EmphasisTypeBold">dd($body, $this-&gt;response-&gt;getStatusCode());</span>
          </div><div class="FixedLine">115      <span class="EmphasisTypeItalic">// ....</span>
          </div><div class="FixedLine">116  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-22.</span><div class="SimplePara">Temporarily Dump the $body Variable</div></div></div></div>
          </div><div id="Par92" class="Para">The <span class="EmphasisFontCategoryNonProportional">dd()</span> function is a convenience function for dumping the variable and exiting the program. Listing <span class="InternalRef"><a href="#Par93">9-23</a></span> shows the output you will receive when you run the test now.</div><div id="Par93" class="Para">
            <div class="ProgramCode" id="PC24"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=store_should_save_new_book_in_the_database</div></div><div class="LineGroup"><div class="FixedLine">null</div><div class="FixedLine">500</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-23.</span><div class="SimplePara">Debugging the Failing Test</div></div></div></div>
          </div><div id="Par94" class="Para">The response body is <span class="EmphasisFontCategoryNonProportional">null</span> and the status code is <span class="EmphasisFontCategoryNonProportional">500</span>. Weird! You should comb the logs and see what you can find. Clear out the <span class="EmphasisFontCategoryNonProportional">storage/logs/lumen.log</span> file and run the test again. You should see something like Listing <span class="InternalRef"><a href="#Par95">9-24</a></span>.</div><div id="Par95" class="Para">
            <div class="ProgramCode" id="PC25"><div class="FixedLine">[2016-07-31 20:37:28] lumen.ERROR: PDOException: SQLSTATE[42S22]: Column not found: 1054 Unknown column 'author' in 'field list' in /Users/paul/Code/laravel-valet/bookr/vendor/illuminate/database/Connection.php:441</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-24.</span><div class="SimplePara">Test Error in storage/logs/lumen.log</div></div></div></div>
          </div><div id="Par96" class="Para">The <span class="EmphasisFontCategoryNonProportional">BooksController@store</span> method is trying to insert an <span class="EmphasisFontCategoryNonProportional">author</span> column that no longer exists in the <span class="EmphasisFontCategoryNonProportional">books</span> table. You could remove it from your test to get the next error, but I want to show you another issue here: the <span class="EmphasisFontCategoryNonProportional">Book</span> model has defined <span class="EmphasisFontCategoryNonProportional">author</span> as a <span class="EmphasisFontCategoryNonProportional">fillable</span> field. You need to remove the field that is invalid now (Listing <span class="InternalRef"><a href="#Par97">9-25</a></span>).</div><div id="Par97" class="Para">
            <div class="ProgramCode" id="PC26"><div class="FixedLine"> 9  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">10   <span class="EmphasisTypeItalic">* The attributes that are mass assignable</span>
          </div><div class="FixedLine">11   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">12   <span class="EmphasisTypeItalic">* @var array</span>
          </div><div class="FixedLine">13   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">14 <span class="EmphasisTypeBold">protected</span> $fillable = ['title', 'description'];</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-25.</span><div class="SimplePara">Updating the app/Book.php Fillable Fields</div></div></div></div>
          </div><div id="Par98" class="Para">If you run your test again, you will get a different error (Listing <span class="InternalRef"><a href="#Par99">9-26</a></span>).</div><div id="Par99" class="Para">
            <div class="ProgramCode" id="PC27"><div class="FixedLine">[2016-07-31 20:38:17] lumen.ERROR: PDOException: SQLSTATE[23000]: Integrity constraint violation: 1452 Cannot add or update a child row: a foreign key constraint fails (`bookr_testing`.`books`, CONSTRAINT `books_author_id_foreign` FOREIGN KEY (`author_id`) REFERENCES `authors` (`id`) ON DELETE CASCADE) in /Users/paul/Code/laravel-valet/bookr/vendor/illuminate/database/Connection.php:441</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-26.</span><div class="SimplePara">A PDOException Error in storage/logs/lumen.log</div></div></div></div>
          </div><div id="Par100" class="Para">Now the <span class="EmphasisFontCategoryNonProportional">BooksController@store</span> method is failing because of a missing foreign key constraint; you are not passing a proper <span class="EmphasisFontCategoryNonProportional">author_id</span> in the request. You are creating a book so you just need to generate a valid author in your test (Listing <span class="InternalRef"><a href="#Par101">9-27</a></span>).</div><div id="Par101" class="Para">
            <div class="ProgramCode" id="PC28"><div class="FixedLine">104  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">105  <span class="EmphasisTypeBold">public function</span> store_should_save_new_book_in_the_database()</div><div class="FixedLine">107  {</div><div class="FixedLine">107      $author = factory(\App\Author::class)-&gt;create([</div><div class="FixedLine">108          'name' =&gt; 'H. G. Wells'</div><div class="FixedLine">109      ]);</div><div class="FixedLine">110</div><div class="FixedLine">111      $this-&gt;post('/books', [</div><div class="FixedLine">112          'title' =&gt; 'The Invisible Man',</div><div class="FixedLine">113          'description' =&gt; 'An invisible man is trapped in the terror of his own creation',</div><div class="FixedLine">114          'author_id' =&gt; $author-&gt;id</div><div class="FixedLine">115      ], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">116</div><div class="FixedLine">117      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">118</div><div class="FixedLine">119      $this-&gt;assertArrayHasKey('data', $body);</div><div class="FixedLine">120</div><div class="FixedLine">121      $data = $body['data'];</div><div class="FixedLine">122      $this-&gt;assertEquals('The Invisible Man', $data['title']);</div><div class="FixedLine">123      $this-&gt;assertEquals(</div><div class="FixedLine">124          'An invisible man is trapped in the terror of his own creation',</div><div class="FixedLine">125          $data['description']</div><div class="FixedLine">126      );</div><div class="FixedLine">127      $this-&gt;assertEquals('H. G. Wells', $data['author']);</div><div class="FixedLine">128      $this-&gt;assertTrue($data['id'] &gt; 0, 'Expected a positive integer, but did not see one.');</div><div class="FixedLine">129</div><div class="FixedLine">130      $this-&gt;assertArrayHasKey('created', $data);</div><div class="FixedLine">131      $this-&gt;assertEquals(Carbon::now()-&gt;toIso8601String(), $data['created']);</div><div class="FixedLine">132      $this-&gt;assertArrayHasKey('updated', $data);</div><div class="FixedLine">133      $this-&gt;assertEquals(Carbon::now()-&gt;toIso8601String(), $data['updated']);</div><div class="FixedLine">134</div><div class="FixedLine">135      $this-&gt;seeInDatabase('books', ['title' =&gt; 'The Invisible Man']);</div><div class="FixedLine">136  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-27.</span><div class="SimplePara">Updating the Test to Pass an Author ID</div></div></div></div>
          </div><div id="Par102" class="Para">Run the test again (Listing <span class="InternalRef"><a href="#Par103">9-28</a></span>).</div><div id="Par103" class="Para">
            <div class="ProgramCode" id="PC29"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=store_should_save_new_book_in_the_database</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::store_should_save_new_book_in_the_database</div><div class="FixedLine">Failed asserting that an array has the key 'data'.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/BooksControllerTest.php:119</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 1, Assertions: 1, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-28.</span><div class="SimplePara">Running Your Failing Test Again</div></div></div></div>
          </div><div id="Par104" class="Para">You’re still getting errors, so let’s investigate the response (Listing <span class="InternalRef"><a href="#Par105">9-29</a></span>).</div><div id="Par105" class="Para">
            <div class="ProgramCode" id="PC30"><div class="FixedLine">104  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">105  <span class="EmphasisTypeBold">public function</span> store_should_save_new_book_in_the_database()</div><div class="FixedLine">106  {</div><div class="FixedLine">107      $author = factory(\App\Author::class)-&gt;create([</div><div class="FixedLine">108          'name' =&gt; 'H. G. Wells'</div><div class="FixedLine">109      ]);</div><div class="FixedLine">110</div><div class="FixedLine">111      $this-&gt;post('/books', [</div><div class="FixedLine">112          'title' =&gt; 'The Invisible Man',</div><div class="FixedLine">113          'description' =&gt; 'An invisible man is trapped in the terror of his own creation',</div><div class="FixedLine">114          'author_id' =&gt; $author-&gt;id</div><div class="FixedLine">115      ], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">116</div><div class="FixedLine">117      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">118      dd($body);</div><div class="FixedLine">119      <span class="EmphasisTypeItalic">// …</span>
          </div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-29.</span><div class="SimplePara">Debugging the Failing Test (Partial Code)</div></div></div></div>
          </div><div id="Par106" class="Para">The output should be something like Listing <span class="InternalRef"><a href="#Par107">9-30</a></span>.</div><div id="Par107" class="Para">
            <div class="ProgramCode" id="PC31"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=store_should_save_new_book_in_the_database</div></div><div class="LineGroup"><div class="FixedLine">array:1 [</div><div class="FixedLine">  "author" =&gt; array:1 [</div><div class="FixedLine">    0 =&gt; "The author field is required."</div><div class="FixedLine">  ]</div><div class="FixedLine">]</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-30.</span><div class="SimplePara">Output from Debugging the Failing Test</div></div></div></div>
          </div><div id="Par108" class="Para">You have a failed validation constraint for the <span class="EmphasisFontCategoryNonProportional">author</span> column that is no longer valid since you removed the <span class="EmphasisFontCategoryNonProportional">authors</span> column. You need to replace it with a validation rule for a valid <span class="EmphasisFontCategoryNonProportional">author_id</span> (Listing <span class="InternalRef"><a href="#Par109">9-31</a></span>).</div><div id="Par109" class="Para">
            <div class="ProgramCode" id="PC32"><div class="FixedLine">43  $this-&gt;validate($request, [</div><div class="FixedLine">44      'title' =&gt; 'required|max:255',</div><div class="FixedLine">45      'description' =&gt; 'required',</div><div class="FixedLine">46      <span class="EmphasisTypeBold">'author_id' =&gt; 'required|exists:authors,id'</span>
          </div><div class="FixedLine">47  ], [</div><div class="FixedLine">48      'description.required' =&gt; 'Please fill out the :attribute.'</div><div class="FixedLine">49  ]);</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-31.</span><div class="SimplePara">Updating Validation in BooksController@store</div></div></div></div>
          </div><div id="Par110" class="Para">You’ve replaced <span class="EmphasisFontCategoryNonProportional">author</span> with <span class="EmphasisFontCategoryNonProportional">author_id</span> and you are using the <span class="EmphasisFontCategoryNonProportional">exists</span> validation rule that ensures an author record exist in the <span class="EmphasisFontCategoryNonProportional">authors</span> table. The <span class="EmphasisFontCategoryNonProportional">exists</span> validation in this case reads like this: <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">exists:&lt;table&gt;,&lt;column&gt;</span></span>. If you omit the column, it will use the field associated with the validation rule, in this case <span class="EmphasisFontCategoryNonProportional">author_id</span>. At this point, running the test again will still fail (see if you can figure out why on your own).</div><div id="Par111" class="Para">You haven’t changed the controller to set the <span class="EmphasisFontCategoryNonProportional">author_id</span> property on the model, although you are passing it at this point in the failing test. You need to allow this field to be fillable (Listing <span class="InternalRef"><a href="#Par112">9-32</a></span>).</div><div id="Par112" class="Para">
            <div class="ProgramCode" id="PC33"><div class="FixedLine"> 9  <span class="EmphasisTypeItalic">/**</span>
          </div><div class="FixedLine">10   <span class="EmphasisTypeItalic">* The attributes that are mass assignable</span>
          </div><div class="FixedLine">11   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">12   <span class="EmphasisTypeItalic">* @var array</span>
          </div><div class="FixedLine">13   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">14  <span class="EmphasisTypeBold">protected</span> $fillable = ['title', 'description', 'author_id'];</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-32.</span><div class="SimplePara">Making the author_id Field Mass-Assignable</div></div></div></div>
          </div><div id="Par113" class="Para">Now your controller should be able to populate the <span class="EmphasisFontCategoryNonProportional">author_id</span> field when it calls <span class="EmphasisFontCategoryNonProportional">$book = Book::create($request-&gt;all());</span>. Let’s run your test again and see (Listing <span class="InternalRef"><a href="#Par114">9-33</a></span>).</div><div id="Par114" class="Para">
            <div class="ProgramCode" id="PC34"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=store_should_save_new_book_in_the_database</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::store_should_save_new_book_in_the_database</div><div class="FixedLine">Array (…) does not match expected type "string".</div></div><div class="LineGroup"><div class="FixedLine">bookr/tests/app/Http/Controllers/BooksControllerTest.php:121</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-33.</span><div class="SimplePara">Running the Test After Making author_id Fillable</div></div></div></div>
          </div><div id="Par115" class="Para">It looks like your save is now succeeding, but your assertions are not matching up anymore. The response should look something like Listing <span class="InternalRef"><a href="#Par116">9-34</a></span> now if you call <span class="EmphasisFontCategoryNonProportional">dd()</span>.</div><div id="Par116" class="Para">
            <div class="ProgramCode" id="PC35"><div class="FixedLine">array:1 [</div><div class="FixedLine">  "data" =&gt; array:6 [</div><div class="FixedLine">    "id" =&gt; 1</div><div class="FixedLine">    "title" =&gt; "The Invisible Man"</div><div class="FixedLine">    "description" =&gt; "An invisible man is trapped in the terror of his own creation"</div><div class="FixedLine">    "author" =&gt; array:6 [</div><div class="FixedLine">      "id" =&gt; 1</div><div class="FixedLine">      "name" =&gt; "H. G. Wells"</div><div class="FixedLine">      "gender" =&gt; "female"</div><div class="FixedLine">      "biography" =&gt; "Ut quis doloremque dolorem eaque. Repellendus et dolor eos doloribus. Velit omnis alias ut fugiat molestias ab velit."</div><div class="FixedLine">      "created_at" =&gt; "2015-11-21 16:32:34"</div><div class="FixedLine">      "updated_at" =&gt; "2015-11-21 16:32:34"</div><div class="FixedLine">    ]</div><div class="FixedLine">    "created" =&gt; "2015-11-21T16:32:34+0000"</div><div class="FixedLine">    "updated" =&gt; "2015-11-21T16:32:34+0000"</div><div class="FixedLine">  ]</div><div class="FixedLine">]</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-34.</span><div class="SimplePara">Dumped Response from the Test</div></div></div></div>
          </div><div id="Par117" class="Para">Whoops, the <span class="EmphasisFontCategoryNonProportional">BookTransformer</span> is now outputting the entire author record instead of just the author name. Later on in the book you will change the way responses include author data, but for now let’s just keep your API the same. You can now use the associated author model to pass the author name (Listing <span class="InternalRef"><a href="#Par118">9-35</a></span>).</div><div id="Par118" class="Para">
            <div class="ProgramCode" id="PC36"><div class="FixedLine">10  /**</div><div class="FixedLine">11   <span class="EmphasisTypeItalic">* Transform a Book model into an array</span>
          </div><div class="FixedLine">12   <span class="EmphasisTypeItalic">*</span>
          </div><div class="FixedLine">13   <span class="EmphasisTypeItalic">* @param Book $book</span>
          </div><div class="FixedLine">14   <span class="EmphasisTypeItalic">* @return array</span>
          </div><div class="FixedLine">15   <span class="EmphasisTypeItalic">*/</span>
          </div><div class="FixedLine">16  <span class="EmphasisTypeBold">public function</span> transform(Book $book)</div><div class="FixedLine">17  {</div><div class="FixedLine">18      <span class="EmphasisTypeBold">return</span> [</div><div class="FixedLine">19          'id'          =&gt; $book-&gt;id,</div><div class="FixedLine">20          'title'       =&gt; $book-&gt;title,</div><div class="FixedLine">21          'description' =&gt; $book-&gt;description,</div><div class="FixedLine">22          <span class="EmphasisTypeBold">'author'      =&gt; $book-&gt;author-&gt;name</span>,</div><div class="FixedLine">23          'created'     =&gt; $book-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">24          'updated'     =&gt; $book-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">25      ];</div><div class="FixedLine">26  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-35.</span><div class="SimplePara">Updating the BookTransformer::transform() Method</div></div></div></div>
          </div><div id="Par119" class="Para">Run your test again after the transformer change (Listing <span class="InternalRef"><a href="#Par120">9-36</a></span>). If you have any <span class="EmphasisFontCategoryNonProportional">dd()</span> calls in your test, don’t forget to remove them!</div><div id="Par120" class="Para">
            <div class="ProgramCode" id="PC37"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=store_should_save_new_book_in_the_database</div><div class="FixedLine">OK (1 test, 10 assertions)</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-36.</span><div class="SimplePara">Running the Test After Updating the BookTransformer</div></div></div></div>
          </div><div id="Par121" class="Para">You had to do considerable amount of investigating for a simple change, but it was a good exercise to get more familiar with debugging failing tests. You are ready to move on to the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">update_should_only_change_fillable_fields</span></span> failing test, shown in Listing <span class="InternalRef"><a href="#Par122">9-37</a></span>.</div><div id="Par122" class="Para">
            <div class="ProgramCode" id="PC38"><div class="FixedLine">Tests\App\Http\Controllers\BooksControllerTest::update_should_only_change_fillable_fields</div><div class="FixedLine">Illuminate\Database\QueryException: SQLSTATE[42S22]: Column not found: 1054 Unknown column 'author' in 'field list'…</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-37.</span><div class="SimplePara">Failing Test for Updating Fillable Fields</div></div></div></div>
          </div><div id="Par123" class="Para">This error looks familiar. The <span class="EmphasisFontCategoryNonProportional">BooksController@update</span> and accompanying tests are still using the <span class="EmphasisFontCategoryNonProportional">author</span> parameter. You will start by updating the test to look like Listing <span class="InternalRef"><a href="#Par124">9-38</a></span>.</div><div id="Par124" class="Para">
            <div class="ProgramCode" id="PC39"><div class="FixedLine">153  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">154  <span class="EmphasisTypeBold">public function</span> update_should_only_change_fillable_fields()</div><div class="FixedLine">155  {</div><div class="FixedLine">156      $book = $this-&gt;bookFactory();</div><div class="FixedLine">157</div><div class="FixedLine">158      $this-&gt;notSeeInDatabase('books', [</div><div class="FixedLine">159          'title' =&gt; 'The War of the Worlds',</div><div class="FixedLine">160          'description' =&gt; 'The book is way better than the movie.',</div><div class="FixedLine">161      ]);</div><div class="FixedLine">162</div><div class="FixedLine">163      $this-&gt;put("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>", [</div><div class="FixedLine">164          'id' =&gt; 5,</div><div class="FixedLine">165          'title' =&gt; 'The War of the Worlds',</div><div class="FixedLine">166          'description' =&gt; 'The book is way better than the movie.'</div><div class="FixedLine">167      ], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">168</div><div class="FixedLine">169      $this</div><div class="FixedLine">170          -&gt;seeStatusCode(200)</div><div class="FixedLine">171          -&gt;seeJson([</div><div class="FixedLine">172              'id' =&gt; 1,</div><div class="FixedLine">173              'title' =&gt; 'The War of the Worlds',</div><div class="FixedLine">174              'description' =&gt; 'The book is way better than the movie.'</div><div class="FixedLine">175          ])</div><div class="FixedLine">176          -&gt;seeInDatabase('books', [</div><div class="FixedLine">177              'title' =&gt; 'The War of the Worlds'</div><div class="FixedLine">178          ]);</div><div class="FixedLine">179</div><div class="FixedLine">180      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">181      $this-&gt;assertArrayHasKey('data', $body);</div><div class="FixedLine">182</div><div class="FixedLine">183      $data = $body['data'];</div><div class="FixedLine">184      $this-&gt;assertArrayHasKey('created', $data);</div><div class="FixedLine">185      $this-&gt;assertEquals(Carbon::now()-&gt;toIso8601String(), $data['created']);</div><div class="FixedLine">186      $this-&gt;assertArrayHasKey('updated', $data);</div><div class="FixedLine">187      $this-&gt;assertEquals(Carbon::now()-&gt;toIso8601String(), $data['updated']);</div><div class="FixedLine">188  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-38.</span><div class="SimplePara">Fixes for the update_should_only_change_fillable_fields Test</div></div></div></div>
          </div><div id="Par125" class="Para">It is a good idea to remove changing the author from the test and focus on updating the book. Now that you have a separate database table for authors, you should make a separate test for changing the author. You should also remove the <span class="EmphasisFontCategoryNonProportional">author</span> column from the <span class="EmphasisFontCategoryNonProportional">notSeeInDatabase</span> and the <span class="EmphasisFontCategoryNonProportional">$this-&gt;seeJson()</span> assertion (Listing <span class="InternalRef"><a href="#Par126">9-39</a></span>).</div><div id="Par126" class="Para">
            <div class="ProgramCode" id="PC40"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=update_should_only_change_fillable_fields</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::update_should_only_change_fil\</div><div class="FixedLine">lable_fields</div><div class="FixedLine">Failed asserting that 422 matches expected 200.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-39.</span><div class="SimplePara">Running the Test After Updating</div></div></div></div>
          </div><div id="Par127" class="Para">It looks like you are getting a validation error from your missing <span class="EmphasisFontCategoryNonProportional">author</span> parameter. Let’s change the validation rule to match the <span class="EmphasisFontCategoryNonProportional">BooksController@update</span> change you just made (Listing <span class="InternalRef"><a href="#Par128">9-40</a></span>).</div><div id="Par128" class="Para">
            <div class="ProgramCode" id="PC41"><div class="FixedLine">$this-&gt;validate($request, [</div><div class="FixedLine">    'title' =&gt; 'required|max:255',</div><div class="FixedLine">    'description' =&gt; 'required',</div><div class="FixedLine">    <span class="EmphasisTypeBold">'author_id' =&gt; 'exists:authors,id'</span>
          </div><div class="FixedLine">], [</div><div class="FixedLine">    'description.required' =&gt; 'Please fill out the :attribute.'</div><div class="FixedLine">]);</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-40.</span><div class="SimplePara">Updating Validation for BooksController@update</div></div></div></div>
          </div><div id="Par129" class="Para">An important difference between <span class="EmphasisFontCategoryNonProportional">BooksController@update</span> and <span class="EmphasisFontCategoryNonProportional">BooksController@store</span> validation is that you don’t use the <span class="EmphasisFontCategoryNonProportional">require</span> rule on update. You only check that the records exist in the <span class="EmphasisFontCategoryNonProportional">authors</span> table if the field is present and allow the endpoint to optionally change the author. Now, let’s see if your change makes the test pass (Listing <span class="InternalRef"><a href="#Par130">9-41</a></span>).</div><div id="Par130" class="Para">
            <div class="ProgramCode" id="PC42"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=update_should_only_change_fillable_fields</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 11 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-41.</span><div class="SimplePara">Running the Test After Updating Validation</div></div></div></div>
          </div><div id="Par131" class="Para">Moving on, the next error from the suite is from the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">destroy_should_remove_a_valid_book</span></span> test (Listing <span class="InternalRef"><a href="#Par132">9-42</a></span>).</div><div id="Par132" class="Para">
            <div class="ProgramCode" id="PC43"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerTest::destroy_should_remove_a_valid_book</div><div class="FixedLine">Illuminate\Database\QueryException: SQLSTATE[23000]: Integrity constraint violation: 1452 Cannot add or update a child row: a foreign key constraint fails</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-42.</span><div class="SimplePara">The Next Error from Your Test Suite</div></div></div></div>
          </div><div id="Par133" class="Para">The test’s <span class="EmphasisFontCategoryNonProportional">factory()</span> call fails because of the foreign key constraint. Fixing this test is a one-line change using your new <span class="EmphasisFontCategoryNonProportional">bookFactory()</span> method (Listing <span class="InternalRef"><a href="#Par134">9-43</a></span>).</div><div id="Par134" class="Para">
            <div class="ProgramCode" id="PC44"><div class="FixedLine">208  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">209  <span class="EmphasisTypeBold">public function</span> destroy_should_remove_a_valid_book()</div><div class="FixedLine">210  {</div><div class="FixedLine">211      $book = $this-&gt;bookFactory();</div><div class="FixedLine">212</div><div class="FixedLine">213      $this</div><div class="FixedLine">214          -&gt;delete("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>")</div><div class="FixedLine">215          -&gt;seeStatusCode(204)</div><div class="FixedLine">216          -&gt;isEmpty();</div><div class="FixedLine">217</div><div class="FixedLine">218      $this-&gt;notSeeInDatabase('books', ['id' =&gt; $book-&gt;id]);</div><div class="FixedLine">219  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-43.</span><div class="SimplePara">Fixing the Failing BooksController@destroy Test</div></div></div></div>
          </div><div id="Par135" class="Para">Let’s see if your destroy test passes after your change (Listing <span class="InternalRef"><a href="#Par136">9-44</a></span>).</div><div id="Par136" class="Para">
            <div class="ProgramCode" id="PC45"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=destroy_should_remove_a_valid_book</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 2 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-44.</span><div class="SimplePara">Running the Test After Updating BooksController@destroy</div></div></div></div>
          </div><div id="Par137" class="Para">You’ve fixed a few individual tests. Now run the entire suite to see what remains (Listing <span class="InternalRef"><a href="#Par138">9-45</a></span>).</div><div id="Par138" class="Para">
            <div class="ProgramCode" id="PC46"><div class="FixedLine">Tests\App\Http\Controllers\BooksControllerValidationTest::it_validates_required_fields_when_updating_a_book</div><div class="FixedLine">Illuminate\Database\QueryException: SQLSTATE[23000]: Integrity constraint violation: 1452 Cannot add or update a child row: a foreign key constraint fails</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-45.</span><div class="SimplePara">The Next Error from the Test Suite</div></div></div></div>
          </div><div id="Par139" class="Para">This error comes from <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">tests/app/Http/Controllers/BooksControllerValidationTest.php</span></span> and looks like another factory failure (Listing <span class="InternalRef"><a href="#Par140">9-46</a></span>).</div><div id="Par140" class="Para">
            <div class="ProgramCode" id="PC47"><div class="LineGroup"><div class="FixedLine">
                  <span class="EmphasisTypeItalic">/** @test **/</span>
                </div><div class="FixedLine">
              <span class="EmphasisTypeBold">public function</span> it_validates_required_fields_when_updating_a_book()</div><div class="FixedLine">{</div><div class="FixedLine">    $book = $this-&gt;bookFactory();</div></div><div class="LineGroup"><div class="FixedLine">    $this-&gt;put("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>", [], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">    $this-&gt;assertEquals(Response::HTTP_UNPROCESSABLE_ENTITY, $this-&gt;response-&gt;getStatusCode());</div><div class="FixedLine">    $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div></div><div class="LineGroup"><div class="FixedLine">    $this-&gt;assertArrayHasKey('title', $body);</div><div class="FixedLine">    $this-&gt;assertArrayHasKey('description', $body);</div></div><div class="LineGroup"><div class="FixedLine">    $this-&gt;assertEquals(["The title field is required."], $body['title']);</div><div class="FixedLine">    $this-&gt;assertEquals(["Please provide a description."], $body['description']);</div><div class="FixedLine">}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-46.</span><div class="SimplePara">Updating the Test to Use the bookFactory() Method</div></div></div></div>
          </div><div id="Par141" class="Para">You replace the <span class="EmphasisFontCategoryNonProportional">factory()</span> call with the <span class="EmphasisFontCategoryNonProportional">bookFactory()</span> method and remove a few assertions for the <span class="EmphasisFontCategoryNonProportional">authors</span> validation. That should be enough to get the test passing again (Listing <span class="InternalRef"><a href="#Par142">9-47</a></span>).</div><div id="Par142" class="Para">
            <div class="ProgramCode" id="PC48"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=it_validates_required_fields_when_updating_a_book</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 5 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-47.</span><div class="SimplePara">Running the Validation Test</div></div></div></div>
          </div><div id="Par143" class="Para">You are getting the same foreign key errors in various places so let’s bulk-update tests that are using the original <span class="EmphasisFontCategoryNonProportional">factory()</span> call and see what remains afterwards. Let’s start with the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">tests/app/Http/Controllers/BooksControllerValidationTest.php</span></span> file (Listing <span class="InternalRef"><a href="#Par144">9-48</a></span>).</div><div id="Par144" class="Para">
            <div class="ProgramCode" id="PC49"><div class="LineGroup"><div class="FixedLine">
                  <span class="EmphasisTypeItalic">/** @test **/</span>
                </div><div class="FixedLine">
              <span class="EmphasisTypeBold">public function</span> title_fails_create_validation_when_just_too_long()</div><div class="FixedLine">{</div><div class="FixedLine">    <span class="EmphasisTypeItalic">// Creating a book</span>
            </div><div class="FixedLine">    $book = $this-&gt;bookFactory();</div><div class="FixedLine">    <span class="EmphasisTypeItalic">//...</span>
            </div><div class="FixedLine">}</div></div><div class="LineGroup"><div class="FixedLine">
                  <span class="EmphasisTypeItalic">/** @test **/</span>
                </div><div class="FixedLine">
              <span class="EmphasisTypeBold">public function</span> title_fails_update_validation_when_just_too_long()</div><div class="FixedLine">{</div><div class="FixedLine">    <span class="EmphasisTypeItalic">// Updating a book</span>
            </div><div class="FixedLine">    $book = $this-&gt;bookFactory();</div><div class="FixedLine">    <span class="EmphasisTypeItalic">// ...</span>
            </div><div class="FixedLine">}</div></div><div class="LineGroup"><div class="FixedLine">
                  <span class="EmphasisTypeItalic">/** @test **/</span>
                </div><div class="FixedLine">
              <span class="EmphasisTypeBold">public function</span> title_passes_create_validation_when_exactly_max()</div><div class="FixedLine">{</div><div class="FixedLine">    <span class="EmphasisTypeItalic">// Creating a new Book</span>
            </div><div class="FixedLine">    $book = $this-&gt;bookFactory();</div><div class="FixedLine">    <span class="EmphasisTypeItalic">// ...</span>
            </div><div class="FixedLine">}</div></div><div class="LineGroup"><div class="FixedLine">
                  <span class="EmphasisTypeItalic">/** @test **/</span>
                </div><div class="FixedLine">
              <span class="EmphasisTypeBold">public function</span> title_passes_update_validation_when_exactly_max()</div><div class="FixedLine">{</div><div class="FixedLine">    <span class="EmphasisTypeItalic">// Updating a book</span>
            </div><div class="FixedLine">    $book = $this-&gt;bookFactory();</div><div class="FixedLine">    <span class="EmphasisTypeItalic">// ...</span>
            </div><div class="FixedLine">}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-48.</span><div class="SimplePara">Replacing All factory() Calls in the Validation Test File</div></div></div></div>
          </div><div id="Par145" class="Para">Next, you will update the <span class="EmphasisFontCategoryNonProportional">tests/app/Http/Controllers/BooksControllerTest.php</span> file (Listing <span class="InternalRef"><a href="#Par146">9-49</a></span>).</div><div id="Par146" class="Para">
            <div class="ProgramCode" id="PC50"><div class="LineGroup"><div class="FixedLine">
                  <span class="EmphasisTypeItalic">/** @test **/</span>
                </div><div class="FixedLine">
              <span class="EmphasisTypeBold">public function</span> index_should_return_a_collection_of_records()</div><div class="FixedLine">{</div><div class="FixedLine">    $books = $this-&gt;bookFactory(2);</div><div class="FixedLine">    <span class="EmphasisTypeItalic">// ...</span>
            </div><div class="FixedLine">}</div></div><div class="LineGroup"><div class="FixedLine">
                  <span class="EmphasisTypeItalic">/** @test **/</span>
                </div><div class="FixedLine">
              <span class="EmphasisTypeBold">public function</span> show_should_return_a_valid_book()</div><div class="FixedLine">{</div><div class="FixedLine">    $book = $this-&gt;bookFactory();</div><div class="FixedLine">    <span class="EmphasisTypeItalic">// ...</span>
            </div><div class="FixedLine">}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-49.</span><div class="SimplePara">Replacing All factory() Calls in BooksControllerTest</div></div></div></div>
          </div><div id="Par147" class="Para ParaTypeImportant ParaOneEmphasisChild">The <span class="EmphasisFontCategoryNonProportional">BooksController@index</span> test creates two books since you are testing for a collection of records.</div><div id="Par148" class="Para">Hopefully the foreign key errors are behind you. Let’s see what failures you have remaining in the <span class="EmphasisFontCategoryNonProportional">BooksControllerValidationTest</span> (Listing <span class="InternalRef"><a href="#Par149">9-50</a></span>).</div><div id="Par149" class="Para">
            <div class="ProgramCode" id="PC51"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit tests/app/Http/Controllers/BooksControllerValidationTest.php</div></div><div class="LineGroup"><div class="FixedLine">There were 2 failures:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Http\Controllers\BooksControllerValidationTest::it_validates_requir\</div><div class="FixedLine">ed_fields_when_creating_a_new_book</div><div class="FixedLine">Failed asserting that an array has the key 'author'.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/BooksControllerValidationTest.php:24</div></div><div class="LineGroup"><div class="FixedLine">2) Tests\App\Http\Controllers\BooksControllerValidationTest::title_passes_create_validation_when_exactly_max</div><div class="FixedLine">Failed asserting that 422 matches expected 201.</div></div><div class="LineGroup"><div class="FixedLine">/home/vagrant/Code/bookr/vendor/laravel/lumen-framework/src/Testing/CrawlerTrait.php:412</div><div class="FixedLine">/home/vagrant/Code/bookr/tests/app/Http/Controllers/BooksControllerValidationTest.php:107</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 6, Assertions: 20, Failures: 2.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-50.</span><div class="SimplePara">Remaining Validation Test Failures</div></div></div></div>
          </div><div id="Par150" class="Para ParaOneEmphasisChild">It looks like you have a failed assertion for a key you are no longer providing and a <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">422</span></span> response code, which means you have some validation errors when you don’t expect them.</div><div id="Par151" class="Para">The first fix is simply removing an assertion for the <span class="EmphasisFontCategoryNonProportional">author</span> key and removing the author validation message check. Listing <span class="InternalRef"><a href="#Par152">9-51</a></span> shows what the <span class="EmphasisFontCategoryNonProportional">BooksControllerValidationTest</span> should look like after you remove the author checks.</div><div id="Par152" class="Para">
            <div class="ProgramCode" id="PC52"><div class="FixedLine">13  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">14  <span class="EmphasisTypeBold">public function</span> it_validates_required_fields_when_creating_a_new_book()</div><div class="FixedLine">15  {</div><div class="FixedLine">16      $this-&gt;post('/books', [], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">17</div><div class="FixedLine">18      $this-&gt;assertEquals(Response::HTTP_UNPROCESSABLE_ENTITY, $this-&gt;response-&gt;getStatusCode());</div><div class="FixedLine">19</div><div class="FixedLine">20      $body = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">21</div><div class="FixedLine">22      $this-&gt;assertArrayHasKey('title', $body);</div><div class="FixedLine">23      $this-&gt;assertArrayHasKey('description', $body);</div><div class="FixedLine">24</div><div class="FixedLine">25      $this-&gt;assertEquals(["The title field is required."], $body['title']);</div><div class="FixedLine">26      $this-&gt;assertEquals(</div><div class="FixedLine">27          ["Please provide a description."],</div><div class="FixedLine">28          $body['description']</div><div class="FixedLine">29      );</div><div class="FixedLine">30  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-51.</span><div class="SimplePara">Removing Author Test Assertions</div></div></div></div>
          </div><div id="Par153" class="Para">The second failure in <span class="EmphasisFontCategoryNonProportional">BooksControllerValidationTest</span> happens because the <span class="EmphasisFontCategoryNonProportional">author_id</span> is a required field (Listing <span class="InternalRef"><a href="#Par154">9-52</a></span>).</div><div id="Par154" class="Para">
            <div class="ProgramCode" id="PC53"><div class="FixedLine"> 90  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine"> 91  <span class="EmphasisTypeBold">public function</span> title_passes_create_validation_when_exactly_max()</div><div class="FixedLine"> 92  {</div><div class="FixedLine"> 93      <span class="EmphasisTypeItalic">// Creating a new Book</span>
          </div><div class="FixedLine"> 94      $book = $this-&gt;bookFactory();</div><div class="FixedLine"> 95      $book-&gt;title = str_repeat('a', 255);</div><div class="FixedLine"> 96      $this-&gt;post("/books", [</div><div class="FixedLine"> 97          'title' =&gt; $book-&gt;title,</div><div class="FixedLine"> 98          'description' =&gt; $book-&gt;description,</div><div class="FixedLine"> 99          <span class="EmphasisTypeBold">'author_id' =&gt; $book-&gt;author-&gt;id</span>, <span class="EmphasisTypeItalic">// Pass a valid author</span>
          </div><div class="FixedLine">100      ], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">101</div><div class="FixedLine">102      $this</div><div class="FixedLine">103          -&gt;seeStatusCode(Response::HTTP_CREATED)</div><div class="FixedLine">104          -&gt;seeInDatabase('books', ['title' =&gt; $book-&gt;title]);</div><div class="FixedLine">105  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-52.</span><div class="SimplePara">Fixing the BooksController@create Exactly Max Validation Test</div></div></div></div>
          </div><div id="Par155" class="Para">Next, there are some instances of <span class="EmphasisFontCategoryNonProportional">'author' =&gt; $book-&gt;author</span> you need to replace with a valid <span class="EmphasisFontCategoryNonProportional">author_id</span> in <span class="EmphasisFontCategoryNonProportional">BooksControllerValidationTest</span>. The first test is when the title is just too long when trying to create a book (Listing <span class="InternalRef"><a href="#Par156">9-53</a></span>).</div><div id="Par156" class="Para">
            <div class="ProgramCode" id="PC54"><div class="FixedLine">48  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">49  <span class="EmphasisTypeBold">public function</span> title_fails_create_validation_when_just_too_long()</div><div class="FixedLine">50  {</div><div class="FixedLine">51      <span class="EmphasisTypeItalic">// Creating a book</span>
          </div><div class="FixedLine">52      $book = $this-&gt;bookFactory();</div><div class="FixedLine">53      $book-&gt;title = str_repeat('a', 256);</div><div class="FixedLine">54</div><div class="FixedLine">55      $this-&gt;post("/books", [</div><div class="FixedLine">56          'title' =&gt; $book-&gt;title,</div><div class="FixedLine">57          'description' =&gt; $book-&gt;description,</div><div class="FixedLine">58          'author_id' =&gt; $book-&gt;author-&gt;id,</div><div class="FixedLine">59      ], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">60</div><div class="FixedLine">61      $this</div><div class="FixedLine">62          -&gt;seeStatusCode(Response::HTTP_UNPROCESSABLE_ENTITY)</div><div class="FixedLine">63          -&gt;seeJson([</div><div class="FixedLine">64              'title' =&gt; ["The title may not be greater than 255 characters."]</div><div class="FixedLine">65          ])</div><div class="FixedLine">66          -&gt;notSeeInDatabase('books', ['title' =&gt; $book-&gt;title]);</div><div class="FixedLine">67  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-53.</span><div class="SimplePara">Adding the author_id Field to the POST Request</div></div></div></div>
          </div><div id="Par157" class="Para">The second place you need to send an author id is when updating a title with a PUT request (Listing <span class="InternalRef"><a href="#Par158">9-54</a></span>).</div><div id="Par158" class="Para">
            <div class="ProgramCode" id="PC55"><div class="FixedLine">69  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">70  <span class="EmphasisTypeBold">public function</span> title_fails_update_validation_when_just_too_long()</div><div class="FixedLine">71  {</div><div class="FixedLine">72      <span class="EmphasisTypeItalic">// Updating a book</span>
          </div><div class="FixedLine">73      $book = $this-&gt;bookFactory();</div><div class="FixedLine">74      $book-&gt;title = str_repeat('a', 256);</div><div class="FixedLine">75</div><div class="FixedLine">76      $this-&gt;put("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>", [</div><div class="FixedLine">77          'title' =&gt; $book-&gt;title,</div><div class="FixedLine">78          'description' =&gt; $book-&gt;description,</div><div class="FixedLine">79          'author_id' =&gt; $book-&gt;author-&gt;id,</div><div class="FixedLine">80      ], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">81</div><div class="FixedLine">82      $this</div><div class="FixedLine">83          -&gt;seeStatusCode(Response::HTTP_UNPROCESSABLE_ENTITY)</div><div class="FixedLine">84          -&gt;seeJson([</div><div class="FixedLine">85              'title' =&gt; ["The title may not be greater than 255 characters."]</div><div class="FixedLine">86          ])</div><div class="FixedLine">87          -&gt;notSeeInDatabase('books', ['title' =&gt; $book-&gt;title]);</div><div class="FixedLine">88  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-54.</span><div class="SimplePara">Adding the author_id Field to the PUT Request</div></div></div></div>
          </div><div id="Par159" class="Para">The final author id replacement is when the title passes validation with exactly the maximum characters allowed (Listing <span class="InternalRef"><a href="#Par160">9-55</a></span>).</div><div id="Par160" class="Para">
            <div class="ProgramCode" id="PC56"><div class="FixedLine">108  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">109  <span class="EmphasisTypeBold">public function</span> title_passes_update_validation_when_exactly_max()</div><div class="FixedLine">110  {</div><div class="FixedLine">111      <span class="EmphasisTypeItalic">// Updating a book</span>
          </div><div class="FixedLine">112      $book = $this-&gt;bookFactory();</div><div class="FixedLine">113      $book-&gt;title = str_repeat('a', 255);</div><div class="FixedLine">114</div><div class="FixedLine">115      $this-&gt;put("/books/<span class="EmphasisTypeBold">{</span>$book-&gt;id<span class="EmphasisTypeBold">}</span>", [</div><div class="FixedLine">116          'title' =&gt; $book-&gt;title,</div><div class="FixedLine">117          'description' =&gt; $book-&gt;description,</div><div class="FixedLine">118          'author_id' =&gt; $book-&gt;author-&gt;id,</div><div class="FixedLine">119      ], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">120</div><div class="FixedLine">121      $this</div><div class="FixedLine">122          -&gt;seeStatusCode(Response::HTTP_OK)</div><div class="FixedLine">123          -&gt;seeInDatabase('books', ['title' =&gt; $book-&gt;title]);</div><div class="FixedLine">124  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-55.</span><div class="SimplePara">Adding the author_id Field to the PUT Request</div></div></div></div>
          </div><div id="Par161" class="Para">After making these author changes, you can run all the tests in the <span class="EmphasisFontCategoryNonProportional">BooksControllerValidationTest</span> class (Listing <span class="InternalRef"><a href="#Par162">9-56</a></span>).</div><div id="Par162" class="Para">
            <div class="ProgramCode" id="PC57"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit tests/app/Http/Controllers/BooksControllerValidationTest.php</div></div><div class="LineGroup"><div class="FixedLine">OK (6 tests, 20 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-56.</span><div class="SimplePara">Running the Tests for BooksControllerValidationTest</div></div></div></div>
          </div><div id="Par163" class="Para">You are starting to see the light at the end of the refactor tunnel! Run your test suite and see what remains (Listing <span class="InternalRef"><a href="#Par164">9-57</a></span>).</div><div id="Par164" class="Para">
            <div class="ProgramCode" id="PC58"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There were 3 failures:</div><div class="FixedLine">...</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 27, Assertions: 104, Errors: 1, Failures: 3.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-57.</span><div class="SimplePara">Running the Full Test Suite After Your Fixes</div></div></div></div>
          </div><div id="Par165" class="Para">I’ve only provided partial error output, but if you inspect the “Unable to find JSON fragment” error closely you will notice that the response includes all author data from the <span class="EmphasisFontCategoryNonProportional">Author</span> model. You need to update your test to check the author’s name (Listing <span class="InternalRef"><a href="#Par166">9-58</a></span>).</div><div id="Par166" class="Para">
            <div class="ProgramCode" id="PC59"><div class="LineGroup"><div class="FixedLine">
                  <span class="EmphasisTypeItalic">/** @test **/</span>
                </div><div class="FixedLine">
              <span class="EmphasisTypeBold">public function</span> index_should_return_a_collection_of_records()</div><div class="FixedLine">{</div><div class="FixedLine">    $books = $this-&gt;bookFactory(2);</div></div><div class="LineGroup"><div class="FixedLine">    $this-&gt;get('/books');</div></div><div class="LineGroup"><div class="FixedLine">    $content = json_decode($this-&gt;response-&gt;getContent(), <span class="EmphasisTypeBold">true</span>);</div><div class="FixedLine">    $this-&gt;assertArrayHasKey('data', $content);</div></div><div class="LineGroup"><div class="FixedLine">    <span class="EmphasisTypeBold">foreach</span> ($books <span class="EmphasisTypeBold">as</span> $book) {</div><div class="FixedLine">        $this-&gt;seeJson([</div><div class="FixedLine">            'id' =&gt; $book-&gt;id,</div><div class="FixedLine">            'title' =&gt; $book-&gt;title,</div><div class="FixedLine">            'description' =&gt; $book-&gt;description,</div><div class="FixedLine">            <span class="EmphasisTypeBold">'author' =&gt; $book-&gt;author-&gt;name</span>, <span class="EmphasisTypeItalic">// Check the author's name</span>
            </div><div class="FixedLine">            'created' =&gt; $book-&gt;created_at-&gt;toIso8601String(),</div><div class="FixedLine">            'updated' =&gt; $book-&gt;updated_at-&gt;toIso8601String(),</div><div class="FixedLine">        ]);</div><div class="FixedLine">    }</div><div class="FixedLine">}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-58.</span><div class="SimplePara">Using Author Model in the Assertion of the author Property</div></div></div></div>
          </div><div id="Par167" class="Para">Next, verify that your change fixed the test (Listing <span class="InternalRef"><a href="#Par168">9-59</a></span>).</div><div id="Par168" class="Para">
            <div class="ProgramCode" id="PC60"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=index_should_return_a_collection_of_records</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 13 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-59.</span><div class="SimplePara">Testing the BooksController@index Test</div></div></div></div>
          </div><div id="Par169" class="Para">Now run <span class="EmphasisFontCategoryNonProportional">phpunit</span> again to get the last two failures (Listing <span class="InternalRef"><a href="#Par170">9-60</a></span>).</div><div id="Par170" class="Para">
            <div class="ProgramCode" id="PC61"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div><div class="FixedLine">...</div><div class="FixedLine">There were 2 failures:</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 27, Assertions: 115, Errors: 1, Failures: 2.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-60.</span><div class="SimplePara">Getting the Next PHPUnit Failure</div></div></div></div>
          </div><div id="Par171" class="Para">You’re getting closer! The next error looks like an invalid comparison of the <span class="EmphasisFontCategoryNonProportional">Author</span> model. Looking at the <span class="EmphasisTypeItalic"><span class="EmphasisFontCategoryNonProportional">show_should_return_a_valid_book</span></span> test closely, you need to update the following <span class="EmphasisFontCategoryNonProportional">assertEquals</span> check (Listing <span class="InternalRef"><a href="#Par172">9-61</a></span>).</div><div id="Par172" class="Para">
            <div class="ProgramCode" id="PC62"><div class="LineGroup"><div class="FixedLine">/** @test **/</div><div class="FixedLine">public function show_should_return_a_valid_book()</div><div class="FixedLine">{</div><div class="FixedLine">    $book = $this-&gt;bookFactory();</div></div><div class="LineGroup"><div class="FixedLine">    $this</div><div class="FixedLine">        -&gt;get("/books/{$book-&gt;id}")</div><div class="FixedLine">        -&gt;seeStatusCode(200);</div></div><div class="LineGroup"><div class="FixedLine">    // Get the response and assert the data key exists</div><div class="FixedLine">    $content = json_decode($this-&gt;response-&gt;getContent(), true);</div><div class="FixedLine">    $this-&gt;assertArrayHasKey('data', $content);</div><div class="FixedLine">    $data = $content['data'];</div></div><div class="LineGroup"><div class="FixedLine">    // Assert the Book Properties match</div><div class="FixedLine">    $this-&gt;assertEquals($book-&gt;id, $data['id']);</div><div class="FixedLine">    $this-&gt;assertEquals($book-&gt;title, $data['title']);</div><div class="FixedLine">    $this-&gt;assertEquals($book-&gt;description, $data['description']);</div><div class="FixedLine">    <span class="EmphasisTypeBold">$this-&gt;assertEquals($book-&gt;author-&gt;name, $data['author']);</span>
            </div><div class="FixedLine">    $this-&gt;assertEquals($book-&gt;created_at-&gt;toIso8601String(), $data['created']);</div><div class="FixedLine">    $this-&gt;assertEquals($book-&gt;updated_at-&gt;toIso8601String(), $data['created']);</div><div class="FixedLine">}</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-61.</span><div class="SimplePara">Fixing the Assertion for the Author’s Name</div></div></div></div>
          </div><div id="Par173" class="Para">Let’s see if you fixed the test and what remains to be fixed (Listing <span class="InternalRef"><a href="#Par174">9-62</a></span>).</div><div id="Par174" class="Para">
            <div class="ProgramCode" id="PC63"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 failure:</div><div class="FixedLine">...</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 27, Assertions: 117, Errors: 1, Failures: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-62.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par175" class="Para">The <span class="EmphasisFontCategoryNonProportional">Failed asserting that 302 matches expected 201</span> message means that the controller is sending a redirect response. You are communicating with JSON clients so you need to send the request with the <span class="EmphasisFontCategoryNonProportional">Accept: application/json</span> header in order to get back a JSON response instead of the default failed validation redirect. Looking at this test, you can see that validation will fail because you need to send an <span class="EmphasisFontCategoryNonProportional">author_id,</span> which is required in <span class="EmphasisFontCategoryNonProportional">BooksController@create</span>, so let’s update both now (Listing <span class="InternalRef"><a href="#Par176">9-63</a></span>).</div><div id="Par176" class="Para">
            <div class="ProgramCode" id="PC64"><div class="FixedLine">138  <span class="EmphasisTypeItalic">/** @test */</span>
          </div><div class="FixedLine">139  <span class="EmphasisTypeBold">public function</span> store_should_respond_with_a_201_and_location_header_when_successful()</div><div class="FixedLine">140  {</div><div class="FixedLine">141      $author = factory(\App\Author::class)-&gt;create();</div><div class="FixedLine">142      $this-&gt;post('/books', [</div><div class="FixedLine">143          'title' =&gt; 'The Invisible Man',</div><div class="FixedLine">144          'description' =&gt; 'An invisible man is trapped in the terror of his own creation',</div><div class="FixedLine">145          'author_id' =&gt; $author-&gt;id</div><div class="FixedLine">146      ], ['Accept' =&gt; 'application/json']);</div><div class="FixedLine">147</div><div class="FixedLine">148      $this</div><div class="FixedLine">149          -&gt;seeStatusCode(201)</div><div class="FixedLine">150          -&gt;seeHeaderWithRegExp('Location', '#/books/[\d]+$#');</div><div class="FixedLine">151  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-63.</span><div class="SimplePara">Using the Author Model to Fix the Failing Test</div></div></div></div>
          </div><div id="Par177" class="Para">The individual test passes now (Listing <span class="InternalRef"><a href="#Par178">9-64</a></span>).</div><div id="Par178" class="Para">
            <div class="ProgramCode" id="PC65"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit --filter=store_should_respond_with_a_201_and_location_header_when_successful</div></div><div class="LineGroup"><div class="FixedLine">OK (1 test, 3 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-64.</span><div class="SimplePara">Running the PHPUnit Test</div></div></div></div>
          </div><div id="Par179" class="Para">Run your entire suite again and see if you are back to green yet (Listing <span class="InternalRef"><a href="#Par180">9-65</a></span>).</div><div id="Par180" class="Para">
            <div class="ProgramCode" id="PC66"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">There was 1 error:</div></div><div class="LineGroup"><div class="FixedLine">1) Tests\App\Transformer\BookTransformerTest::it_transforms_a_book_model</div><div class="FixedLine">Illuminate\Database\QueryException: SQLSTATE[23000]: Integrity constraint violat\</div><div class="FixedLine">ion...</div></div><div class="LineGroup"><div class="FixedLine">FAILURES!</div><div class="FixedLine">Tests: 27, Assertions: 117, Errors: 1.</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-65.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par181" class="Para">One more error and you should be back to green. The error is another foreign key constraint violation in the <span class="EmphasisFontCategoryNonProportional">BooksTransformerTest</span> file. You just need to use the <span class="EmphasisFontCategoryNonProportional">bookFactory()</span> method (Listing <span class="InternalRef"><a href="#Par182">9-66</a></span>).</div><div id="Par182" class="Para">
            <div class="ProgramCode" id="PC67"><div class="FixedLine">22  <span class="EmphasisTypeItalic">/** @test **/</span>
          </div><div class="FixedLine">23  <span class="EmphasisTypeBold">public function</span> it_transforms_a_book_model()</div><div class="FixedLine">24  {</div><div class="FixedLine">25      $book = $this-&gt;bookFactory();</div><div class="FixedLine">26      $subject = <span class="EmphasisTypeBold">new</span> BookTransformer();</div><div class="FixedLine">27</div><div class="FixedLine">28      $transform = $subject-&gt;transform($book);</div><div class="FixedLine">29</div><div class="FixedLine">30      $this-&gt;assertArrayHasKey('id', $transform);</div><div class="FixedLine">31      $this-&gt;assertArrayHasKey('title', $transform);</div><div class="FixedLine">32      $this-&gt;assertArrayHasKey('description', $transform);</div><div class="FixedLine">33      $this-&gt;assertArrayHasKey('author', $transform);</div><div class="FixedLine">34      $this-&gt;assertArrayHasKey('created', $transform);</div><div class="FixedLine">35      $this-&gt;assertArrayHasKey('updated', $transform);</div><div class="FixedLine">36  }</div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-66.</span><div class="SimplePara">Updating the Failing BookTransformerTest</div></div></div></div>
          </div><div id="Par183" class="Para">You should be completely done and have full passing tests again (Listing <span class="InternalRef"><a href="#Par184">9-67</a></span>).</div><div id="Par184" class="Para">
            <div class="ProgramCode" id="PC68"><div class="LineGroup"><div class="FixedLine"># vagrant@homestead:∼/Code/bookr$</div><div class="FixedLine">$ phpunit</div></div><div class="LineGroup"><div class="FixedLine">OK (27 tests, 125 assertions)</div></div><div class="Caption" xml:lang="en"><div class="CaptionContent"><span class="CaptionNumber">Listing 9-67.</span><div class="SimplePara">Running the Test Suite</div></div></div></div>
          </div><div id="Par185" class="Para">Finally!</div><div id="Par186" class="Para ParaTypeImportant">Git Commit: Add Author Model Data to Books</div><div id="Par187" class="Para ParaTypeImportant">b463cc9 (<span class="ExternalRef"><a href="https://bitbucket.org/paulredmond/apress-bookr/commits/b463cc9"><span class="RefSource">
                <span class="EmphasisFontCategoryNonProportional">https://bitbucket.org/paulredmond/apress-bookr/commits/b463cc9</span>
              </span></a></span>)</div></div><div id="Sec3" class="Section1 RenderAsSection1"><h2 class="Heading">Conclusion</h2><div id="Par188" class="Para ParaOneEmphasisChild">You’ve successfully refactored your code to use the new <span class="EmphasisFontCategoryNonProportional">authors</span> model. For a minor change, you can see that your test suite took a bit of work to fix. While annoying, good test coverage is a huge time saver in the long run.</div><div id="Par189" class="Para">The small investment in fixing tests will pay dividends. You can rip out the guts of your code and have confidence that test specifications will lead you to less bugs, and keep business and code requirements documented.</div><div id="Par190" class="Para">You could have designed your schema with separate tables up front in a real project. Thinking about schema design early is important, but do not over-design your schema up front if it blocks you from developing iteratively. Your string column for the author name was fine to get you going, and you were able to refactor things (somewhat) painlessly. You don’t have to finish the application in one sitting and you may get a few things wrong at first.</div></div></div></body></html>
