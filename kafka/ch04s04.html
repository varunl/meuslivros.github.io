<?xml version="1.0" encoding="utf-8" ?>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Replication in Kafka</title><link rel="stylesheet" href="epub.css" type="text/css"/><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"/></head><body id="page"><div class="section" title="Replication in Kafka"><div class="titlepage"><div><div><h1 class="title"><a id="ch04lvl1sec21"/>Replication in Kafka</h1></div></div></div><p>Before we talk about <a id="id80" class="indexterm"/>replication in Kafka, let's talk about message partitioning. In Kafka, <a id="id81" class="indexterm"/>message partitioning strategy<a id="id82" class="indexterm"/> is used at the Kafka broker end. The decision about how the message is partitioned is taken by the producer, and the broker stores the messages in the same order as they arrive. The number of partitions can be configured for each topic within the Kafka broker.</p><p>Kafka replication is one of the very important features introduced in Kafka 0.8. Though Kafka is highly scalable, for better durability of messages and high availability of Kafka clusters, replication guarantees that the message will be published and consumed even in case of broker failure, which may be caused by any reason. Here, both producers and consumers are replication aware in Kafka. The following diagram explains replication in Kafka:</p><div class="mediaobject"><img src="graphics/7938OS_04_03.jpg" alt="Replication in Kafka"/></div><p>Let's discuss the preceding diagram in detail.</p><p>In replication, each partition of a message has <span class="emphasis"><em>n</em></span> replicas and can afford <span class="emphasis"><em>n-1</em></span> failures to guarantee message delivery. Out of the <span class="emphasis"><em>n</em></span> replicas, one replica acts as the lead replica for the rest of the replicas. ZooKeeper keeps the information about the lead replica and the current in-sync follower replica (lead replica maintains the list of all in-sync follower replicas).</p><p>Each replica stores its part of the message in local logs and offsets, and is periodically synced to the disk. This process also ensures that either a message is written to all the replicas or to none of them.</p><p>If the lead replica fails, either while writing the message partition to its local log or before sending the acknowledgement to the message producer, a message partition is resent by the producer to the new lead broker.</p><p>The process of choosing the new lead replica is that all followers' <span class="strong"><strong>In-sync Replicas</strong></span> (<span class="strong"><strong>ISRs</strong></span>)<a id="id83" class="indexterm"/> register themselves with ZooKeeper. The very first registered replica becomes the new lead replica, and the rest of the registered replicas become the followers.</p><p>Kafka supports the <a id="id84" class="indexterm"/>following replication modes:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Synchronous replication</strong></span>: In <a id="id85" class="indexterm"/>synchronous replication, a producer first identifies the lead replica from ZooKeeper and <a id="id86" class="indexterm"/>publishes the message. As soon as the message is published, it is written to the log of the lead replica and all the followers of the lead start pulling the message, and by using a single channel, the order of messages is ensured. Each follower replica sends an acknowledgement to the lead replica once the message is written to its respective logs. Once replications are complete and all expected acknowledgements are received, the lead replica sends an acknowledgement to the producer.<p>On the consumer side, all the pulling of messages is done from the lead replica.</p></li><li class="listitem" style="list-style-type: disc"><span class="strong"><strong>Asynchronous replication</strong></span>: The <a id="id87" class="indexterm"/>only difference in this mode is that as soon as a lead replica writes the <a id="id88" class="indexterm"/>message to its local log, it sends the acknowledgement to the message client and does not wait for the acknowledgements from follower replicas. But as a down side, this mode does not ensure the message delivery in case of broker failure.</li></ul></div><div class="note" title="Note" style=""><div class="inner"><h3 class="title"><a id="note12"/>Note</h3><p>For detailed explanation on <a id="id89" class="indexterm"/>Kafka replication and its usage, visit <a class="ulink" href="https://cwiki.apache.org/confluence/display/KAFKA/Kafka+Replication">https://cwiki.apache.org/confluence/display/KAFKA/Kafka+Replication</a>.</p></div></div></div></body></html>
